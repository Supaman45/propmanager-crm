import React, { useState, useEffect, useRef, useMemo } from 'react';
import './App.css';
import { supabase } from './supabase';
import Auth from './Auth';
import TenantPortal from './TenantPortal';
import PaymentPage from './PaymentPage';
import jsPDF from 'jspdf';
import 'jspdf-autotable';
import Papa from 'papaparse';
import { BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

const initialTenants = [
  {
    id: 1,
    name: 'Sarah Mitchell',
    phone: '(555) 234-5678',
    email: 'sarah.m@email.com',
    property: '1420 Oak Street, Unit 3B',
    rentAmount: 1850,
    securityDeposit: 1850,
    leaseStart: '2024-03-01',
    leaseEnd: '2025-02-28',
    status: 'current',
    paymentStatus: 'paid',
    notes: 'Prefers email communication'
  },
  {
    id: 2,
    name: 'Marcus Johnson',
    phone: '(555) 876-5432',
    email: 'mjohnson@email.com',
    property: '892 Pine Avenue, Unit 12',
    rentAmount: 2200,
    securityDeposit: 2200,
    leaseStart: '2024-01-15',
    leaseEnd: '2025-01-14',
    status: 'current',
    paymentStatus: 'late',
    notes: 'Has 2 pets (cats), pet deposit paid'
  },
  {
    id: 3,
    name: 'Emily Chen',
    phone: '(555) 345-6789',
    email: 'echen@email.com',
    property: '456 Maple Drive',
    rentAmount: 3200,
    securityDeposit: 3200,
    leaseStart: '2023-06-01',
    leaseEnd: '2024-05-31',
    status: 'past',
    paymentStatus: 'paid',
    notes: 'Moved out, full deposit returned'
  },
  {
    id: 4,
    name: 'David Williams',
    phone: '(555) 987-6543',
    email: 'dwilliams@email.com',
    property: 'Unassigned',
    rentAmount: 0,
    securityDeposit: 0,
    leaseStart: '',
    leaseEnd: '',
    status: 'prospect',
    paymentStatus: 'n/a',
    notes: 'Interested in 2BR units, move-in date: Feb 2025'
  }
];

const initialProperties = [
  { id: 1, address: '1420 Oak Street', units: 8, type: 'Multi-Family', occupied: 7, monthlyRevenue: 14200 },
  { id: 2, address: '892 Pine Avenue', units: 24, type: 'Apartment Complex', occupied: 22, monthlyRevenue: 48400 },
  { id: 3, address: '456 Maple Drive', units: 1, type: 'Single Family', occupied: 0, monthlyRevenue: 0 },
  { id: 4, address: '789 Cedar Lane', units: 4, type: 'Multi-Family', occupied: 4, monthlyRevenue: 7600 }
];

const initialMaintenanceRequests = [
  {
    id: 1,
    tenantId: 1,
    tenantName: 'Sarah Mitchell',
    property: '1420 Oak Street, Unit 3B',
    issue: 'Leaky faucet in kitchen',
    priority: 'medium',
    status: 'open',
    date: '2024-12-15',
    description: 'Kitchen faucet has been dripping for 3 days'
  },
  {
    id: 2,
    tenantId: 2,
    tenantName: 'Marcus Johnson',
    property: '892 Pine Avenue, Unit 12',
    issue: 'Broken heating unit',
    priority: 'high',
    status: 'open',
    date: '2024-12-18',
    description: 'Heating not working, urgent during winter'
  },
  {
    id: 3,
    tenantId: 1,
    tenantName: 'Sarah Mitchell',
    property: '1420 Oak Street, Unit 3B',
    issue: 'Window lock broken',
    priority: 'low',
    status: 'open',
    date: '2024-12-20',
    description: 'Bedroom window lock needs repair'
  }
];

// Demo data for Pacific Northwest properties
// Dev account email for admin features
const DEV_EMAIL = 'strongsa@uw.edu'; // Change this to your dev account email

const demoProperties = [
  { name: 'Maple Heights Apartments', address: '1420 N 45th St, Seattle, WA 98103', type: 'Multi-family', units: 24, occupied: 22, monthlyRevenue: 42900, photo: 'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800&q=80' },
  { name: 'Cedar Park Townhomes', address: '3305 SE Hawthorne Blvd, Portland, OR 97214', type: 'Townhouse', units: 12, occupied: 11, monthlyRevenue: 26400, photo: 'https://images.unsplash.com/photo-1605276374104-dee2a0ed3cd6?w=800&q=80' },
  { name: 'Evergreen Commons', address: '742 E Holly St, Bellingham, WA 98225', type: 'Multi-family', units: 16, occupied: 14, monthlyRevenue: 23100, photo: 'https://images.unsplash.com/photo-1574362848149-11496d93a7c7?w=800&q=80' },
  { name: 'Olympic View Duplex', address: '892 Ruston Way, Tacoma, WA 98402', type: 'Duplex', units: 2, occupied: 2, monthlyRevenue: 3900, photo: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=800&q=80' },
  { name: 'Cascade Studio Lofts', address: '2100 Westlake Ave N, Seattle, WA 98109', type: 'Multi-family', units: 18, occupied: 16, monthlyRevenue: 25600, photo: 'https://images.unsplash.com/photo-1460317442991-0ec209397118?w=800&q=80' },
  { name: 'Willamette River House', address: '456 SW River Dr, Portland, OR 97201', type: 'Single-family', units: 1, occupied: 1, monthlyRevenue: 3800, photo: 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=800&q=80' },
  { name: 'Puget Sound Flats', address: '1888 Harbor Ave SW, Seattle, WA 98126', type: 'Multi-family', units: 20, occupied: 18, monthlyRevenue: 36000, photo: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&q=80' },
  { name: 'Columbia Gorge Estates', address: '200 E 2nd St, The Dalles, OR 97058', type: 'Single-family', units: 4, occupied: 4, monthlyRevenue: 9200, photo: 'https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=800&q=80' }
];

const demoTenants = [
  // Maple Heights Apartments - Seattle
  { name: 'Amy Long', email: 'along@email.com', phone: '206-555-0142', property: 'Maple Heights Apartments', unit: '1A', rentAmount: 1950, securityDeposit: 1950, status: 'current', paymentStatus: 'paid', leaseStart: '2024-10-01', leaseEnd: '2025-09-30', notes: 'Quiet tenant, works from home', photo: 'https://randomuser.me/api/portraits/women/44.jpg' },
  { name: 'Marcus Johnson', email: 'mjohnson@email.com', phone: '206-555-0187', property: 'Maple Heights Apartments', unit: '2A', rentAmount: 1950, securityDeposit: 1950, status: 'current', paymentStatus: 'late', leaseStart: '2024-08-01', leaseEnd: '2025-07-31', notes: 'Payment plan in place', photo: 'https://randomuser.me/api/portraits/men/32.jpg' },
  { name: 'Sarah Chen', email: 'schen@email.com', phone: '206-555-0134', property: 'Maple Heights Apartments', unit: '3B', rentAmount: 2100, securityDeposit: 2100, status: 'current', paymentStatus: 'paid', leaseStart: '2025-01-01', leaseEnd: '2025-12-31', notes: 'Renewed for 2nd year', photo: 'https://randomuser.me/api/portraits/women/68.jpg' },
  { name: 'Daniel Park', email: 'dpark@email.com', phone: '206-555-0198', property: 'Maple Heights Apartments', unit: '4C', rentAmount: 1950, securityDeposit: 1950, status: 'current', paymentStatus: 'paid', leaseStart: '2024-07-01', leaseEnd: '2025-06-30', notes: '', photo: 'https://randomuser.me/api/portraits/men/75.jpg' },
  { name: 'Jessica Martinez', email: 'jmartinez@email.com', phone: '206-555-0156', property: 'Maple Heights Apartments', unit: '5A', rentAmount: 1950, securityDeposit: 1950, status: 'current', paymentStatus: 'paid', leaseStart: '2024-11-01', leaseEnd: '2025-10-31', notes: 'Has 1 cat (approved)', photo: 'https://randomuser.me/api/portraits/women/90.jpg' },
  { name: 'Kevin Liu', email: 'kliu@email.com', phone: '206-555-0167', property: 'Maple Heights Apartments', unit: '6B', rentAmount: 2100, securityDeposit: 2100, status: 'current', paymentStatus: 'paid', leaseStart: '2024-09-01', leaseEnd: '2025-08-31', notes: '', photo: 'https://randomuser.me/api/portraits/men/52.jpg' },
  
  // Cedar Park Townhomes - Portland
  { name: 'Emily Nakamura', email: 'enakamura@email.com', phone: '503-555-0156', property: 'Cedar Park Townhomes', unit: '1', rentAmount: 2400, securityDeposit: 2400, status: 'current', paymentStatus: 'paid', leaseStart: '2025-01-15', leaseEnd: '2026-01-14', notes: 'Corner unit', photo: 'https://randomuser.me/api/portraits/women/79.jpg' },
  { name: 'David Okonkwo', email: 'dokonkwo@email.com', phone: '503-555-0198', property: 'Cedar Park Townhomes', unit: '2', rentAmount: 2400, securityDeposit: 2400, status: 'current', paymentStatus: 'paid', leaseStart: '2024-11-01', leaseEnd: '2025-10-31', notes: '', photo: 'https://randomuser.me/api/portraits/men/81.jpg' },
  { name: 'Rachel Green', email: 'rgreen@email.com', phone: '503-555-0123', property: 'Cedar Park Townhomes', unit: '3', rentAmount: 2200, securityDeposit: 2200, status: 'current', paymentStatus: 'paid', leaseStart: '2024-06-01', leaseEnd: '2025-05-31', notes: 'Long-term tenant', photo: 'https://randomuser.me/api/portraits/women/17.jpg' },
  { name: 'Michael Foster', email: 'mfoster@email.com', phone: '503-555-0167', property: 'Cedar Park Townhomes', unit: '4', rentAmount: 2200, securityDeposit: 2200, status: 'current', paymentStatus: 'late', leaseStart: '2024-09-01', leaseEnd: '2025-08-31', notes: 'First late payment', photo: 'https://randomuser.me/api/portraits/men/46.jpg' },
  
  // Evergreen Commons - Bellingham
  { name: 'Lisa Tran', email: 'ltran@email.com', phone: '360-555-0134', property: 'Evergreen Commons', unit: '101', rentAmount: 1650, securityDeposit: 1650, status: 'current', paymentStatus: 'paid', leaseStart: '2025-02-01', leaseEnd: '2026-01-31', notes: '', photo: 'https://randomuser.me/api/portraits/women/37.jpg' },
  { name: 'Samantha Brooks', email: 'sbrooks@email.com', phone: '360-555-0165', property: 'Evergreen Commons', unit: '102', rentAmount: 1650, securityDeposit: 1650, status: 'current', paymentStatus: 'late', leaseStart: '2024-10-01', leaseEnd: '2025-09-30', notes: 'Job transition', photo: 'https://randomuser.me/api/portraits/women/63.jpg' },
  { name: 'Brian Walsh', email: 'bwalsh@email.com', phone: '360-555-0178', property: 'Evergreen Commons', unit: '201', rentAmount: 1650, securityDeposit: 1650, status: 'current', paymentStatus: 'paid', leaseStart: '2024-08-01', leaseEnd: '2025-07-31', notes: '', photo: 'https://randomuser.me/api/portraits/men/22.jpg' },
  { name: 'Amanda Collins', email: 'acollins@email.com', phone: '360-555-0189', property: 'Evergreen Commons', unit: '202', rentAmount: 1650, securityDeposit: 1650, status: 'current', paymentStatus: 'paid', leaseStart: '2025-03-01', leaseEnd: '2026-02-28', notes: 'New move-in', photo: 'https://randomuser.me/api/portraits/women/55.jpg' },
  
  // Olympic View Duplex - Tacoma
  { name: 'James Rodriguez', email: 'jrodriguez@email.com', phone: '253-555-0176', property: 'Olympic View Duplex', unit: 'A', rentAmount: 1950, securityDeposit: 1950, status: 'current', paymentStatus: 'paid', leaseStart: '2024-06-01', leaseEnd: '2025-05-31', notes: 'Waterfront view', photo: 'https://randomuser.me/api/portraits/men/67.jpg' },
  { name: 'Jennifer Walsh', email: 'jwalsh@email.com', phone: '253-555-0112', property: 'Olympic View Duplex', unit: 'B', rentAmount: 1950, securityDeposit: 1950, status: 'current', paymentStatus: 'paid', leaseStart: '2025-01-01', leaseEnd: '2025-12-31', notes: '', photo: 'https://randomuser.me/api/portraits/women/33.jpg' },
  
  // Cascade Studio Lofts - Seattle
  { name: 'Rachel Kim', email: 'rkim@email.com', phone: '206-555-0145', property: 'Cascade Studio Lofts', unit: '301', rentAmount: 1600, securityDeposit: 1600, status: 'current', paymentStatus: 'paid', leaseStart: '2025-04-01', leaseEnd: '2026-03-31', notes: 'Tech worker', photo: 'https://randomuser.me/api/portraits/women/82.jpg' },
  { name: 'Tyler James', email: 'tjames@email.com', phone: '206-555-0156', property: 'Cascade Studio Lofts', unit: '302', rentAmount: 1600, securityDeposit: 1600, status: 'current', paymentStatus: 'paid', leaseStart: '2024-12-01', leaseEnd: '2025-11-30', notes: '', photo: 'https://randomuser.me/api/portraits/men/86.jpg' },
  { name: 'Nina Patel', email: 'npatel@email.com', phone: '206-555-0167', property: 'Cascade Studio Lofts', unit: '401', rentAmount: 1600, securityDeposit: 1600, status: 'current', paymentStatus: 'paid', leaseStart: '2024-10-01', leaseEnd: '2025-09-30', notes: '', photo: 'https://randomuser.me/api/portraits/women/47.jpg' },
  { name: 'Chris Anderson', email: 'canderson@email.com', phone: '206-555-0178', property: 'Cascade Studio Lofts', unit: '402', rentAmount: 1600, securityDeposit: 1600, status: 'current', paymentStatus: 'late', leaseStart: '2024-08-01', leaseEnd: '2025-07-31', notes: 'Medical issue', photo: 'https://randomuser.me/api/portraits/men/94.jpg' },
  
  // Willamette River House - Portland
  { name: 'Thomas Wright', email: 'twright@email.com', phone: '503-555-0189', property: 'Willamette River House', unit: 'Main', rentAmount: 3800, securityDeposit: 3800, status: 'current', paymentStatus: 'paid', leaseStart: '2024-05-01', leaseEnd: '2025-04-30', notes: 'Premium single-family', photo: 'https://randomuser.me/api/portraits/men/36.jpg' },
  
  // Puget Sound Flats - Seattle
  { name: 'Olivia Brown', email: 'obrown@email.com', phone: '206-555-0190', property: 'Puget Sound Flats', unit: '1A', rentAmount: 2000, securityDeposit: 2000, status: 'current', paymentStatus: 'paid', leaseStart: '2024-07-01', leaseEnd: '2025-06-30', notes: '', photo: 'https://randomuser.me/api/portraits/women/26.jpg' },
  { name: 'Ethan Davis', email: 'edavis@email.com', phone: '206-555-0201', property: 'Puget Sound Flats', unit: '2B', rentAmount: 2000, securityDeposit: 2000, status: 'current', paymentStatus: 'paid', leaseStart: '2024-09-01', leaseEnd: '2025-08-31', notes: '', photo: 'https://randomuser.me/api/portraits/men/18.jpg' },
  { name: 'Sophia Wilson', email: 'swilson@email.com', phone: '206-555-0212', property: 'Puget Sound Flats', unit: '3C', rentAmount: 2000, securityDeposit: 2000, status: 'current', paymentStatus: 'paid', leaseStart: '2024-11-01', leaseEnd: '2025-10-31', notes: '', photo: 'https://randomuser.me/api/portraits/women/71.jpg' },
  { name: 'Mason Taylor', email: 'mtaylor@email.com', phone: '206-555-0223', property: 'Puget Sound Flats', unit: '4A', rentAmount: 2000, securityDeposit: 2000, status: 'current', paymentStatus: 'paid', leaseStart: '2025-01-01', leaseEnd: '2025-12-31', notes: '', photo: 'https://randomuser.me/api/portraits/men/29.jpg' },
  
  // Columbia Gorge Estates - The Dalles
  { name: 'William Harris', email: 'wharris@email.com', phone: '541-555-0134', property: 'Columbia Gorge Estates', unit: 'House 1', rentAmount: 2300, securityDeposit: 2300, status: 'current', paymentStatus: 'paid', leaseStart: '2024-04-01', leaseEnd: '2025-03-31', notes: 'Mountain view', photo: 'https://randomuser.me/api/portraits/men/53.jpg' },
  { name: 'Isabella Moore', email: 'imoore@email.com', phone: '541-555-0145', property: 'Columbia Gorge Estates', unit: 'House 2', rentAmount: 2300, securityDeposit: 2300, status: 'current', paymentStatus: 'paid', leaseStart: '2024-06-01', leaseEnd: '2025-05-31', notes: '', photo: 'https://randomuser.me/api/portraits/women/89.jpg' },
  { name: 'Alexander Lee', email: 'alee@email.com', phone: '541-555-0156', property: 'Columbia Gorge Estates', unit: 'House 3', rentAmount: 2300, securityDeposit: 2300, status: 'current', paymentStatus: 'paid', leaseStart: '2024-08-01', leaseEnd: '2025-07-31', notes: '', photo: 'https://randomuser.me/api/portraits/men/73.jpg' },
  { name: 'Charlotte White', email: 'cwhite@email.com', phone: '541-555-0167', property: 'Columbia Gorge Estates', unit: 'House 4', rentAmount: 2300, securityDeposit: 2300, status: 'current', paymentStatus: 'paid', leaseStart: '2024-10-01', leaseEnd: '2025-09-30', notes: '', photo: 'https://randomuser.me/api/portraits/women/14.jpg' },
  
  // Prospects
  { name: 'Jordan Blake', email: 'jblake@email.com', phone: '206-555-0234', property: 'Unassigned', unit: '', rentAmount: 0, securityDeposit: 0, status: 'prospect', paymentStatus: null, leaseStart: null, leaseEnd: null, notes: 'Interested in 2BR at Maple Heights, credit check passed', photo: 'https://randomuser.me/api/portraits/men/42.jpg' },
  { name: 'Morgan Rivera', email: 'mrivera@email.com', phone: '503-555-0245', property: 'Unassigned', unit: '', rentAmount: 0, securityDeposit: 0, status: 'prospect', paymentStatus: null, leaseStart: null, leaseEnd: null, notes: 'Looking for townhome in Portland, move-in Feb 2026', photo: 'https://randomuser.me/api/portraits/women/57.jpg' },
  { name: 'Casey Kim', email: 'ckim@email.com', phone: '360-555-0256', property: 'Unassigned', unit: '', rentAmount: 0, securityDeposit: 0, status: 'prospect', paymentStatus: null, leaseStart: null, leaseEnd: null, notes: 'Student at WWU, needs studio', photo: 'https://randomuser.me/api/portraits/women/95.jpg' },
  
  // Past tenants
  { name: 'Robert Nguyen', email: 'rnguyen@email.com', phone: '206-555-0154', property: 'Cascade Studio Lofts', unit: '303', rentAmount: 1400, securityDeposit: 1400, status: 'past', paymentStatus: null, leaseStart: '2024-01-01', leaseEnd: '2024-12-31', notes: 'Relocated to California, excellent tenant', photo: 'https://randomuser.me/api/portraits/men/61.jpg' },
  { name: 'Lauren Hughes', email: 'lhughes@email.com', phone: '503-555-0265', property: 'Cedar Park Townhomes', unit: '5', rentAmount: 2200, securityDeposit: 2200, status: 'past', paymentStatus: null, leaseStart: '2023-06-01', leaseEnd: '2024-05-31', notes: 'Bought a house', photo: 'https://randomuser.me/api/portraits/women/23.jpg' }
];

const demoMaintenanceRequests = [
  // Open - Urgent
  { property: 'Maple Heights Apartments, Unit 2A', issue: 'No hot water - water heater failure', priority: 'urgent', status: 'open', date: '2026-01-09', description: 'Tenant reports complete loss of hot water since last night. Water heater making strange noises before failure.' },
  { property: 'Evergreen Commons, Unit 102', issue: 'Smoke detector chirping continuously', priority: 'urgent', status: 'open', date: '2026-01-08', description: 'Hardwired smoke detector won\'t stop chirping even after battery replacement.' },
  
  // Open - High
  { property: 'Cedar Park Townhomes, Unit 3', issue: 'Furnace not heating properly', priority: 'high', status: 'in_progress', date: '2026-01-02', description: 'Furnace cycles on but doesn\'t reach set temperature. House staying at 58Â°F.' },
  { property: 'Cascade Studio Lofts, Unit 402', issue: 'Window seal broken - major draft', priority: 'high', status: 'in_progress', date: '2025-12-28', description: 'Living room window has visible gap in seal. Cold air coming in, condensation forming.' },
  { property: 'Puget Sound Flats, Unit 1A', issue: 'Toilet constantly running', priority: 'high', status: 'open', date: '2026-01-07', description: 'Main bathroom toilet runs continuously, water bill concern.' },
  
  // Open - Medium
  { property: 'Olympic View Duplex, Unit A', issue: 'Front door lock sticking', priority: 'medium', status: 'open', date: '2026-01-04', description: 'Deadbolt requires excessive force to turn. Security concern.' },
  { property: 'Evergreen Commons, Unit 201', issue: 'Garbage disposal jammed', priority: 'medium', status: 'open', date: '2026-01-05', description: 'Disposal makes humming sound but won\'t spin. Reset button not helping.' },
  { property: 'Columbia Gorge Estates, House 1', issue: 'Garage door opener malfunction', priority: 'medium', status: 'in_progress', date: '2026-01-03', description: 'Remote works intermittently. Sometimes door reverses mid-close.' },
  { property: 'Maple Heights Apartments, Unit 5A', issue: 'Dishwasher not draining', priority: 'medium', status: 'open', date: '2026-01-06', description: 'Standing water remains after cycle completes.' },
  { property: 'Cedar Park Townhomes, Unit 2', issue: 'Bathroom exhaust fan noisy', priority: 'medium', status: 'open', date: '2026-01-08', description: 'Fan makes grinding noise when running. Still functional but loud.' },
  
  // Open - Low
  { property: 'Willamette River House, Unit Main', issue: 'Annual HVAC maintenance', priority: 'low', status: 'open', date: '2026-01-06', description: 'Scheduled annual maintenance for heating system.' },
  { property: 'Cascade Studio Lofts, Unit 301', issue: 'Closet door off track', priority: 'low', status: 'open', date: '2026-01-07', description: 'Sliding closet door jumps off track when opening.' },
  { property: 'Puget Sound Flats, Unit 3C', issue: 'Kitchen faucet dripping', priority: 'low', status: 'open', date: '2026-01-05', description: 'Slow drip from kitchen faucet, washer likely needs replacement.' },
  
  // Recently closed
  { property: 'Maple Heights Apartments, Unit 4C', issue: 'Leaky faucet in bathroom', priority: 'low', status: 'closed', date: '2025-12-15', description: 'Bathroom sink faucet dripping. Washer replaced.' },
  { property: 'Cedar Park Townhomes, Unit 4', issue: 'Dishwasher not draining', priority: 'medium', status: 'closed', date: '2025-12-20', description: 'Clogged drain line cleared and tested.' },
  { property: 'Evergreen Commons, Unit 101', issue: 'Thermostat not responding', priority: 'high', status: 'closed', date: '2025-12-22', description: 'Replaced batteries and recalibrated thermostat.' },
  { property: 'Olympic View Duplex, Unit B', issue: 'Clogged kitchen sink', priority: 'medium', status: 'closed', date: '2025-12-18', description: 'Snaked drain and cleared grease buildup.' },
  { property: 'Cascade Studio Lofts, Unit 302', issue: 'Light fixture flickering', priority: 'low', status: 'closed', date: '2025-12-23', description: 'Replaced bulb and tightened connection.' },
  { property: 'Columbia Gorge Estates, House 3', issue: 'Exterior light out', priority: 'low', status: 'closed', date: '2025-12-19', description: 'Replaced motion sensor bulb.' }
];

function App() {
  const [user, setUser] = useState(null);
  const [session, setSession] = useState(null);
  const [activeTab, setActiveTab] = useState(() => {
    // Restore active tab from localStorage on mount
    const savedTab = localStorage.getItem('propli_activeTab');
    return savedTab || 'dashboard';
  });
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [showProfileMenu, setShowProfileMenu] = useState(false);
  const [showHelpSupport, setShowHelpSupport] = useState(false);
  const [helpCategory, setHelpCategory] = useState('all');
  const [helpSearchQuery, setHelpSearchQuery] = useState('');
  const [darkMode, setDarkMode] = useState(() => {
    // Restore dark mode from localStorage on mount
    const savedDarkMode = localStorage.getItem('propli_darkMode');
    return savedDarkMode === 'true';
  });
  const [tenants, setTenants] = useState([]);
  const [properties, setProperties] = useState([]);
  const [maintenanceRequests, setMaintenanceRequests] = useState([]);
  const [tags, setTags] = useState([]);
  const [recordTags, setRecordTags] = useState([]); // Tag assignments
  const [tagHistory, setTagHistory] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showAddModal, setShowAddModal] = useState(false);
  const [selectedTenant, setSelectedTenant] = useState(null);
  const [filterStatus, setFilterStatus] = useState('all');
  const [tenantSearchQuery, setTenantSearchQuery] = useState('');
  const [dismissedBanners, setDismissedBanners] = useState(() => {
    // Restore dismissed banners from localStorage
    const saved = localStorage.getItem('propli_dismissedBanners');
    return saved ? JSON.parse(saved) : [];
  });
  const [expiringLeaseIds, setExpiringLeaseIds] = useState([]); // Track IDs of expiring leases for filtering
  const [propertySearchQuery, setPropertySearchQuery] = useState('');
  const [maintenanceSearchQuery, setMaintenanceSearchQuery] = useState('');
  const [maintenanceFilterTab, setMaintenanceFilterTab] = useState('all');
  const [showCompleted, setShowCompleted] = useState(false);
  const [smsMessages, setSmsMessages] = useState([]);
  const [selectedConversation, setSelectedConversation] = useState(null);
  const [newMessage, setNewMessage] = useState('');
  const [messagesRefreshing, setMessagesRefreshing] = useState(false);
  const [maintenanceRefreshing, setMaintenanceRefreshing] = useState(false);
  const [confirmPaymentChange, setConfirmPaymentChange] = useState(null);
  const [confirmDelete, setConfirmDelete] = useState(null);
  const [showPaymentLog, setShowPaymentLog] = useState(null);
  const [showSelectTenantForPayment, setShowSelectTenantForPayment] = useState(false);
  const [paymentTenantSearch, setPaymentTenantSearch] = useState('');
  const [showActivityLog, setShowActivityLog] = useState(null);
  const [newPayment, setNewPayment] = useState({ amount: '', method: 'cash', date: new Date().toISOString().split('T')[0] });
  const [newActivityNote, setNewActivityNote] = useState('');
  const [showExpenseModal, setShowExpenseModal] = useState(null);
  const [newExpense, setNewExpense] = useState({ description: '', amount: '', date: new Date().toISOString().split('T')[0], category: 'repair' });
  const [showAddPropertyModal, setShowAddPropertyModal] = useState(false);
  const [newProperty, setNewProperty] = useState({ address: '', units: '', type: '', occupied: '', monthlyRevenue: '', photo: null, ownerName: '', ownerEmail: '', ownerId: null });
  const [editingProperty, setEditingProperty] = useState(null);
  const [selectedProperty, setSelectedProperty] = useState(null);
  const [propertyPhotoUploading, setPropertyPhotoUploading] = useState(false);
  const [showDeletePropertyConfirm, setShowDeletePropertyConfirm] = useState(null);
  const [showAddMaintenanceModal, setShowAddMaintenanceModal] = useState(false);
  const [newMaintenanceRequest, setNewMaintenanceRequest] = useState({ tenantId: '', tenantName: '', property: '', issue: '', priority: 'medium', description: '', date: new Date().toISOString().split('T')[0] });
  const [selectedMaintenanceRequest, setSelectedMaintenanceRequest] = useState(null);
  const [showStatusDropdown, setShowStatusDropdown] = useState(false);
  const [showVendorInput, setShowVendorInput] = useState(false);
  const [vendorName, setVendorName] = useState('');
  const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7));
  const [propertySortField, setPropertySortField] = useState(null);
  const [propertySortDirection, setPropertySortDirection] = useState('asc');
  const [editingTenant, setEditingTenant] = useState(null);
  const [ownerStatementProperty, setOwnerStatementProperty] = useState('');
  const [ownerStatementMonth, setOwnerStatementMonth] = useState('');
  const [showMoveOutModal, setShowMoveOutModal] = useState(null);
  const [moveOutData, setMoveOutData] = useState({ date: new Date().toISOString().split('T')[0], notes: '', deductions: [{ description: '', amount: '' }] });
  const [showReminderModal, setShowReminderModal] = useState(null);
  const [auditLogExpanded, setAuditLogExpanded] = useState(false);
  const [showPaymentRequestModal, setShowPaymentRequestModal] = useState(null);
  const [paymentRequest, setPaymentRequest] = useState({ amount: '', dueDate: '', note: '' });
  const [paymentLinkCopied, setPaymentLinkCopied] = useState(false);
  const [createdPaymentLink, setCreatedPaymentLink] = useState('');
  const [tagsExpanded, setTagsExpanded] = useState(false);
  const [tenantFiles, setTenantFiles] = useState([]);
  const [propertyFiles, setPropertyFiles] = useState([]);
  
  // Toast notifications
  const [toasts, setToasts] = useState([]);
  
  // Schedule state
  const [scheduleEvents, setScheduleEvents] = useState([]);
  const [calendarDate, setCalendarDate] = useState(new Date());
  const [selectedCalendarDate, setSelectedCalendarDate] = useState(new Date());
  const [showAddEventModal, setShowAddEventModal] = useState(false);
  const [showCalendarSync, setShowCalendarSync] = useState(false);
  const [newEvent, setNewEvent] = useState({
    title: '',
    date: new Date().toISOString().split('T')[0],
    time: '',
    type: 'general',
    description: '',
    property_id: null,
    tenant_id: null
  });
  
  // Onboarding Wizard state
  const [showOnboardingWizard, setShowOnboardingWizard] = useState(false);
  const [onboardingStep, setOnboardingStep] = useState(1);
  const [onboardingData, setOnboardingData] = useState({
    property: null,
    unit: '',
    tenant: {
      name: '',
      email: '',
      phone: '',
      isExisting: false,
      existingId: null
    },
    lease: {
      monthlyRent: '',
      securityDeposit: '',
      startDate: '',
      endDate: '',
      leaseType: 'fixed' // fixed, month-to-month
    },
    documents: [],
    moveInDate: '',
    moveInNotes: ''
  });
  
  // Offboarding Wizard state
  const [showOffboardingWizard, setShowOffboardingWizard] = useState(false);
  const [offboardingStep, setOffboardingStep] = useState(1);
  const [offboardingData, setOffboardingData] = useState({
    tenant: null,
    moveOutDate: '',
    reason: '',
    forwardingAddress: '',
    inspectionChecklist: {
      wallsClean: false,
      floorsClean: false,
      appliancesWorking: false,
      plumbingWorking: false,
      keysReturned: false,
      smokeDetectorsWorking: false,
      noMissingItems: false
    },
    inspectionNotes: '',
    inspectionPhotos: [],
    depositDeductions: [],
    finalStatement: null
  });
  
  // Settings tab navigation
  const [settingsTab, setSettingsTab] = useState('profile');
  
  // Mobile navigation state
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  
  // Tenants page view state
  const [tenantsView, setTenantsView] = useState('board'); // 'board', 'cards', 'table'
  const [tenantFilter, setTenantFilter] = useState('all');
  
  // Table view pagination and sorting
  const [tenantsPage, setTenantsPage] = useState(1);
  const [tenantsPerPage, setTenantsPerPage] = useState(25);
  const [tenantsSortField, setTenantsSortField] = useState('name');
  const [tenantsSortDirection, setTenantsSortDirection] = useState('asc');
  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
  const [advancedFilters, setAdvancedFilters] = useState({
    property: '',
    rentMin: '',
    rentMax: '',
    leaseEndBefore: '',
    leaseEndAfter: '',
    balanceDue: false
  });
  
  // Listen for resize
  useEffect(() => {
    const handleResize = () => {
      const mobile = window.innerWidth < 768;
      setIsMobile(mobile);
      if (!mobile) {
        setMobileMenuOpen(false);
      }
    };
    window.addEventListener('resize', handleResize);
    handleResize(); // Check on mount
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  
  // Profile form state
  const [profileData, setProfileData] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: ''
  });
  
  // Security form state
  const [passwordData, setPasswordData] = useState({
    currentPassword: '',
    newPassword: '',
    confirmPassword: ''
  });
  const [twoFactorEnabled, setTwoFactorEnabled] = useState(false);
  
  // Company form state
  const [companyData, setCompanyData] = useState({
    name: '',
    address: ''
  });
  
  // Email notification preferences
  const [emailNotifications, setEmailNotifications] = useState({
    lateRentReminders: true,
    newTenantAdded: true,
    maintenanceRequests: true,
    paymentReceived: true
  });
  
  // SMS/Twilio settings state
  const [twilioSettings, setTwilioSettings] = useState({
    accountSid: '',
    authToken: '',
    phoneNumber: ''
  });
  const [twilioSettingsLoading, setTwilioSettingsLoading] = useState(false);
  const [testSmsPhone, setTestSmsPhone] = useState('');
  const [testSmsSending, setTestSmsSending] = useState(false);
  const [smsSending, setSmsSending] = useState({});
  
  // Tag management state
  const [showCreateTagModal, setShowCreateTagModal] = useState(false);
  const [newTag, setNewTag] = useState({ name: '', color: 'blue' });
  const [tagPickerOpen, setTagPickerOpen] = useState({ recordType: null, recordId: null });
  const [tagPickerSearch, setTagPickerSearch] = useState('');
  const [selectedTagFilters, setSelectedTagFilters] = useState([]);
  const [quickTagMenu, setQuickTagMenu] = useState({ recordType: null, recordId: null, x: 0, y: 0 });
  const [tagAnalysisDateRange, setTagAnalysisDateRange] = useState('all');
  const [selectedTagForTrend, setSelectedTagForTrend] = useState(null);
  const [expandedTagRow, setExpandedTagRow] = useState(null);
  
  // Owner Portal state
  const [owners, setOwners] = useState([]);
  const [selectedOwner, setSelectedOwner] = useState(null);
  const [showAddOwnerModal, setShowAddOwnerModal] = useState(false);
  const [showEditOwnerModal, setShowEditOwnerModal] = useState(false);
  const [showOwnerDetailModal, setShowOwnerDetailModal] = useState(false);
  const [showAssignPropertyModal, setShowAssignPropertyModal] = useState(false);
  const [showOwnerStatementModal, setShowOwnerStatementModal] = useState(false);
  const [newOwner, setNewOwner] = useState({
    name: '',
    email: '',
    phone: '',
    address: '',
    managementFeePercent: 10,
    portalEnabled: false
  });
  const [ownerProperties, setOwnerProperties] = useState([]);
  const [ownerDistributions, setOwnerDistributions] = useState([]);
  const [assignPropertyId, setAssignPropertyId] = useState('');
  const [assignOwnershipPct, setAssignOwnershipPct] = useState('100');
  const [statementPeriod, setStatementPeriod] = useState({
    start: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0],
    end: new Date().toISOString().split('T')[0]
  });
  
  // Owner Portal login state
  const [ownerPortalView, setOwnerPortalView] = useState('login'); // 'login', 'dashboard'
  const [portalOwner, setPortalOwner] = useState(null);
  const [portalEmail, setPortalEmail] = useState('');
  const [portalPassword, setPortalPassword] = useState('');
  const [portalLoading, setPortalLoading] = useState(false);
  const [portalError, setPortalError] = useState('');
  
  // CSV Import state
  const [tenantCsvFile, setTenantCsvFile] = useState(null);
  const [tenantCsvData, setTenantCsvData] = useState(null);
  const [tenantCsvPreview, setTenantCsvPreview] = useState(null);
  const [tenantColumnMapping, setTenantColumnMapping] = useState({});
  const [tenantImportProgress, setTenantImportProgress] = useState(null);
  
  const [propertyCsvFile, setPropertyCsvFile] = useState(null);
  const [propertyCsvData, setPropertyCsvData] = useState(null);
  const [propertyCsvPreview, setPropertyCsvPreview] = useState(null);
  const [propertyColumnMapping, setPropertyColumnMapping] = useState({});
  const [propertyImportProgress, setPropertyImportProgress] = useState(null);

  // Late Fees state
  const [lateFeeSettings, setLateFeeSettings] = useState([]); // per-property settings
  const [lateFees, setLateFees] = useState([]); // individual late fee records
  const [lateFeeFilter, setLateFeeFilter] = useState('all'); // 'all', 'unpaid', 'paid', 'waived'
  const [showLateFeeSettingsModal, setShowLateFeeSettingsModal] = useState(null); // property id or null
  const [lateFeeSettingsForm, setLateFeeSettingsForm] = useState({
    feeType: 'percentage',
    feeAmount: '5',
    gracePeriodDays: '5',
    isEnabled: true,
    stateCode: ''
  });
  const [applyingLateFees, setApplyingLateFees] = useState(false);
  const [showWaiveLateFeeModal, setShowWaiveLateFeeModal] = useState(null);
  const [waiveReason, setWaiveReason] = useState('');

  // Vendors
  const [vendors, setVendors] = useState([]);
  const [vendorPayments, setVendorPayments] = useState([]);
  const [showAddVendorModal, setShowAddVendorModal] = useState(false);
  const [showEditVendorModal, setShowEditVendorModal] = useState(null);
  const [showVendorDetail, setShowVendorDetail] = useState(null);
  const [showAddPaymentModal, setShowAddPaymentModal] = useState(null);
  const [vendorFilter, setVendorFilter] = useState('all');
  const [vendorSpecialtyFilter, setVendorSpecialtyFilter] = useState('all');
  const [vendorSearchQuery, setVendorSearchQuery] = useState('');

  // Generate unique access code
  const generateAccessCode = () => {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed confusing chars
    let code = '';
    for (let i = 0; i < 8; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  };

  // Helper function to transform database row to app format
  const transformTenant = (row) => ({
    id: row.id,
    name: row.name,
    phone: row.phone || '',
    email: row.email || '',
    property: row.property || '',
    property_id: row.property_id || null,
    unit: row.unit || '',
    rentAmount: parseFloat(row.rent_amount) || 0,
    securityDeposit: parseFloat(row.security_deposit) || 0,
    leaseStart: row.lease_start || '',
    leaseEnd: row.lease_end || '',
    status: row.status || 'prospect',
    paymentStatus: row.payment_status || 'n/a',
    paymentDate: row.payment_date || null,
    paymentLog: row.payment_log || [],
    activityLog: row.activity_log || [],
    auditLog: row.audit_log || [],
    leaseDocuments: row.lease_documents || [],
    notes: row.notes || '',
    moveInDate: row.move_in_date || '',
    moveInNotes: row.move_in_notes || '',
    moveOutDate: row.move_out_date || '',
    moveOutNotes: row.move_out_notes || '',
    depositDeductions: row.deposit_deductions || [],
    depositRefundAmount: parseFloat(row.deposit_refund_amount) || 0,
    refundStatus: row.refund_status || 'pending',
    accessCode: row.access_code || '',
    photo: row.photo || null
  });

  // Helper function to transform app format to database format
  const transformTenantForDB = (tenant) => ({
    user_id: user?.id,
    name: tenant.name,
    phone: tenant.phone || null,
    email: tenant.email || null,
    property: tenant.property || null,
    property_id: tenant.property_id || null,
    unit: tenant.unit || null,
    rent_amount: tenant.rentAmount || 0,
    security_deposit: tenant.securityDeposit || 0,
    lease_start: tenant.leaseStart || null,
    lease_end: tenant.leaseEnd || null,
    status: tenant.status || 'prospect',
    payment_status: tenant.paymentStatus || 'n/a',
    payment_date: tenant.paymentDate || null,
    payment_log: tenant.paymentLog || [],
    activity_log: tenant.activityLog || [],
    audit_log: tenant.auditLog || [],
    lease_documents: tenant.leaseDocuments || [],
    notes: tenant.notes || null,
    move_in_date: tenant.moveInDate || null,
    move_in_notes: tenant.moveInNotes || null,
    move_out_date: tenant.moveOutDate || null,
    move_out_notes: tenant.moveOutNotes || null,
    deposit_deductions: tenant.depositDeductions || [],
    deposit_refund_amount: tenant.depositRefundAmount || null,
    refund_status: tenant.refundStatus || 'pending',
    access_code: tenant.accessCode || null,
    photo: tenant.photo || null
  });

  const transformProperty = (row) => ({
    id: row.id,
    name: row.name || '',
    address: row.address,
    units: row.units || 0,
    type: row.type || '',
    occupied: row.occupied || 0,
    monthlyRevenue: parseFloat(row.monthly_revenue) || 0,
    photoUrl: row.photo_url || null,
    expenses: row.expenses || [],
    ownerName: row.owner_name || '',
    ownerEmail: row.owner_email || '',
    ownerId: row.owner_id || null
  });

  const transformPropertyForDB = (property) => ({
    user_id: user?.id,
    name: property.name || null,
    address: property.address,
    units: property.units || 0,
    type: property.type || null,
    occupied: property.occupied || 0,
    monthly_revenue: property.monthlyRevenue || 0,
    photo_url: property.photoUrl || property.photo || null,
    expenses: property.expenses || [],
    owner_name: property.ownerName || null,
    owner_email: property.ownerEmail || null,
    owner_id: property.ownerId || null
  });

  const transformMaintenanceRequest = (row) => ({
    id: row.id,
    tenantId: row.tenant_id,
    tenantName: row.tenant_name || '',
    property: row.property || '',
    issue: row.issue,
    priority: row.priority || 'medium',
    status: row.status || 'open',
    date: row.date || new Date().toISOString().split('T')[0],
    description: row.description || ''
  });

  const transformMaintenanceRequestForDB = (request) => ({
    user_id: user?.id,
    tenant_id: request.tenantId || null,
    tenant_name: request.tenantName || null,
    property: request.property || null,
    issue: request.issue,
    priority: request.priority || 'medium',
    status: request.status || 'open',
    date: request.date || new Date().toISOString().split('T')[0],
    description: request.description || null
  });

  const transformOwner = (owner) => ({
    id: owner.id,
    name: owner.name,
    email: owner.email,
    phone: owner.phone || '',
    address: owner.address || '',
    managementFeePercent: owner.management_fee_percent || owner.managementFeePercent || 10,
    portalEnabled: owner.portal_enabled || false,
    portalToken: owner.portal_token,
    lastLogin: owner.last_login,
    createdAt: owner.created_at
  });

  // Upload utility functions
  // Upload photo to Supabase storage
  const uploadPhoto = async (file, recordType, recordId) => {
    if (!user) throw new Error('User not logged in');
    
    const fileExt = file.name.split('.').pop();
    const fileName = `${recordType}/${recordId}/photo_${Date.now()}.${fileExt}`;
    
    const { data, error } = await supabase.storage
      .from('photos')
      .upload(fileName, file, { upsert: true });
    
    if (error) throw error;
    
    const { data: urlData } = supabase.storage
      .from('photos')
      .getPublicUrl(fileName);
    
    return urlData.publicUrl;
  };

  // Upload document
  const uploadDocument = async (file, recordType, recordId, category = 'general') => {
    if (!user) throw new Error('User not logged in');
    
    const fileName = `${recordType}/${recordId}/${Date.now()}_${file.name}`;
    
    const { error } = await supabase.storage
      .from('documents')
      .upload(fileName, file);
    
    if (error) throw error;
    
    const { data: fileRecord } = await supabase
      .from('files')
      .insert({
        user_id: user.id,
        record_type: recordType,
        record_id: String(recordId),
        file_name: file.name,
        file_type: file.type,
        file_size: file.size,
        storage_path: fileName,
        category
      })
      .select()
      .single();
    
    return fileRecord;
  };

  // Load files for a record
  const loadFilesForRecord = async (recordType, recordId) => {
    if (!user) return [];
    
    try {
      const { data } = await supabase
        .from('files')
        .select('*')
        .eq('record_type', recordType)
        .eq('record_id', String(recordId))
        .order('uploaded_at', { ascending: false });
      return data || [];
    } catch (error) {
      console.error('Error loading files:', error);
      return [];
    }
  };

  // Get download URL
  const getDocumentUrl = async (storagePath) => {
    try {
      const { data } = await supabase.storage
        .from('documents')
        .createSignedUrl(storagePath, 3600);
      return data?.signedUrl;
    } catch (error) {
      console.error('Error getting document URL:', error);
      throw error;
    }
  };

  // Delete file
  const deleteFile = async (fileId, storagePath) => {
    try {
      await supabase.storage.from('documents').remove([storagePath]);
      await supabase.from('files').delete().eq('id', fileId);
    } catch (error) {
      console.error('Error deleting file:', error);
      throw error;
    }
  };

  // Load Twilio settings
  const loadTwilioSettings = async () => {
    if (!user || !user.id) {
      // User not loaded yet, don't try to load settings
      return;
    }
    
    try {
      const { data, error } = await supabase
        .from('settings')
        .select('twilio_account_sid, twilio_auth_token, twilio_phone_number')
        .eq('user_id', user.id)
        .maybeSingle(); // Use maybeSingle instead of single to avoid errors when no row exists

      if (error) {
        // Only log if it's not a "no rows" error
        if (error.code !== 'PGRST116') {
          console.error('Error loading Twilio settings:', error);
        }
        return;
      }

      if (data) {
        setTwilioSettings({
          accountSid: data.twilio_account_sid || '',
          authToken: data.twilio_auth_token || '',
          phoneNumber: data.twilio_phone_number || ''
        });
      }
    } catch (error) {
      console.error('Error loading Twilio settings:', error);
      // Don't throw - just log the error, settings page should still work
      // This prevents the error from bubbling up and causing logout
    }
  };

  // Save Twilio settings
  const saveTwilioSettings = async () => {
    if (!user) return;
    
    setTwilioSettingsLoading(true);
    try {
      const { error } = await supabase
        .from('settings')
        .upsert({
          user_id: user.id,
          twilio_account_sid: twilioSettings.accountSid,
          twilio_auth_token: twilioSettings.authToken,
          twilio_phone_number: twilioSettings.phoneNumber
        }, {
          onConflict: 'user_id'
        });

      if (error) throw error;
      alert('Twilio settings saved successfully!');
    } catch (error) {
      console.error('Error saving Twilio settings:', error);
      alert('Error saving Twilio settings. Please make sure the settings table exists.');
    } finally {
      setTwilioSettingsLoading(false);
    }
  };

  // Send test SMS
  const sendTestSMS = async () => {
    if (!testSmsPhone || !twilioSettings.accountSid || !twilioSettings.authToken || !twilioSettings.phoneNumber) {
      alert('Please fill in all Twilio settings and a test phone number');
      return;
    }

    setTestSmsSending(true);
    try {
      const { data, error } = await supabase.functions.invoke('send-sms', {
        body: {
          to: testSmsPhone,
          message: 'This is a test message from Propli. SMS notifications are working!',
          accountSid: twilioSettings.accountSid,
          authToken: twilioSettings.authToken,
          fromNumber: twilioSettings.phoneNumber
        }
      });

      if (error) throw error;
      
      if (data.success) {
        alert('Test SMS sent successfully!');
        setTestSmsPhone('');
      } else {
        alert(`Error sending test SMS: ${data.error || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('Error sending test SMS:', error);
      alert('Error sending test SMS. Please check your Twilio credentials and try again.');
    } finally {
      setTestSmsSending(false);
    }
  };

  // Send SMS reminder to tenant
  const sendSMSReminder = async (tenant) => {
    if (!tenant.phone) {
      alert('Tenant does not have a phone number on file');
      return;
    }

    if (!twilioSettings.accountSid || !twilioSettings.authToken || !twilioSettings.phoneNumber) {
      alert('Please configure Twilio settings in Settings page first');
      return;
    }

    setSmsSending({ ...smsSending, [tenant.id]: true });
    
    try {
      const daysLate = tenant.daysLate || 0;
      const message = `Hi ${tenant.name}, this is a reminder that your rent of $${tenant.rentAmount.toLocaleString()} is past due. Please submit payment at your earliest convenience. Questions? Reply to this message. - Property Manager`;

      const { data, error } = await supabase.functions.invoke('send-sms', {
        body: {
          to: tenant.phone.replace(/\D/g, ''), // Remove non-digits
          message: message,
          accountSid: twilioSettings.accountSid,
          authToken: twilioSettings.authToken,
          fromNumber: twilioSettings.phoneNumber,
          tenantId: tenant.id,
          userId: user.id
        }
      });

      if (error) throw error;

      if (data.success) {
        alert('SMS reminder sent successfully!');
      } else {
        alert(`Error sending SMS: ${data.error || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('Error sending SMS reminder:', error);
      alert('Error sending SMS reminder. Please check your Twilio settings and try again.');
    } finally {
      setSmsSending({ ...smsSending, [tenant.id]: false });
    }
  };

  // Load late fee settings
  const loadLateFeeSettings = async () => {
    if (!user) return;
    try {
      const { data, error } = await supabase
        .from('late_fee_settings')
        .select('*')
        .eq('user_id', user.id);
      
      if (error) {
        console.error('Error loading late fee settings:', error);
        return;
      }
      
      setLateFeeSettings(data || []);
    } catch (error) {
      console.error('Error loading late fee settings:', error);
    }
  };

  // Load late fees
  const loadLateFees = async () => {
    if (!user) return;
    try {
      const { data, error } = await supabase
        .from('late_fees')
        .select('*')
        .eq('user_id', user.id)
        .order('applied_date', { ascending: false });
      
      if (error) {
        console.error('Error loading late fees:', error);
        return;
      }
      
      setLateFees(data || []);
    } catch (error) {
      console.error('Error loading late fees:', error);
    }
  };

  // Save late fee settings for a property
  const saveLateFeeSettings = async (propertyId) => {
    if (!user) return;
    
    try {
      const settingsData = {
        user_id: user.id,
        property_id: propertyId,
        fee_type: lateFeeSettingsForm.feeType,
        fee_amount: parseFloat(lateFeeSettingsForm.feeAmount) || 5,
        grace_period_days: parseInt(lateFeeSettingsForm.gracePeriodDays) || 5,
        is_enabled: lateFeeSettingsForm.isEnabled,
        state_code: lateFeeSettingsForm.stateCode || null
      };

      const { error } = await supabase
        .from('late_fee_settings')
        .upsert(settingsData, {
          onConflict: 'user_id,property_id'
        });

      if (error) throw error;
      
      showToast('Late fee settings saved', 'success');
      await loadLateFeeSettings();
      setShowLateFeeSettingsModal(null);
    } catch (error) {
      console.error('Error saving late fee settings:', error);
      showToast('Error saving late fee settings', 'error');
    }
  };

  // Get late fee settings for a property
  const getLateFeeSettingsForProperty = (propertyId) => {
    return lateFeeSettings.find(s => s.property_id === propertyId) || null;
  };

  // Calculate late fee amount
  const calculateLateFeeAmount = (rentAmount, settings) => {
    if (!settings) return 0;
    if (settings.fee_type === 'percentage') {
      return Math.round((rentAmount * settings.fee_amount / 100) * 100) / 100;
    }
    return settings.fee_amount;
  };

  // Apply late fees to overdue tenants
  const applyLateFees = async () => {
    if (!user) return;
    
    setApplyingLateFees(true);
    try {
      // Reload latest late fees to prevent duplicates
      const { data: currentLateFees } = await supabase
        .from('late_fees')
        .select('*')
        .eq('user_id', user.id);
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Get all current tenants with late payment status
      const lateTenants = tenants.filter(t => 
        t.status === 'current' && 
        t.paymentStatus === 'late' &&
        t.rentAmount > 0
      );

      let appliedCount = 0;
      
      for (const tenant of lateTenants) {
        // Find property for this tenant
        const property = properties.find(p => tenant.property?.includes(p.address));
        if (!property) continue;
        
        // Get late fee settings for this property
        const settings = getLateFeeSettingsForProperty(property.id);
        if (!settings || !settings.is_enabled) continue;
        
        // Calculate rent due date (1st of current month if no payment date)
        const rentDueDate = new Date(today.getFullYear(), today.getMonth(), 1);
        
        // Check if grace period has passed
        const gracePeriodEnd = new Date(rentDueDate);
        gracePeriodEnd.setDate(gracePeriodEnd.getDate() + settings.grace_period_days);
        
        if (today <= gracePeriodEnd) continue; // Still within grace period
        
        // Check if late fee already exists for this tenant and rent period (use fresh data)
        const existingFee = (currentLateFees || []).find(f => 
          String(f.tenant_id) === String(tenant.id) && 
          new Date(f.rent_due_date).getMonth() === rentDueDate.getMonth() &&
          new Date(f.rent_due_date).getFullYear() === rentDueDate.getFullYear()
        );
        
        if (existingFee) {
          console.log('Skipping tenant - fee already exists:', tenant.name);
          continue; // Already applied
        }
        
        // Calculate fee amount
        const feeAmount = calculateLateFeeAmount(tenant.rentAmount, settings);
        
        // Create late fee record
        const lateFeeData = {
          user_id: user.id,
          tenant_id: tenant.id,
          property_id: property.id,
          fee_amount: feeAmount,
          fee_type: settings.fee_type,
          fee_percentage: settings.fee_type === 'percentage' ? settings.fee_amount : null,
          rent_amount: tenant.rentAmount,
          grace_period_days: settings.grace_period_days,
          rent_due_date: rentDueDate.toISOString().split('T')[0],
          applied_date: today.toISOString().split('T')[0],
          status: 'unpaid'
        };
        
        const { error } = await supabase
          .from('late_fees')
          .insert(lateFeeData);
        
        if (!error) {
          appliedCount++;
        }
      }
      
      await loadLateFees();
      
      if (appliedCount > 0) {
        showToast(`Applied ${appliedCount} late fee(s)`, 'success');
      } else {
        showToast('No new late fees to apply', 'info');
      }
    } catch (error) {
      console.error('Error applying late fees:', error);
      showToast('Error applying late fees', 'error');
    } finally {
      setApplyingLateFees(false);
    }
  };

  // Mark late fee as paid
  const markLateFeePaid = async (feeId) => {
    if (!user) return;
    
    try {
      const { error } = await supabase
        .from('late_fees')
        .update({ 
          status: 'paid',
          paid_date: new Date().toISOString().split('T')[0]
        })
        .eq('id', feeId);
      
      if (error) throw error;
      
      await loadLateFees();
      showToast('Late fee marked as paid', 'success');
    } catch (error) {
      console.error('Error marking late fee as paid:', error);
      showToast('Error updating late fee', 'error');
    }
  };

  // Waive late fee
  const waiveLateFee = async (feeId) => {
    if (!user || !waiveReason.trim()) {
      showToast('Please provide a reason for waiving', 'error');
      return;
    }
    
    try {
      const { error } = await supabase
        .from('late_fees')
        .update({ 
          status: 'waived',
          waived_at: new Date().toISOString(),
          waived_reason: waiveReason.trim()
        })
        .eq('id', feeId);
      
      if (error) throw error;
      
      await loadLateFees();
      setShowWaiveLateFeeModal(null);
      setWaiveReason('');
      showToast('Late fee waived', 'success');
    } catch (error) {
      console.error('Error waiving late fee:', error);
      showToast('Error waiving late fee', 'error');
    }
  };

  // Delete late fee
  const deleteLateFee = async (feeId) => {
    if (!user) return;
    if (!confirm('Are you sure you want to delete this late fee?')) return;
    
    try {
      const { error } = await supabase
        .from('late_fees')
        .delete()
        .eq('id', feeId);
      
      if (error) throw error;
      
      await loadLateFees();
      showToast('Late fee deleted', 'success');
    } catch (error) {
      console.error('Error deleting late fee:', error);
      showToast('Error deleting late fee', 'error');
    }
  };

  // Get filtered late fees
  const getFilteredLateFees = () => {
    if (lateFeeFilter === 'all') return lateFees;
    return lateFees.filter(f => f.status === lateFeeFilter);
  };

  // Get late fee totals
  const getLateFeeTotals = () => {
    const unpaid = lateFees.filter(f => f.status === 'unpaid').reduce((sum, f) => sum + parseFloat(f.fee_amount), 0);
    const paid = lateFees.filter(f => f.status === 'paid').reduce((sum, f) => sum + parseFloat(f.fee_amount), 0);
    const waived = lateFees.filter(f => f.status === 'waived').reduce((sum, f) => sum + parseFloat(f.fee_amount), 0);
    return { unpaid, paid, waived, total: unpaid + paid };
  };

  // State compliance warnings
  const getStateComplianceWarning = (stateCode) => {
    const warnings = {
      'CA': 'California courts have ruled fees must reflect actual damages. Consider conservative fee amounts.',
      'ME': 'Maine caps late fees at $25 or 4% of monthly rent, whichever is greater.',
      'DC': 'DC caps late fees at 5% of monthly rent with mandatory 5-day grace period.',
      'MD': 'Maryland caps late fees at 5% of monthly rent.',
      'NC': 'North Carolina caps late fees at $15 or 5% of monthly rent.',
      'TN': 'Tennessee requires 5-day grace period before late fees can be charged.',
      'TX': 'Texas requires late fees to be reasonable. 10-12% is generally considered acceptable.',
      'OR': 'Oregon caps late fees at 5% for first late payment and 5% per additional day, max 6 days.'
    };
    return warnings[stateCode] || null;
  };

  // Load data from Supabase
  const loadData = async (currentUser = null) => {
    const userToUse = currentUser || user;
    if (!userToUse) {
      setLoading(false);
      return;
    }
    
    setLoading(true);
    try {
      // Load tenants (RLS will automatically filter by user_id)
      const { data: tenantsData, error: tenantsError } = await supabase
        .from('tenants')
        .select('*')
        .order('created_at', { ascending: false });

      if (tenantsError) throw tenantsError;
      setTenants((tenantsData || []).map(transformTenant));

      // Load properties (RLS will automatically filter by user_id)
      const { data: propertiesData, error: propertiesError } = await supabase
        .from('properties')
        .select('*')
        .order('created_at', { ascending: false });

      if (propertiesError) throw propertiesError;
      setProperties((propertiesData || []).map(transformProperty));

      // Load maintenance requests (RLS will automatically filter by user_id)
      const { data: maintenanceData, error: maintenanceError } = await supabase
        .from('maintenance_requests')
        .select('*')
        .order('created_at', { ascending: false });

      if (maintenanceError) throw maintenanceError;
      setMaintenanceRequests((maintenanceData || []).map(transformMaintenanceRequest));

      // Load tags
      await loadTags(userToUse);

      // Load vendors
      await loadVendors();

      // Load vendor payments
      await loadVendorPayments();

      // Load owners
      try {
        const { data: ownersData, error: ownersError } = await supabase
          .from('owners')
          .select('*')
          .order('created_at', { ascending: false });

        if (ownersError) {
          // If table doesn't exist, don't error - just return empty array
          if (ownersError.code === '42P01') {
            setOwners([]);
          } else {
            throw ownersError;
          }
        } else {
          const transformedOwners = (ownersData || []).map(transformOwner);
          setOwners(transformedOwners);
          
          // Seed demo owners if none exist - COMMENTED OUT: function not implemented yet
          // if (transformedOwners.length === 0) {
          //   await seedDemoOwners(userToUse);
          //   // Reload owners after seeding
          //   const { data: reloadedOwners } = await supabase
          //     .from('owners')
          //     .select('*')
          //     .order('created_at', { ascending: false });
          //   if (reloadedOwners) {
          //     setOwners(reloadedOwners.map(transformOwner));
          //   }
          // }
        }
      } catch (error) {
        console.error('Error loading owners:', error);
        setOwners([]);
      }
    } catch (error) {
      console.error('Error loading data:', error);
      alert('Error loading data. Please check your Supabase connection.');
    } finally {
      setLoading(false);
    }
  };

  // Load tags from Supabase
  const loadTags = async (currentUser = null) => {
    const userToUse = currentUser || user;
    if (!userToUse) return;

    try {
      const { data: tagsData, error: tagsError } = await supabase
        .from('tags')
        .select('*')
        .order('created_at', { ascending: false });

      if (tagsError) {
        // If table doesn't exist or any other error, fail silently
        console.error('Error loading tags:', tagsError);
        setTags([]);
        setRecordTags([]);
        setTagHistory([]);
        return;
      }
      
      // If no tags exist, seed default tags
      if (!tagsData || tagsData.length === 0) {
        try {
          await seedDefaultTags(userToUse);
          // Reload tags after seeding
          const { data: reloadedTags, error: reloadError } = await supabase
            .from('tags')
            .select('*')
            .order('created_at', { ascending: false });
          if (!reloadError && reloadedTags) {
            setTags(reloadedTags);
          } else if (reloadError) {
            console.error('Error reloading tags after seeding:', reloadError);
            setTags([]);
          }
        } catch (seedError) {
          console.error('Error seeding default tags:', seedError);
          setTags([]);
        }
      } else {
        setTags(tagsData || []);
      }

      // Load record tags (tag assignments)
      try {
        const { data: recordTagsData, error: recordTagsError } = await supabase
          .from('record_tags')
          .select('*');

        if (recordTagsError) {
          console.error('Error loading record tags:', recordTagsError);
          setRecordTags([]);
        } else {
          setRecordTags(recordTagsData || []);
        }
      } catch (error) {
        console.error('Error loading record tags:', error);
        setRecordTags([]);
      }

      // Load tag history - COMMENTED OUT: table doesn't exist yet
      // try {
      //   const { data: tagHistoryData, error: tagHistoryError } = await supabase
      //     .from('tag_history')
      //     .select('*')
      //     .order('action_at', { ascending: false });

      //   if (tagHistoryError) {
      //     console.error('Error loading tag history:', tagHistoryError);
      //     setTagHistory([]);
      //   } else {
      //     setTagHistory(tagHistoryData || []);
      //   }
      // } catch (error) {
      //   console.error('Error loading tag history:', error);
      //   setTagHistory([]);
      // }
      setTagHistory([]); // Set empty for now
    } catch (error) {
      console.error('Error loading tags:', error);
      // Fail silently - don't block app load
      setTags([]);
      setRecordTags([]);
      setTagHistory([]);
    }
  };

  // Get tag history for a specific record - COMMENTED OUT: table doesn't exist yet
  const getTagHistoryForRecord = (recordType, recordId) => {
    // return tagHistory
    //   .filter(th => th.record_type === recordType && th.record_id === recordId)
    //   .sort((a, b) => new Date(b.action_at) - new Date(a.action_at));
    return []; // Return empty array for now
  };

  // Get tag analysis data for Reports page
  const getTagAnalysisData = (dateRange = 'all') => {
    const now = new Date();
    let startDate = null;
    
    if (dateRange === '30') {
      startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    } else if (dateRange === '90') {
      startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
    } else if (dateRange === '12months') {
      startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
    }
    
    // Filter record tags by date range if specified
    let filteredRecordTags = recordTags;
    if (startDate) {
      filteredRecordTags = recordTags.filter(rt => {
        const addedDate = new Date(rt.added_at);
        return addedDate >= startDate;
      });
    }
    
    // Group by tag
    const tagStats = {};
    
    tags.forEach(tag => {
      const tagRecords = filteredRecordTags.filter(rt => rt.tag_id === tag.id);
      const tenantCount = tagRecords.filter(rt => rt.record_type === 'tenant').length;
      const propertyCount = tagRecords.filter(rt => rt.record_type === 'property').length;
      const maintenanceCount = tagRecords.filter(rt => rt.record_type === 'maintenance').length;
      
      // Calculate total rent affected (for tenant tags)
      let totalRent = 0;
      if (tenantCount > 0) {
        tagRecords
          .filter(rt => rt.record_type === 'tenant')
          .forEach(rt => {
            const tenant = tenants.find(t => t.id === rt.record_id);
            if (tenant && tenant.rentAmount) {
              totalRent += tenant.rentAmount;
            }
          });
      }
      
      // For maintenance tags, calculate total cost
      let totalCost = 0;
      if (maintenanceCount > 0) {
        // This would require maintenance cost data - placeholder for now
        totalCost = 0;
      }
      
      if (tagRecords.length > 0) {
        tagStats[tag.id] = {
          tag,
          totalRecords: tagRecords.length,
          tenants: tenantCount,
          properties: propertyCount,
          maintenance: maintenanceCount,
          totalRent: totalRent,
          totalCost: totalCost
        };
      }
    });
    
    // Convert to array and sort by total records
    return Object.values(tagStats).sort((a, b) => b.totalRecords - a.totalRecords);
  };

  // Get tag trend data for a specific tag
  const getTagTrendData = (tagId, dateRange = '12months') => {
    const now = new Date();
    let startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
    
    if (dateRange === '30') {
      startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    } else if (dateRange === '90') {
      startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
    }
    
    // Get tag history for this tag within date range
    const tagHistoryFiltered = tagHistory
      .filter(th => th.tag_id === tagId && th.action === 'added' && new Date(th.action_at) >= startDate)
      .sort((a, b) => new Date(a.action_at) - new Date(b.action_at));
    
    // Group by month
    const monthlyData = {};
    tagHistoryFiltered.forEach(th => {
      const date = new Date(th.action_at);
      const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      if (!monthlyData[monthKey]) {
        monthlyData[monthKey] = 0;
      }
      monthlyData[monthKey]++;
    });
    
    // Convert to array format for chart
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return Object.keys(monthlyData)
      .sort()
      .map(monthKey => {
        const [year, month] = monthKey.split('-');
        return {
          month: monthNames[parseInt(month) - 1],
          count: monthlyData[monthKey]
        };
      });
  };

  // Seed default tags
  const seedDefaultTags = async (currentUser = null) => {
    const userToUse = currentUser || user;
    if (!userToUse) return;

    const defaultTags = [
      { name: 'late_payment', color: 'red' },
      { name: 'payment_plan', color: 'yellow' },
      { name: 'roof_repair', color: 'orange' },
      { name: 'hvac_issue', color: 'orange' },
      { name: 'plumbing', color: 'blue' },
      { name: 'pest_control', color: 'purple' },
      { name: 'lease_violation', color: 'red' },
      { name: 'noise_complaint', color: 'yellow' },
      { name: 'section_8', color: 'teal' },
      { name: 'month_to_month', color: 'gray' },
      { name: 'high_priority', color: 'red' },
      { name: 'resolved', color: 'green' }
    ];

    try {
      const tagsToInsert = defaultTags.map(tag => ({
        user_id: userToUse.id,
        name: tag.name,
        color: tag.color
      }));

      const { error } = await supabase
        .from('tags')
        .insert(tagsToInsert);

      if (error) throw error;
    } catch (error) {
      console.error('Error seeding default tags:', error);
    }
  };

  // Create a new tag
  const createTag = async (name, color) => {
    console.log('createTag called:', { name, color, userId: user?.id });
    
    if (!user || !name || !name.trim()) {
      console.error('Cannot create tag: user not logged in or name is empty', { user: !!user, name });
      return null;
    }

    // Normalize name: lowercase, replace spaces with underscores
    const normalizedName = name.trim().toLowerCase().replace(/\s+/g, '_');
    console.log('Normalized tag name:', normalizedName);

    try {
      const insertData = {
        user_id: user.id,
        name: normalizedName,
        color: color || 'blue'
      };
      console.log('Inserting tag:', insertData);
      
      const { data, error } = await supabase
        .from('tags')
        .insert([insertData])
        .select()
        .single();

      if (error) {
        console.error('Error creating tag:', error);
        if (error.code === '23505') { // Unique constraint violation
          console.error('A tag with this name already exists');
        }
        return null;
      }
      
      console.log('Tag created successfully:', data);
      setTags([...tags, data]);
      return data;
    } catch (error) {
      console.error('Error creating tag (catch):', error);
      return null;
    }
  };

  // Delete a tag
  const deleteTag = async (tagId) => {
    if (!user || !tagId) return;

    try {
      const { error } = await supabase
        .from('tags')
        .delete()
        .eq('id', tagId)
        .eq('user_id', user.id);

      if (error) throw error;
      setTags(tags.filter(t => t.id !== tagId));
      
      // Also delete all record_tags associated with this tag
      await supabase
        .from('record_tags')
        .delete()
        .eq('tag_id', tagId);
    } catch (error) {
      console.error('Error deleting tag:', error);
      alert('Error deleting tag: ' + error.message);
      throw error;
    }
  };

  // Get record count for a tag
  const getTagRecordCount = (tagId) => {
    return recordTags.filter(rt => rt.tag_id === tagId).length;
  };

  // Get tags for a specific record (deduplicated by tag_id)
  const getTagsForRecord = (recordType, recordId) => {
    const tagIds = [...new Set(
      recordTags
        .filter(rt => rt.record_type === recordType && String(rt.record_id) === String(recordId))
        .map(rt => rt.tag_id)
    )];
    return tagIds.map(id => tags.find(t => t.id === id)).filter(Boolean);
  };

  // Get tag color styles
  const getTagColor = (color) => {
    const colorMap = {
      blue: { bg: '#e8f0fe', text: '#1a73e8' },
      green: { bg: '#e6f4ea', text: '#1e8e3e' },
      yellow: { bg: '#fef7e0', text: '#f9ab00' },
      orange: { bg: '#feefe3', text: '#e8710a' },
      red: { bg: '#fce8e6', text: '#d93025' },
      purple: { bg: '#f3e8fd', text: '#9334e6' },
      teal: { bg: '#e4f7fb', text: '#0891b2' },
      gray: { bg: '#f1f3f4', text: '#5f6368' }
    };
    return colorMap[color] || colorMap.blue;
  };

  // Get filtered tenants for the modern Tenants page
  const getFilteredTenants = () => {
    let filtered = tenants;
    
    // Apply status filter
    if (tenantFilter === 'current') {
      filtered = filtered.filter(t => t.status === 'Current' || t.status === 'current');
    } else if (tenantFilter === 'late') {
      filtered = filtered.filter(t => (t.status === 'Current' || t.status === 'current') && t.paymentStatus === 'late');
    } else if (tenantFilter === 'prospects') {
      filtered = filtered.filter(t => t.status === 'Prospect' || t.status === 'prospect');
    } else if (tenantFilter === 'expiring') {
      const in90Days = new Date(Date.now() + 90 * 24 * 60 * 60 * 1000);
      filtered = filtered.filter(t => {
        const leaseEnd = t.leaseEnd || t.lease_end;
        return leaseEnd && new Date(leaseEnd) <= in90Days && new Date(leaseEnd) >= new Date();
      });
    }
    
    // Apply search
    if (tenantSearchQuery) {
      const term = tenantSearchQuery.toLowerCase();
      filtered = filtered.filter(t => 
        t.name?.toLowerCase().includes(term) ||
        t.email?.toLowerCase().includes(term) ||
        t.phone?.includes(term)
      );
    }
    
    return filtered;
  };

  // Get tags for a specific tenant
  const getTenantTags = (tenantId) => {
    const tagIds = recordTags
      .filter(rt => rt.record_type === 'tenant' && String(rt.record_id) === String(tenantId))
      .map(rt => rt.tag_id);
    return tags.filter(t => tagIds.includes(t.id));
  };

  // MaintenanceCard component for card grid layout
  const MaintenanceCard = ({ request, onClick }) => {
    const priority = (request.priority || 'medium').toLowerCase();
    const status = (request.status || 'open').toLowerCase();
    const statusDisplay = getMaintenanceStatusDisplay(request.status);
    const unit = extractUnitNumber(request.property);
    const propertyName = request.property ? request.property.replace(/\s*(?:Unit|Apt|Apartment|#)\s*[A-Z0-9]+/i, '').trim() : request.property;
    const isCompleted = status === 'closed' || status === 'completed';
    const isActive = status === 'in_progress' || status === 'in progress';
    
    // Get priority border color (subtle left border)
    const getPriorityBorder = () => {
      if (priority === 'urgent') return '#ef4444';
      if (priority === 'high') return '#f97316';
      if (priority === 'medium') return '#eab308';
      return '#94a3b8';
    };
    
    // Get status text color
    const getStatusColor = () => {
      if (isCompleted) return '#16a34a';
      if (isActive) return '#3b82f6';
      return '#64748b';
    };
    
    const createdDate = request.date || request.created_at;
    
    return (
      <div 
        onClick={onClick}
        style={{
          background: 'white',
          padding: '16px 20px',
          cursor: 'pointer',
          transition: 'background 0.15s ease',
          borderBottom: '1px solid #e2e8f0',
          borderLeft: `3px solid ${getPriorityBorder()}`,
          display: 'flex',
          alignItems: 'center',
          gap: 16,
          opacity: isCompleted ? 0.6 : 1
        }}
        onMouseEnter={(e) => {
          e.currentTarget.style.background = '#f8fafc';
        }}
        onMouseLeave={(e) => {
          e.currentTarget.style.background = 'white';
        }}
      >
        {/* Main content */}
        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>
            <span style={{
              fontSize: 14,
              fontWeight: 500,
              color: isCompleted ? '#64748b' : '#0f172a',
              textDecoration: isCompleted ? 'line-through' : 'none',
              whiteSpace: 'nowrap',
              overflow: 'hidden',
              textOverflow: 'ellipsis'
            }}>
              {request.issue}
            </span>
            {request.source === 'sms' && (
              <span style={{
                fontSize: 10,
                padding: '2px 6px',
                borderRadius: 4,
                background: '#f1f5f9',
                color: '#64748b',
                fontWeight: 500,
                flexShrink: 0
              }}>
                SMS
              </span>
            )}
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 16, fontSize: 13, color: '#64748b' }}>
            <span>{propertyName && unit ? `${propertyName}, ${unit}` : propertyName || 'No property'}</span>
            <span style={{ color: '#cbd5e1' }}>Â·</span>
            <span>{request.tenantName || request.tenant_name || 'Unknown'}</span>
          </div>
        </div>
        
        {/* Date */}
        <div style={{ fontSize: 13, color: '#94a3b8', width: 60, textAlign: 'right', flexShrink: 0 }}>
          {createdDate ? new Date(createdDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : ''}
        </div>
        
        {/* Status */}
        <div style={{ 
          fontSize: 12, 
          fontWeight: 500, 
          color: getStatusColor(),
          width: 80,
          textAlign: 'right',
          flexShrink: 0
        }}>
          {statusDisplay}
        </div>
        
        {/* Arrow */}
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2" style={{ flexShrink: 0 }}>
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </div>
    );
  };

  // TenantKanbanCard component for improved Kanban view
  const TenantKanbanCard = ({ tenant, status, onClick }) => {
    const [isHovered, setIsHovered] = useState(false);
    
    // Get property info - look up by property_id first, then fallback to address match
    const property = properties.find(p => {
      if (tenant.property_id && p.id === tenant.property_id) return true;
      if (tenant.property && p.address && tenant.property.includes(p.address)) return true;
      return false;
    });
    
    // Format property and unit display
    const getPropertyDisplay = () => {
      if (!property && !tenant.unit) {
        return <span style={{ fontStyle: 'italic', color: '#94a3b8' }}>No Property</span>;
      }
      
      const propertyName = property?.name || property?.address?.split(',')[0] || '';
      const unit = tenant.unit || '';
      
      if (propertyName && unit) {
        return `${propertyName} - ${unit}`;
      } else if (unit) {
        return `Unit ${unit}`;
      } else if (propertyName) {
        return propertyName;
      }
      
      return <span style={{ fontStyle: 'italic', color: '#94a3b8' }}>No Property</span>;
    };
    
    // Get balance
    const balance = parseFloat(tenant.balance) || 0;
    
    return (
      <div
        onClick={onClick}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
        style={{
          background: '#ffffff',
          borderRadius: 8,
          padding: 14,
          cursor: 'pointer',
          border: '1px solid #e2e8f0',
          boxShadow: isHovered ? '0 4px 12px rgba(0,0,0,0.08)' : 'none',
          transform: isHovered ? 'translateY(-1px)' : 'none',
          transition: 'all 0.15s ease',
          position: 'relative'
        }}
      >
        {/* Main Content */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 10 }}>
          <div style={{
            width: 36,
            height: 36,
            borderRadius: 8,
            background: '#f1f5f9',
            color: '#64748b',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontWeight: 600,
            fontSize: 12
          }}>
            {tenant.name?.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase()}
          </div>
          <div style={{ flex: 1, minWidth: 0 }}>
            <p style={{ fontWeight: 500, fontSize: 14, margin: 0, color: '#0f172a', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
              {tenant.name}
            </p>
            <p style={{ fontSize: 12, color: '#64748b', margin: '2px 0 0', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
              {getPropertyDisplay()}
            </p>
          </div>
        </div>
        
        {/* Bottom Row */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <span style={{ fontSize: 14, fontWeight: 600, color: '#0f172a' }}>
            ${parseFloat(tenant.rentAmount || tenant.rent || 0).toLocaleString()}/mo
          </span>
          
          {status === 'late' && (
            <span style={{ 
              fontSize: 11, 
              fontWeight: 500, 
              color: '#dc2626',
              background: '#fef2f2',
              padding: '3px 8px',
              borderRadius: 4
            }}>
              Overdue
            </span>
          )}
          
          {status === 'current' && (tenant.leaseEnd || tenant.lease_end) && (
            <span style={{ fontSize: 11, color: '#64748b' }}>
              Ends {new Date(tenant.leaseEnd || tenant.lease_end).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
            </span>
          )}
          
          {status === 'prospect' && (
            <span style={{ 
              fontSize: 11, 
              fontWeight: 500,
              color: '#3b82f6',
              background: '#eff6ff',
              padding: '3px 8px',
              borderRadius: 4
            }}>
              Lead
            </span>
          )}
        </div>
        
        {/* Hover Actions */}
        {isHovered && (
          <div 
            style={{
              display: 'flex',
              justifyContent: 'center',
              gap: 8,
              marginTop: 10,
              paddingTop: 10,
              borderTop: '1px solid #e2e8f0'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <button
              onClick={(e) => { 
                e.stopPropagation(); 
                if (tenant.email) window.location.href = `mailto:${tenant.email}`; 
              }}
              style={{
                background: 'transparent',
                border: '1px solid #e2e8f0',
                borderRadius: 6,
                padding: '6px 12px',
                fontSize: 11,
                color: '#64748b',
                cursor: 'pointer',
                transition: 'all 0.15s ease'
              }}
              onMouseEnter={(e) => { e.currentTarget.style.borderColor = '#94a3b8'; e.currentTarget.style.color = '#0f172a'; }}
              onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#e2e8f0'; e.currentTarget.style.color = '#64748b'; }}
            >
              Email
            </button>
            {status === 'late' && tenant.phone && (
              <button
                onClick={(e) => { 
                  e.stopPropagation(); 
                  sendSMSReminder(tenant);
                }}
                style={{
                  background: '#3b82f6',
                  border: 'none',
                  borderRadius: 6,
                  padding: '6px 12px',
                  fontSize: 11,
                  color: 'white',
                  cursor: 'pointer',
                  fontWeight: 500
                }}
              >
                Remind
              </button>
            )}
          </div>
        )}
      </div>
    );
  };
  // Add tag to a record
  const addTagToRecord = async (tagId, recordType, recordId) => {
    console.log('Adding tag:', { tagId, recordType, recordId, userId: user?.id });
    
    if (!user) {
      console.error('Cannot add tag: user not logged in');
      return;
    }

    // Check if tag is already applied (using String comparison for record_id)
    const existing = recordTags.find(
      rt => rt.tag_id === tagId && 
            rt.record_type === recordType && 
            String(rt.record_id) === String(recordId)
    );
    if (existing) {
      console.log('Tag already applied, skipping');
      return; // Tag already applied
    }

    try {
      const tag = tags.find(t => t.id === tagId);
      const tagName = tag ? tag.name : '';

      const insertData = {
        tag_id: tagId,
        record_type: recordType,
        record_id: recordId, // UUID type, no conversion needed
        added_by: user.id
      };
      
      console.log('Inserting record tag:', insertData);

      // Insert record tag
      const { data, error } = await supabase
        .from('record_tags')
        .insert([insertData])
        .select()
        .single();

      if (error) {
        console.error('Error inserting record tag:', error);
        throw error;
      }
      
      console.log('Record tag inserted successfully:', data);
      
      // Reload record tags from database to ensure consistency and avoid duplicates
      try {
        const { data: allRecordTags, error: reloadError } = await supabase
          .from('record_tags')
          .select('*');
        if (!reloadError && allRecordTags) {
          setRecordTags(allRecordTags);
          console.log('Record tags reloaded:', allRecordTags.length, 'total tags');
        } else if (reloadError) {
          console.error('Error reloading record tags:', reloadError);
          // Fallback: update state with new tag if reload fails
          setRecordTags([...recordTags, data]);
        }
      } catch (reloadErr) {
        console.error('Error reloading record tags:', reloadErr);
        // Fallback: update state with new tag if reload fails
        setRecordTags([...recordTags, data]);
      }

      // Log to tag history - COMMENTED OUT: table doesn't exist yet
      // try {
      //   await supabase
      //     .from('tag_history')
      //     .insert([{
      //       tag_id: tagId,
      //       tag_name: tagName,
      //       record_type: recordType,
      //       record_id: recordId,
      //       action: 'added',
      //       action_by: user.id,
      //       user_id: user.id
      //     }]);
      //   console.log('Tag history logged successfully');
      // } catch (historyError) {
      //   // Don't fail if history logging fails
      //   console.error('Error logging tag history:', historyError);
      // }
    } catch (error) {
      console.error('Error adding tag to record:', error);
      // Fail silently - don't show alert or throw
      return null;
    }
  };

  // Remove tag from a record
  const removeTagFromRecord = async (tagId, recordType, recordId) => {
    if (!user) return;

    try {
      const tag = tags.find(t => t.id === tagId);
      const tagName = tag ? tag.name : '';

      const { error } = await supabase
        .from('record_tags')
        .delete()
        .eq('tag_id', tagId)
        .eq('record_type', recordType)
        .eq('record_id', recordId);

      if (error) throw error;
      setRecordTags(recordTags.filter(
        rt => !(rt.tag_id === tagId && rt.record_type === recordType && rt.record_id === recordId)
      ));

      // Log to tag history - COMMENTED OUT: table doesn't exist yet
      // try {
      //   await supabase
      //     .from('tag_history')
      //     .insert([{
      //       tag_id: tagId,
      //       tag_name: tagName,
      //       record_type: recordType,
      //       record_id: recordId,
      //       action: 'removed',
      //       action_by: user.id,
      //       user_id: user.id
      //     }]);
      // } catch (historyError) {
      //   // Don't fail if history logging fails
      //   console.error('Error logging tag history:', historyError);
      // }
    } catch (error) {
      console.error('Error removing tag from record:', error);
      alert('Error removing tag: ' + error.message);
      throw error;
    }
  };

  // Get most recently used tags (for quick-tag)
  const getMostRecentTags = () => {
    if (recordTags.length === 0) return tags.slice(0, 5);
    
    // Get unique tag IDs from recent record_tags, ordered by most recent
    const recentTagIds = [...new Set(
      recordTags
        .sort((a, b) => new Date(b.added_at) - new Date(a.added_at))
        .map(rt => rt.tag_id)
        .slice(0, 5)
    )];
    
    return recentTagIds.map(id => tags.find(t => t.id === id)).filter(Boolean);
  };

  // Check for existing session on mount
  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      const currentUser = session?.user ?? null;
      setUser(currentUser);
      if (session && currentUser) {
        loadData(currentUser);
        loadTwilioSettings();
        loadOwnerProperties();
        loadOwnerDistributions();
        loadLateFeeSettings();
        loadLateFees();
      } else {
        setLoading(false);
      }
    });

    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
      const currentUser = session?.user ?? null;
      setUser(currentUser);
      if (session && currentUser) {
        loadData(currentUser);
        loadTwilioSettings();
        loadOwnerProperties();
        loadOwnerDistributions();
        loadLateFeeSettings();
        loadLateFees();
      } else {
        setTenants([]);
        setProperties([]);
        setMaintenanceRequests([]);
        setOwnerProperties([]);
        setOwnerDistributions([]);
        setLateFeeSettings([]);
        setLateFees([]);
        setLoading(false);
      }
    });

    return () => subscription.unsubscribe();
  }, []);

  // Load Twilio settings when Settings tab is opened
  useEffect(() => {
    if (activeTab === 'settings' && user && user.id) {
      loadTwilioSettings();
    }
  }, [activeTab, user]);

  // Load SMS messages when Messages tab is opened
  useEffect(() => {
    if (activeTab === 'messages' && user) {
      loadSmsMessages();
    }
  }, [activeTab, user]);

  // Load SMS messages (internal function without toast)
  const loadSmsMessages = async () => {
    try {
      const { data, error } = await supabase
        .from('sms_messages')
        .select(`
          *,
          tenant:tenants(id, name, phone)
        `)
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading SMS messages:', error);
        throw error;
      } else {
        setSmsMessages(data || []);
      }
    } catch (error) {
      console.error('Error loading SMS messages:', error);
      throw error;
    }
  };

  // Messages refresh handler
  const handleMessagesRefresh = async () => {
    setMessagesRefreshing(true);
    try {
      await loadSmsMessages();
      showToast('Messages refreshed', 'success');
    } catch (error) {
      showToast('Error loading messages', 'error');
    } finally {
      setMessagesRefreshing(false);
    }
  };

  // Load maintenance requests (internal function without toast)
  const loadMaintenanceRequests = async () => {
    try {
      const { data: maintenanceData, error: maintenanceError } = await supabase
        .from('maintenance_requests')
        .select('*')
        .order('created_at', { ascending: false });

      if (maintenanceError) {
        console.error('Error loading maintenance requests:', maintenanceError);
        throw maintenanceError;
      } else {
        setMaintenanceRequests((maintenanceData || []).map(transformMaintenanceRequest));
      }
    } catch (error) {
      console.error('Error loading maintenance requests:', error);
      throw error;
    }
  };

  // Maintenance refresh handler
  const handleMaintenanceRefresh = async () => {
    setMaintenanceRefreshing(true);
    try {
      await loadMaintenanceRequests();
      showToast('Maintenance requests refreshed', 'success');
    } catch (error) {
      showToast('Error loading maintenance requests', 'error');
    } finally {
      setMaintenanceRefreshing(false);
    }
  };

  // Load vendors
  const loadVendors = async () => {
    const { data, error } = await supabase
      .from('vendors')
      .select('*')
      .order('name');
    if (error) {
      console.error('Error loading vendors:', error);
      return;
    }
    setVendors(data || []);
  };

  // Load vendor payments
  const loadVendorPayments = async () => {
    const { data, error } = await supabase
      .from('vendor_payments')
      .select('*, vendors(name, company), properties(name), maintenance_requests(title)')
      .order('payment_date', { ascending: false });
    if (error) {
      console.error('Error loading vendor payments:', error);
      return;
    }
    setVendorPayments(data || []);
  };

  // Vendor CRUD
  const addVendor = async (vendorData) => {
    const { data, error } = await supabase
      .from('vendors')
      .insert([{ ...vendorData, user_id: user.id }])
      .select()
      .single();
    if (error) {
      console.error('Error adding vendor:', error);
      alert('Failed to add vendor');
      return null;
    }
    setVendors(prev => [...prev, data]);
    return data;
  };

  const updateVendor = async (id, updates) => {
    const { data, error } = await supabase
      .from('vendors')
      .update({ ...updates, updated_at: new Date().toISOString() })
      .eq('id', id)
      .select()
      .single();
    if (error) {
      console.error('Error updating vendor:', error);
      alert('Failed to update vendor');
      return null;
    }
    setVendors(prev => prev.map(v => v.id === id ? data : v));
    return data;
  };

  const deleteVendor = async (id) => {
    const { error } = await supabase
      .from('vendors')
      .delete()
      .eq('id', id);
    if (error) {
      console.error('Error deleting vendor:', error);
      alert('Failed to delete vendor');
      return false;
    }
    setVendors(prev => prev.filter(v => v.id !== id));
    return true;
  };

  // Vendor Payment CRUD
  const addVendorPayment = async (paymentData) => {
    const { data, error } = await supabase
      .from('vendor_payments')
      .insert([{ ...paymentData, user_id: user.id }])
      .select('*, vendors(name, company), properties(name), maintenance_requests(title)')
      .single();
    if (error) {
      console.error('Error adding payment:', error);
      alert('Failed to add payment');
      return null;
    }
    setVendorPayments(prev => [data, ...prev]);
    return data;
  };

  const updateVendorPayment = async (id, updates) => {
    const { data, error } = await supabase
      .from('vendor_payments')
      .update({ ...updates, updated_at: new Date().toISOString() })
      .eq('id', id)
      .select('*, vendors(name, company), properties(name), maintenance_requests(title)')
      .single();
    if (error) {
      console.error('Error updating payment:', error);
      alert('Failed to update payment');
      return null;
    }
    setVendorPayments(prev => prev.map(p => p.id === id ? data : p));
    return data;
  };

  const deleteVendorPayment = async (id) => {
    const { error } = await supabase
      .from('vendor_payments')
      .delete()
      .eq('id', id);
    if (error) {
      console.error('Error deleting payment:', error);
      alert('Failed to delete payment');
      return false;
    }
    setVendorPayments(prev => prev.filter(p => p.id !== id));
    return true;
  };

  // Assign vendor to maintenance request
  const assignVendorToMaintenance = async (maintenanceId, vendorId, cost = null) => {
    const { data, error } = await supabase
      .from('maintenance_requests')
      .update({ 
        vendor_id: vendorId, 
        vendor_cost: cost,
        updated_at: new Date().toISOString() 
      })
      .eq('id', maintenanceId)
      .select()
      .single();
    if (error) {
      console.error('Error assigning vendor:', error);
      alert('Failed to assign vendor');
      return null;
    }
    setMaintenanceRequests(prev => prev.map(m => m.id === maintenanceId ? data : m));
    return data;
  };

  // Vendor specialty options with SVG icons
  const vendorSpecialties = [
    { value: 'plumber', label: 'Plumber', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path></svg> },
    { value: 'electrician', label: 'Electrician', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg> },
    { value: 'hvac', label: 'HVAC', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 14.5 3 21"></path><path d="M3 3v18h18"></path><path d="M21 21H3"></path><path d="M14 4v9"></path><path d="M4 10h16"></path></svg> },
    { value: 'landscaping', label: 'Landscaping', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 10a6 6 0 0 0 6-6H6a6 6 0 0 0 6 6Z"></path><path d="M12 10v12"></path><path d="M8 22h8"></path></svg> },
    { value: 'general', label: 'General Contractor', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"></path><path d="M17.64 15 22 10.64"></path><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25v-.86L16.01 4.6a5.56 5.56 0 0 0-3.94-1.64H9l.92.82A6.18 6.18 0 0 1 12 8.4v1.56l2 2h2.47l2.26 1.91"></path></svg> },
    { value: 'roofing', label: 'Roofing', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> },
    { value: 'cleaning', label: 'Cleaning', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 11-6 6v3h9l3-3"></path><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"></path></svg> },
    { value: 'pest_control', label: 'Pest Control', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg> },
    { value: 'appliance', label: 'Appliance Repair', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v10"></path><path d="M18.4 6.6a9 9 0 1 1-12.77.04"></path></svg> },
    { value: 'other', label: 'Other', icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg> }
  ];

  const getSpecialtyInfo = (specialty) => {
    return vendorSpecialties.find(s => s.value === specialty) || { value: specialty, label: specialty, icon: <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg> };
  };

  // Payment method options
  const paymentMethods = [
    { value: 'check', label: 'Check' },
    { value: 'ach', label: 'ACH Transfer' },
    { value: 'credit_card', label: 'Credit Card' },
    { value: 'cash', label: 'Cash' },
    { value: 'other', label: 'Other' }
  ];

  // Calculate vendor stats
  const getVendorStats = (vendorId) => {
    const payments = vendorPayments.filter(p => p.vendor_id === vendorId);
    const jobs = maintenanceRequests.filter(m => m.vendor_id === vendorId);
    const totalPaid = payments.filter(p => p.status === 'paid').reduce((sum, p) => sum + Number(p.amount), 0);
    const pendingPayments = payments.filter(p => p.status === 'pending').reduce((sum, p) => sum + Number(p.amount), 0);
    
    return {
      totalJobs: jobs.length,
      completedJobs: jobs.filter(j => j.status === 'completed').length,
      openJobs: jobs.filter(j => j.status === 'open' || j.status === 'in_progress').length,
      totalPaid,
      pendingPayments,
      payments
    };
  };

  // Render star rating
  const renderStars = (rating, interactive = false, onChange = null) => {
    return (
      <div style={{ display: 'flex', gap: '2px' }}>
        {[1, 2, 3, 4, 5].map(star => (
          <span
            key={star}
            onClick={interactive && onChange ? () => onChange(star) : undefined}
            style={{
              cursor: interactive ? 'pointer' : 'default',
              color: star <= rating ? '#f59e0b' : '#e5e7eb',
              fontSize: '16px'
            }}
          >
            â
          </span>
        ))}
      </div>
    );
  };

  // Extract display name - use "Seri" or extract first name properly
  const getUserDisplayName = () => {
    const email = user?.email || '';
    const localPart = email.split('@')[0] || 'there';
    
    // If email starts with common patterns, extract first name
    // Handle formats: seristrong, seri.strong, seri_strong, strongsa
    if (localPart.includes('.')) {
      return localPart.split('.')[0].charAt(0).toUpperCase() + localPart.split('.')[0].slice(1);
    }
    if (localPart.includes('_')) {
      return localPart.split('_')[0].charAt(0).toUpperCase() + localPart.split('_')[0].slice(1);
    }
    
    // For concatenated names or usernames, just capitalize and use first 4-6 reasonable chars
    // Or you can hardcode your name here:
    return 'Seri';
    
    // const name = localPart.charAt(0).toUpperCase() + localPart.slice(1, 5);
    // return name;
  };

  // Handle modal close with unsaved changes check
  const handleModalClose = (formId, closeFunction) => {
    const form = document.getElementById(formId);
    if (form) {
      const formData = new FormData(form);
      const hasData = Array.from(formData.values()).some(value => value && value !== '');
      if (hasData) {
        if (confirm('You have unsaved changes. Are you sure you want to close?')) {
          closeFunction();
        }
      } else {
        closeFunction();
      }
    } else {
      closeFunction();
    }
  };

  // Map display status to database status
  const mapStatusToDB = (displayStatus) => {
    const statusMap = {
      'Pending': 'open',
      'In Progress': 'in_progress',
      'Active': 'in_progress',
      'Completed': 'closed'
    };
    return statusMap[displayStatus] || displayStatus.toLowerCase().replace(' ', '_');
  };

  // Update maintenance status
  const updateMaintenanceStatus = async (maintenanceId, newStatus) => {
    try {
      // Map display status to database status
      const dbStatus = mapStatusToDB(newStatus);

      const { error } = await supabase
        .from('maintenance_requests')
        .update({ status: dbStatus })
        .eq('id', maintenanceId);

      if (error) {
        console.error('Error updating maintenance status:', error);
        showToast('Error updating status', 'error');
        throw error;
      }

      // Refresh the maintenance requests list
      await loadMaintenanceRequests();
      
      // Update the selected maintenance request if it's the same one
      if (selectedMaintenanceRequest && selectedMaintenanceRequest.id === maintenanceId) {
        const { data: updatedRequest } = await supabase
          .from('maintenance_requests')
          .select('*')
          .eq('id', maintenanceId)
          .single();
        
        if (updatedRequest) {
          setSelectedMaintenanceRequest(transformMaintenanceRequest(updatedRequest));
        }
      }

      showToast('Status updated successfully', 'success');
      setShowStatusDropdown(false);
    } catch (error) {
      console.error('Error updating maintenance status:', error);
      showToast('Error updating status', 'error');
    }
  };

  // Group messages by phone number for conversation view
  const conversations = useMemo(() => {
    const grouped = {};
    smsMessages.forEach(msg => {
      const key = msg.phone_number;
      if (!grouped[key]) {
        grouped[key] = {
          phone: key,
          tenant: msg.tenant,
          messages: [],
          lastMessage: null,
          unreadCount: 0
        };
      }
      grouped[key].messages.push(msg);
      
      // Track last message and unread count
      if (!grouped[key].lastMessage || new Date(msg.created_at) > new Date(grouped[key].lastMessage.created_at)) {
        grouped[key].lastMessage = msg;
      }
      
      // Count unread inbound messages (you can add a 'read' field to track this)
      if (msg.direction === 'inbound') {
        grouped[key].unreadCount++;
      }
    });
    
    // Sort conversations by last message time
    return Object.values(grouped).sort((a, b) => {
      const dateA = new Date(a.lastMessage?.created_at || 0);
      const dateB = new Date(b.lastMessage?.created_at || 0);
      return dateB - dateA;
    });
  }, [smsMessages]);

  // Send SMS function
  const sendSms = async (to, message) => {
    if (!message || !message.trim()) {
      showToast('Please enter a message', 'error');
      return;
    }

    try {
      // Get Twilio settings
      const { data: settings } = await supabase
        .from('sms_settings')
        .select('*')
        .single();

      if (!settings || !settings.account_sid || !settings.auth_token || !settings.phone_number) {
        showToast('Twilio settings not configured', 'error');
        return;
      }

      const selectedConv = conversations.find(c => c.phone === to);
      const tenantId = selectedConv?.tenant?.id;

      // Call send-sms function
      const { data, error } = await supabase.functions.invoke('send-sms', {
        body: {
          to,
          message: message.trim(),
          accountSid: settings.account_sid,
          authToken: settings.auth_token,
          fromNumber: settings.phone_number,
          tenantId: tenantId,
          userId: user?.id
        }
      });

      if (error) {
        console.error('Error sending SMS:', error);
        showToast('Error sending message', 'error');
      } else if (data && data.success) {
        // Reload messages (the edge function saves the outbound message)
        await loadSmsMessages();
        setNewMessage('');
        showToast('Message sent', 'success');
      } else {
        showToast(data?.error || 'Error sending message', 'error');
      }
    } catch (error) {
      console.error('Error sending SMS:', error);
      showToast('Error sending message', 'error');
    }
  };

  // Apply dark mode class to body element
  useEffect(() => {
    if (darkMode) {
      document.body.classList.add('dark-mode');
      localStorage.setItem('propli_darkMode', 'true');
    } else {
      document.body.classList.remove('dark-mode');
      localStorage.setItem('propli_darkMode', 'false');
    }
  }, [darkMode]);

  // Save activeTab to localStorage when it changes
  useEffect(() => {
    localStorage.setItem('propli_activeTab', activeTab);
  }, [activeTab]);

  // Keyboard shortcut handler for refresh (R key)
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Only trigger if not typing in an input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }

      // Check if R key is pressed (without Ctrl/Cmd)
      if ((e.key === 'r' || e.key === 'R') && !e.ctrlKey && !e.metaKey) {
        // Handle refresh based on active tab
        if (activeTab === 'messages') {
          e.preventDefault();
          handleMessagesRefresh();
        } else if (activeTab === 'maintenance') {
          e.preventDefault();
          handleMaintenanceRefresh();
        }
      }
    };

    // Close dropdowns when clicking outside
    const handleClickOutside = (e) => {
      if (showStatusDropdown || showVendorInput) {
        // Check if click is outside the dropdown/input
        const target = e.target;
        if (!target.closest('.slide-panel-footer')) {
          setShowStatusDropdown(false);
          setShowVendorInput(false);
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('click', handleClickOutside);
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('click', handleClickOutside);
    };
  }, [activeTab, handleMessagesRefresh, handleMaintenanceRefresh, showStatusDropdown, showVendorInput]);

  // Load tags when tenant modal opens
  useEffect(() => {
    if (selectedTenant && selectedTenant.id) {
      // Reload record tags to ensure we have the latest tags for this tenant
      const loadTenantTags = async () => {
        try {
          const { data: allRecordTags } = await supabase
            .from('record_tags')
            .select('*');
          if (allRecordTags) {
            setRecordTags(allRecordTags);
          }
        } catch (error) {
          console.error('Error loading tenant tags:', error);
        }
      };
      loadTenantTags();
    }
  }, [selectedTenant]);

  const handleAuthSuccess = () => {
    // Auth state change will trigger loadData automatically
  };

  const handleLogout = async () => {
    const { error } = await supabase.auth.signOut();
    if (error) {
      console.error('Error signing out:', error);
      alert('Error signing out');
    }
  };

  // Refresh data function (reloads without page refresh)
  const refreshData = async () => {
    if (user) {
      await loadData(user);
    }
  };

  // Extract unit number from property address
  const extractUnitNumber = (propertyAddress) => {
    if (!propertyAddress) return 'N/A';
    // Try to extract unit number from patterns like "Unit 3B", "Unit 12", "Apt 5", etc.
    const unitMatch = propertyAddress.match(/(?:Unit|Apt|Apartment|#)\s*([A-Z0-9]+)/i);
    if (unitMatch) {
      return unitMatch[1];
    }
    // If no unit found, return the full address
    return propertyAddress;
  };

  // Extract property address without unit
  const extractPropertyAddress = (propertyAddress) => {
    if (!propertyAddress) return 'N/A';
    // Remove unit information
    return propertyAddress.replace(/\s*(?:Unit|Apt|Apartment|#)\s*[A-Z0-9]+/i, '').trim() || propertyAddress;
  };

  // Get rent roll data for current tenants
  const getRentRollData = () => {
    return tenants
      .filter(t => t.status === 'current' && t.rentAmount > 0)
      .map(tenant => {
        const propertyAddress = extractPropertyAddress(tenant.property);
        const unit = extractUnitNumber(tenant.property);
        
        // Get last payment date from payment log
        let lastPaymentDate = null;
        if (tenant.paymentLog && tenant.paymentLog.length > 0) {
          const sortedPayments = [...tenant.paymentLog].sort((a, b) => 
            new Date(b.date) - new Date(a.date)
          );
          lastPaymentDate = sortedPayments[0].date;
        } else if (tenant.paymentDate) {
          lastPaymentDate = tenant.paymentDate;
        }

        // Determine payment status for the selected month
        let paymentStatus = tenant.paymentStatus || 'unpaid';
        if (reportMonth) {
          const [year, month] = reportMonth.split('-');
          const reportDate = new Date(year, month - 1, 1);
          const lastPayment = lastPaymentDate ? new Date(lastPaymentDate) : null;
          
          if (lastPayment) {
            const paymentMonth = lastPayment.getFullYear() + '-' + String(lastPayment.getMonth() + 1).padStart(2, '0');
            if (paymentMonth === reportMonth) {
              paymentStatus = tenant.paymentStatus || 'paid';
            } else if (paymentMonth < reportMonth) {
              paymentStatus = 'unpaid';
            }
          } else {
            paymentStatus = 'unpaid';
          }
        }

        return {
          propertyAddress,
          unit,
          tenantName: tenant.name,
          leaseStart: tenant.leaseStart,
          leaseEnd: tenant.leaseEnd,
          monthlyRent: tenant.rentAmount,
          paymentStatus,
          lastPaymentDate
        };
      })
      .sort((a, b) => {
        // Sort by property address, then by unit
        if (a.propertyAddress !== b.propertyAddress) {
          return a.propertyAddress.localeCompare(b.propertyAddress);
        }
        return a.unit.localeCompare(b.unit);
      });
  };

  // Calculate rent roll totals
  const getRentRollTotals = () => {
    const rentRollData = getRentRollData();
    const totalUnits = rentRollData.length;
    const totalRent = rentRollData.reduce((sum, row) => sum + row.monthlyRent, 0);
    const paidCount = rentRollData.filter(row => row.paymentStatus === 'paid').length;
    const collectionRate = totalUnits > 0 ? Math.round((paidCount / totalUnits) * 100) : 0;
    
    return {
      totalUnits,
      totalRent,
      collectionRate
    };
  };

  // Export rent roll to CSV
  const exportRentRollToCSV = () => {
    const rentRollData = getRentRollData();
    const totals = getRentRollTotals();
    
    const headers = ['Property Address', 'Unit', 'Tenant Name', 'Lease Start', 'Lease End', 'Monthly Rent', 'Payment Status', 'Last Payment Date'];
    const rows = rentRollData.map(row => [
      row.propertyAddress,
      row.unit,
      row.tenantName,
      row.leaseStart || '',
      row.leaseEnd || '',
      row.monthlyRent,
      row.paymentStatus === 'paid' ? 'Paid' : row.paymentStatus === 'late' ? 'Late' : 'Unpaid',
      row.lastPaymentDate || ''
    ]);

    // Add totals row
    rows.push(['', '', '', '', 'TOTALS', totals.totalRent, '', '']);
    rows.push(['Total Units', totals.totalUnits, '', '', 'Collection Rate', `${totals.collectionRate}%`, '', '']);

    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `rent_roll_${reportMonth || 'all'}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Get late tenants with days late calculation
  // Dashboard helper functions
  const getDashboardMetrics = () => {
    const totalUnits = stats.totalUnits;
    const occupiedUnits = stats.occupiedUnits;
    const occupancyPercentage = totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0;
    
    // Calculate monthly revenue collected vs expected
    const expectedRevenue = tenants
      .filter(t => t.status === 'current' && t.rentAmount > 0)
      .reduce((sum, t) => sum + t.rentAmount, 0);
    
    const collectedRevenue = tenants
      .filter(t => t.status === 'current' && t.paymentStatus === 'paid')
      .reduce((sum, t) => sum + t.rentAmount, 0);
    
    // Outstanding balances (late rent)
    const outstandingBalances = tenants
      .filter(t => t.status === 'current' && t.paymentStatus === 'late')
      .reduce((sum, t) => sum + t.rentAmount, 0);
    
    // Leases expiring
    const today = new Date();
    const leasesExpiring30 = tenants.filter(t => {
      if (!t.leaseEnd || t.status !== 'current') return false;
      const endDate = new Date(t.leaseEnd);
      const daysUntilExpiry = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
      return daysUntilExpiry <= 30 && daysUntilExpiry >= 0;
    }).length;
    
    const leasesExpiring60 = tenants.filter(t => {
      if (!t.leaseEnd || t.status !== 'current') return false;
      const endDate = new Date(t.leaseEnd);
      const daysUntilExpiry = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
      return daysUntilExpiry <= 60 && daysUntilExpiry > 30;
    }).length;
    
    const leasesExpiring90 = tenants.filter(t => {
      if (!t.leaseEnd || t.status !== 'current') return false;
      const endDate = new Date(t.leaseEnd);
      const daysUntilExpiry = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
      return daysUntilExpiry <= 90 && daysUntilExpiry > 60;
    }).length;
    
    return {
      totalUnits,
      occupiedUnits,
      occupancyPercentage,
      expectedRevenue,
      collectedRevenue,
      outstandingBalances,
      leasesExpiring30,
      leasesExpiring60,
      leasesExpiring90
    };
  };

  // Get revenue data for last 6 months (Jan-Jun)
  const getRevenueData = () => {
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const months = [];
    
    // Always return Jan-Jun data
    for (let i = 0; i < 6; i++) {
      const monthName = monthNames[i];
      
      // Calculate revenue for this month if we have payment data
      let revenue = 0;
      const currentYear = new Date().getFullYear();
      const monthIndex = i; // Jan=0, Feb=1, etc.
      
      tenants
        .filter(t => t.status === 'current' && t.paymentStatus === 'paid')
        .forEach(tenant => {
          if (tenant.paymentLog && tenant.paymentLog.length > 0) {
            tenant.paymentLog.forEach(payment => {
              const paymentDate = new Date(payment.date);
              if (paymentDate.getMonth() === monthIndex && paymentDate.getFullYear() === currentYear) {
                revenue += payment.amount;
              }
            });
          }
        });
      
      // If no revenue data, use sample data: 0 for first 5 months, actual or 4000 for June
      if (i < 5) {
        months.push({ month: monthName, revenue: revenue || 0 });
      } else {
        // June: use actual data if available, otherwise 4000
        months.push({ month: monthName, revenue: revenue || 4000 });
      }
    }
    
    return months;
  };

  // Get occupancy rate data over time (Jan-Jun)
  const getOccupancyData = () => {
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const months = [];
    
    // Calculate current occupancy rate
    const totalUnits = stats.totalUnits;
    const occupiedUnits = stats.occupiedUnits;
    const occupancyRate = totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 50;
    
    // Always return Jan-Jun data with current occupancy rate (or 50% as default)
    for (let i = 0; i < 6; i++) {
      months.push({ month: monthNames[i], occupancy: occupancyRate || 50 });
    }
    
    return months;
  };

  // Currency formatter function
  const formatCurrency = (value) => {
    if (value === null || value === undefined || isNaN(value)) return '$0';
    return '$' + Number(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  };

  // TagPicker Component (inline function component)
  const TagPicker = ({ recordType, recordId, existingTags = [], onTagsChange }) => {
    const recordTags = getTagsForRecord(recordType, recordId);
    const isOpen = tagPickerOpen.recordType === recordType && tagPickerOpen.recordId === recordId;
    const searchValue = isOpen ? tagPickerSearch : '';

    const availableTags = tags.filter(tag => {
      // Filter out already applied tags
      if (recordTags.some(rt => rt.id === tag.id)) return false;
      // Filter by search
      if (searchValue && !tag.name.toLowerCase().includes(searchValue.toLowerCase())) return false;
      return true;
    });

    const handleAddTag = async (tagId) => {
      console.log('TagPicker handleAddTag called:', { tagId, recordType, recordId });
      try {
        await addTagToRecord(tagId, recordType, recordId);
        // Close dropdown immediately
        setTagPickerOpen({ recordType: null, recordId: null });
        setTagPickerSearch('');
        // Note: addTagToRecord already reloads record tags, so we don't need to reload again
        // But we can call onTagsChange if provided for any additional side effects
        if (onTagsChange) {
          onTagsChange();
        }
      } catch (error) {
        console.error('Error in handleAddTag:', error);
        // Error already handled in addTagToRecord
      }
    };

    const handleRemoveTag = async (tagId) => {
      try {
        await removeTagFromRecord(tagId, recordType, recordId);
        // Refresh tags immediately
        if (onTagsChange) {
          onTagsChange();
        } else {
          // If no onTagsChange callback, reload record tags manually
          try {
            const { data: allRecordTags } = await supabase
              .from('record_tags')
              .select('*');
            if (allRecordTags) {
              setRecordTags(allRecordTags);
            }
          } catch (err) {
            console.error('Error reloading record tags:', err);
          }
        }
      } catch (error) {
        // Error already handled
      }
    };

    const handleCreateAndAddTag = async () => {
      if (!searchValue.trim()) return;
      console.log('handleCreateAndAddTag called:', searchValue);
      try {
        const newTagData = await createTag(searchValue, 'blue');
        console.log('New tag created:', newTagData);
        if (newTagData) {
          console.log('Adding tag to record:', newTagData.id);
          await handleAddTag(newTagData.id);
        } else {
          console.error('Failed to create tag, newTagData is null');
        }
      } catch (error) {
        console.error('Error in handleCreateAndAddTag:', error);
        // Error already handled
      }
    };

    const colorMap = {
      blue: '#1a73e8',
      green: '#10b981',
      yellow: '#fbbf24',
      orange: '#f97316',
      red: '#ef4444',
      purple: '#a855f7',
      teal: '#14b8a6',
      gray: '#6b7280'
    };

    return (
      <div style={{ position: 'relative' }}>
        {/* Existing Tags */}
        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginBottom: '8px' }}>
          {recordTags.map(tag => (
            <span
              key={tag.id}
              className={`tag-pill ${tag.color}`}
              style={{ cursor: 'default' }}
            >
              {tag.name}
              <span
                className="tag-remove"
                onClick={(e) => {
                  e.stopPropagation();
                  handleRemoveTag(tag.id);
                }}
                title="Remove tag"
              >
                Ã
              </span>
            </span>
          ))}
        </div>

        {/* Add Tag Button */}
        <button
          type="button"
          onClick={(e) => {
            e.stopPropagation();
            setTagPickerOpen({ recordType, recordId });
            setTagPickerSearch('');
          }}
          style={{
            background: 'none',
            border: '1px dashed #dadce0',
            borderRadius: '4px',
            padding: '4px 8px',
            fontSize: '11px',
            color: '#5f6368',
            cursor: 'pointer',
            display: 'inline-flex',
            alignItems: 'center',
            gap: '4px'
          }}
          onMouseEnter={(e) => {
            e.target.style.borderColor = '#1a73e8';
            e.target.style.color = '#1a73e8';
          }}
          onMouseLeave={(e) => {
            e.target.style.borderColor = '#dadce0';
            e.target.style.color = '#5f6368';
          }}
        >
          + Add Tag
        </button>

        {/* Dropdown */}
        {isOpen && (
          <>
            <div
              style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                zIndex: 999
              }}
              onClick={() => {
                setTagPickerOpen({ recordType: null, recordId: null });
                setTagPickerSearch('');
              }}
            />
            <div
              className="tag-picker-dropdown"
              onClick={(e) => e.stopPropagation()}
            >
              {/* Search Input */}
              <div style={{ padding: '12px', borderBottom: '1px solid #e5e7eb' }}>
                <input
                  type="text"
                  value={searchValue}
                  onChange={(e) => setTagPickerSearch(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && searchValue.trim() && availableTags.length === 0) {
                      handleCreateAndAddTag();
                    }
                  }}
                  placeholder="Search or create tag..."
                  autoFocus
                  style={{
                    width: '100%',
                    padding: '8px 12px',
                    border: '1px solid #dadce0',
                    borderRadius: '4px',
                    fontSize: '14px'
                  }}
                />
              </div>

              {/* Tag List */}
              <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                {availableTags.length > 0 ? (
                  availableTags.map(tag => (
                    <div
                      key={tag.id}
                      onClick={() => handleAddTag(tag.id)}
                      className="tag-picker-dropdown-item"
                    >
                      <div
                        style={{
                          width: '12px',
                          height: '12px',
                          borderRadius: '50%',
                          background: colorMap[tag.color] || colorMap.blue,
                          flexShrink: 0
                        }}
                      />
                      <span style={{ fontSize: '14px', color: '#202124' }}>{tag.name}</span>
                    </div>
                  ))
                ) : searchValue.trim() ? (
                  <div
                    onClick={handleCreateAndAddTag}
                    className="tag-picker-dropdown-item"
                    style={{ color: '#1a73e8' }}
                  >
                    <span style={{ fontSize: '14px' }}>+ Create "{searchValue}"</span>
                  </div>
                ) : (
                  <div style={{ padding: '12px', textAlign: 'center', color: '#5f6368', fontSize: '14px' }}>
                    No tags available
                  </div>
                )}
              </div>
            </div>
          </>
        )}
      </div>
    );
  };

  // Get recent tenants (last 5)
  const getRecentTenants = () => {
    return tenants
      .filter(t => t.status === 'current')
      .sort((a, b) => {
        // Sort by most recent activity or creation
        const aDate = a.activityLog && a.activityLog.length > 0 
          ? new Date(a.activityLog[a.activityLog.length - 1].timestamp)
          : new Date(0);
        const bDate = b.activityLog && b.activityLog.length > 0
          ? new Date(b.activityLog[b.activityLog.length - 1].timestamp)
          : new Date(0);
        return bDate - aDate;
      })
      .slice(0, 5);
  };

  // Get initials for avatar
  const getInitials = (name) => {
    if (!name) return '?';
    const parts = name.trim().split(' ');
    if (parts.length >= 2) {
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
  };

  // Avatar colors: blue, teal, green, slate
  const avatarColors = ['#1a73e8', '#0891b2', '#059669', '#475569'];
  const getAvatarColor = (index) => {
    return avatarColors[index % avatarColors.length];
  };
  
  // Get avatar color based on tenant name (for consistent colors)
  const getAvatarColorByName = (name) => {
    if (!name) return avatarColors[0];
    const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
    return avatarColors[hash % avatarColors.length];
  };
  
  // Format lease end date
  const formatLeaseEndDate = (leaseEnd, status) => {
    if (!leaseEnd || status === 'prospect') return 'Pending';
    const date = new Date(leaseEnd);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
  };

  // Format time ago
  const formatTimeAgo = (dateString) => {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
    
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''} ago`;
    if (diffDays < 365) return `${Math.floor(diffDays / 30)} month${Math.floor(diffDays / 30) > 1 ? 's' : ''} ago`;
    return `${Math.floor(diffDays / 365)} year${Math.floor(diffDays / 365) > 1 ? 's' : ''} ago`;
  };

  // EventCard component
  const EventCard = ({ event, type, compact }) => {
    const typeColors = {
      'move-in': { bg: '#d1fae5', text: '#065f46', icon: 'ð¦' },
      'move-out': { bg: '#fee2e2', text: '#991b1b', icon: 'ð' },
      'maintenance': { bg: '#fef3c7', text: '#92400e', icon: 'ð§' },
      'inspection': { bg: '#e0f2fe', text: '#0369a1', icon: 'ð' },
      'vendor': { bg: '#f3e8ff', text: '#6b21a8', icon: 'ð·' },
      'lease-expiration': { bg: '#fef3c7', text: '#92400e', icon: 'ð' },
      'general': { bg: '#f3f4f6', text: '#374151', icon: 'ð' }
    };
    
    const colors = typeColors[event.type || type] || typeColors.general;
    
    if (compact) {
      return (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          gap: 8,
          padding: '8px 12px',
          background: colors.bg,
          borderRadius: 6,
          marginBottom: 6
        }}>
          <span>{colors.icon}</span>
          <span style={{ fontSize: 13, color: colors.text, fontWeight: 500 }}>{event.title}</span>
          {event.time && <span style={{ fontSize: 12, color: '#6b7280', marginLeft: 'auto' }}>{event.time}</span>}
        </div>
      );
    }
    
    return (
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 12,
        background: colors.bg,
        borderRadius: 8,
        marginBottom: 8
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <span style={{ fontSize: 20 }}>{colors.icon}</span>
          <div>
            <p style={{ fontWeight: 500, color: colors.text, marginBottom: 2, margin: 0 }}>{event.title}</p>
            <p style={{ fontSize: 13, color: '#6b7280', margin: 0 }}>
              {event.description || event.property_name || ''}
            </p>
          </div>
        </div>
        <div style={{ textAlign: 'right' }}>
          <p style={{ fontWeight: 600, color: colors.text, marginBottom: 2, margin: 0 }}>
            {new Date(event.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
          </p>
          {event.time && <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>{event.time}</p>}
        </div>
      </div>
    );
  };

  // Schedule helper functions
  const getTodayEvents = () => {
    const today = new Date().toDateString();
    const events = [];
    
    // Get scheduled events
    scheduleEvents.forEach(e => {
      if (new Date(e.date).toDateString() === today) {
        events.push(e);
      }
    });
    
    // Get move-ins for today
    tenants.forEach(t => {
      const moveInDate = t.moveInDate || t.move_in_date;
      if (moveInDate && new Date(moveInDate).toDateString() === today) {
        const property = properties.find(p => p.id === t.property_id || p.address === t.property);
        events.push({
          title: `${t.name} - Move-In`,
          type: 'move-in',
          date: moveInDate,
          property_name: property?.name || property?.address || t.property,
          tenant_id: t.id
        });
      }
    });
    
    // Get move-outs for today
    tenants.forEach(t => {
      const moveOutDate = t.moveOutDate || t.move_out_date;
      if (moveOutDate && new Date(moveOutDate).toDateString() === today) {
        const property = properties.find(p => p.id === t.property_id || p.address === t.property);
        events.push({
          title: `${t.name} - Move-Out`,
          type: 'move-out',
          date: moveOutDate,
          property_name: property?.name || property?.address || t.property,
          tenant_id: t.id
        });
      }
    });
    
    return events.sort((a, b) => new Date(a.date) - new Date(b.date));
  };

  const getUpcomingMoveIns = () => {
    const events = [];
    tenants.forEach(t => {
      const moveInDate = t.moveInDate || t.move_in_date;
      if (moveInDate) {
        try {
          const date = new Date(moveInDate);
          if (date >= new Date()) {
            const property = properties.find(p => p.id === t.property_id || p.address === t.property);
            events.push({
              title: `${t.name} - Move-In`,
              type: 'move-in',
              date: moveInDate,
              property_name: property?.name || property?.address || t.property,
              tenant_id: t.id
            });
          }
        } catch (e) {
          // Skip invalid dates
        }
      }
    });
    return events.sort((a, b) => new Date(a.date) - new Date(b.date)).slice(0, 5);
  };

  const getUpcomingMoveOuts = () => {
    const events = [];
    tenants.forEach(t => {
      const moveOutDate = t.moveOutDate || t.move_out_date;
      if (moveOutDate) {
        try {
          const date = new Date(moveOutDate);
          if (date >= new Date()) {
            const property = properties.find(p => p.id === t.property_id || p.address === t.property);
            events.push({
              title: `${t.name} - Move-Out`,
              type: 'move-out',
              date: moveOutDate,
              property_name: property?.name || property?.address || t.property,
              tenant_id: t.id
            });
          }
        } catch (e) {
          // Skip invalid dates
        }
      }
    });
    return events.sort((a, b) => new Date(a.date) - new Date(b.date)).slice(0, 5);
  };

  const getExpiringLeases = () => {
    const today = new Date();
    const in90Days = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
    
    return tenants
      .filter(t => (t.status === 'Current' || t.status === 'current') && (t.leaseEnd || t.lease_end))
      .filter(t => {
        try {
          const leaseEnd = new Date(t.leaseEnd || t.lease_end);
          return leaseEnd >= today && leaseEnd <= in90Days;
        } catch {
          return false;
        }
      })
      .sort((a, b) => {
        const dateA = new Date(a.leaseEnd || a.lease_end || 0);
        const dateB = new Date(b.leaseEnd || b.lease_end || 0);
        return dateA - dateB;
      });
  };

  const getAllEventsForDate = (date) => {
    const dateStr = date.toDateString();
    const events = [];
    
    // Get scheduled events
    scheduleEvents.forEach(e => {
      if (new Date(e.date).toDateString() === dateStr) {
        events.push(e);
      }
    });
    
    // Get move-ins for this date
    tenants.forEach(t => {
      const moveInDate = t.moveInDate || t.move_in_date;
      if (moveInDate && new Date(moveInDate).toDateString() === dateStr) {
        const property = properties.find(p => p.id === t.property_id || p.address === t.property);
        events.push({
          title: `${t.name} - Move-In`,
          type: 'move-in',
          date: moveInDate,
          property_name: property?.name || property?.address || t.property,
          tenant_id: t.id
        });
      }
    });
    
    // Get move-outs for this date
    tenants.forEach(t => {
      const moveOutDate = t.moveOutDate || t.move_out_date;
      if (moveOutDate && new Date(moveOutDate).toDateString() === dateStr) {
        const property = properties.find(p => p.id === t.property_id || p.address === t.property);
        events.push({
          title: `${t.name} - Move-Out`,
          type: 'move-out',
          date: moveOutDate,
          property_name: property?.name || property?.address || t.property,
          tenant_id: t.id
        });
      }
    });
    
    // Add lease expirations for this date
    tenants.forEach(t => {
      const leaseEnd = t.leaseEnd || t.lease_end;
      if (leaseEnd && new Date(leaseEnd).toDateString() === dateStr) {
        const property = properties.find(p => p.id === t.property_id || p.address === t.property);
        events.push({
          title: `${t.name} - Lease Expires`,
          type: 'lease-expiration',
          date: leaseEnd,
          property_name: property?.name || property?.address || t.property,
          tenant_id: t.id
        });
      }
    });
    
    return events;
  };

  const generateCalendarDays = (date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    
    // First day of the month
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    // Day of week for first day (0 = Sunday, 6 = Saturday)
    const startDay = firstDay.getDay();
    
    // Total days in month
    const daysInMonth = lastDay.getDate();
    
    // Previous month's days to fill the grid
    const prevMonth = new Date(year, month, 0);
    const daysInPrevMonth = prevMonth.getDate();
    
    const days = [];
    
    // Add previous month's trailing days
    for (let i = startDay - 1; i >= 0; i--) {
      days.push(new Date(year, month - 1, daysInPrevMonth - i));
    }
    
    // Add current month's days
    for (let i = 1; i <= daysInMonth; i++) {
      days.push(new Date(year, month, i));
    }
    
    // Add next month's leading days to fill the grid (42 cells = 6 weeks)
    const remaining = 42 - days.length;
    for (let i = 1; i <= remaining; i++) {
      days.push(new Date(year, month + 1, i));
    }
    
    return days;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    return date.toLocaleDateString();
  };

  // Get priority badge style (kept for backward compatibility, but using CSS classes now)
  const getPriorityBadgeStyle = (priority) => {
    const priorityLower = (priority || 'medium').toLowerCase();
    const styles = {
      low: { background: '#f3f4f6', color: '#6b7280' },
      medium: { background: '#dbeafe', color: '#2563eb' },
      high: { background: '#fef3c7', color: '#d97706' },
      urgent: { background: '#fee2e2', color: '#dc2626' }
    };
    return styles[priorityLower] || styles.medium;
  };

  // Get status badge style (kept for backward compatibility, but using CSS classes now)
  const getMaintenanceStatusBadgeStyle = (status) => {
    const statusLower = (status || 'open').toLowerCase();
    // Map 'open' to 'Pending', 'in_progress' to 'Active', 'closed'/'completed' to 'Completed'
    let mappedStatus = statusLower;
    if (statusLower === 'open') mappedStatus = 'pending';
    if (statusLower === 'in_progress' || statusLower === 'in progress') mappedStatus = 'active';
    if (statusLower === 'closed' || statusLower === 'completed') mappedStatus = 'completed';
    
    const styles = {
      pending: { background: 'transparent', border: '1px solid #f59e0b', color: '#d97706' },
      active: { background: 'transparent', border: '1px solid #10b981', color: '#059669' },
      completed: { background: '#dcfce7', border: '1px solid #dcfce7', color: '#166534' }
    };
    return styles[mappedStatus] || styles.pending;
  };

  // Get status display name
  const getMaintenanceStatusDisplay = (status) => {
    const statusLower = (status || 'open').toLowerCase();
    if (statusLower === 'open') return 'Pending';
    if (statusLower === 'in_progress' || statusLower === 'in progress') return 'Active';
    if (statusLower === 'closed' || statusLower === 'completed') return 'Completed';
    return status.charAt(0).toUpperCase() + status.slice(1);
  };

  // Reports helper functions
  const getReportsStats = () => {
    try {
      // Calculate total revenue (from all current tenants' rent)
      const totalRevenue = (tenants || [])
        .filter(t => t && t.status === 'current' && (t.rentAmount || 0) > 0)
        .reduce((sum, t) => sum + (t.rentAmount || 0), 0);
      
      // Calculate total expenses (from all properties)
      const totalExpenses = (properties || []).reduce((sum, p) => {
        if (!p) return sum;
        const propertyExpenses = (p.expenses || []).reduce((expSum, exp) => expSum + (exp?.amount || 0), 0);
        return sum + propertyExpenses;
      }, 0);
      
      // Calculate net profit
      const netProfit = totalRevenue - totalExpenses;
      const profitMargin = totalRevenue > 0 ? Math.round((netProfit / totalRevenue) * 100) : 0;
      
      // Calculate average occupancy
      const totalUnits = (properties || []).reduce((sum, p) => sum + ((p?.units) || 0), 0);
      const totalOccupied = (properties || []).reduce((sum, p) => sum + ((p?.occupied) || 0), 0);
      const avgOccupancy = totalUnits > 0 ? Math.round((totalOccupied / totalUnits) * 100) : 85;
      
      // Calculate revenue change (simplified - using current vs previous period)
      const revenueChange = totalRevenue > 0 ? 5 : 0; // Placeholder - would need historical data
      
      // Calculate expenses as percentage of revenue
      const expensesPercent = totalRevenue > 0 ? Math.round((totalExpenses / totalRevenue) * 100) : 0;
      
      return {
        totalRevenue: totalRevenue || 0,
        totalExpenses: totalExpenses || 0,
        netProfit: netProfit || 0,
        profitMargin: profitMargin || 0,
        avgOccupancy: avgOccupancy || 85,
        revenueChange: revenueChange || 0,
        expensesPercent: expensesPercent || 0
      };
    } catch (error) {
      console.error('Error calculating reports stats:', error);
      return {
        totalRevenue: 0,
        totalExpenses: 0,
        netProfit: 0,
        profitMargin: 0,
        avgOccupancy: 85,
        revenueChange: 0,
        expensesPercent: 0
      };
    }
  };

  // Get revenue vs expenses data for last 6 months
  const getRevenueVsExpensesData = () => {
    // Use demo payment history if available, otherwise return sample data
    const hasDemoData = tenants.length > 10 && properties.length > 5;
    
    if (hasDemoData) {
      // Calculate from actual tenant payment logs and property expenses
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
      const months = [];
      
      for (let i = 0; i < 6; i++) {
        const monthIndex = i;
        const currentYear = 2026; // Demo data year
        
        // Calculate revenue from payment logs
        let revenue = 0;
        tenants
          .filter(t => t.status === 'current')
          .forEach(tenant => {
            if (tenant.paymentLog && tenant.paymentLog.length > 0) {
              tenant.paymentLog.forEach(payment => {
                try {
                  const paymentDate = new Date(payment.date);
                  if (paymentDate.getMonth() === monthIndex && paymentDate.getFullYear() === currentYear) {
                    revenue += payment.amount || 0;
                  }
                } catch (e) {
                  // Skip invalid dates
                }
              });
            }
          });
        
        // Calculate expenses from property expenses
        let expenses = 0;
        properties.forEach(property => {
          if (property && property.expenses && property.expenses.length > 0) {
            property.expenses.forEach(expense => {
              try {
                const expenseDate = new Date(expense.date);
                if (expenseDate.getMonth() === monthIndex && expenseDate.getFullYear() === currentYear) {
                  expenses += expense.amount || 0;
                }
              } catch (e) {
                // Skip invalid dates
              }
            });
          }
        });
        
        months.push({
          month: monthNames[i],
          revenue: Math.round(revenue) || 0,
          expenses: Math.round(expenses) || 0
        });
      }
      
      return months;
    }
    
    // Return demo payment history data
    return [
      { month: 'Jan', revenue: 28400, expenses: 4200 },
      { month: 'Feb', revenue: 28400, expenses: 3100 },
      { month: 'Mar', revenue: 29250, expenses: 6800 },
      { month: 'Apr', revenue: 29250, expenses: 2900 },
      { month: 'May', revenue: 30100, expenses: 3500 },
      { month: 'Jun', revenue: 30100, expenses: 4100 }
    ];
  };

  // Get occupancy trend data for last 6 months
  const getOccupancyTrendData = () => {
    // Return sample data with variation
    return [
      { month: 'Jan', occupancy: 45 },
      { month: 'Feb', occupancy: 50 },
      { month: 'Mar', occupancy: 52 },
      { month: 'Apr', occupancy: 50 },
      { month: 'May', occupancy: 55 },
      { month: 'Jun', occupancy: 50 }
    ];
  };

  // Get revenue by property data for pie chart
  const getRevenueByPropertyData = () => {
    try {
      // Calculate revenue per property from tenants
      const revenueMap = new Map();
      
      (tenants || [])
        .filter(t => t && t.status === 'current' && (t.rentAmount || 0) > 0)
        .forEach(tenant => {
          if (tenant.property) {
            const propertyName = tenant.property.split(',')[0] || tenant.property; // Get property address
            const currentRevenue = revenueMap.get(propertyName) || 0;
            revenueMap.set(propertyName, currentRevenue + (tenant.rentAmount || 0));
          }
        });
      
      // If we have properties but no tenant revenue, use property monthlyRevenue
      if (revenueMap.size === 0 && (properties || []).length > 0) {
        (properties || []).forEach(property => {
          if (property && property.address) {
            const revenue = property.monthlyRevenue || 0;
            if (revenue > 0) {
              revenueMap.set(property.address, revenue);
            }
          }
        });
      }
      
      // Convert map to array
      const data = Array.from(revenueMap.entries()).map(([name, value]) => ({
        name: name.length > 20 ? name.substring(0, 20) + '...' : name,
        value: Math.round(value) || 0
      }));
      
      // If no data, return placeholder
      if (data.length === 0) {
        return [
          { name: 'Property A', value: 3000 },
          { name: 'Property B', value: 2500 },
          { name: 'Property C', value: 2000 }
        ];
      }
      
      return data;
    } catch (error) {
      console.error('Error calculating revenue by property data:', error);
      return [
        { name: 'Property A', value: 3000 },
        { name: 'Property B', value: 2500 },
        { name: 'Property C', value: 2000 }
      ];
    }
  };

  // Pie chart colors
  const pieChartColors = ['#1a73e8', '#0891b2', '#10b981', '#f59e0b', '#8b5cf6'];

  const getActionItems = () => {
    const latePayments = tenants
      .filter(t => t.status === 'current' && t.paymentStatus === 'late')
      .slice(0, 5)
      .map(t => ({ type: 'late_payment', tenant: t, id: t.id }));
    
    const openMaintenance = maintenanceRequests
      .filter(r => r.status === 'open')
      .slice(0, 5)
      .map(r => ({ type: 'maintenance', request: r, id: r.id }));
    
    const leasesExpiringSoon = expiringLeases.slice(0, 5).map(t => ({
      type: 'lease_expiring',
      tenant: t,
      id: t.id
    }));
    
    // Move-outs scheduled this month
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const moveOutsScheduled = tenants
      .filter(t => {
        if (!t.moveOutDate || t.status !== 'current') return false;
        const moveOutDate = new Date(t.moveOutDate);
        return moveOutDate.getMonth() === currentMonth && moveOutDate.getFullYear() === currentYear;
      })
      .slice(0, 5)
      .map(t => ({ type: 'move_out', tenant: t, id: t.id }));
    
    return [...latePayments, ...openMaintenance, ...leasesExpiringSoon, ...moveOutsScheduled];
  };

  const getRecentActivity = () => {
    const activities = [];
    
    // Get recent payments
    tenants.forEach(tenant => {
      if (tenant.paymentLog && tenant.paymentLog.length > 0) {
        tenant.paymentLog.forEach(payment => {
          activities.push({
            type: 'payment',
            description: `Payment received: $${payment.amount.toLocaleString()} from ${tenant.name}`,
            timestamp: payment.date,
            tenantId: tenant.id
          });
        });
      }
    });
    
    // Get maintenance completed
    maintenanceRequests
      .filter(r => r.status !== 'open')
      .forEach(request => {
        activities.push({
          type: 'maintenance',
          description: `Maintenance completed: ${request.issue}`,
          timestamp: request.date,
          requestId: request.id
        });
      });
    
    // Get tenants added (from activity log)
    tenants.forEach(tenant => {
      if (tenant.activityLog && tenant.activityLog.length > 0) {
        tenant.activityLog.forEach(activity => {
          if (activity.note.toLowerCase().includes('added') || activity.note.toLowerCase().includes('created')) {
            activities.push({
              type: 'tenant_added',
              description: activity.note,
              timestamp: activity.timestamp,
              tenantId: tenant.id
            });
          }
        });
      }
    });
    
    // Sort by timestamp and return last 10
    return activities
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
      .slice(0, 10);
  };

  // Global search function
  const performGlobalSearch = (query) => {
    if (!query || !query.trim()) return { tenants: [], properties: [] };
    
    const lowerQuery = query.toLowerCase().trim();
    const matchingTenants = tenants.filter(t => {
      if (!t) return false;
      const nameMatch = t.name && t.name.toLowerCase().includes(lowerQuery);
      const propertyMatch = t.property && t.property.toLowerCase().includes(lowerQuery);
      const emailMatch = t.email && t.email.toLowerCase().includes(lowerQuery);
      return nameMatch || propertyMatch || emailMatch;
    });
    
    const matchingProperties = properties.filter(p => {
      if (!p) return false;
      const addressMatch = p.address && p.address.toLowerCase().includes(lowerQuery);
      const typeMatch = p.type && p.type.toLowerCase().includes(lowerQuery);
      return addressMatch || typeMatch;
    });
    
    return { tenants: matchingTenants, properties: matchingProperties };
  };

  const getLateTenants = () => {
    const today = new Date();
    const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    return tenants
      .filter(t => t.status === 'current' && t.paymentStatus === 'late')
      .map(tenant => {
        // Calculate days late from the 1st of current month
        const daysLate = Math.floor((today - firstOfMonth) / (1000 * 60 * 60 * 24));
        
        return {
          ...tenant,
          daysLate
        };
      })
      .sort((a, b) => b.daysLate - a.daysLate);
  };

  // Generate email reminder for a tenant
  const generateReminderEmail = (tenant) => {
    const subject = encodeURIComponent(`Rent Payment Reminder - ${tenant.property}`);
    const body = encodeURIComponent(
      `Dear ${tenant.name},\n\n` +
      `This is a reminder that your rent payment for ${tenant.property} is currently overdue.\n\n` +
      `Amount Due: $${tenant.rentAmount.toLocaleString()}\n` +
      `Property: ${tenant.property}\n\n` +
      `Please remit payment as soon as possible to avoid any additional fees.\n\n` +
      `Thank you,\nProperty Management`
    );
    return `mailto:${tenant.email}?subject=${subject}&body=${body}`;
  };

  // Send reminder email for a single tenant
  const handleSendReminder = (tenant) => {
    const mailtoLink = generateReminderEmail(tenant);
    window.location.href = mailtoLink;
  };

  // Send reminders to all late tenants
  const handleSendAllReminders = () => {
    const lateTenants = getLateTenants();
    if (lateTenants.length === 0) {
      alert('No late tenants to send reminders to');
      return;
    }

    // Get all email addresses for BCC
    const bccEmails = lateTenants
      .filter(t => t.email)
      .map(t => t.email)
      .join(',');

    if (!bccEmails) {
      alert('No email addresses found for late tenants');
      return;
    }

    // Create a summary email
    const subject = encodeURIComponent('Rent Payment Reminders - Multiple Properties');
    const body = encodeURIComponent(
      `Dear Tenants,\n\n` +
      `This is a reminder that your rent payments are currently overdue.\n\n` +
      `Please remit payment as soon as possible to avoid any additional fees.\n\n` +
      `Thank you,\nProperty Management`
    );

    // Use mailto with BCC (note: BCC support varies by email client)
    const mailtoLink = `mailto:?bcc=${encodeURIComponent(bccEmails)}&subject=${subject}&body=${body}`;
    window.location.href = mailtoLink;
  };

  // Get all audit logs from all tenants
  const getAllAuditLogs = () => {
    const allAuditLogs = [];
    tenants.forEach(tenant => {
      if (tenant.auditLog && tenant.auditLog.length > 0) {
        tenant.auditLog.forEach(audit => {
          allAuditLogs.push({
            ...audit,
            tenantId: tenant.id,
            tenantName: tenant.name,
            tenantProperty: tenant.property
          });
        });
      }
    });
    // Sort by timestamp, most recent first
    return allAuditLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  };

  // Get owner statement data for a property and month
  const getOwnerStatementData = () => {
    if (!ownerStatementProperty || !ownerStatementMonth) return null;

    const property = properties.find(p => p.id === parseInt(ownerStatementProperty));
    if (!property) return null;

    const [year, month] = ownerStatementMonth.split('-');
    const statementDate = new Date(year, month - 1, 1);
    const nextMonth = new Date(year, month, 1);

    // Get income: rent payments from tenants at this property
    const propertyAddress = property.address.toLowerCase();
    const incomeItems = [];
    let totalIncome = 0;

    tenants
      .filter(t => t.status === 'current' && t.property && t.property.toLowerCase().includes(propertyAddress))
      .forEach(tenant => {
        // Check payment log for payments in the selected month
        if (tenant.paymentLog && tenant.paymentLog.length > 0) {
          tenant.paymentLog.forEach(payment => {
            const paymentDate = new Date(payment.date);
            if (paymentDate >= statementDate && paymentDate < nextMonth) {
              incomeItems.push({
                tenantName: tenant.name,
                unit: extractUnitNumber(tenant.property),
                amount: payment.amount,
                date: payment.date,
                method: payment.method
              });
              totalIncome += payment.amount;
            }
          });
        }
        // Also check paymentDate if it's in the selected month
        if (tenant.paymentDate) {
          const paymentDate = new Date(tenant.paymentDate);
          if (paymentDate >= statementDate && paymentDate < nextMonth) {
            // Check if not already in incomeItems
            const exists = incomeItems.some(item => 
              item.tenantName === tenant.name && 
              item.date === tenant.paymentDate
            );
            if (!exists && tenant.paymentStatus === 'paid') {
              incomeItems.push({
                tenantName: tenant.name,
                unit: extractUnitNumber(tenant.property),
                amount: tenant.rentAmount,
                date: tenant.paymentDate,
                method: 'Recorded'
              });
              totalIncome += tenant.rentAmount;
            }
          }
        }
      });

    // Get expenses for the selected month
    const expenseItems = [];
    let totalExpenses = 0;

    if (property.expenses && property.expenses.length > 0) {
      property.expenses.forEach(expense => {
        const expenseDate = new Date(expense.date);
        if (expenseDate >= statementDate && expenseDate < nextMonth) {
          expenseItems.push({
            description: expense.description,
            amount: expense.amount,
            date: expense.date,
            category: expense.category || 'Other'
          });
          totalExpenses += expense.amount;
        }
      });
    }

    // Calculate management fee (10% of collected rent)
    const managementFee = totalIncome * 0.1;
    const netProfit = totalIncome - totalExpenses - managementFee;

    return {
      property,
      month: ownerStatementMonth,
      monthName: statementDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
      incomeItems: incomeItems.sort((a, b) => new Date(a.date) - new Date(b.date)),
      expenseItems: expenseItems.sort((a, b) => new Date(a.date) - new Date(b.date)),
      totalIncome,
      totalExpenses,
      managementFee,
      netProfit
    };
  };

  // Export owner statement to PDF
  const exportOwnerStatementToPDF = () => {
    const statementData = getOwnerStatementData();
    if (!statementData) {
      alert('Please select a property and month');
      return;
    }

    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 20;
    let yPos = margin;

    // Header
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('OWNER STATEMENT', pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;

    // Property and Owner Info
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    yPos += 5;
    doc.text(`Property: ${statementData.property.address}`, margin, yPos);
    yPos += 7;
    if (statementData.property.ownerName) {
      doc.text(`Owner: ${statementData.property.ownerName}`, margin, yPos);
      yPos += 7;
    }
    if (statementData.property.ownerEmail) {
      doc.text(`Email: ${statementData.property.ownerEmail}`, margin, yPos);
      yPos += 7;
    }
    doc.text(`Statement Period: ${statementData.monthName}`, margin, yPos);
    yPos += 10;

    // Income Section
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('INCOME', margin, yPos);
    yPos += 8;

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    if (statementData.incomeItems.length > 0) {
      const incomeTableData = statementData.incomeItems.map(item => [
        item.tenantName,
        item.unit || 'N/A',
        `$${item.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
        new Date(item.date).toLocaleDateString()
      ]);

      doc.autoTable({
        startY: yPos,
        head: [['Tenant', 'Unit', 'Amount', 'Date']],
        body: incomeTableData,
        theme: 'striped',
        headStyles: { fillColor: [29, 78, 216], textColor: 255, fontStyle: 'bold' },
        styles: { fontSize: 9 },
        margin: { left: margin, right: margin }
      });

      yPos = doc.lastAutoTable.finalY + 5;
    } else {
      doc.text('No income recorded for this period', margin, yPos);
      yPos += 7;
    }

    doc.setFont(undefined, 'bold');
    doc.text(`Total Income: $${statementData.totalIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, margin, yPos);
    yPos += 10;

    // Expenses Section
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('EXPENSES', margin, yPos);
    yPos += 8;

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');

    if (statementData.expenseItems.length > 0) {
      const expenseTableData = statementData.expenseItems.map(item => [
        item.description,
        item.category || 'Other',
        `$${item.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
        new Date(item.date).toLocaleDateString()
      ]);

      doc.autoTable({
        startY: yPos,
        head: [['Description', 'Category', 'Amount', 'Date']],
        body: expenseTableData,
        theme: 'striped',
        headStyles: { fillColor: [220, 38, 38], textColor: 255, fontStyle: 'bold' },
        styles: { fontSize: 9 },
        margin: { left: margin, right: margin }
      });

      yPos = doc.lastAutoTable.finalY + 5;
    } else {
      doc.text('No expenses recorded for this period', margin, yPos);
      yPos += 7;
    }

    doc.setFont(undefined, 'bold');
    doc.text(`Total Expenses: $${statementData.totalExpenses.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, margin, yPos);
    yPos += 10;

    // Summary Section
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('SUMMARY', margin, yPos);
    yPos += 8;

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Total Income: $${statementData.totalIncome.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, margin, yPos);
    yPos += 7;
    doc.text(`Total Expenses: $${statementData.totalExpenses.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, margin, yPos);
    yPos += 7;
    doc.text(`Management Fee (10%): $${statementData.managementFee.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, margin, yPos);
    yPos += 7;
    
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.text(`Net Profit: $${statementData.netProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, margin, yPos);

    // Footer
    yPos = doc.internal.pageSize.getHeight() - 20;
    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    doc.text(`Generated on ${new Date().toLocaleDateString()}`, pageWidth / 2, yPos, { align: 'center' });

    doc.save(`owner_statement_${statementData.property.address.replace(/\s+/g, '_')}_${statementData.month.replace('-', '_')}.pdf`);
  };

  // Export rent roll to PDF
  const exportRentRollToPDF = () => {
    const rentRollData = getRentRollData();
    const totals = getRentRollTotals();
    const monthName = reportMonth ? new Date(reportMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'All Time';
    
    const doc = new jsPDF();
    
    // Title
    doc.setFontSize(18);
    doc.text('Rent Roll Report', 14, 20);
    doc.setFontSize(12);
    doc.text(`Report Period: ${monthName}`, 14, 30);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 36);
    
    // Table data
    const tableData = rentRollData.map(row => [
      row.propertyAddress,
      row.unit,
      row.tenantName,
      row.leaseStart ? new Date(row.leaseStart).toLocaleDateString() : 'N/A',
      row.leaseEnd ? new Date(row.leaseEnd).toLocaleDateString() : 'N/A',
      `$${row.monthlyRent.toLocaleString()}`,
      row.paymentStatus === 'paid' ? 'Paid' : row.paymentStatus === 'late' ? 'Late' : 'Unpaid',
      row.lastPaymentDate ? new Date(row.lastPaymentDate).toLocaleDateString() : 'N/A'
    ]);

    // Add totals row
    tableData.push([
      '',
      '',
      '',
      '',
      'TOTALS',
      `$${totals.totalRent.toLocaleString()}`,
      '',
      ''
    ]);

    doc.autoTable({
      head: [['Property Address', 'Unit', 'Tenant Name', 'Lease Start', 'Lease End', 'Monthly Rent', 'Payment Status', 'Last Payment']],
      body: tableData,
      startY: 45,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [29, 78, 216], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [248, 250, 252] }
    });

    // Add summary
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text(`Total Units: ${totals.totalUnits}`, 14, finalY);
    doc.text(`Total Monthly Rent: $${totals.totalRent.toLocaleString()}`, 14, finalY + 6);
    doc.text(`Collection Rate: ${totals.collectionRate}%`, 14, finalY + 12);

    doc.save(`rent_roll_${reportMonth || 'all'}_${new Date().toISOString().split('T')[0]}.pdf`);
  };

  const [newTenant, setNewTenant] = useState({
    name: '',
    phone: '',
    email: '',
    property: '',
    rentAmount: '',
    securityDeposit: '',
    leaseStart: '',
    leaseEnd: '',
    status: 'prospect',
    paymentStatus: 'n/a',
    notes: '',
    moveInDate: '',
    moveInNotes: ''
  });

  const filteredTenants = tenants.filter(t => {
    // Status filter
    let matchesStatus = true;
    if (filterStatus !== 'all') {
      if (filterStatus === 'late') {
        matchesStatus = t.paymentStatus === 'late';
      } else if (filterStatus === 'expiring') {
        // Filter to show only expiring leases
        matchesStatus = expiringLeaseIds.includes(t.id);
      } else {
        matchesStatus = t.status === filterStatus;
      }
    }
    
    // Search filter
    const matchesSearch = !tenantSearchQuery || tenantSearchQuery.trim() === '' || 
      (t.name && t.name.toLowerCase().includes(tenantSearchQuery.toLowerCase())) ||
      (t.property && t.property.toLowerCase().includes(tenantSearchQuery.toLowerCase()));
    
    // Tag filter
    let matchesTags = true;
    if (selectedTagFilters.length > 0) {
      const tenantTagIds = getTagsForRecord('tenant', t.id).map(tag => tag.id);
      matchesTags = selectedTagFilters.every(filterTagId => tenantTagIds.includes(filterTagId));
    }
    
    return matchesStatus && matchesSearch && matchesTags;
  });

  const handleTogglePaymentStatus = async (tenantId, e) => {
    e.stopPropagation();
    const tenant = tenants.find(t => t.id === tenantId);
    const newStatus = tenant.paymentStatus === 'paid' ? 'late' : 'paid';
    
    // Show confirmation only when marking as late
    if (newStatus === 'late') {
      setConfirmPaymentChange({ tenantId, tenantName: tenant.name, newStatus });
    } else {
      // Mark as paid immediately without confirmation
      const updatedTenant = { ...tenant, paymentStatus: 'paid', paymentDate: new Date().toISOString().split('T')[0] };
      const { error } = await supabase
        .from('tenants')
        .update({ 
          payment_status: 'paid', 
          payment_date: new Date().toISOString().split('T')[0] 
        })
        .eq('id', tenantId);
      
      if (!error) {
        setTenants(tenants.map(t => t.id === tenantId ? updatedTenant : t));
      } else {
        console.error('Error updating payment status:', error);
        alert('Error updating payment status');
      }
    }
  };

  const confirmPaymentChangeAction = async () => {
    if (confirmPaymentChange) {
      const { error } = await supabase
        .from('tenants')
        .update({ 
          payment_status: confirmPaymentChange.newStatus, 
          payment_date: new Date().toISOString().split('T')[0] 
        })
        .eq('id', confirmPaymentChange.tenantId);
      
      if (!error) {
        setTenants(tenants.map(t => 
          t.id === confirmPaymentChange.tenantId 
            ? { ...t, paymentStatus: confirmPaymentChange.newStatus, paymentDate: new Date().toISOString().split('T')[0] }
            : t
        ));
        setConfirmPaymentChange(null);
      } else {
        console.error('Error updating payment status:', error);
        alert('Error updating payment status');
      }
    }
  };

  const handleDeleteTenant = (tenantId, e) => {
    e.stopPropagation();
    const tenant = tenants.find(t => t.id === tenantId);
    setConfirmDelete({ tenantId, tenantName: tenant.name });
  };

  const confirmDeleteAction = async () => {
    if (confirmDelete) {
      const { error } = await supabase
        .from('tenants')
        .delete()
        .eq('id', confirmDelete.tenantId);
      
      if (!error) {
        setTenants(tenants.filter(t => t.id !== confirmDelete.tenantId));
        setConfirmDelete(null);
        if (selectedTenant && selectedTenant.id === confirmDelete.tenantId) {
          setSelectedTenant(null);
        }
      } else {
        console.error('Error deleting tenant:', error);
        alert('Error deleting tenant');
      }
    }
  };

  const exportToCSV = () => {
    const headers = ['Name', 'Phone', 'Email', 'Property', 'Rent Amount', 'Security Deposit', 'Status', 'Payment Status', 'Payment Date', 'Lease Start', 'Lease End', 'Notes'];
    const rows = tenants.map(tenant => [
      tenant.name,
      tenant.phone,
      tenant.email,
      tenant.property,
      tenant.rentAmount || '',
      tenant.securityDeposit || '',
      tenant.status,
      tenant.paymentStatus,
      tenant.paymentDate || '',
      tenant.leaseStart || '',
      tenant.leaseEnd || '',
      tenant.notes || ''
    ]);

    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `tenants_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Get leases expiring within 90 days
  const expiringLeases = tenants.filter(t => {
    if (!t.leaseEnd || t.status !== 'current') return false;
    const endDate = new Date(t.leaseEnd);
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Normalize to start of day
    const daysUntilExpiry = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
    return daysUntilExpiry <= 90 && daysUntilExpiry >= 0;
  });

  // Update expiring lease IDs when expiringLeases changes
  useEffect(() => {
    const ids = expiringLeases.map(t => t.id);
    const idsString = ids.sort().join(',');
    const currentIdsString = expiringLeaseIds.sort().join(',');
    if (idsString !== currentIdsString) {
      setExpiringLeaseIds(ids);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [expiringLeases.length, expiringLeases.map(t => `${t.id}-${t.leaseEnd}`).join(',')]);

  // Save dismissed banners to localStorage
  useEffect(() => {
    localStorage.setItem('propli_dismissedBanners', JSON.stringify(dismissedBanners));
  }, [dismissedBanners]);

  const stats = {
    totalTenants: tenants.filter(t => t.status === 'current').length,
    prospects: tenants.filter(t => t.status === 'prospect').length,
    latePayments: tenants.filter(t => t.paymentStatus === 'late').length,
    totalUnits: properties.reduce((acc, p) => acc + p.units, 0),
    occupiedUnits: properties.reduce((acc, p) => acc + p.occupied, 0),
    monthlyRevenue: properties.reduce((acc, p) => acc + p.monthlyRevenue, 0),
    expiringLeases: expiringLeases.length
  };

  const handleAddPayment = async (tenantId, e) => {
    e?.stopPropagation();
    if (!newPayment.amount) return;
    const tenant = tenants.find(t => t.id === tenantId);
    const payment = {
      id: Date.now(),
      amount: Number(newPayment.amount),
      method: newPayment.method,
      date: newPayment.date,
      timestamp: new Date().toISOString()
    };
    const updatedPaymentLog = [...(tenant.paymentLog || []), payment];
    
    const { error } = await supabase
      .from('tenants')
      .update({ 
        payment_log: updatedPaymentLog,
        payment_status: 'paid',
        payment_date: newPayment.date
      })
      .eq('id', tenantId);
    
    if (!error) {
      setTenants(tenants.map(t => 
        t.id === tenantId 
          ? { 
              ...t, 
              paymentLog: updatedPaymentLog,
              paymentStatus: 'paid',
              paymentDate: newPayment.date
            }
          : t
      ));
      setNewPayment({ amount: '', method: 'cash', date: new Date().toISOString().split('T')[0] });
      setShowPaymentLog(null);
    } else {
      console.error('Error adding payment:', error);
      alert('Error adding payment');
    }
  };

  const handleAddActivity = async (tenantId, e) => {
    e?.stopPropagation();
    if (!newActivityNote.trim()) return;
    const tenant = tenants.find(t => t.id === tenantId);
    const activity = {
      id: Date.now(),
      note: newActivityNote,
      timestamp: new Date().toISOString()
    };
    const updatedActivityLog = [...(tenant.activityLog || []), activity];
    
    const { error } = await supabase
      .from('tenants')
      .update({ activity_log: updatedActivityLog })
      .eq('id', tenantId);
    
    if (!error) {
      setTenants(tenants.map(t => 
        t.id === tenantId 
          ? { ...t, activityLog: updatedActivityLog }
          : t
      ));
      setNewActivityNote('');
      setShowActivityLog(null);
    } else {
      console.error('Error adding activity:', error);
      alert('Error adding activity');
    }
  };

  const handleLeaseDocumentUpload = async (tenantId, e) => {
    e?.stopPropagation();
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.type !== 'application/pdf') {
      alert('Please upload a PDF file');
      return;
    }

    const tenant = tenants.find(t => t.id === tenantId);
    if (!tenant || !user) return;

    try {
      // Create file path: user_id/tenant_id/filename
      const filePath = `${user.id}/${tenantId}/${Date.now()}_${file.name}`;
      
      // Upload file to Supabase Storage
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('lease-documents')
        .upload(filePath, file, {
          cacheControl: '3600',
          upsert: false
        });

      if (uploadError) {
        console.error('Error uploading lease document:', uploadError);
        alert(`Error uploading lease document: ${uploadError.message}`);
        return;
      }

      // Get public URL for the uploaded file
      const { data: urlData } = supabase.storage
        .from('lease-documents')
        .getPublicUrl(filePath);

      // Create document record
      const document = {
        id: Date.now() + Math.random(),
        name: file.name,
        path: filePath,
        url: urlData.publicUrl,
        uploadedAt: new Date().toISOString(),
        size: file.size
      };

      // Update tenant's lease_documents array
      const updatedDocuments = [...(tenant.leaseDocuments || []), document];
      
      const { error: updateError } = await supabase
        .from('tenants')
        .update({ lease_documents: updatedDocuments })
        .eq('id', tenantId);

      if (updateError) {
        console.error('Error updating tenant documents:', updateError);
        alert('Error saving document record');
        // Try to delete the uploaded file
        await supabase.storage.from('lease-documents').remove([filePath]);
        return;
      }

      // Add activity log entry
      const activity = {
        id: Date.now(),
        note: `Lease document "${file.name}" uploaded`,
        timestamp: new Date().toISOString()
      };
      const updatedActivityLog = [...(tenant.activityLog || []), activity];
      
      await supabase
        .from('tenants')
        .update({ activity_log: updatedActivityLog })
        .eq('id', tenantId);

      // Update local state
      setTenants(tenants.map(t => 
        t.id === tenantId 
          ? { ...t, leaseDocuments: updatedDocuments, activityLog: updatedActivityLog }
          : t
      ));

      // Update selectedTenant if it's the same tenant
      if (selectedTenant && selectedTenant.id === tenantId) {
        setSelectedTenant({ ...selectedTenant, leaseDocuments: updatedDocuments, activityLog: updatedActivityLog });
      }

      // Reset file input
      e.target.value = '';
    } catch (error) {
      console.error('Error uploading lease document:', error);
      alert('Error uploading lease document');
    }
  };

  const handleDeleteLeaseDocument = async (tenantId, documentId, documentPath) => {
    if (!confirm('Are you sure you want to delete this document?')) return;

    const tenant = tenants.find(t => t.id === tenantId);
    if (!tenant) return;

    try {
      // Delete file from storage
      const { error: deleteError } = await supabase.storage
        .from('lease-documents')
        .remove([documentPath]);

      if (deleteError) {
        console.error('Error deleting file from storage:', deleteError);
        alert('Error deleting file from storage');
        return;
      }

      // Remove document from tenant's lease_documents array
      const updatedDocuments = (tenant.leaseDocuments || []).filter(doc => doc.id !== documentId);
      
      const { error: updateError } = await supabase
        .from('tenants')
        .update({ lease_documents: updatedDocuments })
        .eq('id', tenantId);

      if (updateError) {
        console.error('Error updating tenant documents:', updateError);
        alert('Error updating document list');
        return;
      }

      // Add activity log entry
      const deletedDoc = tenant.leaseDocuments.find(doc => doc.id === documentId);
      const activity = {
        id: Date.now(),
        note: `Lease document "${deletedDoc?.name || 'document'}" deleted`,
        timestamp: new Date().toISOString()
      };
      const updatedActivityLog = [...(tenant.activityLog || []), activity];
      
      await supabase
        .from('tenants')
        .update({ activity_log: updatedActivityLog })
        .eq('id', tenantId);

      // Update local state
      setTenants(tenants.map(t => 
        t.id === tenantId 
          ? { ...t, leaseDocuments: updatedDocuments, activityLog: updatedActivityLog }
          : t
      ));

      // Update selectedTenant if it's the same tenant
      if (selectedTenant && selectedTenant.id === tenantId) {
        setSelectedTenant({ ...selectedTenant, leaseDocuments: updatedDocuments, activityLog: updatedActivityLog });
      }
    } catch (error) {
      console.error('Error deleting lease document:', error);
      alert('Error deleting lease document');
    }
  };

  const handleMoveOut = async (tenantId, e) => {
    e?.preventDefault();
    if (!moveOutData.date) {
      alert('Please enter a move-out date');
      return;
    }

    const tenant = tenants.find(t => t.id === tenantId);
    if (!tenant) return;

    try {
      // Calculate total deductions
      const totalDeductions = moveOutData.deductions
        .filter(d => d.description && d.amount)
        .reduce((sum, d) => sum + Number(d.amount) || 0, 0);

      // Calculate refund amount
      const refundAmount = Math.max(0, tenant.securityDeposit - totalDeductions);

      // Prepare deductions array (only include valid entries)
      const validDeductions = moveOutData.deductions
        .filter(d => d.description && d.amount)
        .map(d => ({
          id: Date.now() + Math.random(),
          description: d.description,
          amount: Number(d.amount) || 0,
          date: new Date().toISOString()
        }));

      // Update tenant with move-out information
      const updatedTenant = {
        ...tenant,
        status: 'past',
        moveOutDate: moveOutData.date,
        moveOutNotes: moveOutData.notes || '',
        depositDeductions: validDeductions,
        depositRefundAmount: refundAmount,
        refundStatus: 'pending'
      };

      const { data, error } = await supabase
        .from('tenants')
        .update(transformTenantForDB(updatedTenant))
        .eq('id', tenantId)
        .select()
        .single();

      if (error) {
        console.error('Error recording move-out:', error);
        alert('Error recording move-out');
        return;
      }

      // Add activity log entry
      const activity = {
        id: Date.now(),
        note: `Move-out recorded on ${new Date(moveOutData.date).toLocaleDateString()}. Refund: $${refundAmount.toLocaleString()}`,
        timestamp: new Date().toISOString()
      };
      const updatedActivityLog = [...(tenant.activityLog || []), activity];
      
      await supabase
        .from('tenants')
        .update({ activity_log: updatedActivityLog })
        .eq('id', tenantId);

      // Update local state
      const transformedTenant = transformTenant({ ...data, activity_log: updatedActivityLog });
      setTenants(tenants.map(t => t.id === tenantId ? transformedTenant : t));

      // Update selectedTenant if it's the same tenant
      if (selectedTenant && selectedTenant.id === tenantId) {
        setSelectedTenant(transformedTenant);
      }

      // Reset form and close modal
      setMoveOutData({ date: new Date().toISOString().split('T')[0], notes: '', deductions: [{ description: '', amount: '' }] });
      setShowMoveOutModal(null);
    } catch (error) {
      console.error('Error recording move-out:', error);
      alert('Error recording move-out');
    }
  };

  // Owner management functions
  const handleAddOwner = async (e) => {
    e.preventDefault();
    if (!user) return;
    
    if (!newOwner.name || !newOwner.email) {
      alert('Name and Email are required');
      return;
    }

    try {
      const { data, error } = await supabase
        .from('owners')
        .insert([{
          user_id: user.id,
          name: newOwner.name,
          email: newOwner.email,
          phone: newOwner.phone || null,
          address: newOwner.address || null,
          management_fee_percent: newOwner.managementFeePercent || 10,
          portal_enabled: newOwner.portalEnabled || false
        }])
        .select()
        .single();

      if (error) {
        console.error('Error adding owner:', error);
        alert('Error adding owner: ' + error.message);
        return;
      }

      setOwners([transformOwner(data), ...owners]);
      setNewOwner({ name: '', email: '', phone: '', address: '', managementFeePercent: 10, portalEnabled: false });
      setShowAddOwnerModal(false);
    } catch (error) {
      console.error('Error adding owner:', error);
      alert('Error adding owner');
    }
  };

  const handleUpdateOwner = async (e) => {
    e.preventDefault();
    if (!user || !selectedOwner) return;

    try {
      const { data, error } = await supabase
        .from('owners')
        .update({
          name: selectedOwner.name,
          email: selectedOwner.email,
          phone: selectedOwner.phone || null,
          address: selectedOwner.address || null,
          management_fee_percent: selectedOwner.managementFeePercent || 10,
          portal_enabled: selectedOwner.portalEnabled || false
        })
        .eq('id', selectedOwner.id)
        .select()
        .single();

      if (error) {
        console.error('Error updating owner:', error);
        alert('Error updating owner: ' + error.message);
        return;
      }

      setOwners(owners.map(o => o.id === selectedOwner.id ? transformOwner(data) : o));
      setShowEditOwnerModal(false);
      setSelectedOwner(transformOwner(data));
    } catch (error) {
      console.error('Error updating owner:', error);
      alert('Error updating owner');
    }
  };

  const handleDeleteOwner = async (ownerId) => {
    if (!confirm('Are you sure you want to delete this owner? This will unassign all their properties.')) return;

    try {
      // Unassign properties from this owner
      await supabase
        .from('properties')
        .update({ owner_id: null })
        .eq('owner_id', ownerId);

      // Delete owner
      const { error } = await supabase
        .from('owners')
        .delete()
        .eq('id', ownerId);

      if (error) throw error;

      setOwners(owners.filter(o => o.id !== ownerId));
      setSelectedOwner(null);
      // Update properties to remove owner reference
      setProperties(properties.map(p => p.ownerId === ownerId ? { ...p, ownerId: null } : p));
    } catch (error) {
      console.error('Error deleting owner:', error);
      alert('Error deleting owner: ' + error.message);
    }
  };

  const handleToggleOwnerPortal = async (ownerId, enabled) => {
    try {
      const { data, error } = await supabase
        .from('owners')
        .update({ portal_enabled: enabled })
        .eq('id', ownerId)
        .select()
        .single();

      if (error) throw error;

      setOwners(owners.map(o => o.id === ownerId ? transformOwner(data) : o));
      if (selectedOwner && selectedOwner.id === ownerId) {
        setSelectedOwner(transformOwner(data));
      }
    } catch (error) {
      console.error('Error toggling owner portal:', error);
      alert('Error updating portal access');
    }
  };

  const getOwnerPortalLink = (owner) => {
    if (!owner || !owner.portalToken) return '';
    const baseUrl = window.location.origin;
    return `${baseUrl}/tenant-portal?owner=${owner.portalToken}`;
  };

  const sendOwnerPortalInvite = (owner) => {
    const link = getOwnerPortalLink(owner);
    const subject = encodeURIComponent('Owner Portal Access - Propli');
    const body = encodeURIComponent(`Hello ${owner.name},\n\nYou now have access to the Propli Owner Portal. Click the link below to access your account:\n\n${link}\n\nBest regards,\nPropli Team`);
    window.location.href = `mailto:${owner.email}?subject=${subject}&body=${body}`;
  };

  // Load owner properties from junction table
  const loadOwnerProperties = async () => {
    try {
      const { data, error } = await supabase.from('owner_properties').select('*');
      if (error) {
        console.error('Error loading owner_properties:', error);
        setOwnerProperties([]);
        return;
      }
      setOwnerProperties(data || []);
    } catch (err) {
      console.error('Error loading owner_properties:', err);
      setOwnerProperties([]);
    }
  };

  // Load owner distributions
  const loadOwnerDistributions = async () => {
    try {
      const { data, error } = await supabase
        .from('owner_distributions')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) {
        console.error('Error loading owner_distributions:', error);
        setOwnerDistributions([]);
        return;
      }
      setOwnerDistributions(data || []);
    } catch (err) {
      console.error('Error loading owner_distributions:', err);
      setOwnerDistributions([]);
    }
  };

  // Get properties for a specific owner (using junction table)
  const getOwnerPropertiesById = (ownerId) => {
    const ownerPropIds = ownerProperties
      .filter(op => op.owner_id === ownerId)
      .map(op => ({ propertyId: op.property_id, ownership_percentage: op.ownership_percentage }));
    
    return ownerPropIds.map(op => {
      const property = properties.find(p => p.id === op.propertyId);
      return property ? { ...property, ownership_percentage: op.ownership_percentage } : null;
    }).filter(Boolean);
  };

  // Get total revenue for owner
  const getOwnerRevenue = (ownerId) => {
    const ownerProps = getOwnerPropertiesById(ownerId);
    
    let totalRevenue = 0;
    ownerProps.forEach(prop => {
      // Find all current tenants in this property
      // Check both property_id (numeric) and property (string address) fields
      const propTenants = tenants.filter(t => {
        const matchesProperty = t.property_id === prop.id || 
                                (t.property && prop.address && t.property.includes(prop.address)) ||
                                (t.property && prop.name && t.property.includes(prop.name));
        const isCurrent = (t.status === 'Current' || t.status === 'current' || t.status === 'Late' || t.status === 'late');
        return matchesProperty && isCurrent;
      });
      
      // Sum their rent (check both rentAmount and rent fields)
      const propRent = propTenants.reduce((sum, t) => {
        const rent = parseFloat(t.rentAmount || t.rent || 0);
        return sum + rent;
      }, 0);
      
      // Apply ownership percentage
      const ownerShare = propRent * ((prop.ownership_percentage || 100) / 100);
      totalRevenue += ownerShare;
    });
    
    return Math.round(totalRevenue);
  };

  // Get pending distribution amount for owner
  const getPendingDistribution = (ownerId) => {
    const revenue = getOwnerRevenue(ownerId);
    const owner = owners.find(o => o.id === ownerId);
    const managementFee = owner?.managementFeePercent || 10;
    return Math.round(revenue * (100 - managementFee) / 100);
  };

  // Get distributions for owner
  const getOwnerDistributionsById = (ownerId) => {
    return ownerDistributions.filter(d => d.owner_id === ownerId);
  };

  // Assign property to owner
  const assignPropertyToOwner = async () => {
    if (!assignPropertyId || !selectedOwner) {
      showToast('Please select a property', 'error');
      return;
    }
    
    try {
      const { error } = await supabase.from('owner_properties').insert({
        owner_id: selectedOwner.id,
        property_id: parseInt(assignPropertyId),
        ownership_percentage: parseFloat(assignOwnershipPct) || 100
      });
      
      if (error) throw error;
      
      await loadOwnerProperties();
      setShowAssignPropertyModal(false);
      setAssignPropertyId('');
      setAssignOwnershipPct('100');
      showToast('Property assigned successfully', 'success');
    } catch (err) {
      console.error('Failed to assign property:', err);
      showToast('Failed to assign property: ' + (err.message || 'Unknown error'), 'error');
    }
  };

  // Unassign property from owner
  const unassignProperty = async (ownerId, propertyId) => {
    if (!confirm('Remove this property from the owner?')) return;
    
    try {
      const { error } = await supabase
        .from('owner_properties')
        .delete()
        .eq('owner_id', ownerId)
        .eq('property_id', propertyId);
      
      if (error) throw error;
      
      await loadOwnerProperties();
      showToast('Property removed from owner', 'success');
    } catch (err) {
      console.error('Failed to unassign property:', err);
      showToast('Failed to remove property: ' + (err.message || 'Unknown error'), 'error');
    }
  };

  // Toggle owner portal access
  const toggleOwnerPortal = async (owner) => {
    try {
      const newStatus = !owner.portalEnabled;
      
      // If enabling, generate a portal token
      const updates = {
        portal_enabled: newStatus,
        portal_token: newStatus ? crypto.randomUUID() : null
      };
      
      const { data, error } = await supabase
        .from('owners')
        .update(updates)
        .eq('id', owner.id)
        .select()
        .single();
      
      if (error) throw error;
      
      setOwners(owners.map(o => o.id === owner.id ? transformOwner(data) : o));
      if (selectedOwner && selectedOwner.id === owner.id) {
        setSelectedOwner(transformOwner(data));
      }
      
      if (newStatus) {
        showToast(`Portal enabled for ${owner.name}. They can now log in.`, 'success');
      } else {
        showToast(`Portal disabled for ${owner.name}`, 'success');
      }
    } catch (err) {
      console.error('Failed to toggle portal:', err);
      showToast('Failed to update portal access', 'error');
    }
  };

  // Open owner detail modal
  const openOwnerDetail = (owner) => {
    setSelectedOwner(owner);
    setShowOwnerDetailModal(true);
  };

  // Open owner statement modal
  const openOwnerStatement = (owner) => {
    setSelectedOwner(owner);
    setStatementPeriod({
      start: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0],
      end: new Date().toISOString().split('T')[0]
    });
    setShowOwnerStatementModal(true);
  };

  // Record distribution payment
  const recordDistribution = async (owner) => {
    try {
      const amount = getPendingDistribution(owner.id);
      
      const { error } = await supabase.from('owner_distributions').insert({
        owner_id: owner.id,
        amount: amount,
        period_start: statementPeriod.start,
        period_end: statementPeriod.end,
        status: 'pending',
        created_at: new Date().toISOString()
      });
      
      if (error) throw error;
      
      await loadOwnerDistributions();
      showToast(`Distribution of $${amount.toLocaleString()} recorded`, 'success');
      setShowOwnerStatementModal(false);
    } catch (err) {
      console.error('Failed to record distribution:', err);
      showToast('Failed to record distribution', 'error');
    }
  };

  // Owner Portal Login
  const handleOwnerPortalLogin = async (e) => {
    e.preventDefault();
    setPortalLoading(true);
    setPortalError('');
    
    try {
      // Find owner by email with portal enabled
      const { data: owner, error } = await supabase
        .from('owners')
        .select('*')
        .eq('email', portalEmail.toLowerCase().trim())
        .eq('portal_enabled', true)
        .single();
      
      if (error || !owner) {
        setPortalError('Invalid email or portal access not enabled. Please contact your property manager.');
        setPortalLoading(false);
        return;
      }
      
      // For now, simple email-based auth (in production, use proper password hashing)
      // Check if portal_token matches or use email-based magic link
      setPortalOwner(transformOwner(owner));
      setOwnerPortalView('dashboard');
      
      // Update last login
      await supabase
        .from('owners')
        .update({ portal_last_login: new Date().toISOString() })
        .eq('id', owner.id);
        
    } catch (err) {
      console.error('Portal login error:', err);
      setPortalError('Login failed. Please try again.');
    }
    
    setPortalLoading(false);
  };

  // Owner Portal Logout
  const handleOwnerPortalLogout = () => {
    setPortalOwner(null);
    setOwnerPortalView('login');
    setPortalEmail('');
    setPortalPassword('');
  };

  const handleAddExpense = async (propertyId, e) => {
    e?.preventDefault();
    if (!newExpense.description || !newExpense.amount) return;
    const property = properties.find(p => p.id === propertyId);
    const expense = {
      id: Date.now(),
      description: newExpense.description,
      amount: Number(newExpense.amount),
      date: newExpense.date,
      category: newExpense.category,
      timestamp: new Date().toISOString()
    };
    const updatedExpenses = [...(property.expenses || []), expense];
    
    const { error } = await supabase
      .from('properties')
      .update({ expenses: updatedExpenses })
      .eq('id', propertyId);
    
    if (!error) {
      setProperties(properties.map(p => 
        p.id === propertyId 
          ? { ...p, expenses: updatedExpenses }
          : p
      ));
      setNewExpense({ description: '', amount: '', date: new Date().toISOString().split('T')[0], category: 'repair' });
      setShowExpenseModal(null);
    } else {
      console.error('Error adding expense:', error);
      alert('Error adding expense');
    }
  };

  const uploadPropertyPhoto = async (file, propertyId = null) => {
    if (!file || !user) return null;
    
    setPropertyPhotoUploading(true);
    try {
      const fileExt = file.name.split('.').pop();
      const fileName = propertyId 
        ? `${user.id}/${propertyId}.${fileExt}`
        : `${user.id}/temp_${Date.now()}.${fileExt}`;
      
      const { error: uploadError } = await supabase.storage
        .from('property-photos')
        .upload(fileName, file, { upsert: true });
      
      if (uploadError) {
        console.error('Error uploading photo:', uploadError);
        throw uploadError;
      }
      
      const { data: { publicUrl } } = supabase.storage
        .from('property-photos')
        .getPublicUrl(fileName);
      
      return publicUrl;
    } catch (error) {
      console.error('Error uploading photo:', error);
      alert('Error uploading photo');
      return null;
    } finally {
      setPropertyPhotoUploading(false);
    }
  };

  const handleAddProperty = async (e) => {
    e.preventDefault();
    
    let photoUrl = null;
    if (newProperty.photo) {
      photoUrl = await uploadPropertyPhoto(newProperty.photo);
      if (!photoUrl) return; // Stop if photo upload failed
    }
    
    const propertyData = {
      address: newProperty.address,
      units: Number(newProperty.units) || 0,
      type: newProperty.type || null,
      occupied: Number(newProperty.occupied) || 0,
      monthlyRevenue: Number(newProperty.monthlyRevenue) || 0,
      photoUrl: photoUrl,
      expenses: [],
      ownerName: newProperty.ownerName || '',
      ownerEmail: newProperty.ownerEmail || '',
      ownerId: newProperty.ownerId || null
    };
    
    const { data, error } = await supabase
      .from('properties')
      .insert([transformPropertyForDB(propertyData)])
      .select()
      .single();
    
    if (error) {
      console.error('Error adding property:', error);
      alert('Error adding property');
      return;
    }
    
    // Rename temp photo file to use property ID
    if (photoUrl && data.id) {
      const tempFileName = photoUrl.split('/').pop();
      const fileExt = tempFileName.split('.').pop();
      const newFileName = `${user.id}/${data.id}.${fileExt}`;
      const oldFileName = `${user.id}/${tempFileName}`;
      
      // Copy to new name and delete old
      const { data: copyData } = await supabase.storage
        .from('property-photos')
        .copy(oldFileName, newFileName);
      
      if (copyData) {
        await supabase.storage
          .from('property-photos')
          .remove([oldFileName]);
        
        const { data: { publicUrl } } = supabase.storage
          .from('property-photos')
          .getPublicUrl(newFileName);
        
        // Update property with correct URL
        await supabase
          .from('properties')
          .update({ photo_url: publicUrl })
          .eq('id', data.id);
        
        propertyData.photoUrl = publicUrl;
      }
    }
    
    setProperties([transformProperty({ ...data, photo_url: propertyData.photoUrl }), ...properties]);
    setNewProperty({ address: '', units: '', type: '', occupied: '', monthlyRevenue: '', photo: null, ownerName: '', ownerEmail: '', ownerId: null });
    setShowAddPropertyModal(false);
  };

  const handleUpdateProperty = async (e) => {
    e.preventDefault();
    
    if (!editingProperty) return;
    
    let photoUrl = editingProperty.photoUrl;
    if (editingProperty.photo && editingProperty.photo instanceof File) {
      photoUrl = await uploadPropertyPhoto(editingProperty.photo);
      if (!photoUrl) return; // Stop if photo upload failed
      
      // Rename temp photo file to use property ID
      if (photoUrl && editingProperty.id) {
        const tempFileName = photoUrl.split('/').pop();
        const fileExt = tempFileName.split('.').pop();
        const newFileName = `${user.id}/${editingProperty.id}.${fileExt}`;
        const oldFileName = `${user.id}/${tempFileName}`;
        
        // Copy to new name and delete old
        const { data: copyData } = await supabase.storage
          .from('property-photos')
          .copy(oldFileName, newFileName);
        
        if (copyData) {
          await supabase.storage
            .from('property-photos')
            .remove([oldFileName]);
          
          const { data: { publicUrl } } = supabase.storage
            .from('property-photos')
            .getPublicUrl(newFileName);
          
          photoUrl = publicUrl;
        }
      }
    }
    
    const propertyData = {
      address: editingProperty.address,
      units: Number(editingProperty.units) || 0,
      type: editingProperty.type || null,
      occupied: Number(editingProperty.occupied) || 0,
      monthlyRevenue: Number(editingProperty.monthlyRevenue) || 0,
      photoUrl: photoUrl,
      ownerName: editingProperty.ownerName || '',
      ownerEmail: editingProperty.ownerEmail || '',
      ownerId: editingProperty.ownerId || null
    };
    
    const { data, error } = await supabase
      .from('properties')
      .update(transformPropertyForDB(propertyData))
      .eq('id', editingProperty.id)
      .select()
      .single();
    
    if (error) {
      console.error('Error updating property:', error);
      alert('Error updating property');
      return;
    }
    
    setProperties(properties.map(p => p.id === editingProperty.id ? transformProperty({ ...data, photo_url: photoUrl }) : p));
    setEditingProperty(null);
    setSelectedProperty(null);
  };

  const handleDeleteProperty = async (propertyId) => {
    const { error } = await supabase
      .from('properties')
      .delete()
      .eq('id', propertyId);
    
    if (error) {
      console.error('Error deleting property:', error);
      alert('Error deleting property');
    } else {
      setProperties(properties.filter(p => p.id !== propertyId));
      setSelectedProperty(null);
      setShowDeletePropertyConfirm(null);
    }
  };

  const handleRemovePropertyPhoto = async (propertyId) => {
    if (!confirm('Are you sure you want to remove this photo?')) return;
    
    const property = properties.find(p => p.id === propertyId);
    if (property && property.photoUrl) {
      // Extract filename from URL
      const urlParts = property.photoUrl.split('/');
      const fileName = urlParts[urlParts.length - 1];
      const fullPath = `${user.id}/${fileName}`;
      
      // Delete from storage
      await supabase.storage
        .from('property-photos')
        .remove([fullPath]);
      
      // Update property
      const { data, error } = await supabase
        .from('properties')
        .update({ photo_url: null })
        .eq('id', propertyId)
        .select()
        .single();
      
      if (!error) {
        setProperties(properties.map(p => p.id === propertyId ? transformProperty({ ...data, photo_url: null }) : p));
        if (selectedProperty && selectedProperty.id === propertyId) {
          setSelectedProperty({ ...selectedProperty, photoUrl: null });
        }
      }
    }
  };

  const handlePropertyPhotoUpdate = async (propertyId, file) => {
    if (!file || !user) return;
    
    setPropertyPhotoUploading(true);
    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `${user.id}/${propertyId}.${fileExt}`;
      
      const { error: uploadError } = await supabase.storage
        .from('property-photos')
        .upload(fileName, file, { upsert: true });
      
      if (uploadError) {
        console.error('Error uploading photo:', uploadError);
        alert('Error uploading photo');
        return;
      }
      
      const { data: { publicUrl } } = supabase.storage
        .from('property-photos')
        .getPublicUrl(fileName);
      
      const { error: updateError } = await supabase
        .from('properties')
        .update({ photo_url: publicUrl })
        .eq('id', propertyId);
      
      if (updateError) {
        console.error('Error updating property:', updateError);
        alert('Error updating property');
        return;
      }
      
      setProperties(properties.map(p => 
        p.id === propertyId 
          ? { ...p, photoUrl: publicUrl }
          : p
      ));
      
      if (selectedProperty && selectedProperty.id === propertyId) {
        setSelectedProperty({ ...selectedProperty, photoUrl: publicUrl });
      }
    } catch (error) {
      console.error('Error updating photo:', error);
      alert('Error updating photo');
    } finally {
      setPropertyPhotoUploading(false);
    }
  };

  // Load demo data function
  const loadDemoData = async () => {
    if (!user) {
      alert('Please log in first');
      return;
    }

    if (!confirm('This will replace all existing data with comprehensive demo data. This includes 8 properties, 35 tenants, 20 maintenance requests, and 12 months of payment/expense history. Continue?')) {
      return;
    }

    setLoading(true);
    try {
      // First, delete all existing data
      await supabase.from('maintenance_requests').delete().eq('user_id', user.id);
      await supabase.from('tenants').delete().eq('user_id', user.id);
      await supabase.from('properties').delete().eq('user_id', user.id);

      // Create properties with 12 months of expense data
      const propertiesWithExpenses = demoProperties.map((prop, index) => {
        const expenses = [];
        const expenseCategories = ['maintenance', 'utilities', 'insurance', 'repairs', 'landscaping', 'cleaning'];
        
        // Generate 12 months of expenses (Jan 2025 - Dec 2025 and Jan 2026)
        for (let month = 1; month <= 12; month++) {
          const year = month <= 12 ? 2025 : 2026;
          const monthNum = month <= 12 ? month : month - 12;
          
          // Each property gets 2-4 expenses per month
          const numExpenses = 2 + Math.floor(Math.random() * 3);
          for (let i = 0; i < numExpenses; i++) {
            const category = expenseCategories[Math.floor(Math.random() * expenseCategories.length)];
            const baseAmount = category === 'utilities' ? 200 : category === 'insurance' ? 150 : category === 'maintenance' ? 300 : 250;
            const amount = Math.round(baseAmount * (0.5 + Math.random()) * (prop.units || 1) / 4);
            
            expenses.push({
              description: `${category.charAt(0).toUpperCase() + category.slice(1)} - ${new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'short' })}`,
              amount: amount,
              date: `${year}-${String(monthNum).padStart(2, '0')}-${String(10 + Math.floor(Math.random() * 15)).padStart(2, '0')}`,
              category: category
            });
          }
        }

        return {
          ...prop,
          expenses
        };
      });

      // Insert properties
      const { data: insertedProperties, error: propertiesError } = await supabase
        .from('properties')
        .insert(propertiesWithExpenses.map(transformPropertyForDB))
        .select();

      if (propertiesError) throw propertiesError;

      // Create a map of property names to IDs
      const propertyMap = {};
      insertedProperties.forEach(p => {
        const prop = transformProperty(p);
        propertyMap[prop.name] = prop.id;
      });

      // Add demo tenants with 12 months of payment history
      const tenantsWithPayments = demoTenants.map((tenant, index) => {
        const paymentLog = [];
        const activityLog = [];
        
        // Only add payment logs for current tenants
        if (tenant.status === 'current') {
          // Generate 12 months of payments
          for (let month = 1; month <= 12; month++) {
            const year = 2025;
            const paymentDate = `${year}-${String(month).padStart(2, '0')}-01`;
            
            // Most tenants pay on time, some late
            if (tenant.paymentStatus === 'paid' || month < 12) {
              paymentLog.push({
                amount: tenant.rentAmount,
                date: paymentDate,
                method: ['ach', 'check', 'credit_card', 'cash'][Math.floor(Math.random() * 4)],
                notes: `${new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long' })} rent`
              });
            }
          }
          
          // Add January 2026 payment for paid tenants
          if (tenant.paymentStatus === 'paid') {
            paymentLog.push({
              amount: tenant.rentAmount,
              date: '2026-01-01',
              method: 'ach',
              notes: 'January rent'
            });
          }
          
          // Add some activity notes
          activityLog.push({
            type: 'note',
            date: tenant.leaseStart,
            note: 'Lease signed and move-in completed'
          });
          if (tenant.notes) {
            activityLog.push({
              type: 'note',
              date: new Date().toISOString().split('T')[0],
              note: tenant.notes
            });
          }
        }

        return {
          ...tenant,
          property_id: propertyMap[tenant.property] || null,
          paymentLog,
          activityLog,
          accessCode: generateAccessCode()
        };
      });

      // Insert tenants
      const { error: tenantsError } = await supabase
        .from('tenants')
        .insert(tenantsWithPayments.map(transformTenantForDB));

      if (tenantsError) throw tenantsError;

      // Add maintenance requests
      const { error: maintenanceError } = await supabase
        .from('maintenance_requests')
        .insert(demoMaintenanceRequests.map(req => transformMaintenanceRequestForDB({
          ...req,
          tenantId: null,
          tenantName: req.property.split(',')[0] || ''
        })));

      if (maintenanceError) throw maintenanceError;

      // Reload data
      await loadData(user);
      alert('Demo data loaded successfully! 8 properties, 35 tenants, 20 maintenance requests, and 12 months of history.');
    } catch (error) {
      console.error('Error loading demo data:', error);
      alert('Error loading demo data: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  // Clear all data function (dev only)
  const clearAllData = async () => {
    if (!user) {
      alert('Please log in first');
      return;
    }

    if (!confirm('â ï¸ WARNING: This will permanently delete ALL your data including properties, tenants, maintenance requests, messages, and payment history. This cannot be undone. Are you absolutely sure?')) {
      return;
    }

    // Double confirmation
    const confirmText = prompt('Type "DELETE ALL" to confirm:');
    if (confirmText !== 'DELETE ALL') {
      alert('Deletion cancelled.');
      return;
    }

    setLoading(true);
    try {
      // Delete in order to respect foreign key constraints
      await supabase.from('sms_messages').delete().eq('user_id', user.id);
      await supabase.from('maintenance_requests').delete().eq('user_id', user.id);
      await supabase.from('tenants').delete().eq('user_id', user.id);
      await supabase.from('properties').delete().eq('user_id', user.id);

      // Reset local state
      setTenants([]);
      setProperties([]);
      setMaintenanceRequests([]);
      setSmsMessages([]);
      
      alert('All data has been cleared. Fresh start!');
    } catch (error) {
      console.error('Error clearing data:', error);
      alert('Error clearing data: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleAddMaintenanceRequest = async (e) => {
    e.preventDefault();
    if (!newMaintenanceRequest.issue) return;
    
    try {
      let data, error;
      
      if (newMaintenanceRequest.id) {
        // Update existing request
        const { data: updatedData, error: updateError } = await supabase
          .from('maintenance_requests')
          .update(transformMaintenanceRequestForDB(newMaintenanceRequest))
          .eq('id', newMaintenanceRequest.id)
          .select()
          .single();
        
        data = updatedData;
        error = updateError;
        
        if (!error) {
          // Update in local state
          const updatedRequests = maintenanceRequests.map(req => 
            req.id === newMaintenanceRequest.id ? transformMaintenanceRequest(data) : req
          );
          setMaintenanceRequests(updatedRequests);
          
          // Update selected request if it's the one being edited
          if (selectedMaintenanceRequest && selectedMaintenanceRequest.id === newMaintenanceRequest.id) {
            setSelectedMaintenanceRequest(transformMaintenanceRequest(data));
          }
        }
      } else {
        // Insert new request
        const { data: insertedData, error: insertError } = await supabase
          .from('maintenance_requests')
          .insert([transformMaintenanceRequestForDB(newMaintenanceRequest)])
          .select()
          .single();
        
        data = insertedData;
        error = insertError;
        
        if (!error) {
          setMaintenanceRequests([transformMaintenanceRequest(data), ...maintenanceRequests]);
        }
      }
      
      if (error) {
        console.error('Error saving maintenance request:', error);
        showToast('Error saving maintenance request', 'error');
        return;
      }
      
      setNewMaintenanceRequest({ tenantId: '', tenantName: '', property: '', issue: '', priority: 'medium', description: '', date: new Date().toISOString().split('T')[0] });
      setShowAddMaintenanceModal(false);
      showToast(newMaintenanceRequest.id ? 'Maintenance request updated' : 'Maintenance request added', 'success');
    } catch (error) {
      console.error('Error saving maintenance request:', error);
      showToast('Error saving maintenance request', 'error');
    }
  };

  const handleAddTenant = async (e) => {
    e.preventDefault();
    const tenantData = {
      ...newTenant,
      rentAmount: Number(newTenant.rentAmount) || 0,
      securityDeposit: Number(newTenant.securityDeposit) || 0,
      paymentLog: [],
      activityLog: [],
      leaseDocuments: [],
      moveInDate: '',
      moveInNotes: '',
      moveOutDate: '',
      moveOutNotes: '',
      depositDeductions: [],
      depositRefundAmount: 0,
      refundStatus: 'pending',
      accessCode: generateAccessCode() // Generate unique access code
    };
    
    const { data, error } = await supabase
      .from('tenants')
      .insert([transformTenantForDB(tenantData)])
      .select()
      .single();
    
    if (error) {
      console.error('Error adding tenant:', error);
      alert('Error adding tenant');
      return;
    }
    
    setTenants([transformTenant(data), ...tenants]);
    setNewTenant({
      name: '',
      phone: '',
      email: '',
      property: '',
      rentAmount: '',
      securityDeposit: '',
      leaseStart: '',
      leaseEnd: '',
      status: 'prospect',
      paymentStatus: 'n/a',
      notes: '',
      moveInDate: '',
      moveInNotes: ''
    });
    setShowAddModal(false);
  };

  // Toast helper function
  const showToast = (message, type = 'error') => {
    const toast = { message, type, id: Date.now() };
    setToasts(prev => [...prev, toast]);
    setTimeout(() => {
      setToasts(prev => prev.filter(t => t.id !== toast.id));
    }, 4000);
  };

  // RequiredLabel component
  const RequiredLabel = ({ children, required = true }) => (
    <label className='form-label'>
      {children}
      {required && <span style={{ color: '#dc2626', marginLeft: 4 }}>*</span>}
    </label>
  );

  // Get available units for a property
  const getAvailableUnits = (property) => {
    if (!property) return [];
    
    // Get all units that are currently occupied by tenants
    const occupiedUnits = tenants
      .filter(t => {
        // Check if tenant's property matches (could be by ID or address)
        const tenantProperty = t.property || '';
        const propertyMatch = property.id ? 
          (t.property_id === property.id || tenantProperty.includes(property.address)) :
          tenantProperty.includes(property.address);
        return propertyMatch && (t.status === 'current' || t.status === 'Current');
      })
      .map(t => {
        // Extract unit from property string (e.g., "123 Main St, Unit 4B" -> "4B")
        const unitMatch = t.property?.match(/Unit\s+([A-Z0-9]+)/i);
        return unitMatch ? unitMatch[1] : null;
      })
      .filter(Boolean);
    
    // Generate unit list based on total units
    const totalUnits = property.units || property.total_units || 1;
    const allUnits = [];
    
    // Generate unit names (numbers for most properties)
    for (let i = 1; i <= totalUnits; i++) {
      const unitName = String(i);
      if (!occupiedUnits.includes(unitName)) {
        allUnits.push(unitName);
      }
    }
    
    return allUnits;
  };

  // Validate and continue onboarding
  const validateAndContinue = () => {
    // Step 1 validation
    if (onboardingStep === 1) {
      if (!onboardingData.property) {
        showToast('Please select a property', 'error');
        return;
      }
      const isMultiUnit = (onboardingData.property.units || onboardingData.property.total_units || 0) > 1 ||
        ['Multi-Family', 'Multi-family', 'Townhouse', 'Duplex', 'Apartment Complex'].includes(onboardingData.property.type || onboardingData.property.property_type);
      if (isMultiUnit && !onboardingData.unit) {
        showToast('Please select an available unit', 'error');
        return;
      }
      // Auto-set unit for single-family
      if (!isMultiUnit && !onboardingData.unit) {
        setOnboardingData({ ...onboardingData, unit: 'Main' });
      }
      setOnboardingStep(2);
      return;
    }
    
    // Step 2 validation
    if (onboardingStep === 2) {
      if (onboardingData.tenant.isExisting) {
        if (!onboardingData.tenant.existingId) {
          showToast('Please select a prospect', 'error');
          return;
        }
      } else {
        if (!onboardingData.tenant.name) {
          showToast('Full name is required', 'error');
          return;
        }
        if (!onboardingData.tenant.email) {
          showToast('Email is required', 'error');
          return;
        }
      }
      setOnboardingStep(3);
      return;
    }
    
    // Step 3 validation
    if (onboardingStep === 3) {
      if (!onboardingData.lease.monthlyRent) {
        showToast('Monthly rent is required', 'error');
        return;
      }
      if (!onboardingData.lease.startDate) {
        showToast('Lease start date is required', 'error');
        return;
      }
      if (onboardingData.lease.leaseType === 'fixed' && !onboardingData.lease.endDate) {
        showToast('Lease end date is required for fixed-term leases', 'error');
        return;
      }
      setOnboardingStep(4);
      return;
    }
    
    // Step 4 - documents optional, can continue
    if (onboardingStep === 4) {
      setOnboardingStep(5);
      return;
    }
    
    // Step 5 validation
    if (onboardingStep === 5) {
      if (!onboardingData.moveInDate) {
        showToast('Move-in date is required', 'error');
        return;
      }
      setOnboardingStep(6);
      return;
    }
    
    // Step 6 - complete
    if (onboardingStep === 6) {
      completeOnboarding();
    }
  };

  // Complete onboarding wizard
  const completeOnboarding = async () => {
    if (!user) {
      alert('Please log in to complete onboarding');
      return;
    }

    try {
      // Create or update tenant
      let tenantId;
      const propertyAddress = onboardingData.property?.address || onboardingData.property?.name || '';
      const fullProperty = onboardingData.unit ? `${propertyAddress}, Unit ${onboardingData.unit}` : propertyAddress;

      if (onboardingData.tenant.isExisting && onboardingData.tenant.existingId) {
        // Update existing prospect to current tenant
        tenantId = onboardingData.tenant.existingId;
        const existingTenant = tenants.find(t => t.id === tenantId);
        const updatedTenant = {
          ...existingTenant,
          status: 'current',
          property: fullProperty,
          rentAmount: parseFloat(onboardingData.lease.monthlyRent) || 0,
          securityDeposit: parseFloat(onboardingData.lease.securityDeposit) || 0,
          leaseStart: onboardingData.lease.startDate || '',
          leaseEnd: onboardingData.lease.endDate || null,
          moveInDate: onboardingData.moveInDate || '',
          moveInNotes: onboardingData.moveInNotes || '',
          paymentStatus: 'n/a',
          paymentLog: existingTenant?.paymentLog || [],
          activityLog: existingTenant?.activityLog || [],
          leaseDocuments: existingTenant?.leaseDocuments || []
        };

        const { error: updateError } = await supabase
          .from('tenants')
          .update(transformTenantForDB(updatedTenant))
          .eq('id', tenantId);

        if (updateError) throw updateError;
      } else {
        // Create new tenant
        const newTenantData = {
          name: onboardingData.tenant.name,
          email: onboardingData.tenant.email || '',
          phone: onboardingData.tenant.phone || '',
          property: fullProperty,
          rentAmount: parseFloat(onboardingData.lease.monthlyRent) || 0,
          securityDeposit: parseFloat(onboardingData.lease.securityDeposit) || 0,
          leaseStart: onboardingData.lease.startDate || '',
          leaseEnd: onboardingData.lease.endDate || null,
          status: 'current',
          paymentStatus: 'n/a',
          paymentLog: [],
          activityLog: [],
          leaseDocuments: [],
          notes: '',
          moveInDate: onboardingData.moveInDate || '',
          moveInNotes: onboardingData.moveInNotes || '',
          accessCode: generateAccessCode()
        };

        const { data: newTenant, error: insertError } = await supabase
          .from('tenants')
          .insert([transformTenantForDB(newTenantData)])
          .select()
          .single();

        if (insertError) throw insertError;
        tenantId = newTenant.id;
      }

      // Upload documents
      for (const doc of onboardingData.documents) {
        try {
          await uploadDocument(doc, 'tenant', tenantId, 'lease');
        } catch (docError) {
          console.error('Error uploading document:', docError);
          // Continue with other documents even if one fails
        }
      }

      // Refresh data and close wizard
      await loadData();
      setShowOnboardingWizard(false);
      setOnboardingStep(1);
      setOnboardingData({
        property: null,
        unit: '',
        tenant: {
          name: '',
          email: '',
          phone: '',
          isExisting: false,
          existingId: null
        },
        lease: {
          monthlyRent: '',
          securityDeposit: '',
          startDate: '',
          endDate: '',
          leaseType: 'fixed'
        },
        documents: [],
        moveInDate: '',
        moveInNotes: ''
      });

      alert('Tenant onboarded successfully!');
    } catch (err) {
      console.error('Onboarding failed:', err);
      alert('Failed to complete onboarding: ' + (err.message || 'Unknown error'));
    }
  };

  // Validate and continue offboarding
  const validateAndContinueOffboarding = () => {
    // Step 1 validation
    if (offboardingStep === 1) {
      if (!offboardingData.tenant) {
        showToast('Please select a tenant', 'error');
        return;
      }
      setOffboardingStep(2);
      return;
    }
    
    // Step 2 validation
    if (offboardingStep === 2) {
      if (!offboardingData.moveOutDate) {
        showToast('Move-out date is required', 'error');
        return;
      }
      setOffboardingStep(3);
      return;
    }
    
    // Step 3 - inspection optional, can continue
    if (offboardingStep === 3) {
      setOffboardingStep(4);
      return;
    }
    
    // Step 4 - deposit optional, can continue
    if (offboardingStep === 4) {
      setOffboardingStep(5);
      return;
    }
    
    // Step 5 - statement review, can continue
    if (offboardingStep === 5) {
      setOffboardingStep(6);
      completeOffboarding();
      return;
    }
  };

  // Complete offboarding wizard
  const completeOffboarding = async () => {
    if (!user || !offboardingData.tenant) {
      showToast('Please log in and select a tenant', 'error');
      return;
    }

    try {
      // Update tenant status to Past
      await supabase.from('tenants').update({
        status: 'Past',
        move_out_date: offboardingData.moveOutDate,
        move_out_reason: offboardingData.reason,
        move_out_notes: offboardingData.inspectionNotes,
        forwarding_address: offboardingData.forwardingAddress,
        deposit_deductions: offboardingData.depositDeductions,
        deposit_refund_amount: Math.max(0, (offboardingData.tenant.security_deposit || 0) - offboardingData.depositDeductions.reduce((sum, d) => sum + (d.amount || 0), 0)),
        refund_status: 'pending'
      }).eq('id', offboardingData.tenant.id);
      
      // Upload inspection photos
      for (const photo of offboardingData.inspectionPhotos) {
        try {
          await uploadDocument(photo, 'tenant', offboardingData.tenant.id, 'move-out-inspection');
        } catch (photoError) {
          console.error('Error uploading photo:', photoError);
          // Continue with other photos even if one fails
        }
      }
      
      // Refresh data
      await loadData();
      showToast('Tenant offboarded successfully', 'success');
      setOffboardingStep(6);
    } catch (err) {
      console.error('Offboarding failed:', err);
      showToast('Failed to complete offboarding: ' + (err.message || 'Unknown error'), 'error');
    }
  };

  // Helper function to create audit log entry
  const createAuditEntry = (field, oldValue, newValue) => {
    return {
      id: Date.now() + Math.random(),
      field,
      oldValue: oldValue !== null && oldValue !== undefined ? String(oldValue) : '',
      newValue: newValue !== null && newValue !== undefined ? String(newValue) : '',
      timestamp: new Date().toISOString(),
      changedBy: user?.email || 'Unknown'
    };
  };

  const handleUpdateTenant = async (e) => {
    e.preventDefault();
    if (!editingTenant) return;

    const originalTenant = tenants.find(t => t.id === editingTenant.id);
    if (!originalTenant) return;

    // Merge with original tenant to preserve all fields (paymentLog, activityLog, leaseDocument, etc.)
    const updatedTenant = {
      ...originalTenant,
      ...editingTenant,
      rentAmount: Number(editingTenant.rentAmount) || 0,
      securityDeposit: Number(editingTenant.securityDeposit) || 0,
      // Preserve these fields from original
      paymentLog: originalTenant.paymentLog || [],
      activityLog: originalTenant.activityLog || [],
      leaseDocuments: originalTenant.leaseDocuments || [],
      paymentDate: originalTenant.paymentDate || null,
      accessCode: originalTenant.accessCode || generateAccessCode() // Preserve or generate access code
    };

    // Track changes for audit log
    const auditEntries = [];
    const fieldMappings = {
      name: 'Name',
      phone: 'Phone',
      email: 'Email',
      property: 'Property',
      rentAmount: 'Monthly Rent',
      securityDeposit: 'Security Deposit',
      leaseStart: 'Lease Start',
      leaseEnd: 'Lease End',
      status: 'Status',
      paymentStatus: 'Payment Status',
      notes: 'Notes'
    };

    Object.keys(fieldMappings).forEach(key => {
      const oldValue = originalTenant[key];
      const newValue = updatedTenant[key];
      
      // Compare values (handle different types)
      if (oldValue !== newValue) {
        // Format values for display
        let displayOldValue = oldValue;
        let displayNewValue = newValue;
        
        if (key === 'rentAmount' || key === 'securityDeposit') {
          displayOldValue = oldValue ? `$${Number(oldValue).toLocaleString()}` : '';
          displayNewValue = newValue ? `$${Number(newValue).toLocaleString()}` : '';
        } else if (key === 'leaseStart' || key === 'leaseEnd') {
          displayOldValue = oldValue ? new Date(oldValue).toLocaleDateString() : '';
          displayNewValue = newValue ? new Date(newValue).toLocaleDateString() : '';
        }
        
        auditEntries.push(createAuditEntry(fieldMappings[key], displayOldValue, displayNewValue));
      }
    });

    // Add audit entries to existing audit log
    const updatedAuditLog = [...(originalTenant.auditLog || []), ...auditEntries];

    const tenantData = {
      ...updatedTenant,
      auditLog: updatedAuditLog
    };

    const { data, error } = await supabase
      .from('tenants')
      .update(transformTenantForDB(tenantData))
      .eq('id', editingTenant.id)
      .select()
      .single();

    if (error) {
      console.error('Error updating tenant:', error);
      alert(`Error updating tenant: ${error.message}`);
      return;
    }

    setTenants(tenants.map(t => t.id === editingTenant.id ? transformTenant(data) : t));
    setEditingTenant(null);
    
    // Update selectedTenant if it's the same tenant
    if (selectedTenant && selectedTenant.id === editingTenant.id) {
      setSelectedTenant(transformTenant(data));
    }
  };

  const getStatusBadge = (status) => {
    const styles = {
      current: { background: '#dcfce7', color: '#166534' },
      past: { background: '#f3f4f6', color: '#4b5563' },
      prospect: { background: '#dbeafe', color: '#1e40af' }
    };
    return styles[status] || styles.prospect;
  };

  const getPaymentBadge = (status) => {
    const styles = {
      paid: { background: '#dcfce7', color: '#166534' },
      late: { background: '#fee2e2', color: '#991b1b' },
      'n/a': { background: '#f3f4f6', color: '#6b7280' }
    };
    return styles[status] || styles['n/a'];
  };

  // Auto-detect column mapping for tenants
  const autoDetectTenantColumns = (headers) => {
    const mapping = {};
    const headerLower = headers.map(h => h.toLowerCase().trim());
    
    // Common AppFolio and other header variations
    const patterns = {
      name: ['tenant name', 'name', 'tenant', 'full name', 'tenant full name'],
      phone: ['phone number', 'phone', 'telephone', 'mobile', 'cell'],
      email: ['email address', 'email', 'e-mail', 'email address'],
      property: ['unit', 'property', 'property/unit', 'address', 'property address', 'unit number'],
      rentAmount: ['rent amount', 'rent', 'monthly rent', 'rental amount', 'rent amount'],
      securityDeposit: ['deposit', 'security deposit', 'deposit amount', 'security'],
      leaseStart: ['lease from', 'lease start', 'start date', 'lease start date', 'from'],
      leaseEnd: ['lease to', 'lease end', 'end date', 'lease end date', 'to'],
      status: ['status', 'tenant status', 'current status']
    };

    Object.keys(patterns).forEach(field => {
      const found = headerLower.findIndex(h => patterns[field].some(p => h.includes(p)));
      if (found !== -1) {
        mapping[field] = headers[found];
      }
    });

    return mapping;
  };

  // Auto-detect column mapping for properties
  const autoDetectPropertyColumns = (headers) => {
    const mapping = {};
    const headerLower = headers.map(h => h.toLowerCase().trim());
    
    const patterns = {
      address: ['property address', 'address', 'property', 'street address'],
      type: ['type', 'property type', 'unit type', 'building type'],
      units: ['units', 'total units', 'unit count', 'number of units'],
      ownerName: ['owner', 'owner name', 'property owner', 'owner name'],
      ownerEmail: ['owner email', 'owner e-mail', 'email', 'owner email address']
    };

    Object.keys(patterns).forEach(field => {
      const found = headerLower.findIndex(h => patterns[field].some(p => h.includes(p)));
      if (found !== -1) {
        mapping[field] = headers[found];
      }
    });

    return mapping;
  };

  // Handle tenant CSV upload
  const handleTenantCsvUpload = (file) => {
    setTenantCsvFile(file);
    setTenantImportProgress(null);
    
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        if (results.errors.length > 0) {
          alert('Error parsing CSV: ' + results.errors.map(e => e.message).join(', '));
          return;
        }

        const headers = Object.keys(results.data[0] || {});
        const rows = results.data.filter(row => Object.values(row).some(v => v));
        
        setTenantCsvData(results.data);
        
        // Create preview
        const previewRows = rows.slice(0, 5).map(row => {
          const previewRow = {};
          headers.forEach(header => {
            previewRow[header] = row[header] || '';
          });
          return previewRow;
        });
        
        setTenantCsvPreview({
          headers,
          rows: previewRows
        });

        // Auto-detect columns
        const autoMapping = autoDetectTenantColumns(headers);
        setTenantColumnMapping(autoMapping);
      },
      error: (error) => {
        alert('Error reading CSV file: ' + error.message);
        setTenantCsvFile(null);
      }
    });
  };

  // Handle property CSV upload
  const handlePropertyCsvUpload = (file) => {
    setPropertyCsvFile(file);
    setPropertyImportProgress(null);
    
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        if (results.errors.length > 0) {
          alert('Error parsing CSV: ' + results.errors.map(e => e.message).join(', '));
          return;
        }

        const headers = Object.keys(results.data[0] || {});
        const rows = results.data.filter(row => Object.values(row).some(v => v));
        
        setPropertyCsvData(results.data);
        
        // Create preview
        const previewRows = rows.slice(0, 5).map(row => {
          const previewRow = {};
          headers.forEach(header => {
            previewRow[header] = row[header] || '';
          });
          return previewRow;
        });
        
        setPropertyCsvPreview({
          headers,
          rows: previewRows
        });

        // Auto-detect columns
        const autoMapping = autoDetectPropertyColumns(headers);
        setPropertyColumnMapping(autoMapping);
      },
      error: (error) => {
        alert('Error reading CSV file: ' + error.message);
        setPropertyCsvFile(null);
      }
    });
  };

  // Import tenants from CSV
  const handleImportTenants = async () => {
    if (!tenantCsvData || !tenantColumnMapping.name) {
      alert('Please map at least the Name column');
      return;
    }

    const progress = {
      total: tenantCsvData.length,
      processed: 0,
      success: 0,
      errors: 0,
      duplicates: 0,
      complete: false
    };
    setTenantImportProgress(progress);

    const existingEmails = new Set(tenants.filter(t => t.email).map(t => t.email.toLowerCase()));

    for (let i = 0; i < tenantCsvData.length; i++) {
      const row = tenantCsvData[i];
      
      try {
        // Map CSV columns to tenant fields
        const tenantData = {
          name: row[tenantColumnMapping.name] || '',
          phone: row[tenantColumnMapping.phone] || '',
          email: row[tenantColumnMapping.email] || '',
          property: row[tenantColumnMapping.property] || '',
          rentAmount: parseFloat(row[tenantColumnMapping.rentAmount] || 0) || 0,
          securityDeposit: parseFloat(row[tenantColumnMapping.securityDeposit] || 0) || 0,
          leaseStart: row[tenantColumnMapping.leaseStart] || '',
          leaseEnd: row[tenantColumnMapping.leaseEnd] || '',
          status: (row[tenantColumnMapping.status] || 'prospect').toLowerCase(),
          paymentStatus: 'n/a',
          paymentLog: [],
          activityLog: [],
          auditLog: [],
          leaseDocuments: [],
          notes: '',
          moveInDate: '',
          moveInNotes: '',
          depositDeductions: [],
          depositRefundAmount: null,
          refundStatus: 'pending'
        };

        // Skip if name is missing
        if (!tenantData.name.trim()) {
          progress.errors++;
          progress.processed++;
          setTenantImportProgress({...progress});
          continue;
        }

        // Check for duplicates by email
        if (tenantData.email && existingEmails.has(tenantData.email.toLowerCase())) {
          progress.duplicates++;
          progress.processed++;
          setTenantImportProgress({...progress});
          continue;
        }

        // Add to Supabase
        const { error } = await supabase
          .from('tenants')
          .insert([transformTenantForDB(tenantData)]);

        if (error) {
          console.error('Error importing tenant:', error);
          progress.errors++;
        } else {
          progress.success++;
          if (tenantData.email) {
            existingEmails.add(tenantData.email.toLowerCase());
          }
        }
      } catch (error) {
        console.error('Error processing tenant row:', error);
        progress.errors++;
      }

      progress.processed++;
      setTenantImportProgress({...progress});
    }

    // Reload tenants
    await loadData();
    
    progress.complete = true;
    setTenantImportProgress({...progress});
  };

  // Import properties from CSV
  const handleImportProperties = async () => {
    if (!propertyCsvData || !propertyColumnMapping.address) {
      alert('Please map at least the Address column');
      return;
    }

    const progress = {
      total: propertyCsvData.length,
      processed: 0,
      success: 0,
      errors: 0,
      duplicates: 0,
      complete: false
    };
    setPropertyImportProgress(progress);

    const existingAddresses = new Set(properties.map(p => p.address.toLowerCase()));

    for (let i = 0; i < propertyCsvData.length; i++) {
      const row = propertyCsvData[i];
      
      try {
        // Map CSV columns to property fields
        const propertyData = {
          address: row[propertyColumnMapping.address] || '',
          type: row[propertyColumnMapping.type] || '',
          units: parseInt(row[propertyColumnMapping.units] || 0) || 0,
          occupied: 0,
          monthlyRevenue: 0,
          photoUrl: null,
          expenses: [],
          ownerName: row[propertyColumnMapping.ownerName] || '',
          ownerEmail: row[propertyColumnMapping.ownerEmail] || ''
        };

        // Skip if address is missing
        if (!propertyData.address.trim()) {
          progress.errors++;
          progress.processed++;
          setPropertyImportProgress({...progress});
          continue;
        }

        // Check for duplicates by address
        if (existingAddresses.has(propertyData.address.toLowerCase())) {
          progress.duplicates++;
          progress.processed++;
          setPropertyImportProgress({...progress});
          continue;
        }

        // Add to Supabase
        const { error } = await supabase
          .from('properties')
          .insert([transformPropertyForDB(propertyData)]);

        if (error) {
          console.error('Error importing property:', error);
          progress.errors++;
        } else {
          progress.success++;
          existingAddresses.add(propertyData.address.toLowerCase());
        }
      } catch (error) {
        console.error('Error processing property row:', error);
        progress.errors++;
      }

      progress.processed++;
      setPropertyImportProgress({...progress});
    }

    // Reload properties
    await loadData();
    
    progress.complete = true;
    setPropertyImportProgress({...progress});
  };

  // Owner Portal Dashboard Component
  const OwnerPortalDashboard = ({ owner, onLogout }) => {
    const [portalTab, setPortalTab] = useState('overview');
    const [ownerPropertiesData, setOwnerPropertiesData] = useState([]);
    const [ownerTenantsData, setOwnerTenantsData] = useState([]);
    const [ownerDistributionsData, setOwnerDistributionsData] = useState([]);
    const [loading, setLoading] = useState(true);
    
    useEffect(() => {
      loadOwnerData();
    }, [owner]);
    
    const loadOwnerData = async () => {
      setLoading(true);
      try {
        // Load owner's properties
        const { data: ownerProps, error: propsError } = await supabase
          .from('owner_properties')
          .select('*, properties(*)')
          .eq('owner_id', owner.id);
        
        if (propsError) throw propsError;
        
        const propertyIds = ownerProps?.map(op => op.property_id).filter(Boolean) || [];
        
        // Load tenants for those properties
        let tenantData = [];
        if (propertyIds.length > 0) {
          const { data: tenants, error: tenantsError } = await supabase
            .from('tenants')
            .select('*')
            .in('property_id', propertyIds);
          
          if (!tenantsError) {
            tenantData = tenants || [];
          }
        }
        
        // Load distributions
        const { data: distData, error: distError } = await supabase
          .from('owner_distributions')
          .select('*')
          .eq('owner_id', owner.id)
          .order('created_at', { ascending: false });
        
        if (!distError) {
          setOwnerDistributionsData(distData || []);
        }
        
        setOwnerPropertiesData(ownerProps?.map(op => ({
          ...op.properties,
          ownership_percentage: op.ownership_percentage
        })).filter(p => p.id) || []);
        setOwnerTenantsData(tenantData);
      } catch (err) {
        console.error('Failed to load owner data:', err);
      }
      setLoading(false);
    };
    
    // Calculate totals
    const totalUnits = ownerPropertiesData.reduce((sum, p) => sum + (p.units || p.total_units || 1), 0);
    const occupiedUnits = ownerTenantsData.filter(t => (t.status === 'Current' || t.status === 'current' || t.status === 'Late' || t.status === 'late')).length;
    const monthlyRevenue = ownerTenantsData
      .filter(t => (t.status === 'Current' || t.status === 'current' || t.status === 'Late' || t.status === 'late'))
      .reduce((sum, t) => sum + (parseFloat(t.rentAmount || t.rent || 0)), 0);
    const managementFee = monthlyRevenue * ((owner.managementFeePercent || owner.management_fee_percent || 10) / 100);
    const netIncome = monthlyRevenue - managementFee;
    
    if (loading) {
      return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#f9fafb' }}>
          <p>Loading your dashboard...</p>
        </div>
      );
    }
    
    return (
      <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
        {/* Header */}
        <header style={{
          background: 'white',
          borderBottom: '1px solid #e5e7eb',
          padding: '16px 24px',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          position: 'sticky',
          top: 0,
          zIndex: 100
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <span style={{ fontSize: 28 }}>ð </span>
            <div>
              <h1 style={{ fontSize: 20, fontWeight: 700, color: '#1a73e8', margin: 0 }}>Propli</h1>
              <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Owner Portal</p>
            </div>
          </div>
          
          <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
            <span style={{ fontSize: 14, color: '#4b5563' }}>Welcome, {owner.name}</span>
            <button
              onClick={onLogout}
              style={{
                padding: '8px 16px',
                background: '#f3f4f6',
                border: 'none',
                borderRadius: 6,
                cursor: 'pointer',
                fontSize: 14
              }}
            >
              Sign Out
            </button>
          </div>
        </header>
        
        {/* Navigation Tabs */}
        <div style={{ background: 'white', borderBottom: '1px solid #e5e7eb', padding: '0 24px' }}>
          <div style={{ display: 'flex', gap: 8 }}>
            {['overview', 'properties', 'tenants', 'statements'].map(tab => (
              <button
                key={tab}
                onClick={() => setPortalTab(tab)}
                style={{
                  padding: '16px 20px',
                  background: 'none',
                  border: 'none',
                  borderBottom: portalTab === tab ? '2px solid #1a73e8' : '2px solid transparent',
                  color: portalTab === tab ? '#1a73e8' : '#6b7280',
                  fontWeight: portalTab === tab ? 600 : 400,
                  cursor: 'pointer',
                  fontSize: 14,
                  textTransform: 'capitalize'
                }}
              >
                {tab}
              </button>
            ))}
          </div>
        </div>
        
        {/* Content */}
        <div style={{ padding: 24, maxWidth: 1200, margin: '0 auto' }}>
          
          {/* Overview Tab */}
          {portalTab === 'overview' && (
            <div>
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 24 }}>Dashboard Overview</h2>
              
              {/* Stats Grid */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 20, marginBottom: 32 }}>
                <div style={{ background: 'white', padding: 24, borderRadius: 12, border: '1px solid #e5e7eb' }}>
                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Properties</p>
                  <p style={{ fontSize: 32, fontWeight: 700, color: '#1a73e8', margin: '8px 0 0' }}>{ownerPropertiesData.length}</p>
                </div>
                <div style={{ background: 'white', padding: 24, borderRadius: 12, border: '1px solid #e5e7eb' }}>
                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Occupancy</p>
                  <p style={{ fontSize: 32, fontWeight: 700, color: '#10b981', margin: '8px 0 0' }}>
                    {totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0}%
                  </p>
                  <p style={{ fontSize: 12, color: '#6b7280', margin: '4px 0 0' }}>{occupiedUnits} of {totalUnits} units</p>
                </div>
                <div style={{ background: 'white', padding: 24, borderRadius: 12, border: '1px solid #e5e7eb' }}>
                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Monthly Revenue</p>
                  <p style={{ fontSize: 32, fontWeight: 700, color: '#10b981', margin: '8px 0 0' }}>${Math.round(monthlyRevenue).toLocaleString()}</p>
                </div>
                <div style={{ background: 'white', padding: 24, borderRadius: 12, border: '1px solid #e5e7eb' }}>
                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Net Income</p>
                  <p style={{ fontSize: 32, fontWeight: 700, color: '#059669', margin: '8px 0 0' }}>${Math.round(netIncome).toLocaleString()}</p>
                  <p style={{ fontSize: 12, color: '#6b7280', margin: '4px 0 0' }}>After {owner.managementFeePercent || owner.management_fee_percent || 10}% fee</p>
                </div>
              </div>
              
              {/* Recent Activity */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 24 }}>
                {/* Properties Summary */}
                <div style={{ background: 'white', padding: 24, borderRadius: 12, border: '1px solid #e5e7eb' }}>
                  <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 16 }}>Your Properties</h3>
                  {ownerPropertiesData.length > 0 ? (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                      {ownerPropertiesData.map(prop => (
                        <div key={prop.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: 12, background: '#f9fafb', borderRadius: 8 }}>
                          <div>
                            <p style={{ fontWeight: 500, margin: 0 }}>{prop.name || prop.address}</p>
                            <p style={{ fontSize: 13, color: '#6b7280', margin: '2px 0 0' }}>{prop.type || prop.property_type || 'Property'}</p>
                          </div>
                          <span style={{ fontSize: 14, fontWeight: 600, color: '#1a73e8' }}>{prop.ownership_percentage || 100}%</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p style={{ color: '#9ca3af' }}>No properties assigned</p>
                  )}
                </div>
                
                {/* Recent Distributions */}
                <div style={{ background: 'white', padding: 24, borderRadius: 12, border: '1px solid #e5e7eb' }}>
                  <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 16 }}>Recent Distributions</h3>
                  {ownerDistributionsData.length > 0 ? (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                      {ownerDistributionsData.slice(0, 5).map(dist => (
                        <div key={dist.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: 12, background: '#f9fafb', borderRadius: 8 }}>
                          <div>
                            <p style={{ fontWeight: 500, margin: 0 }}>
                              {dist.period_start ? new Date(dist.period_start).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'N/A'}
                            </p>
                            <p style={{ fontSize: 13, color: dist.status === 'paid' ? '#10b981' : '#f59e0b', margin: '2px 0 0' }}>
                              {dist.status === 'paid' ? 'Paid' : 'Pending'}
                            </p>
                          </div>
                          <span style={{ fontSize: 16, fontWeight: 600, color: '#059669' }}>${parseFloat(dist.amount || 0).toLocaleString()}</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p style={{ color: '#9ca3af' }}>No distributions yet</p>
                  )}
                </div>
              </div>
            </div>
          )}
          
          {/* Properties Tab */}
          {portalTab === 'properties' && (
            <div>
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 24 }}>Your Properties</h2>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: 20 }}>
                {ownerPropertiesData.map(prop => {
                  const propTenants = ownerTenantsData.filter(t => t.property_id === prop.id);
                  const propRevenue = propTenants.filter(t => (t.status === 'Current' || t.status === 'current' || t.status === 'Late' || t.status === 'late')).reduce((sum, t) => sum + (parseFloat(t.rentAmount || t.rent || 0)), 0);
                  const propOccupied = propTenants.filter(t => (t.status === 'Current' || t.status === 'current' || t.status === 'Late' || t.status === 'late')).length;
                  
                  return (
                    <div key={prop.id} style={{ background: 'white', borderRadius: 12, border: '1px solid #e5e7eb', overflow: 'hidden' }}>
                      <div style={{ padding: 20 }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 16 }}>
                          <div>
                            <h3 style={{ fontWeight: 600, fontSize: 18, margin: 0 }}>{prop.name || prop.address}</h3>
                            <p style={{ fontSize: 14, color: '#6b7280', margin: '4px 0 0' }}>{prop.address}</p>
                          </div>
                          <span style={{ padding: '4px 12px', background: '#e8f0fe', color: '#1a73e8', borderRadius: 20, fontSize: 13, fontWeight: 500 }}>
                            {prop.ownership_percentage || 100}% ownership
                          </span>
                        </div>
                        
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 }}>
                          <div>
                            <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Type</p>
                            <p style={{ fontWeight: 500, margin: '4px 0 0' }}>{prop.type || prop.property_type || 'Property'}</p>
                          </div>
                          <div>
                            <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Occupancy</p>
                            <p style={{ fontWeight: 500, margin: '4px 0 0' }}>{propOccupied}/{prop.units || prop.total_units || 1}</p>
                          </div>
                          <div>
                            <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Revenue</p>
                            <p style={{ fontWeight: 500, margin: '4px 0 0', color: '#10b981' }}>${Math.round(propRevenue).toLocaleString()}/mo</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
              {ownerPropertiesData.length === 0 && (
                <div style={{ background: 'white', padding: 40, borderRadius: 12, border: '1px solid #e5e7eb', textAlign: 'center' }}>
                  <p style={{ color: '#9ca3af' }}>No properties assigned</p>
                </div>
              )}
            </div>
          )}
          
          {/* Tenants Tab */}
          {portalTab === 'tenants' && (
            <div>
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 24 }}>Tenants</h2>
              <div style={{ background: 'white', borderRadius: 12, border: '1px solid #e5e7eb', overflow: 'hidden' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                  <thead>
                    <tr style={{ background: '#f9fafb' }}>
                      <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: '#6b7280' }}>Tenant</th>
                      <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: '#6b7280' }}>Property</th>
                      <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: '#6b7280' }}>Rent</th>
                      <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: '#6b7280' }}>Lease End</th>
                      <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: '#6b7280' }}>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {ownerTenantsData.map(tenant => {
                      const prop = ownerPropertiesData.find(p => p.id === tenant.property_id);
                      return (
                        <tr key={tenant.id} style={{ borderTop: '1px solid #e5e7eb' }}>
                          <td style={{ padding: '12px 16px' }}>
                            <p style={{ fontWeight: 500, margin: 0 }}>{tenant.name}</p>
                            <p style={{ fontSize: 13, color: '#6b7280', margin: '2px 0 0' }}>{tenant.email || tenant.phone || ''}</p>
                          </td>
                          <td style={{ padding: '12px 16px', fontSize: 14 }}>
                            {prop?.name || prop?.address || 'N/A'}{tenant.unit ? `, Unit ${tenant.unit}` : ''}
                          </td>
                          <td style={{ padding: '12px 16px', fontSize: 14, fontWeight: 500 }}>${parseFloat(tenant.rentAmount || tenant.rent || 0).toLocaleString()}/mo</td>
                          <td style={{ padding: '12px 16px', fontSize: 14 }}>{tenant.leaseEnd || tenant.lease_end || 'MTM'}</td>
                          <td style={{ padding: '12px 16px' }}>
                            <span style={{
                              padding: '4px 10px',
                              borderRadius: 12,
                              fontSize: 12,
                              fontWeight: 500,
                              background: tenant.status === 'Current' || tenant.status === 'current' ? '#d1fae5' : tenant.status === 'Late' || tenant.status === 'late' ? '#fee2e2' : '#f3f4f6',
                              color: tenant.status === 'Current' || tenant.status === 'current' ? '#065f46' : tenant.status === 'Late' || tenant.status === 'late' ? '#991b1b' : '#6b7280'
                            }}>
                              {tenant.status}
                            </span>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                {ownerTenantsData.length === 0 && (
                  <p style={{ padding: 24, textAlign: 'center', color: '#9ca3af' }}>No tenants found</p>
                )}
              </div>
            </div>
          )}
          
          {/* Statements Tab */}
          {portalTab === 'statements' && (
            <div>
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 24 }}>Statements & Distributions</h2>
              <div style={{ background: 'white', borderRadius: 12, border: '1px solid #e5e7eb', overflow: 'hidden' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                  <thead>
                    <tr style={{ background: '#f9fafb' }}>
                      <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: '#6b7280' }}>Period</th>
                      <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: '#6b7280' }}>Amount</th>
                      <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: '#6b7280' }}>Status</th>
                      <th style={{ padding: '12px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: '#6b7280' }}>Payment Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    {ownerDistributionsData.map(dist => (
                      <tr key={dist.id} style={{ borderTop: '1px solid #e5e7eb' }}>
                        <td style={{ padding: '12px 16px', fontWeight: 500 }}>
                          {dist.period_start ? new Date(dist.period_start).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'N/A'}
                        </td>
                        <td style={{ padding: '12px 16px', fontSize: 16, fontWeight: 600, color: '#059669' }}>
                          ${parseFloat(dist.amount || 0).toLocaleString()}
                        </td>
                        <td style={{ padding: '12px 16px' }}>
                          <span style={{
                            padding: '4px 10px',
                            borderRadius: 12,
                            fontSize: 12,
                            fontWeight: 500,
                            background: dist.status === 'paid' ? '#d1fae5' : '#fef3c7',
                            color: dist.status === 'paid' ? '#065f46' : '#92400e'
                          }}>
                            {dist.status === 'paid' ? 'Paid' : 'Pending'}
                          </span>
                        </td>
                        <td style={{ padding: '12px 16px', fontSize: 14 }}>
                          {dist.payment_date ? new Date(dist.payment_date).toLocaleDateString() : '-'}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {ownerDistributionsData.length === 0 && (
                  <p style={{ padding: 24, textAlign: 'center', color: '#9ca3af' }}>No statements yet</p>
                )}
              </div>
            </div>
          )}
          
        </div>
        
        {/* Footer */}
        <footer style={{ padding: 24, textAlign: 'center', color: '#9ca3af', fontSize: 13 }}>
          <p>Propli Owner Portal â¢ Questions? Contact your property manager.</p>
        </footer>
      </div>
    );
  };

  // Check if we're on the tenant portal route
  useEffect(() => {
    if (window.location.pathname === '/tenant-portal') {
      // Tenant portal handles its own routing
    }
  }, []);

  // Show owner portal if on that route
  const isOwnerPortal = window.location.pathname === '/owner-portal';
  if (isOwnerPortal) {
    // Owner Dashboard
    if (ownerPortalView === 'dashboard' && portalOwner) {
      return <OwnerPortalDashboard owner={portalOwner} onLogout={handleOwnerPortalLogout} />;
    }
    
    // Owner Login Page
    return (
      <div style={{ 
        minHeight: '100vh', 
        background: 'linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: 20
      }}>
        <div style={{
          background: 'white',
          borderRadius: 16,
          padding: 40,
          width: '100%',
          maxWidth: 420,
          boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
        }}>
          {/* Logo */}
          <div style={{ textAlign: 'center', marginBottom: 32 }}>
            <div style={{ fontSize: 48, marginBottom: 8 }}>ð </div>
            <h1 style={{ fontSize: 28, fontWeight: 700, color: '#1a73e8', margin: 0 }}>Propli</h1>
            <p style={{ color: '#6b7280', marginTop: 8 }}>Owner Portal</p>
          </div>
          
          {/* Login Form */}
          <form onSubmit={handleOwnerPortalLogin}>
            <div style={{ marginBottom: 20 }}>
              <label style={{ display: 'block', fontSize: 14, fontWeight: 500, marginBottom: 6, color: '#374151' }}>
                Email Address
              </label>
              <input
                type="email"
                value={portalEmail}
                onChange={(e) => setPortalEmail(e.target.value)}
                placeholder="your@email.com"
                required
                style={{
                  width: '100%',
                  padding: '12px 16px',
                  border: '1px solid #d1d5db',
                  borderRadius: 8,
                  fontSize: 16,
                  outline: 'none',
                  transition: 'border-color 0.2s'
                }}
                onFocus={(e) => e.target.style.borderColor = '#1a73e8'}
                onBlur={(e) => e.target.style.borderColor = '#d1d5db'}
              />
            </div>
            
            {portalError && (
              <div style={{
                padding: 12,
                background: '#fee2e2',
                color: '#991b1b',
                borderRadius: 8,
                fontSize: 14,
                marginBottom: 20
              }}>
                {portalError}
              </div>
            )}
            
            <button
              type="submit"
              disabled={portalLoading}
              style={{
                width: '100%',
                padding: '14px 20px',
                background: '#1a73e8',
                color: 'white',
                border: 'none',
                borderRadius: 8,
                fontSize: 16,
                fontWeight: 600,
                cursor: portalLoading ? 'not-allowed' : 'pointer',
                opacity: portalLoading ? 0.7 : 1
              }}
            >
              {portalLoading ? 'Signing in...' : 'Sign In'}
            </button>
          </form>
          
          <p style={{ textAlign: 'center', marginTop: 24, fontSize: 14, color: '#6b7280' }}>
            Don't have access? Contact your property manager.
          </p>
        </div>
      </div>
    );
  }

  // Show tenant portal if on that route
  if (window.location.pathname === '/tenant-portal') {
    return <TenantPortal />;
  }

  // Show payment page if on /pay route (public, no auth required)
  if (window.location.pathname.startsWith('/pay/')) {
    return <PaymentPage />;
  }

  // Show auth screen if not authenticated
  if (!user) {
    return <Auth onAuthSuccess={handleAuthSuccess} />;
  }

  // Mobile Header Component
  const MobileHeader = () => (
    <div className='mobile-header'>
      <button className='hamburger-btn' onClick={() => setMobileMenuOpen(true)} type="button">
        â°
      </button>
      <span style={{ fontWeight: 700, fontSize: 18, color: '#1a73e8' }}>Propli</span>
      <div style={{ width: 40, height: 40, borderRadius: '50%', background: '#1a73e8', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 600 }}>
        {user?.email?.[0]?.toUpperCase() || 'U'}
      </div>
    </div>
  );

  return (
    <div className="app google-style">
      {/* Mobile Header - only show on mobile */}
      {isMobile && <MobileHeader />}
      
      {/* Toast Notifications */}
      <div style={{
        position: 'fixed',
        top: 20,
        right: 20,
        zIndex: 9999,
        display: 'flex',
        flexDirection: 'column',
        gap: 8
      }}>
        {toasts.map((toast) => (
          <div
            key={toast.id}
            style={{
              padding: '12px 16px',
              background: toast.type === 'error' ? '#fee2e2' : toast.type === 'success' ? '#d1fae5' : '#e0f2fe',
              color: toast.type === 'error' ? '#dc2626' : toast.type === 'success' ? '#059669' : '#0284c7',
              borderRadius: 8,
              boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
              display: 'flex',
              alignItems: 'center',
              gap: 12,
              minWidth: 300,
              animation: 'slideIn 0.3s ease'
            }}
          >
            <span style={{ fontSize: 18 }}>{toast.type === 'error' ? 'â ï¸' : toast.type === 'success' ? 'â' : 'â¹ï¸'}</span>
            <span style={{ flex: 1 }}>{toast.message}</span>
            <button 
              onClick={() => setToasts(toasts.filter(t => t.id !== toast.id))} 
              style={{ 
                background: 'none', 
                border: 'none', 
                cursor: 'pointer', 
                fontSize: 20,
                color: 'inherit',
                padding: 0,
                width: 24,
                height: 24,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}
            >
              Ã
            </button>
          </div>
        ))}
      </div>

      {/* Top Header - Google Workspace Style - hide on mobile */}
      {!isMobile && (
      <header className="top-header">
        <div className="header-left">
          <a href="#" className="header-logo" onClick={(e) => { e.preventDefault(); setActiveTab('dashboard'); }}>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span>Propli</span>
          </a>
        </div>
        <div className="header-search">
          <input 
            type="text" 
            id="global-search"
            name="global-search"
            placeholder="Search tenants, properties..." 
            className="search-bar" 
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            aria-label="Search tenants, properties"
          />
        </div>
        <div className="header-right">
          {/* User Profile Dropdown */}
          <div style={{ position: 'relative' }}>
            <button
              onClick={() => setShowProfileMenu(!showProfileMenu)}
              style={{
                width: '44px',
                height: '44px',
                borderRadius: '50%',
                background: '#1a73e8',
                border: 'none',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                color: 'white',
                fontSize: '18px',
                fontWeight: '600'
              }}
            >
              {user?.email?.charAt(0).toUpperCase() || 'U'}
            </button>
            
            {showProfileMenu && (
              <>
                {/* Overlay to close menu when clicking outside */}
                <div 
                  onClick={() => setShowProfileMenu(false)}
                  style={{
                    position: 'fixed',
                    inset: 0,
                    zIndex: 998
                  }}
                />
                
                {/* Dropdown Menu */}
                <div style={{
                  position: 'absolute',
                  top: '54px',
                  right: 0,
                  width: '280px',
                  background: 'white',
                  borderRadius: '12px',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                  border: '1px solid #e2e8f0',
                  zIndex: 999,
                  overflow: 'hidden'
                }}>
                  {/* User Info Header */}
                  <div style={{
                    padding: '20px',
                    borderBottom: '1px solid #e2e8f0',
                    background: '#f8fafc'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '14px' }}>
                      <div style={{
                        width: '56px',
                        height: '56px',
                        borderRadius: '50%',
                        background: '#1a73e8',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: 'white',
                        fontSize: '24px',
                        fontWeight: '600'
                      }}>
                        {user?.email?.charAt(0).toUpperCase() || 'U'}
                      </div>
                      <div>
                        <p style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>
                          {getUserDisplayName()}
                        </p>
                        <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#64748b' }}>
                          {user?.email || 'No email'}
                        </p>
                        <span style={{
                          display: 'inline-block',
                          marginTop: '6px',
                          padding: '3px 8px',
                          background: '#dbeafe',
                          color: '#1e40af',
                          borderRadius: '4px',
                          fontSize: '11px',
                          fontWeight: '500'
                        }}>
                          Admin
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Menu Items */}
                  <div style={{ padding: '8px' }}>
                    <button
                      onClick={() => {
                        setShowProfileMenu(false);
                        setActiveTab('settings');
                      }}
                      style={{
                        width: '100%',
                        padding: '12px 16px',
                        background: 'none',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        color: '#374151',
                        fontSize: '14px',
                        textAlign: 'left'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = '#f1f5f9'}
                      onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                    >
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                      My Profile
                    </button>
                    
                    <button
                      onClick={() => {
                        setShowProfileMenu(false);
                        setActiveTab('settings');
                      }}
                      style={{
                        width: '100%',
                        padding: '12px 16px',
                        background: 'none',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        color: '#374151',
                        fontSize: '14px',
                        textAlign: 'left'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = '#f1f5f9'}
                      onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                    >
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                      Settings
                    </button>
                    
                    <button
                      onClick={() => {
                        setShowProfileMenu(false);
                        // Add admin panel navigation if you have one
                        setActiveTab('settings');
                      }}
                      style={{
                        width: '100%',
                        padding: '12px 16px',
                        background: 'none',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        color: '#374151',
                        fontSize: '14px',
                        textAlign: 'left'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = '#f1f5f9'}
                      onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                    >
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                      Admin Panel
                    </button>
                    
                    <button
                      onClick={() => {
                        setShowProfileMenu(false);
                        setShowHelpSupport(true);
                      }}
                      style={{
                        width: '100%',
                        padding: '12px 16px',
                        background: 'none',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        color: '#374151',
                        fontSize: '14px',
                        textAlign: 'left'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = '#f1f5f9'}
                      onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                    >
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                      Help & Support
                    </button>
                  </div>
                  
                  {/* Logout */}
                  <div style={{ padding: '8px', borderTop: '1px solid #e2e8f0' }}>
                    <button
                      onClick={async () => {
                        setShowProfileMenu(false);
                        await supabase.auth.signOut();
                      }}
                      style={{
                        width: '100%',
                        padding: '12px 16px',
                        background: 'none',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        color: '#dc2626',
                        fontSize: '14px',
                        textAlign: 'left'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.background = '#fef2f2'}
                      onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                    >
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                      Log Out
                    </button>
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      </header>
      )}

      {/* Mobile Menu */}
      {mobileMenuOpen && (
        <>
          <div className='mobile-overlay' onClick={() => setMobileMenuOpen(false)} />
          <aside className={`sidebar mobile-open`}>
            <div style={{ padding: 20, borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <span style={{ fontWeight: 700, fontSize: 20, color: '#1a73e8' }}>Propli</span>
              <button 
                type="button"
                onClick={() => setMobileMenuOpen(false)} 
                style={{ background: 'none', border: 'none', fontSize: 24, cursor: 'pointer', color: '#4b5563', padding: 4 }}
              >
                Ã
              </button>
            </div>
            <nav style={{ padding: 16 }}>
              {[
                { id: 'dashboard', icon: 'ð', label: 'Dashboard' },
                { id: 'tenants', icon: 'ð¥', label: 'Tenants' },
                { id: 'properties', icon: 'ð ', label: 'Properties' },
                { id: 'owners', icon: 'ð¤', label: 'Owners' },
                { id: 'maintenance', icon: 'ð§', label: 'Maintenance' },
                { id: 'vendors', icon: 'ð·', label: 'Vendors' },
                { id: 'late-fees', icon: 'ð°', label: 'Late Fees' },
                { id: 'schedule', icon: 'ð', label: 'Schedule' },
                { id: 'reports', icon: 'ð', label: 'Reports' },
                { id: 'settings', icon: 'âï¸', label: 'Settings' }
              ].map(item => (
                <div
                  key={item.id}
                  onClick={() => {
                    setActiveTab(item.id);
                    setMobileMenuOpen(false);
                  }}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: 12,
                    padding: '14px 16px',
                    borderRadius: 8,
                    cursor: 'pointer',
                    background: activeTab === item.id ? '#e8f0fe' : 'transparent',
                    color: activeTab === item.id ? '#1a73e8' : '#4b5563',
                    fontWeight: activeTab === item.id ? 600 : 400,
                    marginBottom: 4
                  }}
                >
                  <span style={{ fontSize: 20 }}>{item.icon}</span>
                  <span>{item.label}</span>
                </div>
              ))}
            </nav>
          </aside>
        </>
      )}

      {/* Sidebar - always render */}
      <aside 
        className='sidebar'
        style={{
          display: 'flex',
          flexDirection: 'column',
          width: sidebarCollapsed ? 64 : 220,
          height: '100vh',
          position: 'fixed',
          left: 0,
          top: 0,
          background: 'white',
          borderRight: '1px solid #e5e7eb',
          zIndex: 100,
          transition: 'width 0.2s ease'
        }}
      >
          {/* Logo */}
          <div style={{ padding: '20px 16px', borderBottom: '1px solid #e5e7eb' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a73e8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
              {!sidebarCollapsed && (
                <span style={{ fontWeight: 700, fontSize: 20, color: '#1a73e8' }}>Propli</span>
              )}
            </div>
          </div>
          
          {/* Main Navigation */}
          <nav style={{ padding: 16, flex: 1, overflowY: 'auto' }}>
            <div
              onClick={() => setActiveTab('dashboard')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'dashboard' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'dashboard' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'dashboard' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
              {!sidebarCollapsed && <span>Dashboard</span>}
            </div>
            
            <div
              onClick={() => setActiveTab('tenants')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'tenants' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'tenants' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'tenants' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
              {!sidebarCollapsed && <span>Tenants</span>}
            </div>
            
            <div
              onClick={() => setActiveTab('properties')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'properties' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'properties' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'properties' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
              {!sidebarCollapsed && <span>Properties</span>}
            </div>
            
            <div
              onClick={() => setActiveTab('maintenance')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'maintenance' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'maintenance' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'maintenance' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
              {!sidebarCollapsed && <span>Maintenance</span>}
            </div>
            
            <div
              onClick={() => setActiveTab('vendors')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'vendors' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'vendors' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'vendors' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
              {!sidebarCollapsed && <span>Vendors</span>}
            </div>
            
            <div
              onClick={() => setActiveTab('messages')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'messages' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'messages' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'messages' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
              {!sidebarCollapsed && <span>Messages</span>}
            </div>
            
            <div
              onClick={() => setActiveTab('schedule')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'schedule' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'schedule' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'schedule' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              {!sidebarCollapsed && <span>Schedule</span>}
            </div>
            
            <div
              onClick={() => setActiveTab('late-fees')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'late-fees' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'late-fees' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'late-fees' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
              {!sidebarCollapsed && <span>Late Fees</span>}
            </div>
            
            <div
              onClick={() => setActiveTab('reports')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'reports' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'reports' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'reports' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
              {!sidebarCollapsed && <span>Reports</span>}
            </div>
          </nav>
          
          {/* Divider */}
          <div style={{ 
            borderTop: '1px solid #e5e7eb', 
            margin: '16px 12px' 
          }} />
          
          {/* Bottom Navigation */}
          <nav style={{ padding: '0 16px 16px' }}>
            <div
              onClick={() => setActiveTab('owners')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'owners' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'owners' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'owners' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              {!sidebarCollapsed && <span>Owners</span>}
            </div>
            
            <div
              onClick={() => setActiveTab('settings')}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 12,
                padding: '12px 16px',
                borderRadius: 8,
                cursor: 'pointer',
                background: activeTab === 'settings' ? '#e8f0fe' : 'transparent',
                color: activeTab === 'settings' ? '#1a73e8' : '#4b5563',
                fontWeight: activeTab === 'settings' ? 600 : 400,
                marginBottom: 4,
                transition: 'background 0.2s'
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
              {!sidebarCollapsed && <span>Settings</span>}
            </div>
          </nav>
        </aside>

      {/* Main Content Area */}
      <div className="main-content-wrapper" style={{ marginLeft: isMobile ? 0 : (sidebarCollapsed ? 64 : 220) }}>
        <main className="main-content">
          {/* Mobile Pull to Refresh Hint */}
          {isMobile && (
            <div style={{ textAlign: 'center', padding: 8, fontSize: 12, color: '#9ca3af', marginBottom: 8 }}>
              Pull down to refresh
            </div>
          )}
          {loading ? (
            <div style={{ textAlign: 'center', padding: '2rem' }}>
              <p>Loading data...</p>
            </div>
          ) : (
            <>
              {/* Global Search Results */}
              {searchQuery && searchQuery.trim() && (() => {
                const searchResults = performGlobalSearch(searchQuery);
                const hasResults = searchResults.tenants.length > 0 || searchResults.properties.length > 0;
                
                return (
                  <div className="search-results-overlay" onClick={() => setSearchQuery('')}>
                    <div className="search-results" onClick={(e) => e.stopPropagation()}>
                      <div className="search-results-header">
                        <h3>Search Results</h3>
                        <button 
                          className="close-btn"
                          onClick={() => setSearchQuery('')}
                          style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#5f6368', padding: '0', width: '32px', height: '32px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                        >
                          Ã
                        </button>
                      </div>
                      {!hasResults ? (
                        <div style={{ padding: '2rem', textAlign: 'center', color: '#5f6368' }}>
                          <p>No results found for "{searchQuery}"</p>
                        </div>
                      ) : (
                        <>
                          {searchResults.tenants.length > 0 && (
                            <div className="search-results-section">
                              <h4>Tenants ({searchResults.tenants.length})</h4>
                              {searchResults.tenants.map(tenant => (
                                <div 
                                  key={tenant.id} 
                                  className="search-result-item"
                                  onClick={async () => {
                                    setSelectedTenant(tenant);
                                    setSearchQuery('');
                                    setActiveTab('tenants');
                                    // Load files for this tenant
                                    const files = await loadFilesForRecord('tenant', tenant.id);
                                    setTenantFiles(files);
                                  }}
                                >
                                  <strong>{tenant.name || 'Unnamed'}</strong>
                                  <span>{tenant.property || 'No property'}</span>
                                </div>
                              ))}
                            </div>
                          )}
                          {searchResults.properties.length > 0 && (
                            <div className="search-results-section">
                              <h4>Properties ({searchResults.properties.length})</h4>
                              {searchResults.properties.map(property => (
                                <div 
                                  key={property.id} 
                                  className="search-result-item"
                                  onClick={async () => {
                                    setSelectedProperty(property);
                                    setSearchQuery('');
                                    setActiveTab('properties');
                                    // Load files for this property
                                    const files = await loadFilesForRecord('property', property.id);
                                    setPropertyFiles(files);
                                  }}
                                >
                                  <strong>{property.address || 'Unnamed'}</strong>
                                  <span>{property.type || 'No type'}</span>
                                </div>
                              ))}
                            </div>
                          )}
                        </>
                      )}
                    </div>
                  </div>
                );
              })()}

              {/* Dashboard Tab */}
              {activeTab === 'dashboard' && (
                <div className="dashboard-container" style={{ maxWidth: '1400px', margin: '0 auto' }}>
                  {(() => {
                    const hour = new Date().getHours();
                    const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
                    const formattedName = getUserDisplayName();
                    const today = new Date();
                    const dateString = today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    
                    // Calculate key metrics
                    const overduePayments = tenants.filter(t => t.status === 'current' && t.paymentStatus === 'late');
                    const urgentMaintenance = maintenanceRequests.filter(r => r.status === 'open' && (r.priority === 'high' || r.priority === 'urgent'));
                    const leasesExpiring14Days = tenants.filter(t => {
                      if (!t.leaseEnd || t.status !== 'current') return false;
                      const endDate = new Date(t.leaseEnd);
                      const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                      return daysUntil <= 14 && daysUntil >= 0;
                    });
                    const unpaidLateFees = lateFees.filter(f => f.status === 'unpaid');
                    
                    const totalAttentionItems = overduePayments.length + urgentMaintenance.length + leasesExpiring14Days.length + unpaidLateFees.length;
                    
                    // Calculate collection stats
                    const expectedRevenue = tenants.filter(t => t.status === 'current').reduce((sum, t) => sum + (t.rentAmount || 0), 0);
                    const collectedRevenue = tenants.filter(t => t.status === 'current' && t.paymentStatus === 'paid').reduce((sum, t) => sum + (t.rentAmount || 0), 0);
                    const collectionRate = expectedRevenue > 0 ? Math.round((collectedRevenue / expectedRevenue) * 100) : 0;
                    
                    // Occupancy
                    const totalUnits = properties.reduce((sum, p) => sum + (p.units || 1), 0);
                    const occupiedUnits = properties.reduce((sum, p) => sum + (p.occupied || 0), 0);
                    const occupancyRate = totalUnits > 0 ? Math.round((occupiedUnits / totalUnits) * 100) : 0;
                    
                    // Open maintenance
                    const openMaintenance = maintenanceRequests.filter(r => r.status === 'open' || r.status === 'in_progress').length;

                    // Brand colors - monochrome with single accent
                    const colors = {
                      text: '#0f172a',
                      textSecondary: '#64748b',
                      textMuted: '#94a3b8',
                      border: '#e2e8f0',
                      borderLight: '#f1f5f9',
                      bg: '#ffffff',
                      bgSubtle: '#f8fafc',
                      accent: '#3b82f6',
                      accentHover: '#2563eb',
                      success: '#10b981',
                      warning: '#f59e0b',
                      danger: '#ef4444'
                    };
                    
                    return (
                      <>
                        {/* Clean Header */}
                        <div style={{ marginBottom: '32px' }}>
                          <p style={{ margin: '0 0 4px 0', fontSize: '13px', color: colors.textMuted, fontWeight: '500', letterSpacing: '0.5px' }}>
                            {dateString.toUpperCase()}
                          </p>
                          <h1 style={{ margin: '0 0 8px 0', fontSize: '28px', fontWeight: '600', color: colors.text, letterSpacing: '-0.5px' }}>
                            {greeting}, {formattedName}
                          </h1>
                          {totalAttentionItems > 0 ? (
                            <p style={{ margin: 0, fontSize: '15px', color: colors.textSecondary }}>
                              {totalAttentionItems} item{totalAttentionItems !== 1 ? 's' : ''} need your attention
                            </p>
                          ) : (
                            <p style={{ margin: 0, fontSize: '15px', color: colors.success }}>
                              All caught up. Your portfolio is running smoothly.
                            </p>
                          )}
                        </div>

                        {/* Action Items - Subtle left border style */}
                        {totalAttentionItems > 0 && (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '32px' }}>
                            {overduePayments.length > 0 && (
                              <div 
                                onClick={() => { setActiveTab('tenants'); setFilterStatus('late'); }}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  padding: '14px 16px',
                                  background: colors.bg,
                                  borderRadius: '8px',
                                  border: `1px solid ${colors.border}`,
                                  borderLeft: `3px solid ${colors.danger}`,
                                  cursor: 'pointer',
                                  transition: 'all 0.15s ease'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.background = colors.bgSubtle; e.currentTarget.style.borderColor = colors.textMuted; }}
                                onMouseLeave={(e) => { e.currentTarget.style.background = colors.bg; e.currentTarget.style.borderColor = colors.border; }}
                              >
                                <div>
                                  <p style={{ margin: 0, fontSize: '14px', fontWeight: '500', color: colors.text }}>
                                    {overduePayments.length} overdue payment{overduePayments.length !== 1 ? 's' : ''}
                                  </p>
                                  <p style={{ margin: '2px 0 0', fontSize: '13px', color: colors.textSecondary }}>
                                    ${overduePayments.reduce((sum, t) => sum + (t.rentAmount || 0), 0).toLocaleString()} outstanding
                                  </p>
                                </div>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={colors.textMuted} strokeWidth="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                              </div>
                            )}

                            {urgentMaintenance.length > 0 && (
                              <div 
                                onClick={() => setActiveTab('maintenance')}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  padding: '14px 16px',
                                  background: colors.bg,
                                  borderRadius: '8px',
                                  border: `1px solid ${colors.border}`,
                                  borderLeft: `3px solid ${colors.warning}`,
                                  cursor: 'pointer',
                                  transition: 'all 0.15s ease'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.background = colors.bgSubtle; e.currentTarget.style.borderColor = colors.textMuted; }}
                                onMouseLeave={(e) => { e.currentTarget.style.background = colors.bg; e.currentTarget.style.borderColor = colors.border; }}
                              >
                                <div>
                                  <p style={{ margin: 0, fontSize: '14px', fontWeight: '500', color: colors.text }}>
                                    {urgentMaintenance.length} urgent request{urgentMaintenance.length !== 1 ? 's' : ''}
                                  </p>
                                  <p style={{ margin: '2px 0 0', fontSize: '13px', color: colors.textSecondary }}>
                                    {urgentMaintenance[0]?.issue?.substring(0, 40)}{urgentMaintenance[0]?.issue?.length > 40 ? '...' : ''}
                                  </p>
                                </div>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={colors.textMuted} strokeWidth="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                              </div>
                            )}

                            {leasesExpiring14Days.length > 0 && (
                              <div 
                                onClick={() => { setActiveTab('tenants'); setFilterStatus('expiring'); }}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  padding: '14px 16px',
                                  background: colors.bg,
                                  borderRadius: '8px',
                                  border: `1px solid ${colors.border}`,
                                  borderLeft: `3px solid ${colors.accent}`,
                                  cursor: 'pointer',
                                  transition: 'all 0.15s ease'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.background = colors.bgSubtle; e.currentTarget.style.borderColor = colors.textMuted; }}
                                onMouseLeave={(e) => { e.currentTarget.style.background = colors.bg; e.currentTarget.style.borderColor = colors.border; }}
                              >
                                <div>
                                  <p style={{ margin: 0, fontSize: '14px', fontWeight: '500', color: colors.text }}>
                                    {leasesExpiring14Days.length} lease{leasesExpiring14Days.length !== 1 ? 's' : ''} expiring soon
                                  </p>
                                  <p style={{ margin: '2px 0 0', fontSize: '13px', color: colors.textSecondary }}>
                                    Within 14 days
                                  </p>
                                </div>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={colors.textMuted} strokeWidth="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                              </div>
                            )}

                            {unpaidLateFees.length > 0 && (
                              <div 
                                onClick={() => setActiveTab('late-fees')}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  padding: '14px 16px',
                                  background: colors.bg,
                                  borderRadius: '8px',
                                  border: `1px solid ${colors.border}`,
                                  borderLeft: `3px solid ${colors.textMuted}`,
                                  cursor: 'pointer',
                                  transition: 'all 0.15s ease'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.background = colors.bgSubtle; e.currentTarget.style.borderColor = colors.textMuted; }}
                                onMouseLeave={(e) => { e.currentTarget.style.background = colors.bg; e.currentTarget.style.borderColor = colors.border; }}
                              >
                                <div>
                                  <p style={{ margin: 0, fontSize: '14px', fontWeight: '500', color: colors.text }}>
                                    {unpaidLateFees.length} late fee{unpaidLateFees.length !== 1 ? 's' : ''} to collect
                                  </p>
                                  <p style={{ margin: '2px 0 0', fontSize: '13px', color: colors.textSecondary }}>
                                    ${unpaidLateFees.reduce((sum, f) => sum + parseFloat(f.fee_amount), 0).toFixed(0)} pending
                                  </p>
                                </div>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={colors.textMuted} strokeWidth="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Stats Grid - Clean cards with thin progress bars */}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '32px' }}>
                          {/* Collection Rate */}
                          <div style={{
                            background: colors.bg,
                            borderRadius: '12px',
                            padding: '20px',
                            border: `1px solid ${colors.border}`
                          }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                              <p style={{ margin: 0, fontSize: '13px', color: colors.textSecondary, fontWeight: '500' }}>Collection Rate</p>
                            </div>
                            <p style={{ margin: '0 0 4px 0', fontSize: '32px', fontWeight: '600', color: colors.text, letterSpacing: '-1px' }}>{collectionRate}%</p>
                            <p style={{ margin: '0 0 12px 0', fontSize: '12px', color: colors.textMuted }}>
                              ${collectedRevenue.toLocaleString()} of ${expectedRevenue.toLocaleString()}
                            </p>
                            <div style={{ height: '3px', background: colors.borderLight, borderRadius: '2px', overflow: 'hidden' }}>
                              <div style={{ 
                                width: `${collectionRate}%`, 
                                height: '100%', 
                                background: collectionRate >= 90 ? colors.success : collectionRate >= 70 ? colors.warning : colors.danger,
                                borderRadius: '2px',
                                transition: 'width 0.5s ease'
                              }}></div>
                            </div>
                          </div>

                          {/* Occupancy */}
                          <div style={{
                            background: colors.bg,
                            borderRadius: '12px',
                            padding: '20px',
                            border: `1px solid ${colors.border}`
                          }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                              <p style={{ margin: 0, fontSize: '13px', color: colors.textSecondary, fontWeight: '500' }}>Occupancy</p>
                            </div>
                            <p style={{ margin: '0 0 4px 0', fontSize: '32px', fontWeight: '600', color: colors.text, letterSpacing: '-1px' }}>{occupancyRate}%</p>
                            <p style={{ margin: '0 0 12px 0', fontSize: '12px', color: colors.textMuted }}>
                              {occupiedUnits} of {totalUnits} units
                            </p>
                            <div style={{ height: '3px', background: colors.borderLight, borderRadius: '2px', overflow: 'hidden' }}>
                              <div style={{ width: `${occupancyRate}%`, height: '100%', background: colors.accent, borderRadius: '2px' }}></div>
                            </div>
                          </div>

                          {/* Open Tickets */}
                          <div 
                            onClick={() => setActiveTab('maintenance')}
                            style={{
                              background: colors.bg,
                              borderRadius: '12px',
                              padding: '20px',
                              border: `1px solid ${colors.border}`,
                              cursor: 'pointer',
                              transition: 'border-color 0.15s ease'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.borderColor = colors.textMuted}
                            onMouseLeave={(e) => e.currentTarget.style.borderColor = colors.border}
                          >
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                              <p style={{ margin: 0, fontSize: '13px', color: colors.textSecondary, fontWeight: '500' }}>Open Tickets</p>
                            </div>
                            <p style={{ margin: '0 0 4px 0', fontSize: '32px', fontWeight: '600', color: colors.text, letterSpacing: '-1px' }}>{openMaintenance}</p>
                            <p style={{ margin: 0, fontSize: '12px', color: urgentMaintenance.length > 0 ? colors.warning : colors.textMuted }}>
                              {urgentMaintenance.length} high priority
                            </p>
                          </div>

                          {/* Monthly Revenue */}
                          <div 
                            onClick={() => setActiveTab('reports')}
                            style={{
                              background: colors.bg,
                              borderRadius: '12px',
                              padding: '20px',
                              border: `1px solid ${colors.border}`,
                              cursor: 'pointer',
                              transition: 'border-color 0.15s ease'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.borderColor = colors.textMuted}
                            onMouseLeave={(e) => e.currentTarget.style.borderColor = colors.border}
                          >
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                              <p style={{ margin: 0, fontSize: '13px', color: colors.textSecondary, fontWeight: '500' }}>Expected Revenue</p>
                            </div>
                            <p style={{ margin: '0 0 4px 0', fontSize: '32px', fontWeight: '600', color: colors.text, letterSpacing: '-1px' }}>${expectedRevenue.toLocaleString()}</p>
                            <p style={{ margin: 0, fontSize: '12px', color: colors.success }}>
                              This month
                            </p>
                          </div>
                        </div>

                        {/* Two Column Layout */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px', marginBottom: '32px' }}>
                          
                          {/* Overdue Payments */}
                          <div style={{
                            background: colors.bg,
                            borderRadius: '12px',
                            border: `1px solid ${colors.border}`,
                            overflow: 'hidden'
                          }}>
                            <div style={{ padding: '16px 20px', borderBottom: `1px solid ${colors.borderLight}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                              <div>
                                <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600', color: colors.text }}>Overdue Payments</h3>
                                <p style={{ margin: '2px 0 0', fontSize: '12px', color: colors.textMuted }}>{overduePayments.length} tenant{overduePayments.length !== 1 ? 's' : ''}</p>
                              </div>
                              {overduePayments.length > 0 && (
                                <button 
                                  onClick={() => { setActiveTab('tenants'); setFilterStatus('late'); }}
                                  style={{ background: 'none', border: 'none', color: colors.accent, fontSize: '12px', fontWeight: '500', cursor: 'pointer' }}
                                >
                                  View all
                                </button>
                              )}
                            </div>
                            <div style={{ maxHeight: '280px', overflowY: 'auto' }}>
                              {overduePayments.length === 0 ? (
                                <div style={{ padding: '32px 20px', textAlign: 'center' }}>
                                  <p style={{ margin: 0, fontSize: '13px', color: colors.textMuted }}>No overdue payments</p>
                                </div>
                              ) : (
                                overduePayments.slice(0, 5).map((tenant, idx) => (
                                  <div 
                                    key={tenant.id}
                                    onClick={async () => {
                                      setSelectedTenant(tenant);
                                      const files = await loadFilesForRecord('tenant', tenant.id);
                                      setTenantFiles(files);
                                    }}
                                    style={{
                                      padding: '12px 20px',
                                      borderBottom: idx < Math.min(overduePayments.length, 5) - 1 ? `1px solid ${colors.borderLight}` : 'none',
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '12px',
                                      cursor: 'pointer',
                                      transition: 'background 0.1s ease'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = colors.bgSubtle}
                                    onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                  >
                                    <div style={{
                                      width: '36px',
                                      height: '36px',
                                      borderRadius: '8px',
                                      background: colors.bgSubtle,
                                      color: colors.textSecondary,
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      fontSize: '12px',
                                      fontWeight: '600'
                                    }}>
                                      {getInitials(tenant.name)}
                                    </div>
                                    <div style={{ flex: 1, minWidth: 0 }}>
                                      <p style={{ margin: 0, fontWeight: '500', color: colors.text, fontSize: '13px' }}>{tenant.name}</p>
                                      <p style={{ margin: '1px 0 0', fontSize: '12px', color: colors.textMuted, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                        {tenant.property?.split(',')[0]}
                                      </p>
                                    </div>
                                    <div style={{ textAlign: 'right' }}>
                                      <p style={{ margin: 0, fontWeight: '600', color: colors.text, fontSize: '13px' }}>${tenant.rentAmount?.toLocaleString()}</p>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          sendSMSReminder(tenant);
                                        }}
                                        style={{
                                          background: 'none',
                                          border: 'none',
                                          color: colors.accent,
                                          fontSize: '11px',
                                          cursor: 'pointer',
                                          padding: 0,
                                          fontWeight: '500'
                                        }}
                                      >
                                        Remind
                                      </button>
                                    </div>
                                  </div>
                                ))
                              )}
                            </div>
                          </div>

                          {/* Maintenance Requests */}
                          <div style={{
                            background: colors.bg,
                            borderRadius: '12px',
                            border: `1px solid ${colors.border}`,
                            overflow: 'hidden'
                          }}>
                            <div style={{ padding: '16px 20px', borderBottom: `1px solid ${colors.borderLight}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                              <div>
                                <h3 style={{ margin: 0, fontSize: '14px', fontWeight: '600', color: colors.text }}>Maintenance</h3>
                                <p style={{ margin: '2px 0 0', fontSize: '12px', color: colors.textMuted }}>{openMaintenance} open</p>
                              </div>
                              {openMaintenance > 0 && (
                                <button 
                                  onClick={() => setActiveTab('maintenance')}
                                  style={{ background: 'none', border: 'none', color: colors.accent, fontSize: '12px', fontWeight: '500', cursor: 'pointer' }}
                                >
                                  View all
                                </button>
                              )}
                            </div>
                            <div style={{ maxHeight: '280px', overflowY: 'auto' }}>
                              {maintenanceRequests.filter(r => r.status === 'open' || r.status === 'in_progress').length === 0 ? (
                                <div style={{ padding: '32px 20px', textAlign: 'center' }}>
                                  <p style={{ margin: 0, fontSize: '13px', color: colors.textMuted }}>No open requests</p>
                                </div>
                              ) : (
                                maintenanceRequests
                                  .filter(r => r.status === 'open' || r.status === 'in_progress')
                                  .slice(0, 5)
                                  .map((request, idx, arr) => (
                                    <div 
                                      key={request.id}
                                      onClick={() => setSelectedMaintenanceRequest(request)}
                                      style={{
                                        padding: '12px 20px',
                                        borderBottom: idx < arr.length - 1 ? `1px solid ${colors.borderLight}` : 'none',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px',
                                        cursor: 'pointer',
                                        transition: 'background 0.1s ease'
                                      }}
                                      onMouseEnter={(e) => e.currentTarget.style.background = colors.bgSubtle}
                                      onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                    >
                                      <div style={{
                                        width: '8px',
                                        height: '8px',
                                        borderRadius: '50%',
                                        background: request.priority === 'high' || request.priority === 'urgent' ? colors.danger : request.priority === 'medium' ? colors.warning : colors.textMuted,
                                        flexShrink: 0
                                      }}></div>
                                      <div style={{ flex: 1, minWidth: 0 }}>
                                        <p style={{ margin: 0, fontWeight: '500', color: colors.text, fontSize: '13px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                          {request.issue}
                                        </p>
                                        <p style={{ margin: '1px 0 0', fontSize: '12px', color: colors.textMuted }}>
                                          {request.property?.split(',')[0]}
                                        </p>
                                      </div>
                                      <span style={{
                                        fontSize: '11px',
                                        padding: '3px 8px',
                                        borderRadius: '4px',
                                        background: request.status === 'in_progress' ? colors.bgSubtle : 'transparent',
                                        border: `1px solid ${colors.border}`,
                                        color: colors.textSecondary,
                                        fontWeight: '500'
                                      }}>
                                        {request.status === 'in_progress' ? 'In Progress' : 'Open'}
                                      </span>
                                    </div>
                                  ))
                              )}
                            </div>
                          </div>
                        </div>

                        {/* Quick Actions - Minimal style */}
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                          <button
                            onClick={() => setShowAddTenantModal(true)}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px',
                              padding: '8px 14px',
                              background: 'transparent',
                              border: `1px solid ${colors.border}`,
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '500',
                              color: colors.textSecondary,
                              cursor: 'pointer',
                              transition: 'all 0.1s ease'
                            }}
                            onMouseEnter={(e) => { e.currentTarget.style.borderColor = colors.textMuted; e.currentTarget.style.color = colors.text; }}
                            onMouseLeave={(e) => { e.currentTarget.style.borderColor = colors.border; e.currentTarget.style.color = colors.textSecondary; }}
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                            Add Tenant
                          </button>
                          <button
                            onClick={() => setShowAddPropertyModal(true)}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px',
                              padding: '8px 14px',
                              background: 'transparent',
                              border: `1px solid ${colors.border}`,
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '500',
                              color: colors.textSecondary,
                              cursor: 'pointer',
                              transition: 'all 0.1s ease'
                            }}
                            onMouseEnter={(e) => { e.currentTarget.style.borderColor = colors.textMuted; e.currentTarget.style.color = colors.text; }}
                            onMouseLeave={(e) => { e.currentTarget.style.borderColor = colors.border; e.currentTarget.style.color = colors.textSecondary; }}
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                            Add Property
                          </button>
                          <button
                            onClick={() => setShowAddMaintenanceModal(true)}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px',
                              padding: '8px 14px',
                              background: 'transparent',
                              border: `1px solid ${colors.border}`,
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '500',
                              color: colors.textSecondary,
                              cursor: 'pointer',
                              transition: 'all 0.1s ease'
                            }}
                            onMouseEnter={(e) => { e.currentTarget.style.borderColor = colors.textMuted; e.currentTarget.style.color = colors.text; }}
                            onMouseLeave={(e) => { e.currentTarget.style.borderColor = colors.border; e.currentTarget.style.color = colors.textSecondary; }}
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                            New Request
                          </button>
                          <button
                            onClick={() => setShowOnboardingWizard(true)}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px',
                              padding: '8px 14px',
                              background: colors.accent,
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '500',
                              color: 'white',
                              cursor: 'pointer',
                              transition: 'background 0.1s ease'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = colors.accentHover}
                            onMouseLeave={(e) => e.currentTarget.style.background = colors.accent}
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                            Move-In Wizard
                          </button>
                        </div>
                      </>
                    );
                  })()}
                </div>
              )}

              {/* Late Payments Banner */}
              {stats.latePayments > 0 && activeTab !== 'dashboard' && !dismissedBanners.includes('late-payments') && (
                <div className="alert-banner" style={{ background: '#fee2e2', borderColor: '#fecaca', marginBottom: '16px' }}>
                <div className="alert-content" style={{ flex: 1, minWidth: 0 }}>
                  <span className="alert-icon">ð°</span>
                  <div className="alert-text" style={{ wordWrap: 'break-word', overflowWrap: 'break-word' }}>
                    <strong>You have {stats.latePayments} tenant{stats.latePayments > 1 ? 's' : ''} with late payments</strong>
                  </div>
                </div>
                <div style={{ display: 'flex', gap: '12px', alignItems: 'center', flexShrink: 0 }}>
                  <button 
                    className="alert-action"
                    onClick={() => {
                      setActiveTab('tenants');
                      setFilterStatus('late');
                    }}
                    style={{
                      background: 'none',
                      border: 'none',
                      color: '#1a73e8',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: '500',
                      padding: '0',
                      textDecoration: 'none',
                      whiteSpace: 'nowrap'
                    }}
                    onMouseEnter={(e) => e.target.style.textDecoration = 'underline'}
                    onMouseLeave={(e) => e.target.style.textDecoration = 'none'}
                  >
                    View Late Tenants
                  </button>
                  <button
                    onClick={() => {
                      setDismissedBanners([...dismissedBanners, 'late-payments']);
                      // Reset filter if currently on late filter
                      if (filterStatus === 'late' && activeTab === 'tenants') {
                        setFilterStatus('all');
                      }
                    }}
                    style={{
                      background: 'none',
                      border: 'none',
                      color: '#5f6368',
                      cursor: 'pointer',
                      padding: '4px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      borderRadius: '4px'
                    }}
                    onMouseEnter={(e) => e.target.style.background = 'rgba(0,0,0,0.05)'}
                    onMouseLeave={(e) => e.target.style.background = 'none'}
                    title="Dismiss"
                    aria-label="Dismiss alert"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
            )}

            {expiringLeases.length > 0 && !dismissedBanners.includes('expiring-leases') && (
              <div className="alert-banner" style={{ marginBottom: '16px' }}>
                <div className="alert-content" style={{ flex: 1, minWidth: 0 }}>
                  <span className="alert-icon">â ï¸</span>
                  <div className="alert-text" style={{ wordWrap: 'break-word', overflowWrap: 'break-word' }}>
                    <strong>{expiringLeases.length} lease{expiringLeases.length > 1 ? 's' : ''} expiring within 90 days:</strong>
                    <span className="alert-tenants" style={{ display: 'block', marginTop: '4px', wordWrap: 'break-word', overflowWrap: 'break-word' }}>
                      {expiringLeases.map(t => t.name).join(', ')}
                    </span>
                  </div>
                </div>
                <div style={{ display: 'flex', gap: '12px', alignItems: 'center', flexShrink: 0 }}>
                  <button 
                    className="alert-action"
                    onClick={() => {
                      setActiveTab('tenants');
                      setFilterStatus('expiring');
                    }}
                    style={{
                      background: 'none',
                      border: 'none',
                      color: '#1a73e8',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: '500',
                      padding: '0',
                      textDecoration: 'none',
                      whiteSpace: 'nowrap'
                    }}
                    onMouseEnter={(e) => e.target.style.textDecoration = 'underline'}
                    onMouseLeave={(e) => e.target.style.textDecoration = 'none'}
                  >
                    View Expiring Leases
                  </button>
                  <button
                    onClick={() => {
                      setDismissedBanners([...dismissedBanners, 'expiring-leases']);
                      // Reset filter if currently on expiring filter
                      if (filterStatus === 'expiring' && activeTab === 'tenants') {
                        setFilterStatus('all');
                      }
                    }}
                    style={{
                      background: 'none',
                      border: 'none',
                      color: '#5f6368',
                      cursor: 'pointer',
                      padding: '4px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      borderRadius: '4px'
                    }}
                    onMouseEnter={(e) => e.target.style.background = 'rgba(0,0,0,0.05)'}
                    onMouseLeave={(e) => e.target.style.background = 'none'}
                    title="Dismiss"
                    aria-label="Dismiss alert"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
            )}

              {activeTab === 'tenants' && (
                <div style={{ padding: 24 }}>
                  {/* Header */}
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 24 }}>
                    <div>
                      <h1 style={{ fontSize: 28, fontWeight: 700, marginBottom: 4, margin: 0 }}>Tenants</h1>
                      <p style={{ color: '#6b7280', fontSize: 14, margin: '4px 0 0' }}>{tenants.length} total tenants</p>
                    </div>
                    <div style={{ display: 'flex', gap: 12 }}>
                      <button 
                        className='btn-secondary' 
                        onClick={() => {
                          setShowOnboardingWizard(true);
                          setOnboardingStep(1);
                          setOnboardingData({
                            property: null,
                            unit: '',
                            tenant: { name: '', email: '', phone: '', isExisting: false, existingId: null },
                            lease: { monthlyRent: '', securityDeposit: '', startDate: '', endDate: '', leaseType: 'fixed' },
                            documents: [],
                            moveInDate: '',
                            moveInNotes: ''
                          });
                        }}
                        style={{
                          background: 'white',
                          border: '1px solid #e5e7eb',
                          borderRadius: 8,
                          padding: '10px 20px',
                          fontSize: 14,
                          fontWeight: 500,
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          gap: 8
                        }}
                      >
                        + Onboard
                      </button>
                      <button 
                        className='btn-primary' 
                        onClick={() => setShowAddModal(true)}
                        style={{
                          background: '#1a73e8',
                          color: 'white',
                          border: 'none',
                          borderRadius: 8,
                          padding: '10px 20px',
                          fontSize: 14,
                          fontWeight: 500,
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          gap: 8
                        }}
                      >
                        + Add Tenant
                      </button>
                    </div>
                  </div>
                  
                  {/* Quick Stats Bar */}
                  <div style={{ display: 'flex', gap: 16, marginBottom: 24, overflowX: 'auto', paddingBottom: 8 }}>
                    <div 
                      onClick={() => setTenantFilter('all')}
                      style={{
                        padding: '12px 20px',
                        background: tenantFilter === 'all' ? '#1a73e8' : 'white',
                        color: tenantFilter === 'all' ? 'white' : '#4b5563',
                        borderRadius: 24,
                        border: '1px solid #e5e7eb',
                        cursor: 'pointer',
                        whiteSpace: 'nowrap',
                        fontWeight: 500,
                        fontSize: 14
                      }}
                    >
                      All ({tenants.length})
                    </div>
                    <div 
                      onClick={() => setTenantFilter('current')}
                      style={{
                        padding: '12px 20px',
                        background: tenantFilter === 'current' ? '#10b981' : 'white',
                        color: tenantFilter === 'current' ? 'white' : '#4b5563',
                        borderRadius: 24,
                        border: '1px solid #e5e7eb',
                        cursor: 'pointer',
                        whiteSpace: 'nowrap',
                        fontWeight: 500,
                        fontSize: 14
                      }}
                    >
                      Current ({tenants.filter(t => t.status === 'Current' || t.status === 'current').length})
                    </div>
                    <div 
                      onClick={() => setTenantFilter('late')}
                      style={{
                        padding: '12px 20px',
                        background: tenantFilter === 'late' ? '#ef4444' : 'white',
                        color: tenantFilter === 'late' ? 'white' : '#4b5563',
                        borderRadius: 24,
                        border: '1px solid #e5e7eb',
                        cursor: 'pointer',
                        whiteSpace: 'nowrap',
                        fontWeight: 500,
                        fontSize: 14
                      }}
                    >
                      Late ({tenants.filter(t => (t.status === 'Current' || t.status === 'current') && t.paymentStatus === 'late').length})
                    </div>
                    <div 
                      onClick={() => setTenantFilter('expiring')}
                      style={{
                        padding: '12px 20px',
                        background: tenantFilter === 'expiring' ? '#f59e0b' : 'white',
                        color: tenantFilter === 'expiring' ? 'white' : '#4b5563',
                        borderRadius: 24,
                        border: '1px solid #e5e7eb',
                        cursor: 'pointer',
                        whiteSpace: 'nowrap',
                        fontWeight: 500,
                        fontSize: 14
                      }}
                    >
                      Expiring Soon ({getExpiringLeases().length})
                    </div>
                    <div 
                      onClick={() => setTenantFilter('prospects')}
                      style={{
                        padding: '12px 20px',
                        background: tenantFilter === 'prospects' ? '#8b5cf6' : 'white',
                        color: tenantFilter === 'prospects' ? 'white' : '#4b5563',
                        borderRadius: 24,
                        border: '1px solid #e5e7eb',
                        cursor: 'pointer',
                        whiteSpace: 'nowrap',
                        fontWeight: 500,
                        fontSize: 14
                      }}
                    >
                      Prospects ({tenants.filter(t => t.status === 'Prospect' || t.status === 'prospect').length})
                    </div>
                  </div>
                  
                  {/* Search and View Toggle */}
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
                    <div style={{ position: 'relative', width: 300 }}>
                      <span style={{ position: 'absolute', left: 12, top: '50%', transform: 'translateY(-50%)', color: '#9ca3af' }}>ð</span>
                      <input
                        type='text'
                        placeholder='Search tenants...'
                        value={tenantSearchQuery}
                        onChange={(e) => setTenantSearchQuery(e.target.value)}
                        style={{
                          width: '100%',
                          padding: '10px 12px 10px 40px',
                          border: '1px solid #e5e7eb',
                          borderRadius: 8,
                          fontSize: 14
                        }}
                      />
                    </div>
                    
                    {/* View Toggle */}
                    <div style={{ display: 'flex', background: '#f3f4f6', borderRadius: 8, padding: 4 }}>
                      <button
                        onClick={() => setTenantsView('board')}
                        style={{
                          padding: '8px 16px',
                          border: 'none',
                          borderRadius: 6,
                          background: tenantsView === 'board' ? 'white' : 'transparent',
                          boxShadow: tenantsView === 'board' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none',
                          cursor: 'pointer',
                          fontSize: 14
                        }}
                      >
                        â¤ Board
                      </button>
                      <button
                        onClick={() => setTenantsView('cards')}
                        style={{
                          padding: '8px 16px',
                          border: 'none',
                          borderRadius: 6,
                          background: tenantsView === 'cards' ? 'white' : 'transparent',
                          boxShadow: tenantsView === 'cards' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none',
                          cursor: 'pointer',
                          fontSize: 14
                        }}
                      >
                        â¦ Cards
                      </button>
                      <button
                        onClick={() => setTenantsView('table')}
                        style={{
                          padding: '8px 16px',
                          border: 'none',
                          borderRadius: 6,
                          background: tenantsView === 'table' ? 'white' : 'transparent',
                          boxShadow: tenantsView === 'table' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none',
                          cursor: 'pointer',
                          fontSize: 14
                        }}
                      >
                        â° Table
                      </button>
                    </div>
                  </div>
                  
                  {/* BOARD VIEW - Kanban style grouped by status */}
                  {tenantsView === 'board' && (
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16, alignItems: 'flex-start' }}>
                      
                      {/* Current Column */}
                      <div style={{ background: '#ffffff', borderRadius: 12, border: '1px solid #e2e8f0', overflow: 'hidden' }}>
                        <div style={{ 
                          padding: '14px 16px', 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'center',
                          borderBottom: '1px solid #e2e8f0',
                          borderLeft: '3px solid #10b981'
                        }}>
                          <span style={{ color: '#0f172a', fontWeight: 600, fontSize: 13 }}>Current</span>
                          <span style={{ 
                            background: '#f1f5f9', 
                            color: '#64748b', 
                            padding: '2px 10px', 
                            borderRadius: 12, 
                            fontSize: 12, 
                            fontWeight: 600 
                          }}>
                            {getFilteredTenants().filter(t => (t.status === 'Current' || t.status === 'current') && t.paymentStatus !== 'late').length}
                          </span>
                        </div>
                        <div style={{ padding: 12, display: 'flex', flexDirection: 'column', gap: 8, maxHeight: 'calc(100vh - 320px)', overflowY: 'auto', background: '#f8fafc' }}>
                          {getFilteredTenants().filter(t => (t.status === 'Current' || t.status === 'current') && t.paymentStatus !== 'late').map(tenant => (
                            <TenantKanbanCard 
                              key={tenant.id} 
                              tenant={tenant} 
                              status="current" 
                              onClick={() => {
                                setSelectedTenant(tenant);
                                loadFilesForRecord('tenant', tenant.id).then(files => setTenantFiles(files));
                              }} 
                            />
                          ))}
                          {getFilteredTenants().filter(t => (t.status === 'Current' || t.status === 'current') && t.paymentStatus !== 'late').length === 0 && (
                            <p style={{ color: '#94a3b8', fontSize: 13, textAlign: 'center', padding: 20 }}>No current tenants</p>
                          )}
                        </div>
                      </div>
                      
                      {/* Late Column */}
                      <div style={{ background: '#ffffff', borderRadius: 12, border: '1px solid #e2e8f0', overflow: 'hidden' }}>
                        <div style={{ 
                          padding: '14px 16px', 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'center',
                          borderBottom: '1px solid #e2e8f0',
                          borderLeft: '3px solid #ef4444'
                        }}>
                          <span style={{ color: '#0f172a', fontWeight: 600, fontSize: 13 }}>Late</span>
                          <span style={{ 
                            background: '#fef2f2', 
                            color: '#dc2626', 
                            padding: '2px 10px', 
                            borderRadius: 12, 
                            fontSize: 12, 
                            fontWeight: 600 
                          }}>
                            {getFilteredTenants().filter(t => (t.status === 'Current' || t.status === 'current') && t.paymentStatus === 'late').length}
                          </span>
                        </div>
                        <div style={{ padding: 12, display: 'flex', flexDirection: 'column', gap: 8, maxHeight: 'calc(100vh - 320px)', overflowY: 'auto', background: '#f8fafc' }}>
                          {getFilteredTenants().filter(t => (t.status === 'Current' || t.status === 'current') && t.paymentStatus === 'late').map(tenant => (
                            <TenantKanbanCard 
                              key={tenant.id} 
                              tenant={tenant} 
                              status="late" 
                              onClick={() => {
                                setSelectedTenant(tenant);
                                loadFilesForRecord('tenant', tenant.id).then(files => setTenantFiles(files));
                              }} 
                            />
                          ))}
                          {getFilteredTenants().filter(t => (t.status === 'Current' || t.status === 'current') && t.paymentStatus === 'late').length === 0 && (
                            <p style={{ color: '#94a3b8', fontSize: 13, textAlign: 'center', padding: 20 }}>No late tenants</p>
                          )}
                        </div>
                      </div>
                      
                      {/* Prospects Column */}
                      <div style={{ background: '#ffffff', borderRadius: 12, border: '1px solid #e2e8f0', overflow: 'hidden' }}>
                        <div style={{ 
                          padding: '14px 16px', 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'center',
                          borderBottom: '1px solid #e2e8f0',
                          borderLeft: '3px solid #3b82f6'
                        }}>
                          <span style={{ color: '#0f172a', fontWeight: 600, fontSize: 13 }}>Prospects</span>
                          <span style={{ 
                            background: '#f1f5f9', 
                            color: '#64748b', 
                            padding: '2px 10px', 
                            borderRadius: 12, 
                            fontSize: 12, 
                            fontWeight: 600 
                          }}>
                            {getFilteredTenants().filter(t => t.status === 'Prospect' || t.status === 'prospect').length}
                          </span>
                        </div>
                        <div style={{ padding: 12, display: 'flex', flexDirection: 'column', gap: 8, maxHeight: 'calc(100vh - 320px)', overflowY: 'auto', background: '#f8fafc' }}>
                          {getFilteredTenants().filter(t => t.status === 'Prospect' || t.status === 'prospect').map(tenant => (
                            <TenantKanbanCard 
                              key={tenant.id} 
                              tenant={tenant} 
                              status="prospect" 
                              onClick={() => {
                                setSelectedTenant(tenant);
                                loadFilesForRecord('tenant', tenant.id).then(files => setTenantFiles(files));
                              }} 
                            />
                          ))}
                          {getFilteredTenants().filter(t => t.status === 'Prospect' || t.status === 'prospect').length === 0 && (
                            <p style={{ color: '#94a3b8', fontSize: 13, textAlign: 'center', padding: 20 }}>No prospects</p>
                          )}
                        </div>
                      </div>
                      
                      {/* Past Column */}
                      <div style={{ background: '#ffffff', borderRadius: 12, border: '1px solid #e2e8f0', overflow: 'hidden' }}>
                        <div style={{ 
                          padding: '14px 16px', 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'center',
                          borderBottom: '1px solid #e2e8f0',
                          borderLeft: '3px solid #94a3b8'
                        }}>
                          <span style={{ color: '#0f172a', fontWeight: 600, fontSize: 13 }}>Past</span>
                          <span style={{ 
                            background: '#f1f5f9', 
                            color: '#64748b', 
                            padding: '2px 10px', 
                            borderRadius: 12, 
                            fontSize: 12, 
                            fontWeight: 600 
                          }}>
                            {getFilteredTenants().filter(t => t.status === 'Past' || t.status === 'past').length}
                          </span>
                        </div>
                        <div style={{ padding: 12, display: 'flex', flexDirection: 'column', gap: 8, maxHeight: 'calc(100vh - 320px)', overflowY: 'auto', background: '#f8fafc' }}>
                          {getFilteredTenants().filter(t => t.status === 'Past' || t.status === 'past').map(tenant => (
                            <TenantKanbanCard 
                              key={tenant.id} 
                              tenant={tenant} 
                              status="past" 
                              onClick={() => {
                                setSelectedTenant(tenant);
                                loadFilesForRecord('tenant', tenant.id).then(files => setTenantFiles(files));
                              }} 
                            />
                          ))}
                          {getFilteredTenants().filter(t => t.status === 'Past' || t.status === 'past').length === 0 && (
                            <p style={{ color: '#9ca3af', fontSize: 13, textAlign: 'center', padding: 20 }}>No past tenants</p>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* CARDS VIEW - Grid of tenant cards */}
                  {tenantsView === 'cards' && (
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 16 }}>
                      {getFilteredTenants().map(tenant => {
                        const property = properties.find(p => p.id === tenant.property_id || p.address === tenant.property);
                        const tenantTags = getTenantTags(tenant.id);
                        const isLate = tenant.paymentStatus === 'late';
                        const displayStatus = tenant.status === 'current' || tenant.status === 'Current' 
                          ? (isLate ? 'Late' : 'Current')
                          : tenant.status === 'prospect' || tenant.status === 'Prospect'
                          ? 'Prospect'
                          : 'Past';
                        
                        return (
                          <div
                            key={tenant.id}
                            onClick={() => {
                              setSelectedTenant(tenant);
                              loadFilesForRecord('tenant', tenant.id).then(files => setTenantFiles(files));
                            }}
                            style={{
                              background: 'white',
                              borderRadius: 12,
                              border: '1px solid #e5e7eb',
                              padding: 20,
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'}
                            onMouseLeave={(e) => e.currentTarget.style.boxShadow = 'none'}
                          >
                            <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                              {/* Avatar */}
                              <div style={{
                                width: 56,
                                height: 56,
                                borderRadius: 12,
                                background: displayStatus === 'Current' ? '#d1fae5' : displayStatus === 'Late' ? '#fee2e2' : displayStatus === 'Prospect' ? '#ede9fe' : '#f3f4f6',
                                color: displayStatus === 'Current' ? '#065f46' : displayStatus === 'Late' ? '#991b1b' : displayStatus === 'Prospect' ? '#5b21b6' : '#4b5563',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontWeight: 700,
                                fontSize: 18
                              }}>
                                {tenant.name?.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase()}
                              </div>
                              
                              <div style={{ flex: 1 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                  <h3 style={{ fontWeight: 600, fontSize: 16, margin: 0 }}>{tenant.name}</h3>
                                  <span style={{
                                    padding: '2px 8px',
                                    borderRadius: 12,
                                    fontSize: 11,
                                    fontWeight: 500,
                                    background: displayStatus === 'Current' ? '#d1fae5' : displayStatus === 'Late' ? '#fee2e2' : displayStatus === 'Prospect' ? '#ede9fe' : '#f3f4f6',
                                    color: displayStatus === 'Current' ? '#065f46' : displayStatus === 'Late' ? '#991b1b' : displayStatus === 'Prospect' ? '#5b21b6' : '#4b5563'
                                  }}>
                                    {displayStatus}
                                  </span>
                                </div>
                                <p style={{ fontSize: 13, color: '#6b7280', margin: '4px 0' }}>{tenant.email}</p>
                                <p style={{ fontSize: 13, color: '#6b7280', margin: 0 }}>
                                  ð {property?.name || property?.address?.split(',')[0] || tenant.property || 'Unassigned'}{tenant.unit ? `, Unit ${tenant.unit}` : ''}
                                </p>
                              </div>
                            </div>
                            
                            {/* Financial Info */}
                            <div style={{ display: 'flex', gap: 24, marginTop: 16, paddingTop: 16, borderTop: '1px solid #f3f4f6' }}>
                              <div>
                                <p style={{ fontSize: 11, color: '#9ca3af', margin: 0, textTransform: 'uppercase' }}>Rent</p>
                                <p style={{ fontSize: 16, fontWeight: 600, margin: '4px 0 0' }}>${tenant.rentAmount || tenant.rent || 0}</p>
                              </div>
                              <div>
                                <p style={{ fontSize: 11, color: '#9ca3af', margin: 0, textTransform: 'uppercase' }}>Balance</p>
                                <p style={{ 
                                  fontSize: 16, 
                                  fontWeight: 600, 
                                  margin: '4px 0 0',
                                  color: (tenant.balance || 0) > 0 ? '#dc2626' : '#10b981'
                                }}>
                                  ${tenant.balance || 0}
                                </p>
                              </div>
                              <div>
                                <p style={{ fontSize: 11, color: '#9ca3af', margin: 0, textTransform: 'uppercase' }}>Lease Ends</p>
                                <p style={{ fontSize: 14, fontWeight: 500, margin: '4px 0 0' }}>
                                  {(tenant.leaseEnd || tenant.lease_end) ? new Date(tenant.leaseEnd || tenant.lease_end).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'MTM'}
                                </p>
                              </div>
                            </div>
                            
                            {/* Tags */}
                            {tenantTags.length > 0 && (
                              <div style={{ display: 'flex', gap: 6, marginTop: 12, flexWrap: 'wrap' }}>
                                {tenantTags.map(tag => {
                                  const tagColor = getTagColor(tag.color);
                                  return (
                                    <span key={tag.id} style={{
                                      padding: '2px 8px',
                                      borderRadius: 6,
                                      fontSize: 11,
                                      background: tagColor.bg,
                                      color: tagColor.text
                                    }}>
                                      {tag.name}
                                    </span>
                                  );
                                })}
                              </div>
                            )}
                            
                            {/* Quick Actions */}
                            <div style={{ display: 'flex', gap: 8, marginTop: 16 }}>
                              <a href={`mailto:${tenant.email}`} onClick={e => e.stopPropagation()} style={{
                                flex: 1,
                                padding: '8px 12px',
                                background: '#f3f4f6',
                                borderRadius: 6,
                                textAlign: 'center',
                                textDecoration: 'none',
                                color: '#4b5563',
                                fontSize: 13
                              }}>
                                âï¸ Email
                              </a>
                              <a href={`tel:${tenant.phone}`} onClick={e => e.stopPropagation()} style={{
                                flex: 1,
                                padding: '8px 12px',
                                background: '#f3f4f6',
                                borderRadius: 6,
                                textAlign: 'center',
                                textDecoration: 'none',
                                color: '#4b5563',
                                fontSize: 13
                              }}>
                                ð Call
                              </a>
                              <button onClick={(e) => { e.stopPropagation(); setShowPaymentRequestModal(tenant); }} style={{
                                flex: 1,
                                padding: '8px 12px',
                                background: '#1a73e8',
                                color: 'white',
                                border: 'none',
                                borderRadius: 6,
                                cursor: 'pointer',
                                fontSize: 13
                              }}>
                                ð° Payment
                              </button>
                            </div>
                          </div>
                        );
                      })}
                      {getFilteredTenants().length === 0 && (
                        <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: 40, color: '#5f6368' }}>
                          No tenants found
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* TABLE VIEW - Traditional table */}
                  {tenantsView === 'table' && (
                    <div>
                      {/* Advanced Filters Slide-out */}
                      {showAdvancedFilters && (
                        <div style={{
                          background: 'white',
                          borderRadius: 8,
                          border: '1px solid #e2e8f0',
                          padding: 20,
                          marginBottom: 16
                        }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                            <h4 style={{ margin: 0, fontSize: 14, fontWeight: 600, color: '#0f172a' }}>Advanced Filters</h4>
                            <button
                              onClick={() => {
                                setAdvancedFilters({ property: '', rentMin: '', rentMax: '', leaseEndBefore: '', leaseEndAfter: '', balanceDue: false });
                              }}
                              style={{
                                background: 'none',
                                border: 'none',
                                color: '#64748b',
                                fontSize: 12,
                                cursor: 'pointer',
                                textDecoration: 'underline'
                              }}
                            >
                              Clear all
                            </button>
                          </div>
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16 }}>
                            <div>
                              <label style={{ display: 'block', fontSize: 12, color: '#64748b', marginBottom: 4 }}>Property</label>
                              <select
                                value={advancedFilters.property}
                                onChange={(e) => setAdvancedFilters({ ...advancedFilters, property: e.target.value })}
                                style={{
                                  width: '100%',
                                  padding: '8px 12px',
                                  border: '1px solid #e2e8f0',
                                  borderRadius: 6,
                                  fontSize: 13,
                                  color: '#0f172a'
                                }}
                              >
                                <option value="">All Properties</option>
                                {properties.map(p => (
                                  <option key={p.id} value={p.id}>{p.name || p.address}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: 12, color: '#64748b', marginBottom: 4 }}>Rent Range</label>
                              <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                                <input
                                  type="number"
                                  placeholder="Min"
                                  value={advancedFilters.rentMin}
                                  onChange={(e) => setAdvancedFilters({ ...advancedFilters, rentMin: e.target.value })}
                                  style={{
                                    width: '100%',
                                    padding: '8px 12px',
                                    border: '1px solid #e2e8f0',
                                    borderRadius: 6,
                                    fontSize: 13
                                  }}
                                />
                                <span style={{ color: '#94a3b8' }}>-</span>
                                <input
                                  type="number"
                                  placeholder="Max"
                                  value={advancedFilters.rentMax}
                                  onChange={(e) => setAdvancedFilters({ ...advancedFilters, rentMax: e.target.value })}
                                  style={{
                                    width: '100%',
                                    padding: '8px 12px',
                                    border: '1px solid #e2e8f0',
                                    borderRadius: 6,
                                    fontSize: 13
                                  }}
                                />
                              </div>
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: 12, color: '#64748b', marginBottom: 4 }}>Lease Ends Between</label>
                              <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                                <input
                                  type="date"
                                  value={advancedFilters.leaseEndAfter}
                                  onChange={(e) => setAdvancedFilters({ ...advancedFilters, leaseEndAfter: e.target.value })}
                                  style={{
                                    width: '100%',
                                    padding: '8px 12px',
                                    border: '1px solid #e2e8f0',
                                    borderRadius: 6,
                                    fontSize: 13
                                  }}
                                />
                                <span style={{ color: '#94a3b8' }}>-</span>
                                <input
                                  type="date"
                                  value={advancedFilters.leaseEndBefore}
                                  onChange={(e) => setAdvancedFilters({ ...advancedFilters, leaseEndBefore: e.target.value })}
                                  style={{
                                    width: '100%',
                                    padding: '8px 12px',
                                    border: '1px solid #e2e8f0',
                                    borderRadius: 6,
                                    fontSize: 13
                                  }}
                                />
                              </div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                              <label style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' }}>
                                <input
                                  type="checkbox"
                                  checked={advancedFilters.balanceDue}
                                  onChange={(e) => setAdvancedFilters({ ...advancedFilters, balanceDue: e.target.checked })}
                                  style={{ width: 16, height: 16 }}
                                />
                                <span style={{ fontSize: 13, color: '#0f172a' }}>Has balance due</span>
                              </label>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Table Container */}
                      <div style={{ background: 'white', borderRadius: 8, border: '1px solid #e2e8f0', overflow: 'hidden' }}>
                        {/* Table Header Row */}
                        <div style={{ 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'center', 
                          padding: '12px 16px',
                          borderBottom: '1px solid #e2e8f0',
                          background: '#f8fafc'
                        }}>
                          <div style={{ fontSize: 13, color: '#64748b' }}>
                            {(() => {
                              const filtered = getFilteredTenants();
                              const start = (tenantsPage - 1) * tenantsPerPage + 1;
                              const end = Math.min(tenantsPage * tenantsPerPage, filtered.length);
                              return `Showing ${start}-${end} of ${filtered.length} tenants`;
                            })()}
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                            <button
                              onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: 6,
                                padding: '6px 12px',
                                background: showAdvancedFilters ? '#f1f5f9' : 'white',
                                border: '1px solid #e2e8f0',
                                borderRadius: 6,
                                fontSize: 12,
                                color: '#64748b',
                                cursor: 'pointer'
                              }}
                            >
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                              </svg>
                              Filters
                              {(advancedFilters.property || advancedFilters.rentMin || advancedFilters.rentMax || advancedFilters.leaseEndBefore || advancedFilters.leaseEndAfter || advancedFilters.balanceDue) && (
                                <span style={{
                                  width: 6,
                                  height: 6,
                                  borderRadius: '50%',
                                  background: '#3b82f6'
                                }}></span>
                              )}
                            </button>
                            <select
                              value={tenantsPerPage}
                              onChange={(e) => {
                                setTenantsPerPage(Number(e.target.value));
                                setTenantsPage(1);
                              }}
                              style={{
                                padding: '6px 12px',
                                border: '1px solid #e2e8f0',
                                borderRadius: 6,
                                fontSize: 12,
                                color: '#64748b',
                                background: 'white'
                              }}
                            >
                              <option value={10}>10 per page</option>
                              <option value={25}>25 per page</option>
                              <option value={50}>50 per page</option>
                              <option value={100}>100 per page</option>
                            </select>
                          </div>
                        </div>
                        
                        {/* Table */}
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                          <thead>
                            <tr style={{ background: '#f8fafc', borderBottom: '1px solid #e2e8f0' }}>
                              {[
                                { field: 'name', label: 'Tenant', width: '22%' },
                                { field: 'property', label: 'Property', width: '20%' },
                                { field: 'rent', label: 'Rent', width: '12%' },
                                { field: 'leaseEnd', label: 'Lease End', width: '14%' },
                                { field: 'status', label: 'Status', width: '12%' },
                                { field: 'contact', label: 'Contact', width: '10%' },
                                { field: 'actions', label: '', width: '10%' }
                              ].map(col => (
                                <th 
                                  key={col.field}
                                  onClick={() => {
                                    if (col.field !== 'contact' && col.field !== 'actions') {
                                      if (tenantsSortField === col.field) {
                                        setTenantsSortDirection(tenantsSortDirection === 'asc' ? 'desc' : 'asc');
                                      } else {
                                        setTenantsSortField(col.field);
                                        setTenantsSortDirection('asc');
                                      }
                                    }
                                  }}
                                  style={{ 
                                    padding: '10px 16px', 
                                    textAlign: 'left', 
                                    fontSize: 11, 
                                    fontWeight: 600, 
                                    color: '#64748b',
                                    textTransform: 'uppercase',
                                    letterSpacing: '0.5px',
                                    cursor: col.field !== 'contact' && col.field !== 'actions' ? 'pointer' : 'default',
                                    width: col.width,
                                    userSelect: 'none'
                                  }}
                                >
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
                                    {col.label}
                                    {tenantsSortField === col.field && (
                                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        {tenantsSortDirection === 'asc' 
                                          ? <path d="M18 15l-6-6-6 6"/> 
                                          : <path d="M6 9l6 6 6-6"/>
                                        }
                                      </svg>
                                    )}
                                  </div>
                                </th>
                              ))}
                            </tr>
                          </thead>
                          <tbody>
                            {(() => {
                              // Apply advanced filters
                              let filtered = getFilteredTenants().filter(tenant => {
                                if (advancedFilters.property && tenant.property_id !== advancedFilters.property && String(tenant.property_id) !== advancedFilters.property) return false;
                                const rent = tenant.rentAmount || tenant.rent || 0;
                                if (advancedFilters.rentMin && rent < Number(advancedFilters.rentMin)) return false;
                                if (advancedFilters.rentMax && rent > Number(advancedFilters.rentMax)) return false;
                                const leaseEnd = tenant.leaseEnd || tenant.lease_end;
                                if (advancedFilters.leaseEndAfter && leaseEnd && new Date(leaseEnd) < new Date(advancedFilters.leaseEndAfter)) return false;
                                if (advancedFilters.leaseEndBefore && leaseEnd && new Date(leaseEnd) > new Date(advancedFilters.leaseEndBefore)) return false;
                                if (advancedFilters.balanceDue && tenant.paymentStatus !== 'late') return false;
                                return true;
                              });
                              
                              // Sort
                              filtered.sort((a, b) => {
                                let aVal, bVal;
                                switch (tenantsSortField) {
                                  case 'name':
                                    aVal = a.name || '';
                                    bVal = b.name || '';
                                    break;
                                  case 'property':
                                    aVal = a.property || '';
                                    bVal = b.property || '';
                                    break;
                                  case 'rent':
                                    aVal = a.rentAmount || a.rent || 0;
                                    bVal = b.rentAmount || b.rent || 0;
                                    break;
                                  case 'leaseEnd':
                                    aVal = a.leaseEnd || a.lease_end || '9999-12-31';
                                    bVal = b.leaseEnd || b.lease_end || '9999-12-31';
                                    break;
                                  case 'status':
                                    aVal = a.status || '';
                                    bVal = b.status || '';
                                    break;
                                  default:
                                    aVal = a.name || '';
                                    bVal = b.name || '';
                                }
                                if (typeof aVal === 'string') {
                                  return tenantsSortDirection === 'asc' 
                                    ? aVal.localeCompare(bVal) 
                                    : bVal.localeCompare(aVal);
                                }
                                return tenantsSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                              });
                              
                              // Paginate
                              const startIndex = (tenantsPage - 1) * tenantsPerPage;
                              const paginated = filtered.slice(startIndex, startIndex + tenantsPerPage);
                              
                              if (paginated.length === 0) {
                                return (
                                  <tr>
                                    <td colSpan="7" style={{ padding: 40, textAlign: 'center', color: '#94a3b8' }}>
                                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ margin: '0 auto 12px', display: 'block' }}>
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                      </svg>
                                      No tenants found
                                    </td>
                                  </tr>
                                );
                              }
                              
                              return paginated.map((tenant, index) => {
                                const property = properties.find(p => p.id === tenant.property_id || p.address === tenant.property);
                                const isLate = (tenant.status === 'current' || tenant.status === 'Current') && tenant.paymentStatus === 'late';
                                const displayStatus = tenant.status === 'current' || tenant.status === 'Current'
                                  ? (isLate ? 'Late' : 'Current')
                                  : tenant.status === 'prospect' || tenant.status === 'Prospect'
                                  ? 'Prospect'
                                  : 'Past';
                                
                                return (
                                  <tr
                                    key={tenant.id}
                                    onClick={() => {
                                      setSelectedTenant(tenant);
                                      loadFilesForRecord('tenant', tenant.id).then(files => setTenantFiles(files));
                                    }}
                                    style={{
                                      borderBottom: '1px solid #f1f5f9',
                                      cursor: 'pointer',
                                      transition: 'background 0.15s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = '#f8fafc'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                                  >
                                    <td style={{ padding: '12px 16px' }}>
                                      <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                        <div style={{
                                          width: 36,
                                          height: 36,
                                          borderRadius: 8,
                                          background: '#f1f5f9',
                                          color: '#64748b',
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          fontSize: 13,
                                          fontWeight: 500,
                                          flexShrink: 0
                                        }}>
                                          {getInitials(tenant.name)}
                                        </div>
                                        <div>
                                          <div style={{ fontSize: 14, fontWeight: 500, color: '#0f172a' }}>{tenant.name}</div>
                                          <div style={{ fontSize: 12, color: '#94a3b8' }}>Unit {tenant.unit || 'N/A'}</div>
                                        </div>
                                      </div>
                                    </td>
                                    <td style={{ padding: '12px 16px', fontSize: 13, color: '#0f172a' }}>
                                      {property?.name || property?.address?.split(',')[0] || tenant.property || 'Unassigned'}
                                    </td>
                                    <td style={{ padding: '12px 16px', fontSize: 13, fontWeight: 500, color: '#0f172a' }}>
                                      ${(tenant.rentAmount || tenant.rent || 0).toLocaleString()}/mo
                                    </td>
                                    <td style={{ padding: '12px 16px', fontSize: 13, color: '#64748b' }}>
                                      {(tenant.leaseEnd || tenant.lease_end) 
                                        ? new Date(tenant.leaseEnd || tenant.lease_end).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                                        : 'MTM'}
                                    </td>
                                    <td style={{ padding: '12px 16px' }}>
                                      <span style={{
                                        padding: '4px 10px',
                                        borderRadius: 4,
                                        fontSize: 11,
                                        fontWeight: 500,
                                        background: displayStatus === 'Current' ? '#f0fdf4' : displayStatus === 'Late' ? '#fef2f2' : displayStatus === 'Prospect' ? '#f5f3ff' : '#f8fafc',
                                        color: displayStatus === 'Current' ? '#16a34a' : displayStatus === 'Late' ? '#dc2626' : displayStatus === 'Prospect' ? '#7c3aed' : '#64748b',
                                        border: `1px solid ${displayStatus === 'Current' ? '#bbf7d0' : displayStatus === 'Late' ? '#fecaca' : displayStatus === 'Prospect' ? '#ddd6fe' : '#e2e8f0'}`
                                      }}>
                                        {displayStatus}
                                      </span>
                                    </td>
                                    <td style={{ padding: '12px 16px' }}>
                                      <div style={{ display: 'flex', gap: 4 }}>
                                        {tenant.email && (
                                          <a 
                                            href={`mailto:${tenant.email}`} 
                                            onClick={e => e.stopPropagation()}
                                            style={{ 
                                              width: 28, height: 28, borderRadius: 6,
                                              background: '#f1f5f9', 
                                              display: 'flex', alignItems: 'center', justifyContent: 'center',
                                              textDecoration: 'none'
                                            }}
                                            title={tenant.email}
                                          >
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                              <polyline points="22,6 12,13 2,6"></polyline>
                                            </svg>
                                          </a>
                                        )}
                                        {tenant.phone && (
                                          <a 
                                            href={`tel:${tenant.phone}`} 
                                            onClick={e => e.stopPropagation()}
                                            style={{ 
                                              width: 28, height: 28, borderRadius: 6,
                                              background: '#f1f5f9', 
                                              display: 'flex', alignItems: 'center', justifyContent: 'center',
                                              textDecoration: 'none'
                                            }}
                                            title={tenant.phone}
                                          >
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                            </svg>
                                          </a>
                                        )}
                                      </div>
                                    </td>
                                    <td style={{ padding: '12px 16px', textAlign: 'right' }}>
                                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                      </svg>
                                    </td>
                                  </tr>
                                );
                              });
                            })()}
                          </tbody>
                        </table>
                        
                        {/* Pagination Footer */}
                        {(() => {
                          let filtered = getFilteredTenants().filter(tenant => {
                            if (advancedFilters.property && tenant.property_id !== advancedFilters.property && String(tenant.property_id) !== advancedFilters.property) return false;
                            const rent = tenant.rentAmount || tenant.rent || 0;
                            if (advancedFilters.rentMin && rent < Number(advancedFilters.rentMin)) return false;
                            if (advancedFilters.rentMax && rent > Number(advancedFilters.rentMax)) return false;
                            const leaseEnd = tenant.leaseEnd || tenant.lease_end;
                            if (advancedFilters.leaseEndAfter && leaseEnd && new Date(leaseEnd) < new Date(advancedFilters.leaseEndAfter)) return false;
                            if (advancedFilters.leaseEndBefore && leaseEnd && new Date(leaseEnd) > new Date(advancedFilters.leaseEndBefore)) return false;
                            if (advancedFilters.balanceDue && tenant.paymentStatus !== 'late') return false;
                            return true;
                          });
                          const totalPages = Math.ceil(filtered.length / tenantsPerPage);
                          
                          if (totalPages <= 1) return null;
                          
                          return (
                            <div style={{ 
                              display: 'flex', 
                              justifyContent: 'space-between', 
                              alignItems: 'center', 
                              padding: '12px 16px',
                              borderTop: '1px solid #e2e8f0',
                              background: '#f8fafc'
                            }}>
                              <button
                                onClick={() => setTenantsPage(Math.max(1, tenantsPage - 1))}
                                disabled={tenantsPage === 1}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: 4,
                                  padding: '6px 12px',
                                  background: 'white',
                                  border: '1px solid #e2e8f0',
                                  borderRadius: 6,
                                  fontSize: 12,
                                  color: tenantsPage === 1 ? '#94a3b8' : '#64748b',
                                  cursor: tenantsPage === 1 ? 'not-allowed' : 'pointer',
                                  opacity: tenantsPage === 1 ? 0.5 : 1
                                }}
                              >
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                                Previous
                              </button>
                              
                              <div style={{ display: 'flex', gap: 4 }}>
                                {Array.from({ length: Math.min(7, totalPages) }, (_, i) => {
                                  let pageNum;
                                  if (totalPages <= 7) {
                                    pageNum = i + 1;
                                  } else if (tenantsPage <= 4) {
                                    pageNum = i + 1;
                                  } else if (tenantsPage >= totalPages - 3) {
                                    pageNum = totalPages - 6 + i;
                                  } else {
                                    pageNum = tenantsPage - 3 + i;
                                  }
                                  
                                  return (
                                    <button
                                      key={pageNum}
                                      onClick={() => setTenantsPage(pageNum)}
                                      style={{
                                        width: 32,
                                        height: 32,
                                        borderRadius: 6,
                                        border: tenantsPage === pageNum ? 'none' : '1px solid #e2e8f0',
                                        background: tenantsPage === pageNum ? '#0f172a' : 'white',
                                        color: tenantsPage === pageNum ? 'white' : '#64748b',
                                        fontSize: 12,
                                        fontWeight: tenantsPage === pageNum ? 600 : 400,
                                        cursor: 'pointer'
                                      }}
                                    >
                                      {pageNum}
                                    </button>
                                  );
                                })}
                              </div>
                              
                              <button
                                onClick={() => setTenantsPage(Math.min(totalPages, tenantsPage + 1))}
                                disabled={tenantsPage === totalPages}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: 4,
                                  padding: '6px 12px',
                                  background: 'white',
                                  border: '1px solid #e2e8f0',
                                  borderRadius: 6,
                                  fontSize: 12,
                                  color: tenantsPage === totalPages ? '#94a3b8' : '#64748b',
                                  cursor: tenantsPage === totalPages ? 'not-allowed' : 'pointer',
                                  opacity: tenantsPage === totalPages ? 0.5 : 1
                                }}
                              >
                                Next
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                              </button>
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'properties' && (
                <div className="content-section">
                  {/* Header */}
                  <div style={{ marginBottom: '24px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                      <div>
                        <h1 style={{ fontSize: '32px', fontWeight: '400', color: '#202124', margin: '0 0 8px 0' }}>Properties</h1>
                        <p style={{ fontSize: '14px', color: '#5f6368', margin: 0 }}>Manage your property portfolio</p>
                      </div>
                      <button 
                        className="btn-primary" 
                        onClick={() => setShowAddPropertyModal(true)}
                        style={{
                          background: '#1a73e8',
                          color: '#fff',
                          border: 'none',
                          borderRadius: '4px',
                          padding: '10px 24px',
                          fontSize: '14px',
                          fontWeight: '500',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px'
                        }}
                      >
                        + Add Property
                      </button>
                    </div>
                  </div>

                  {/* Stats Cards Row */}
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '24px' }}>
                    {(() => {
                      const totalProperties = properties.length;
                      const totalUnits = properties.reduce((sum, p) => sum + (p.units || 0), 0);
                      const totalOccupied = properties.reduce((sum, p) => sum + (p.occupied || 0), 0);
                      const occupancyRate = totalUnits > 0 ? Math.round((totalOccupied / totalUnits) * 100) : 0;
                      
                      return (
                        <>
                          {/* Total Properties Card */}
                          <div style={{
                            background: '#fff',
                            border: '1px solid #e2e8f0',
                            borderRadius: '8px',
                            padding: '20px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '16px'
                          }}>
                            <div style={{
                              width: '48px',
                              height: '48px',
                              borderRadius: '8px',
                              background: '#f1f5f9',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              flexShrink: 0
                            }}>
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                              </svg>
                            </div>
                            <div>
                              <div style={{ fontSize: '13px', color: '#64748b', marginBottom: '4px' }}>Total Properties</div>
                              <div style={{ fontSize: '32px', fontWeight: '600', color: '#0f172a', letterSpacing: '-1px' }}>{totalProperties}</div>
                            </div>
                          </div>

                          {/* Total Units Card */}
                          <div style={{
                            background: '#fff',
                            border: '1px solid #e2e8f0',
                            borderRadius: '8px',
                            padding: '20px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '16px'
                          }}>
                            <div style={{
                              width: '48px',
                              height: '48px',
                              borderRadius: '8px',
                              background: '#f1f5f9',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              flexShrink: 0
                            }}>
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                              </svg>
                            </div>
                            <div>
                              <div style={{ fontSize: '13px', color: '#64748b', marginBottom: '4px' }}>Total Units</div>
                              <div style={{ fontSize: '32px', fontWeight: '600', color: '#0f172a', letterSpacing: '-1px' }}>{totalUnits}</div>
                              <div style={{ fontSize: '13px', color: '#64748b' }}>{totalOccupied} occupied</div>
                            </div>
                          </div>

                          {/* Occupancy Rate Card */}
                          <div style={{
                            background: '#fff',
                            border: '1px solid #e2e8f0',
                            borderRadius: '8px',
                            padding: '20px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '16px'
                          }}>
                            <div style={{ position: 'relative', width: '64px', height: '64px', flexShrink: 0 }}>
                              <svg width="64" height="64" style={{ transform: 'rotate(-90deg)' }}>
                                <circle
                                  cx="32"
                                  cy="32"
                                  r="28"
                                  fill="none"
                                  stroke="#e2e8f0"
                                  strokeWidth="4"
                                />
                                <circle
                                  cx="32"
                                  cy="32"
                                  r="28"
                                  fill="none"
                                  stroke="#3b82f6"
                                  strokeWidth="4"
                                  strokeDasharray={`${2 * Math.PI * 28}`}
                                  strokeDashoffset={`${2 * Math.PI * 28 * (1 - occupancyRate / 100)}`}
                                  strokeLinecap="round"
                                />
                              </svg>
                              <div style={{
                                position: 'absolute',
                                top: '50%',
                                left: '50%',
                                transform: 'translate(-50%, -50%)',
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#0f172a'
                              }}>
                                {occupancyRate}%
                              </div>
                            </div>
                            <div>
                              <div style={{ fontSize: '13px', color: '#64748b', marginBottom: '4px' }}>Occupancy Rate</div>
                              <div style={{ fontSize: '20px', fontWeight: '600', color: '#0f172a' }}>{occupancyRate}%</div>
                            </div>
                          </div>
                        </>
                      );
                    })()}
                  </div>

                  {/* Search and Export Bar */}
                  <div style={{ 
                    display: 'flex', 
                    gap: '12px', 
                    marginBottom: '24px',
                    alignItems: 'center'
                  }}>
                    <div style={{ position: 'relative', flex: 1, maxWidth: '400px' }}>
                      <input
                        type="text"
                        placeholder="Search properties..."
                        value={propertySearchQuery}
                        onChange={(e) => setPropertySearchQuery(e.target.value)}
                        aria-label="Search properties"
                        style={{
                          width: '100%',
                          height: '40px',
                          padding: '0 16px 0 40px',
                          border: '1px solid #dadce0',
                          borderRadius: '4px',
                          fontSize: '14px',
                          color: '#202124'
                        }}
                      />
                      <svg 
                        width="20" 
                        height="20" 
                        viewBox="0 0 24 24" 
                        fill="none" 
                        stroke="#5f6368" 
                        strokeWidth="2"
                        style={{
                          position: 'absolute',
                          left: '12px',
                          top: '50%',
                          transform: 'translateY(-50%)',
                          pointerEvents: 'none'
                        }}
                      >
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                      </svg>
                    </div>
                    {/* Tag Filter for Properties */}
                    {tags.length > 0 && (
                      <div style={{ position: 'relative', display: 'flex', alignItems: 'center' }}>
                        <div style={{ position: 'relative' }}>
                          <button
                            onClick={() => {
                              const dropdown = document.getElementById('property-tag-filter-dropdown');
                              if (dropdown) {
                                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                              }
                            }}
                            style={{
                              height: '40px',
                              padding: '0 16px',
                              border: '1px solid #dadce0',
                              borderRadius: '4px',
                              background: '#fff',
                              color: '#202124',
                              fontSize: '14px',
                              cursor: 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px',
                              whiteSpace: 'nowrap'
                            }}
                          >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                              <line x1="7" y1="7" x2="7.01" y2="7"></line>
                            </svg>
                            Filter by Tag
                            {selectedTagFilters.length > 0 && (
                              <span style={{
                                background: '#1a73e8',
                                color: '#fff',
                                borderRadius: '10px',
                                padding: '2px 6px',
                                fontSize: '11px',
                                fontWeight: '500'
                              }}>
                                {selectedTagFilters.length}
                              </span>
                            )}
                          </button>
                          <div
                            id="property-tag-filter-dropdown"
                            style={{
                              display: 'none',
                              position: 'absolute',
                              top: '100%',
                              left: 0,
                              marginTop: '4px',
                              background: '#fff',
                              border: '1px solid #dadce0',
                              borderRadius: '8px',
                              boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
                              zIndex: 1000,
                              minWidth: '200px',
                              maxHeight: '300px',
                              overflowY: 'auto',
                              padding: '8px'
                            }}
                            onClick={(e) => e.stopPropagation()}
                          >
                            {tags.map(tag => {
                              const isSelected = selectedTagFilters.includes(tag.id);
                              const colorMap = {
                                blue: '#1a73e8',
                                green: '#10b981',
                                yellow: '#fbbf24',
                                orange: '#f97316',
                                red: '#ef4444',
                                purple: '#a855f7',
                                teal: '#14b8a6',
                                gray: '#6b7280'
                              };
                              return (
                                <label
                                  key={tag.id}
                                  style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '8px',
                                    cursor: 'pointer',
                                    borderRadius: '4px'
                                  }}
                                  onMouseEnter={(e) => e.target.style.background = '#f8f9fa'}
                                  onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                >
                                  <input
                                    type="checkbox"
                                    checked={isSelected}
                                    onChange={(e) => {
                                      if (e.target.checked) {
                                        setSelectedTagFilters([...selectedTagFilters, tag.id]);
                                      } else {
                                        setSelectedTagFilters(selectedTagFilters.filter(id => id !== tag.id));
                                      }
                                    }}
                                    style={{ cursor: 'pointer' }}
                                  />
                                  <div
                                    style={{
                                      width: '12px',
                                      height: '12px',
                                      borderRadius: '50%',
                                      background: colorMap[tag.color] || colorMap.blue,
                                      flexShrink: 0
                                    }}
                                  />
                                  <span style={{ fontSize: '14px', color: '#202124' }}>{tag.name}</span>
                                </label>
                              );
                            })}
                            {selectedTagFilters.length > 0 && (
                              <div style={{ padding: '8px', borderTop: '1px solid #e5e7eb', marginTop: '4px' }}>
                                <button
                                  onClick={() => {
                                    setSelectedTagFilters([]);
                                    document.getElementById('property-tag-filter-dropdown').style.display = 'none';
                                  }}
                                  style={{
                                    width: '100%',
                                    padding: '6px',
                                    background: 'none',
                                    border: '1px solid #dadce0',
                                    borderRadius: '4px',
                                    color: '#5f6368',
                                    cursor: 'pointer',
                                    fontSize: '12px'
                                  }}
                                >
                                  Clear filters
                                </button>
                              </div>
                            )}
                          </div>
                        </div>
                        {selectedTagFilters.length > 0 && (
                          <button
                            onClick={() => setSelectedTagFilters([])}
                            style={{
                              marginLeft: '8px',
                              background: 'none',
                              border: 'none',
                              color: '#5f6368',
                              cursor: 'pointer',
                              padding: '4px',
                              display: 'flex',
                              alignItems: 'center'
                            }}
                            title="Clear tag filters"
                          >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <line x1="18" y1="6" x2="6" y2="18"></line>
                              <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                          </button>
                        )}
                      </div>
                    )}
                    <button
                      onClick={() => {
                        // Export properties to CSV
                        const csvData = properties.map(p => ({
                          Address: p.address,
                          Type: p.type || '',
                          Units: p.units,
                          Occupied: p.occupied,
                          'Monthly Revenue': p.monthlyRevenue,
                          'Owner Name': p.ownerName || '',
                          'Owner Email': p.ownerEmail || ''
                        }));
                        const csv = Papa.unparse(csvData);
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'properties.csv';
                        a.click();
                      }}
                      style={{
                        height: '40px',
                        padding: '0 16px',
                        border: '1px solid #dadce0',
                        borderRadius: '4px',
                        background: '#fff',
                        color: '#202124',
                        fontSize: '14px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                      </svg>
                      Export
                    </button>
                  </div>

                  {/* Property Cards Grid */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(3, 1fr)',
                    gap: '24px'
                  }}>
                    {properties
                      .filter(property => {
                        if (!propertySearchQuery || !propertySearchQuery.trim()) return true;
                        const search = propertySearchQuery.toLowerCase();
                        return (property.address && property.address.toLowerCase().includes(search)) ||
                               (property.type && property.type.toLowerCase().includes(search));
                      })
                      .map(property => {
                        const available = (property.units || 0) - (property.occupied || 0);
                        const isFull = available === 0;
                        const occupancyPercentage = property.units > 0 
                          ? Math.round(((property.occupied || 0) / property.units) * 100) 
                          : 0;
                        
                        return (
                          <div
                            key={property.id}
                            onContextMenu={(e) => {
                              e.preventDefault();
                              setQuickTagMenu({
                                recordType: 'property',
                                recordId: property.id,
                                x: e.clientX,
                                y: e.clientY
                              });
                            }}
                            style={{
                              background: '#fff',
                              borderRadius: '8px',
                              overflow: 'hidden',
                              border: '1px solid #e2e8f0',
                              transition: 'all 0.15s ease',
                              cursor: 'pointer'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
                              e.currentTarget.style.borderColor = '#cbd5e1';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.boxShadow = 'none';
                              e.currentTarget.style.borderColor = '#e2e8f0';
                            }}
                          >
                            {/* Property Photo */}
                            <div
                              onClick={() => setSelectedProperty(property)}
                              style={{
                                position: 'relative',
                                width: '100%',
                                height: '180px',
                                overflow: 'hidden',
                                background: property.photoUrl 
                                  ? 'transparent' 
                                  : '#e2e8f0',
                                cursor: 'pointer'
                              }}
                            >
                              {property.photoUrl ? (
                                <img
                                  src={property.photoUrl}
                                  alt={property.address}
                                  style={{
                                    width: '100%',
                                    height: '100%',
                                    objectFit: 'cover'
                                  }}
                                />
                              ) : (
                                <div style={{
                                  width: '100%',
                                  height: '100%',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center'
                                }}>
                                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="1.5">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                  </svg>
                                </div>
                              )}
                              
                              {/* Availability Badge */}
                              <div style={{
                                position: 'absolute',
                                top: '12px',
                                right: '12px',
                                padding: '4px 10px',
                                borderRadius: '4px',
                                fontSize: '11px',
                                fontWeight: '500',
                                background: isFull ? '#fef2f2' : '#f0fdf4',
                                color: isFull ? '#dc2626' : '#16a34a',
                                border: isFull ? '1px solid #fecaca' : '1px solid #bbf7d0'
                              }}>
                                {isFull ? 'Full' : `${available} Available`}
                              </div>
                            </div>

                            {/* Card Content */}
                            <div style={{ padding: '16px' }}>
                              {/* Property Name */}
                              <h3 style={{
                                fontSize: '15px',
                                fontWeight: '500',
                                color: '#0f172a',
                                margin: '0 0 8px 0'
                              }}>
                                {property.address}
                              </h3>

                              {/* Address with Location Icon */}
                              <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px',
                                marginBottom: '8px',
                                fontSize: '13px',
                                color: '#64748b'
                              }}>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                  <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                <span>{property.type || 'Property'}</span>
                              </div>

                              {/* Tags */}
                              <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginBottom: '12px' }}>
                                {getTagsForRecord('property', property.id).map(tag => (
                                  <span
                                    key={tag.id}
                                    className={`tag-pill ${tag.color} clickable`}
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      // Filter by this tag
                                      if (!selectedTagFilters.includes(tag.id)) {
                                        setSelectedTagFilters([...selectedTagFilters, tag.id]);
                                        setActiveTab('properties');
                                      }
                                    }}
                                    title={`Filter by ${tag.name}`}
                                  >
                                    {tag.name}
                                  </span>
                                ))}
                              </div>

                              {/* Stats Row */}
                              <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                marginBottom: '16px',
                                paddingBottom: '16px',
                                borderBottom: '1px solid #e2e8f0'
                              }}>
                                <div>
                                  <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '2px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Units</div>
                                  <div style={{ fontSize: '14px', fontWeight: '600', color: '#0f172a' }}>
                                    {property.occupied || 0}/{property.units || 0}
                                  </div>
                                </div>
                                <div style={{ textAlign: 'right' }}>
                                  <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '2px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Revenue</div>
                                  <div style={{ fontSize: '14px', fontWeight: '600', color: '#0f172a' }}>
                                    ${(property.monthlyRevenue || 0).toLocaleString()}
                                  </div>
                                </div>
                              </div>

                              {/* View Details Button */}
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setSelectedProperty(property);
                                  // Load files for this property
                                  loadFilesForRecord('property', property.id).then(files => {
                                    setPropertyFiles(files);
                                  });
                                }}
                                style={{
                                  width: '100%',
                                  padding: '10px 16px',
                                  border: '1px solid #e2e8f0',
                                  borderRadius: '6px',
                                  background: '#fff',
                                  color: '#0f172a',
                                  fontSize: '13px',
                                  fontWeight: '500',
                                  cursor: 'pointer',
                                  transition: 'all 0.15s ease'
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.background = '#f8fafc';
                                  e.currentTarget.style.borderColor = '#94a3b8';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.background = '#fff';
                                  e.currentTarget.style.borderColor = '#e2e8f0';
                                }}
                              >
                                View Details
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    {properties.filter(property => {
                      if (!propertySearchQuery || !propertySearchQuery.trim()) return true;
                      const search = propertySearchQuery.toLowerCase();
                      return (property.address && property.address.toLowerCase().includes(search)) ||
                             (property.type && property.type.toLowerCase().includes(search));
                    }).length === 0 && (
                      <div style={{
                        gridColumn: '1 / -1',
                        textAlign: 'center',
                        padding: '40px',
                        color: '#5f6368'
                      }}>
                        No properties found
                      </div>
                    )}
                  </div>
                </div>
              )}

              {activeTab === 'maintenance' && (
                <div className="content-section">
                  {/* Header */}
                  <div style={{ marginBottom: '24px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                      <div>
                        <h1 style={{ fontSize: '32px', fontWeight: '600', color: '#202124', margin: '0 0 8px 0' }}>Maintenance</h1>
                        <p style={{ fontSize: '14px', color: '#6b7280', margin: 0 }}>Track and manage maintenance requests</p>
                      </div>
                      <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                        <button 
                          onClick={handleMaintenanceRefresh}
                          disabled={maintenanceRefreshing}
                          style={{
                            background: 'transparent',
                            border: 'none',
                            padding: 8,
                            cursor: maintenanceRefreshing ? 'not-allowed' : 'pointer',
                            borderRadius: 8,
                            display: 'flex',
                            alignItems: 'center',
                            color: maintenanceRefreshing ? '#9ca3af' : '#6b7280',
                            transition: 'all 0.2s',
                            opacity: maintenanceRefreshing ? 0.6 : 1
                          }}
                          onMouseEnter={(e) => {
                            if (!maintenanceRefreshing) {
                              e.currentTarget.style.background = '#f3f4f6';
                              e.currentTarget.style.color = '#374151';
                            }
                          }}
                          onMouseLeave={(e) => {
                            if (!maintenanceRefreshing) {
                              e.currentTarget.style.background = 'transparent';
                              e.currentTarget.style.color = '#6b7280';
                            }
                          }}
                          title='Refresh'
                        >
                          <svg 
                            width='20' 
                            height='20' 
                            viewBox='0 0 24 24' 
                            fill='none' 
                            stroke='currentColor' 
                            strokeWidth='2'
                            style={{
                              animation: maintenanceRefreshing ? 'spin 1s linear infinite' : 'none'
                            }}
                          >
                            <path d='M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15'/>
                          </svg>
                        </button>
                        <button 
                          className="btn btn-primary" 
                          onClick={() => setShowAddMaintenanceModal(true)}
                          style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                          }}
                        >
                          + New Request
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Stats Cards Row - Clickable Filters */}
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '24px' }}>
                    {(() => {
                      const pending = maintenanceRequests.filter(r => {
                        const status = (r.status || 'open').toLowerCase();
                        return status === 'open';
                      }).length;
                      
                      const inProgress = maintenanceRequests.filter(r => {
                        const status = (r.status || '').toLowerCase();
                        return status === 'in_progress' || status === 'in progress';
                      }).length;
                      
                      const completed = maintenanceRequests.filter(r => {
                        const status = (r.status || '').toLowerCase();
                        return status === 'closed' || status === 'completed';
                      }).length;
                      
                      const isPendingActive = maintenanceFilterTab === 'pending';
                      const isInProgressActive = maintenanceFilterTab === 'active';
                      const isCompletedActive = maintenanceFilterTab === 'completed';
                      
                      return (
                        <>
                          {/* Pending Card */}
                          <div 
                            onClick={() => setMaintenanceFilterTab(isPendingActive ? 'all' : 'pending')}
                            style={{
                              background: '#fff',
                              border: '1px solid #e2e8f0',
                              borderRadius: '8px',
                              padding: '20px',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '16px',
                              cursor: 'pointer',
                              transition: 'all 0.15s',
                              borderLeft: isPendingActive ? '3px solid #f59e0b' : '1px solid #e2e8f0'
                            }}
                            onMouseEnter={(e) => {
                              if (!isPendingActive) e.currentTarget.style.borderColor = '#cbd5e1';
                            }}
                            onMouseLeave={(e) => {
                              if (!isPendingActive) e.currentTarget.style.borderColor = '#e2e8f0';
                            }}
                          >
                            <div style={{
                              width: '48px',
                              height: '48px',
                              borderRadius: '8px',
                              background: '#f1f5f9',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              flexShrink: 0
                            }}>
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                              </svg>
                            </div>
                            <div>
                              <div style={{ fontSize: '13px', color: '#64748b', marginBottom: '4px' }}>Pending</div>
                              <div style={{ fontSize: '32px', fontWeight: '600', color: '#0f172a', letterSpacing: '-1px' }}>{pending}</div>
                            </div>
                          </div>

                          {/* In Progress Card */}
                          <div 
                            onClick={() => setMaintenanceFilterTab(isInProgressActive ? 'all' : 'active')}
                            style={{
                              background: '#fff',
                              border: '1px solid #e2e8f0',
                              borderRadius: '8px',
                              padding: '20px',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '16px',
                              cursor: 'pointer',
                              transition: 'all 0.15s',
                              borderLeft: isInProgressActive ? '3px solid #3b82f6' : '1px solid #e2e8f0'
                            }}
                            onMouseEnter={(e) => {
                              if (!isInProgressActive) e.currentTarget.style.borderColor = '#cbd5e1';
                            }}
                            onMouseLeave={(e) => {
                              if (!isInProgressActive) e.currentTarget.style.borderColor = '#e2e8f0';
                            }}
                          >
                            <div style={{
                              width: '48px',
                              height: '48px',
                              borderRadius: '8px',
                              background: '#f1f5f9',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              flexShrink: 0
                            }}>
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
                              </svg>
                            </div>
                            <div>
                              <div style={{ fontSize: '13px', color: '#64748b', marginBottom: '4px' }}>In Progress</div>
                              <div style={{ fontSize: '32px', fontWeight: '600', color: '#0f172a', letterSpacing: '-1px' }}>{inProgress}</div>
                            </div>
                          </div>

                          {/* Completed Card */}
                          <div 
                            onClick={() => {
                              setShowCompleted(!showCompleted);
                              setMaintenanceFilterTab('all');
                            }}
                            style={{
                              background: '#fff',
                              border: '1px solid #e2e8f0',
                              borderRadius: '8px',
                              padding: '20px',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '16px',
                              cursor: 'pointer',
                              transition: 'all 0.15s',
                              borderLeft: showCompleted ? '3px solid #10b981' : '1px solid #e2e8f0'
                            }}
                            onMouseEnter={(e) => {
                              if (!showCompleted) e.currentTarget.style.borderColor = '#cbd5e1';
                            }}
                            onMouseLeave={(e) => {
                              if (!showCompleted) e.currentTarget.style.borderColor = '#e2e8f0';
                            }}
                          >
                            <div style={{
                              width: '48px',
                              height: '48px',
                              borderRadius: '8px',
                              background: '#f1f5f9',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              flexShrink: 0
                            }}>
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                              </svg>
                            </div>
                            <div>
                              <div style={{ fontSize: '13px', color: '#64748b', marginBottom: '4px' }}>Completed</div>
                              <div style={{ fontSize: '32px', fontWeight: '600', color: '#0f172a', letterSpacing: '-1px' }}>{completed}</div>
                            </div>
                          </div>
                        </>
                      );
                    })()}
                  </div>

                  {/* Search and Filter Bar */}
                  <div style={{ 
                    display: 'flex', 
                    gap: '12px', 
                    marginBottom: '16px',
                    alignItems: 'center'
                  }}>
                    <div style={{ position: 'relative', flex: 1, maxWidth: '400px' }}>
                      <input
                        type="text"
                        placeholder="Search requests..."
                        value={maintenanceSearchQuery}
                        onChange={(e) => setMaintenanceSearchQuery(e.target.value)}
                        aria-label="Search maintenance requests"
                        className="form-input"
                        style={{
                          paddingLeft: '40px'
                        }}
                      />
                      <svg 
                        width="20" 
                        height="20" 
                        viewBox="0 0 24 24" 
                        fill="none" 
                        stroke="#6b7280" 
                        strokeWidth="2"
                        style={{
                          position: 'absolute',
                          left: '12px',
                          top: '50%',
                          transform: 'translateY(-50%)',
                          pointerEvents: 'none'
                        }}
                      >
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                      </svg>
                    </div>
                    <button
                      className="btn btn-secondary"
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                      </svg>
                      Filter
                    </button>
                  </div>

                  {/* Active Maintenance Cards Grid */}
                  {(() => {
                    const activeRequests = maintenanceRequests
                      .filter(request => {
                        const status = (request.status || 'open').toLowerCase();
                        if (status === 'closed' || status === 'completed') return false;
                        
                        let matchesStatus = true;
                        if (maintenanceFilterTab === 'pending') {
                          matchesStatus = status === 'open';
                        } else if (maintenanceFilterTab === 'active') {
                          matchesStatus = status === 'in_progress' || status === 'in progress';
                        }
                        
                        const matchesSearch = !maintenanceSearchQuery || !maintenanceSearchQuery.trim() ||
                          (request.issue && request.issue.toLowerCase().includes(maintenanceSearchQuery.toLowerCase())) ||
                          (request.description && request.description.toLowerCase().includes(maintenanceSearchQuery.toLowerCase())) ||
                          (request.property && request.property.toLowerCase().includes(maintenanceSearchQuery.toLowerCase())) ||
                          (request.tenantName && request.tenantName.toLowerCase().includes(maintenanceSearchQuery.toLowerCase()));
                        
                        let matchesTags = true;
                        if (selectedTagFilters.length > 0) {
                          const requestTagIds = getTagsForRecord('maintenance', request.id).map(tag => tag.id);
                          matchesTags = selectedTagFilters.every(filterTagId => requestTagIds.includes(filterTagId));
                        }
                        
                        return matchesStatus && matchesSearch && matchesTags;
                      })
                      .sort((a, b) => {
                        const dateA = new Date(a.date || a.created_at || 0);
                        const dateB = new Date(b.date || b.created_at || 0);
                        return dateB - dateA;
                      });
                    
                    const completedRequests = maintenanceRequests
                      .filter(request => {
                        const status = (request.status || 'open').toLowerCase();
                        if (status !== 'closed' && status !== 'completed') return false;
                        
                        const matchesSearch = !maintenanceSearchQuery || !maintenanceSearchQuery.trim() ||
                          (request.issue && request.issue.toLowerCase().includes(maintenanceSearchQuery.toLowerCase())) ||
                          (request.description && request.description.toLowerCase().includes(maintenanceSearchQuery.toLowerCase())) ||
                          (request.property && request.property.toLowerCase().includes(maintenanceSearchQuery.toLowerCase())) ||
                          (request.tenantName && request.tenantName.toLowerCase().includes(maintenanceSearchQuery.toLowerCase()));
                        
                        let matchesTags = true;
                        if (selectedTagFilters.length > 0) {
                          const requestTagIds = getTagsForRecord('maintenance', request.id).map(tag => tag.id);
                          matchesTags = selectedTagFilters.every(filterTagId => requestTagIds.includes(filterTagId));
                        }
                        
                        return matchesSearch && matchesTags;
                      })
                      .sort((a, b) => {
                        const dateA = new Date(a.date || a.created_at || 0);
                        const dateB = new Date(b.date || b.created_at || 0);
                        return dateB - dateA;
                      });
                    
                    return (
                      <>
                        {/* List container */}
                        <div style={{ 
                          background: 'white',
                          borderRadius: 8,
                          border: '1px solid #e2e8f0',
                          overflow: 'hidden'
                        }}>
                          {/* List header */}
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            padding: '12px 20px',
                            background: '#f8fafc',
                            borderBottom: '1px solid #e2e8f0',
                            fontSize: 12,
                            fontWeight: 500,
                            color: '#64748b',
                            textTransform: 'uppercase',
                            letterSpacing: '0.5px'
                          }}>
                            <div style={{ flex: 1 }}>Request</div>
                            <div style={{ width: 60, textAlign: 'right' }}>Date</div>
                            <div style={{ width: 80, textAlign: 'right' }}>Status</div>
                            <div style={{ width: 16 }}></div>
                          </div>
                          
                          {activeRequests.map(request => (
                            <MaintenanceCard 
                              key={request.id}
                              request={request}
                              onClick={() => {
                                setSelectedMaintenanceRequest(request);
                              }}
                            />
                          ))}
                          
                          {/* Empty State for Active Requests */}
                          {activeRequests.length === 0 && (
                            <div style={{
                              textAlign: 'center',
                              padding: '60px 20px',
                              color: '#64748b'
                            }}>
                              <div style={{ 
                                width: 48, 
                                height: 48, 
                                borderRadius: 12, 
                                background: '#f1f5f9', 
                                display: 'flex', 
                                alignItems: 'center', 
                                justifyContent: 'center',
                                margin: '0 auto 16px'
                              }}>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="1.5">
                                  <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                                </svg>
                              </div>
                              <p style={{ fontSize: 14, fontWeight: 500, marginBottom: 4, color: '#0f172a' }}>No active requests</p>
                              <p style={{ fontSize: 13 }}>
                                {maintenanceFilterTab !== 'all' 
                                  ? 'Try adjusting your filters'
                                  : 'Create your first maintenance request'}
                              </p>
                            </div>
                          )}
                        </div>
                        
                        {/* Show Completed Toggle */}
                        {completedRequests.length > 0 && (
                          <>
                            <div style={{ 
                              marginTop: 24, 
                              paddingTop: 16, 
                              borderTop: '1px solid #e5e7eb',
                              display: 'flex',
                              alignItems: 'center',
                              gap: 8
                            }}>
                              <button
                                onClick={() => setShowCompleted(!showCompleted)}
                                style={{
                                  background: 'none',
                                  border: 'none',
                                  color: '#6b7280',
                                  cursor: 'pointer',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: 6,
                                  fontSize: 14,
                                  padding: '4px 8px',
                                  borderRadius: 4,
                                  transition: 'background 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = '#f3f4f6'}
                                onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                              >
                                <span style={{ fontSize: 12 }}>{showCompleted ? 'â¼' : 'â¶'}</span>
                                <span>Completed ({completedRequests.length})</span>
                              </button>
                            </div>
                            
                            {showCompleted && (
                              <div style={{ 
                                background: 'white',
                                borderRadius: 8,
                                border: '1px solid #e2e8f0',
                                overflow: 'hidden',
                                marginTop: 16
                              }}>
                                {completedRequests.map(request => (
                                  <MaintenanceCard 
                                    key={request.id}
                                    request={request}
                                    onClick={() => {
                                      setSelectedMaintenanceRequest(request);
                                    }}
                                  />
                                ))}
                              </div>
                            )}
                          </>
                        )}
                      </>
                    );
                  })()}
                </div>
              )}

              {activeTab === 'owners' && (
                <div style={{ padding: 24 }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
                    <div>
                      <h1 style={{ fontSize: 28, fontWeight: 700, marginBottom: 4 }}>Property Owners</h1>
                      <p style={{ color: '#6b7280' }}>Manage owners, statements, and portal access</p>
                    </div>
                    <button 
                      className='btn-primary' 
                      onClick={() => {
                        setNewOwner({ name: '', email: '', phone: '', address: '', managementFeePercent: 10, portalEnabled: false });
                        setShowAddOwnerModal(true);
                      }}
                    >
                      + Add Owner
                    </button>
                  </div>
                  
                  {/* Owner Cards */}
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(380px, 1fr))', gap: 20 }}>
                    {owners.map(owner => {
                      const ownerProps = getOwnerPropertiesById(owner.id);
                      const totalRevenue = getOwnerRevenue(owner.id);
                      const pendingDistribution = getPendingDistribution(owner.id);
                      
                      return (
                        <div
                          key={owner.id}
                          style={{
                            background: 'white',
                            borderRadius: 12,
                            border: '1px solid #e5e7eb',
                            overflow: 'hidden'
                          }}
                        >
                          {/* Owner Header */}
                          <div style={{ padding: 20, borderBottom: '1px solid #f3f4f6' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                              <div style={{
                                width: 56,
                                height: 56,
                                borderRadius: 12,
                                background: '#e8f0fe',
                                color: '#1a73e8',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontWeight: 700,
                                fontSize: 20
                              }}>
                                {owner.name?.split(' ').map(n => n[0]).join('').slice(0, 2)}
                              </div>
                              <div style={{ flex: 1 }}>
                                <h3 style={{ fontWeight: 600, fontSize: 18, margin: 0 }}>{owner.name}</h3>
                                <p style={{ color: '#6b7280', fontSize: 14, margin: '4px 0 0' }}>{owner.email}</p>
                              </div>
                              <div style={{
                                padding: '4px 12px',
                                borderRadius: 20,
                                fontSize: 12,
                                fontWeight: 500,
                                background: owner.portalEnabled ? '#d1fae5' : '#f3f4f6',
                                color: owner.portalEnabled ? '#065f46' : '#6b7280'
                              }}>
                                {owner.portalEnabled ? 'ð¢ Portal Active' : 'Portal Inactive'}
                              </div>
                            </div>
                          </div>
                          
                          {/* Stats */}
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', borderBottom: '1px solid #f3f4f6' }}>
                            <div style={{ padding: 16, textAlign: 'center', borderRight: '1px solid #f3f4f6' }}>
                              <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Properties</p>
                              <p style={{ fontSize: 20, fontWeight: 700, margin: '4px 0 0', color: '#1a73e8' }}>{ownerProps.length}</p>
                            </div>
                            <div style={{ padding: 16, textAlign: 'center', borderRight: '1px solid #f3f4f6' }}>
                              <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Monthly Revenue</p>
                              <p style={{ fontSize: 20, fontWeight: 700, margin: '4px 0 0', color: '#10b981' }}>${totalRevenue.toLocaleString()}</p>
                            </div>
                            <div style={{ padding: 16, textAlign: 'center' }}>
                              <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Pending Payout</p>
                              <p style={{ fontSize: 20, fontWeight: 700, margin: '4px 0 0', color: '#f59e0b' }}>${pendingDistribution.toLocaleString()}</p>
                            </div>
                          </div>
                          
                          {/* Properties List */}
                          <div style={{ padding: 16 }}>
                            <p style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 8 }}>Properties</p>
                            {ownerProps.length > 0 ? (
                              <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                                {ownerProps.slice(0, 3).map(prop => (
                                  <div key={prop.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: 14 }}>
                                    <span>{prop.name || prop.address}</span>
                                    <span style={{ color: '#6b7280' }}>{prop.ownership_percentage || 100}%</span>
                                  </div>
                                ))}
                                {ownerProps.length > 3 && (
                                  <p style={{ fontSize: 13, color: '#1a73e8', margin: 0 }}>+{ownerProps.length - 3} more</p>
                                )}
                              </div>
                            ) : (
                              <p style={{ fontSize: 14, color: '#9ca3af' }}>No properties assigned</p>
                            )}
                          </div>
                          
                          {/* Actions */}
                          <div style={{ padding: 16, borderTop: '1px solid #f3f4f6', display: 'flex', gap: 8 }}>
                            <button
                              onClick={() => openOwnerDetail(owner)}
                              className='btn-secondary'
                              style={{ flex: 1, fontSize: 13 }}
                            >
                              View Details
                            </button>
                            <button
                              onClick={() => openOwnerStatement(owner)}
                              className='btn-secondary'
                              style={{ flex: 1, fontSize: 13 }}
                            >
                              ð Statement
                            </button>
                            <button
                              onClick={() => toggleOwnerPortal(owner)}
                              style={{
                                flex: 1,
                                fontSize: 13,
                                padding: '8px 12px',
                                border: '1px solid #e5e7eb',
                                borderRadius: 6,
                                background: owner.portalEnabled ? '#fee2e2' : '#d1fae5',
                                color: owner.portalEnabled ? '#991b1b' : '#065f46',
                                cursor: 'pointer'
                              }}
                            >
                              {owner.portalEnabled ? 'Disable Portal' : 'Enable Portal'}
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* Empty State */}
                  {owners.length === 0 && (
                    <div style={{ 
                      textAlign: 'center', 
                      padding: 60, 
                      background: 'white', 
                      borderRadius: 12, 
                      border: '1px solid #e5e7eb' 
                    }}>
                      <div style={{ fontSize: 48, marginBottom: 16 }}>ð¤</div>
                      <h3 style={{ fontSize: 18, fontWeight: 600, marginBottom: 8 }}>No owners yet</h3>
                      <p style={{ color: '#6b7280', marginBottom: 20 }}>Add property owners to manage their statements and portal access</p>
                      <button 
                        className='btn-primary'
                        onClick={() => {
                          setNewOwner({ name: '', email: '', phone: '', address: '', managementFeePercent: 10, portalEnabled: false });
                          setShowAddOwnerModal(true);
                        }}
                      >
                        + Add First Owner
                      </button>
                    </div>
                  )}
                </div>
              )}

              {/* Late Fees Tab */}
              {activeTab === 'late-fees' && (
                <div className="content-section" style={{ padding: '24px' }}>
                  {/* Header */}
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '24px' }}>
                    <div>
                      <h1 style={{ margin: 0, fontSize: '32px', fontWeight: '400', color: '#202124' }}>Late Fees</h1>
                      <p style={{ margin: '8px 0 0', fontSize: '14px', color: '#5f6368' }}>Manage and track late rent fees</p>
                    </div>
                    <button 
                      className="btn-primary" 
                      onClick={applyLateFees}
                      disabled={applyingLateFees}
                      style={{ display: 'flex', alignItems: 'center', gap: '8px' }}
                    >
                      {applyingLateFees ? (
                        <>Processing...</>
                      ) : (
                        <>
                          <span>ð°</span>
                          Apply Late Fees
                        </>
                      )}
                    </button>
                  </div>

                  {/* Stats Cards */}
                  {(() => {
                    const totals = getLateFeeTotals();
                    return (
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' }}>
                        <div style={{ background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                          <p style={{ margin: 0, fontSize: '14px', color: '#5f6368', marginBottom: '8px' }}>Unpaid Fees</p>
                          <p style={{ margin: 0, fontSize: '28px', fontWeight: '500', color: '#dc2626' }}>${totals.unpaid.toLocaleString()}</p>
                          <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#6b7280' }}>{lateFees.filter(f => f.status === 'unpaid').length} fees outstanding</p>
                        </div>
                        <div style={{ background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                          <p style={{ margin: 0, fontSize: '14px', color: '#5f6368', marginBottom: '8px' }}>Collected</p>
                          <p style={{ margin: 0, fontSize: '28px', fontWeight: '500', color: '#10b981' }}>${totals.paid.toLocaleString()}</p>
                          <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#6b7280' }}>{lateFees.filter(f => f.status === 'paid').length} fees paid</p>
                        </div>
                        <div style={{ background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                          <p style={{ margin: 0, fontSize: '14px', color: '#5f6368', marginBottom: '8px' }}>Waived</p>
                          <p style={{ margin: 0, fontSize: '28px', fontWeight: '500', color: '#6b7280' }}>${totals.waived.toLocaleString()}</p>
                          <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#6b7280' }}>{lateFees.filter(f => f.status === 'waived').length} fees waived</p>
                        </div>
                        <div style={{ background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                          <p style={{ margin: 0, fontSize: '14px', color: '#5f6368', marginBottom: '8px' }}>Properties Configured</p>
                          <p style={{ margin: 0, fontSize: '28px', fontWeight: '500', color: '#1a73e8' }}>{lateFeeSettings.filter(s => s.is_enabled).length}</p>
                          <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#6b7280' }}>of {properties.length} properties</p>
                        </div>
                      </div>
                    );
                  })()}

                  {/* Two Column Layout */}
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                    {/* Left Column: Property Settings */}
                    <div style={{ background: 'white', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                      <div style={{ padding: '20px 24px', borderBottom: '1px solid #e5e7eb' }}>
                        <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '500', color: '#202124' }}>Property Settings</h2>
                        <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#5f6368' }}>Configure late fees per property</p>
                      </div>
                      <div style={{ padding: '16px 24px', maxHeight: '500px', overflowY: 'auto' }}>
                        {properties.length === 0 ? (
                          <p style={{ color: '#6b7280', textAlign: 'center', padding: '24px' }}>No properties found</p>
                        ) : (
                          properties.map(property => {
                            const settings = getLateFeeSettingsForProperty(property.id);
                            return (
                              <div 
                                key={property.id}
                                style={{ 
                                  display: 'flex', 
                                  justifyContent: 'space-between', 
                                  alignItems: 'center',
                                  padding: '16px',
                                  background: '#f9fafb',
                                  borderRadius: '8px',
                                  marginBottom: '12px',
                                  border: '1px solid #e5e7eb'
                                }}
                              >
                                <div>
                                  <p style={{ margin: 0, fontWeight: '500', color: '#202124', fontSize: '14px' }}>
                                    {property.address.split(',')[0]}
                                  </p>
                                  {settings && settings.is_enabled ? (
                                    <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#10b981' }}>
                                      {settings.fee_type === 'percentage' 
                                        ? `${settings.fee_amount}% after ${settings.grace_period_days} days`
                                        : `$${settings.fee_amount} after ${settings.grace_period_days} days`
                                      }
                                    </p>
                                  ) : (
                                    <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#9ca3af' }}>Not configured</p>
                                  )}
                                </div>
                                <button
                                  onClick={() => {
                                    if (settings) {
                                      setLateFeeSettingsForm({
                                        feeType: settings.fee_type,
                                        feeAmount: String(settings.fee_amount),
                                        gracePeriodDays: String(settings.grace_period_days),
                                        isEnabled: settings.is_enabled,
                                        stateCode: settings.state_code || ''
                                      });
                                    } else {
                                      setLateFeeSettingsForm({
                                        feeType: 'percentage',
                                        feeAmount: '5',
                                        gracePeriodDays: '5',
                                        isEnabled: true,
                                        stateCode: ''
                                      });
                                    }
                                    setShowLateFeeSettingsModal(property.id);
                                  }}
                                  className="btn-text"
                                  style={{ fontSize: '13px', padding: '6px 12px' }}
                                >
                                  {settings ? 'Edit' : 'Configure'}
                                </button>
                              </div>
                            );
                          })
                        )}
                      </div>
                    </div>

                    {/* Right Column: Late Fees List */}
                    <div style={{ background: 'white', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                      <div style={{ padding: '20px 24px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                          <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '500', color: '#202124' }}>Applied Late Fees</h2>
                          <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#5f6368' }}>Track and manage individual fees</p>
                        </div>
                        <select
                          value={lateFeeFilter}
                          onChange={(e) => setLateFeeFilter(e.target.value)}
                          style={{
                            padding: '8px 12px',
                            borderRadius: '6px',
                            border: '1px solid #dadce0',
                            fontSize: '13px',
                            background: 'white'
                          }}
                        >
                          <option value="all">All Fees</option>
                          <option value="unpaid">Unpaid</option>
                          <option value="paid">Paid</option>
                          <option value="waived">Waived</option>
                        </select>
                      </div>
                      <div style={{ padding: '16px 24px', maxHeight: '500px', overflowY: 'auto' }}>
                        {getFilteredLateFees().length === 0 ? (
                          <p style={{ color: '#6b7280', textAlign: 'center', padding: '24px' }}>
                            {lateFeeFilter === 'all' ? 'No late fees applied yet' : `No ${lateFeeFilter} late fees`}
                          </p>
                        ) : (
                          getFilteredLateFees().map(fee => {
                            const tenant = tenants.find(t => t.id === fee.tenant_id);
                            const property = properties.find(p => p.id === fee.property_id);
                            return (
                              <div 
                                key={fee.id}
                                style={{ 
                                  padding: '16px',
                                  background: '#f9fafb',
                                  borderRadius: '8px',
                                  marginBottom: '12px',
                                  border: '1px solid #e5e7eb'
                                }}
                              >
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                                  <div>
                                    <p style={{ margin: 0, fontWeight: '500', color: '#202124', fontSize: '14px' }}>
                                      {tenant?.name || 'Unknown Tenant'}
                                    </p>
                                    <p style={{ margin: '2px 0 0', fontSize: '12px', color: '#6b7280' }}>
                                      {property?.address.split(',')[0] || 'Unknown Property'}
                                    </p>
                                  </div>
                                  <span style={{ 
                                    fontSize: '18px', 
                                    fontWeight: '600', 
                                    color: fee.status === 'paid' ? '#10b981' : fee.status === 'waived' ? '#6b7280' : '#dc2626'
                                  }}>
                                    ${parseFloat(fee.fee_amount).toFixed(2)}
                                  </span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                  <div style={{ display: 'flex', gap: '12px', fontSize: '12px', color: '#6b7280' }}>
                                    <span>Due: {new Date(fee.rent_due_date).toLocaleDateString()}</span>
                                    <span>Applied: {new Date(fee.applied_date).toLocaleDateString()}</span>
                                  </div>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <span className={`badge ${fee.status === 'paid' ? 'badge-current' : fee.status === 'waived' ? 'badge-past' : 'badge-late'}`}>
                                      {fee.status.charAt(0).toUpperCase() + fee.status.slice(1)}
                                    </span>
                                    {fee.status === 'unpaid' && (
                                      <>
                                        <button
                                          onClick={() => markLateFeePaid(fee.id)}
                                          className="btn-text"
                                          style={{ fontSize: '12px', padding: '4px 8px', color: '#10b981' }}
                                        >
                                          Mark Paid
                                        </button>
                                        <button
                                          onClick={() => setShowWaiveLateFeeModal(fee.id)}
                                          className="btn-text"
                                          style={{ fontSize: '12px', padding: '4px 8px' }}
                                        >
                                          Waive
                                        </button>
                                      </>
                                    )}
                                    <button
                                      onClick={() => deleteLateFee(fee.id)}
                                      className="btn-text"
                                      style={{ fontSize: '12px', padding: '4px 8px', color: '#dc2626' }}
                                    >
                                      Delete
                                    </button>
                                  </div>
                                </div>
                                {fee.waived_reason && (
                                  <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#6b7280', fontStyle: 'italic' }}>
                                    Waived: {fee.waived_reason}
                                  </p>
                                )}
                              </div>
                            );
                          })
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Late Fee Settings Modal */}
              {showLateFeeSettingsModal && (
                <>
                  <div className="panel-overlay" onClick={() => setShowLateFeeSettingsModal(null)} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 1000 }}></div>
                  <div style={{ 
                    position: 'fixed', 
                    top: '50%', 
                    left: '50%', 
                    transform: 'translate(-50%, -50%)', 
                    background: 'white', 
                    borderRadius: '12px', 
                    boxShadow: '0 4px 24px rgba(0,0,0,0.2)', 
                    maxWidth: '500px', 
                    width: '90%', 
                    maxHeight: '90vh', 
                    overflow: 'auto',
                    zIndex: 1001 
                  }} onClick={e => e.stopPropagation()}>
                    <div style={{ padding: '24px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                        <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '500', color: '#202124' }}>
                          Late Fee Settings
                        </h2>
                        <button 
                          onClick={() => setShowLateFeeSettingsModal(null)}
                          style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#5f6368' }}
                        >
                          Ã
                        </button>
                      </div>

                      <p style={{ fontSize: '14px', color: '#5f6368', marginBottom: '24px' }}>
                        {properties.find(p => p.id === showLateFeeSettingsModal)?.address.split(',')[0]}
                      </p>

                      {/* Enable Toggle */}
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px', padding: '16px', background: '#f9fafb', borderRadius: '8px' }}>
                        <div>
                          <p style={{ margin: 0, fontWeight: '500', color: '#202124' }}>Enable Late Fees</p>
                          <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#6b7280' }}>Automatically apply fees for late payments</p>
                        </div>
                        <label style={{ position: 'relative', display: 'inline-block', width: '48px', height: '28px' }}>
                          <input
                            type="checkbox"
                            checked={lateFeeSettingsForm.isEnabled}
                            onChange={(e) => setLateFeeSettingsForm({ ...lateFeeSettingsForm, isEnabled: e.target.checked })}
                            style={{ opacity: 0, width: 0, height: 0 }}
                          />
                          <span style={{
                            position: 'absolute',
                            cursor: 'pointer',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            backgroundColor: lateFeeSettingsForm.isEnabled ? '#1a73e8' : '#ccc',
                            borderRadius: '28px',
                            transition: '0.3s'
                          }}>
                            <span style={{
                              position: 'absolute',
                              height: '20px',
                              width: '20px',
                              left: lateFeeSettingsForm.isEnabled ? '24px' : '4px',
                              bottom: '4px',
                              backgroundColor: 'white',
                              borderRadius: '50%',
                              transition: '0.3s'
                            }}></span>
                          </span>
                        </label>
                      </div>

                      {/* Fee Type */}
                      <div style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>
                          Fee Type
                        </label>
                        <select
                          value={lateFeeSettingsForm.feeType}
                          onChange={(e) => setLateFeeSettingsForm({ ...lateFeeSettingsForm, feeType: e.target.value })}
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: '1px solid #dadce0',
                            borderRadius: '4px',
                            fontSize: '14px',
                            color: '#202124'
                          }}
                        >
                          <option value="percentage">Percentage of Rent</option>
                          <option value="flat">Flat Fee</option>
                        </select>
                      </div>

                      {/* Fee Amount */}
                      <div style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>
                          {lateFeeSettingsForm.feeType === 'percentage' ? 'Fee Percentage' : 'Fee Amount'}
                        </label>
                        <div style={{ position: 'relative' }}>
                          <span style={{ 
                            position: 'absolute', 
                            left: '12px', 
                            top: '50%', 
                            transform: 'translateY(-50%)', 
                            color: '#6b7280' 
                          }}>
                            {lateFeeSettingsForm.feeType === 'percentage' ? '%' : '$'}
                          </span>
                          <input
                            type="number"
                            value={lateFeeSettingsForm.feeAmount}
                            onChange={(e) => setLateFeeSettingsForm({ ...lateFeeSettingsForm, feeAmount: e.target.value })}
                            placeholder={lateFeeSettingsForm.feeType === 'percentage' ? '5' : '50'}
                            style={{
                              width: '100%',
                              padding: '10px 12px 10px 32px',
                              border: '1px solid #dadce0',
                              borderRadius: '4px',
                              fontSize: '14px',
                              color: '#202124'
                            }}
                          />
                        </div>
                        <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#6b7280' }}>
                          Industry standard: 5% or $50 flat fee
                        </p>
                      </div>

                      {/* Grace Period */}
                      <div style={{ marginBottom: '20px' }}>
                        <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>
                          Grace Period (Days)
                        </label>
                        <input
                          type="number"
                          value={lateFeeSettingsForm.gracePeriodDays}
                          onChange={(e) => setLateFeeSettingsForm({ ...lateFeeSettingsForm, gracePeriodDays: e.target.value })}
                          placeholder="5"
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: '1px solid #dadce0',
                            borderRadius: '4px',
                            fontSize: '14px',
                            color: '#202124'
                          }}
                        />
                        <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#6b7280' }}>
                          Days after rent due date before fee is applied (typically 3-5 days)
                        </p>
                      </div>

                      {/* State Code for Compliance */}
                      <div style={{ marginBottom: '24px' }}>
                        <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>
                          Property State (for compliance)
                        </label>
                        <select
                          value={lateFeeSettingsForm.stateCode}
                          onChange={(e) => setLateFeeSettingsForm({ ...lateFeeSettingsForm, stateCode: e.target.value })}
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: '1px solid #dadce0',
                            borderRadius: '4px',
                            fontSize: '14px',
                            color: '#202124'
                          }}
                        >
                          <option value="">Select State</option>
                          <option value="CA">California</option>
                          <option value="DC">Washington D.C.</option>
                          <option value="ME">Maine</option>
                          <option value="MD">Maryland</option>
                          <option value="NC">North Carolina</option>
                          <option value="OR">Oregon</option>
                          <option value="TN">Tennessee</option>
                          <option value="TX">Texas</option>
                          <option value="WA">Washington</option>
                          <option value="OTHER">Other</option>
                        </select>
                      </div>

                      {/* State Compliance Warning */}
                      {lateFeeSettingsForm.stateCode && getStateComplianceWarning(lateFeeSettingsForm.stateCode) && (
                        <div style={{ 
                          padding: '16px', 
                          background: '#fef3c7', 
                          borderRadius: '8px', 
                          marginBottom: '24px',
                          border: '1px solid #fcd34d'
                        }}>
                          <div style={{ display: 'flex', gap: '12px' }}>
                            <span style={{ fontSize: '20px' }}>â ï¸</span>
                            <div>
                              <p style={{ margin: 0, fontWeight: '500', color: '#92400e', fontSize: '14px' }}>State Compliance Note</p>
                              <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#92400e' }}>
                                {getStateComplianceWarning(lateFeeSettingsForm.stateCode)}
                              </p>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Action Buttons */}
                      <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                        <button
                          onClick={() => setShowLateFeeSettingsModal(null)}
                          className="btn-secondary"
                        >
                          Cancel
                        </button>
                        <button
                          onClick={() => saveLateFeeSettings(showLateFeeSettingsModal)}
                          className="btn-primary"
                        >
                          Save Settings
                        </button>
                      </div>
                    </div>
                  </div>
                </>
              )}

              {/* Waive Late Fee Modal */}
              {showWaiveLateFeeModal && (
                <>
                  <div className="panel-overlay" onClick={() => { setShowWaiveLateFeeModal(null); setWaiveReason(''); }} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 1000 }}></div>
                  <div style={{ 
                    position: 'fixed', 
                    top: '50%', 
                    left: '50%', 
                    transform: 'translate(-50%, -50%)', 
                    background: 'white', 
                    borderRadius: '12px', 
                    boxShadow: '0 4px 24px rgba(0,0,0,0.2)', 
                    maxWidth: '400px', 
                    width: '90%',
                    zIndex: 1001 
                  }} onClick={e => e.stopPropagation()}>
                    <div style={{ padding: '24px' }}>
                      <h2 style={{ margin: '0 0 16px', fontSize: '20px', fontWeight: '500', color: '#202124' }}>
                        Waive Late Fee
                      </h2>
                      <p style={{ fontSize: '14px', color: '#5f6368', marginBottom: '20px' }}>
                        Please provide a reason for waiving this late fee.
                      </p>
                      <div style={{ marginBottom: '24px' }}>
                        <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>
                          Reason
                        </label>
                        <textarea
                          value={waiveReason}
                          onChange={(e) => setWaiveReason(e.target.value)}
                          placeholder="e.g., First-time late payment, hardship, payment system issue..."
                          rows={3}
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            border: '1px solid #dadce0',
                            borderRadius: '4px',
                            fontSize: '14px',
                            color: '#202124',
                            resize: 'vertical'
                          }}
                        />
                      </div>
                      <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                        <button
                          onClick={() => { setShowWaiveLateFeeModal(null); setWaiveReason(''); }}
                          className="btn-secondary"
                        >
                          Cancel
                        </button>
                        <button
                          onClick={() => waiveLateFee(showWaiveLateFeeModal)}
                          className="btn-primary"
                          disabled={!waiveReason.trim()}
                        >
                          Waive Fee
                        </button>
                      </div>
                    </div>
                  </div>
                </>
              )}

              {/* Vendors Tab */}
              {activeTab === 'vendors' && (
                <div>
                  {/* Header */}
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center', 
                    marginBottom: '24px' 
                  }}>
                    <div>
                      <h1 style={{ fontSize: '24px', fontWeight: '600', color: '#1e293b', margin: 0 }}>
                        Vendor Directory
                      </h1>
                      <p style={{ color: '#64748b', fontSize: '14px', marginTop: '4px' }}>
                        Manage contractors and track payments
                      </p>
                    </div>
                    <button
                      onClick={() => setShowAddVendorModal(true)}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        padding: '10px 16px',
                        background: '#1a73e8',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '14px',
                        fontWeight: '500',
                        cursor: 'pointer'
                      }}
                    >
                      <span>+</span> Add Vendor
                    </button>
                  </div>

                  {/* Stats Cards */}
                  <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(4, 1fr)', 
                    gap: '16px', 
                    marginBottom: '24px' 
                  }}>
                    {[
                      { 
                        label: 'Total Vendors', 
                        value: vendors.length,
                        sub: `${vendors.filter(v => v.status === 'active').length} active`
                      },
                      { 
                        label: 'Preferred Vendors', 
                        value: vendors.filter(v => v.is_preferred).length,
                        sub: 'marked as preferred'
                      },
                      { 
                        label: 'Pending Payments', 
                        value: `$${vendorPayments.filter(p => p.status === 'pending').reduce((sum, p) => sum + Number(p.amount), 0).toLocaleString()}`,
                        sub: `${vendorPayments.filter(p => p.status === 'pending').length} payments`
                      },
                      { 
                        label: 'Paid This Month', 
                        value: `$${vendorPayments.filter(p => {
                          const paymentDate = new Date(p.payment_date);
                          const now = new Date();
                          return p.status === 'paid' && 
                            paymentDate.getMonth() === now.getMonth() && 
                            paymentDate.getFullYear() === now.getFullYear();
                        }).reduce((sum, p) => sum + Number(p.amount), 0).toLocaleString()}`,
                        sub: 'this month'
                      }
                    ].map((stat, i) => (
                      <div key={i} style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        border: '1px solid #e2e8f0'
                      }}>
                        <p style={{ color: '#64748b', fontSize: '13px', margin: 0 }}>{stat.label}</p>
                        <p style={{ fontSize: '28px', fontWeight: '600', color: '#1e293b', margin: '8px 0 4px' }}>
                          {stat.value}
                        </p>
                        <p style={{ color: '#94a3b8', fontSize: '12px', margin: 0 }}>{stat.sub}</p>
                      </div>
                    ))}
                  </div>

                  {/* Filters */}
                  <div style={{ 
                    display: 'flex', 
                    gap: '12px', 
                    marginBottom: '20px',
                    flexWrap: 'wrap'
                  }}>
                    <input
                      type="text"
                      placeholder="Search vendors..."
                      value={vendorSearchQuery}
                      onChange={(e) => setVendorSearchQuery(e.target.value)}
                      style={{
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        width: '240px'
                      }}
                    />
                    <select
                      value={vendorFilter}
                      onChange={(e) => setVendorFilter(e.target.value)}
                      style={{
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white'
                      }}
                    >
                      <option value="all">All Status</option>
                      <option value="active">Active</option>
                      <option value="inactive">Inactive</option>
                    </select>
                    <select
                      value={vendorSpecialtyFilter}
                      onChange={(e) => setVendorSpecialtyFilter(e.target.value)}
                      style={{
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white'
                      }}
                    >
                      <option value="all">All Specialties</option>
                      {vendorSpecialties.map(s => (
                        <option key={s.value} value={s.value}>{s.label}</option>
                      ))}
                    </select>
                  </div>

                  {/* Vendor Grid */}
                  <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', 
                    gap: '16px' 
                  }}>
                    {vendors
                      .filter(v => {
                        if (vendorFilter !== 'all' && v.status !== vendorFilter) return false;
                        if (vendorSpecialtyFilter !== 'all' && v.specialty !== vendorSpecialtyFilter) return false;
                        if (vendorSearchQuery) {
                          const query = vendorSearchQuery.toLowerCase();
                          return (
                            v.name?.toLowerCase().includes(query) ||
                            v.company?.toLowerCase().includes(query) ||
                            v.email?.toLowerCase().includes(query) ||
                            v.phone?.includes(query)
                          );
                        }
                        return true;
                      })
                      .map(vendor => {
                        const stats = getVendorStats(vendor.id);
                        const specialtyInfo = getSpecialtyInfo(vendor.specialty);
                        
                        return (
                          <div
                            key={vendor.id}
                            onClick={() => setShowVendorDetail(vendor)}
                            style={{
                              background: 'white',
                              borderRadius: '12px',
                              border: '1px solid #e2e8f0',
                              padding: '20px',
                              cursor: 'pointer',
                              transition: 'border-color 0.15s ease'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.borderColor = '#1a73e8'}
                            onMouseLeave={(e) => e.currentTarget.style.borderColor = '#e2e8f0'}
                          >
                            {/* Header */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                              <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                                <div style={{
                                  width: '48px',
                                  height: '48px',
                                  borderRadius: '10px',
                                  background: '#f1f5f9',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  color: '#64748b'
                                }}>
                                  {specialtyInfo.icon}
                                </div>
                                <div>
                                  <h3 style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: '#1e293b' }}>
                                    {vendor.name}
                                  </h3>
                                  {vendor.company && (
                                    <p style={{ margin: '2px 0 0', fontSize: '13px', color: '#64748b' }}>
                                      {vendor.company}
                                    </p>
                                  )}
                                </div>
                              </div>
                              <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                                {vendor.is_preferred && (
                                  <span style={{
                                    padding: '4px 8px',
                                    background: '#fef3c7',
                                    color: '#92400e',
                                    borderRadius: '6px',
                                    fontSize: '11px',
                                    fontWeight: '500'
                                  }}>
                                    Preferred
                                  </span>
                                )}
                                <span style={{
                                  padding: '4px 8px',
                                  background: vendor.status === 'active' ? '#dcfce7' : '#f1f5f9',
                                  color: vendor.status === 'active' ? '#166534' : '#64748b',
                                  borderRadius: '6px',
                                  fontSize: '11px',
                                  fontWeight: '500'
                                }}>
                                  {vendor.status === 'active' ? 'Active' : 'Inactive'}
                                </span>
                              </div>
                            </div>

                            {/* Specialty */}
                            <p style={{ 
                              margin: '0 0 12px', 
                              fontSize: '13px', 
                              color: '#1a73e8',
                              fontWeight: '500'
                            }}>
                              {specialtyInfo.label}
                            </p>

                            {/* Rating */}
                            {vendor.rating && (
                              <div style={{ marginBottom: '12px' }}>
                                {renderStars(vendor.rating)}
                              </div>
                            )}

                            {/* Contact Info */}
                            <div style={{ 
                              display: 'flex', 
                              gap: '16px', 
                              fontSize: '13px', 
                              color: '#64748b',
                              marginBottom: '12px'
                            }}>
                              {vendor.phone && (
                                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                  {vendor.phone}
                                </span>
                              )}
                              {vendor.email && (
                                <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                  {vendor.email}
                                </span>
                              )}
                            </div>

                            {/* Stats */}
                            <div style={{
                              display: 'grid',
                              gridTemplateColumns: 'repeat(3, 1fr)',
                              gap: '8px',
                              padding: '12px',
                              background: '#f8fafc',
                              borderRadius: '8px',
                              fontSize: '12px'
                            }}>
                              <div style={{ textAlign: 'center' }}>
                                <p style={{ margin: 0, color: '#64748b' }}>Jobs</p>
                                <p style={{ margin: '4px 0 0', fontWeight: '600', color: '#1e293b' }}>
                                  {stats.totalJobs}
                                </p>
                              </div>
                              <div style={{ textAlign: 'center' }}>
                                <p style={{ margin: 0, color: '#64748b' }}>Total Paid</p>
                                <p style={{ margin: '4px 0 0', fontWeight: '600', color: '#1e293b' }}>
                                  ${stats.totalPaid.toLocaleString()}
                                </p>
                              </div>
                              <div style={{ textAlign: 'center' }}>
                                <p style={{ margin: 0, color: '#64748b' }}>Pending</p>
                                <p style={{ margin: '4px 0 0', fontWeight: '600', color: stats.pendingPayments > 0 ? '#dc2626' : '#1e293b' }}>
                                  ${stats.pendingPayments.toLocaleString()}
                                </p>
                              </div>
                            </div>

                            {/* Rate */}
                            {(vendor.hourly_rate || vendor.flat_rate) && (
                              <p style={{ 
                                margin: '12px 0 0', 
                                fontSize: '13px', 
                                color: '#64748b' 
                              }}>
                                {vendor.hourly_rate && `$${vendor.hourly_rate}/hr`}
                                {vendor.hourly_rate && vendor.flat_rate && ' | '}
                                {vendor.flat_rate && `$${vendor.flat_rate} flat`}
                              </p>
                            )}
                          </div>
                        );
                      })}
                  </div>

                  {/* Empty State */}
                  {vendors.length === 0 && (
                    <div style={{
                      textAlign: 'center',
                      padding: '60px 20px',
                      background: 'white',
                      borderRadius: '12px',
                      border: '1px solid #e2e8f0'
                    }}>
                      <div style={{ 
                        width: '64px', 
                        height: '64px', 
                        margin: '0 auto 16px',
                        background: '#f1f5f9',
                        borderRadius: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: '#64748b'
                      }}>
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                      </div>
                      <h3 style={{ margin: '0 0 8px', color: '#1e293b' }}>No vendors yet</h3>
                      <p style={{ margin: '0 0 20px', color: '#64748b' }}>
                        Add your first vendor to start tracking contractors and payments.
                      </p>
                      <button
                        onClick={() => setShowAddVendorModal(true)}
                        style={{
                          padding: '10px 20px',
                          background: '#1a73e8',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '500',
                          cursor: 'pointer'
                        }}
                      >
                        Add First Vendor
                      </button>
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'reports' && (() => {
                const stats = getReportsStats();
                const totalUnits = properties.reduce((sum, p) => sum + (p.units || 1), 0);
                const totalOccupied = properties.reduce((sum, p) => sum + (p.occupied || 0), 0);
                const occupancyRate = totalUnits > 0 ? Math.round((totalOccupied / totalUnits) * 100) : 85;
                const profitMargin = stats.totalRevenue > 0 ? Math.round((stats.netProfit / stats.totalRevenue) * 100) : 0;
                const expensesPercent = stats.totalRevenue > 0 ? Math.round((stats.totalExpenses / stats.totalRevenue) * 100) : 0;
                
                // Calculate property performance data
                const propertyPerformanceData = properties.map(property => {
                  const propertyTenants = tenants.filter(t => t.status === 'current' && t.property && property.address && t.property.includes(property.address));
                  const propertyRevenue = propertyTenants.reduce((sum, t) => sum + (t.rentAmount || 0), 0) || property.monthlyRevenue || 0;
                  const propertyUnits = property.units || 1;
                  const propertyOccupied = property.occupied || propertyTenants.length;
                  
                  return {
                    ...property,
                    propertyRevenue,
                    propertyUnits,
                    propertyOccupied
                  };
                });
                
                // Get revenue by property data for pie chart
                const revenueByPropertyData = getRevenueByPropertyData();
                const pieColors = ['#1a73e8', '#0891b2', '#10b981', '#f97316'];
                const totalRevenueForPie = revenueByPropertyData.reduce((sum, item) => sum + item.value, 0);
                
                // Helper function to get short property name
                const getShortPropertyName = (name) => {
                  if (!name) return 'Unknown';
                  // Extract first part before comma or take first 15 chars
                  const shortName = name.split(',')[0].trim();
                  return shortName.length > 15 ? shortName.substring(0, 15) + '...' : shortName;
                };
                
                return (
                  <div className="content-section" style={{padding: '24px'}}>
                    {/* Header */}
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '24px'}}>
                      <div>
                        <h1 style={{margin: 0, fontSize: '32px', fontWeight: '400', color: '#202124'}}>Reports</h1>
                        <p style={{margin: '8px 0 0', fontSize: '14px', color: '#5f6368'}}>Financial insights and analytics</p>
                      </div>
                      <button className="btn-primary" onClick={() => exportRentRollToCSV()} style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                          <polyline points="7 10 12 15 17 10"></polyline>
                          <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export Reports
                      </button>
                    </div>
                    
                    {/* Stats Cards */}
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px'}}>
                      {/* Total Revenue */}
                      <div style={{background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', position: 'relative'}}>
                        <div style={{position: 'absolute', top: '20px', right: '20px', width: '40px', height: '40px', borderRadius: '50%', background: '#1a73e8', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                          </svg>
                        </div>
                        <p style={{margin: 0, fontSize: '14px', color: '#5f6368', marginBottom: '12px'}}>Total Revenue</p>
                        <p style={{margin: 0, fontSize: '32px', fontWeight: '500', color: '#202124', marginBottom: '8px'}}>
                          {'$' + stats.totalRevenue.toLocaleString()}
                        </p>
                        <p style={{margin: 0, fontSize: '12px', color: '#10b981'}}>+12.5% from last period</p>
                      </div>
                      
                      {/* Total Expenses */}
                      <div style={{background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', position: 'relative'}}>
                        <div style={{position: 'absolute', top: '20px', right: '20px', width: '40px', height: '40px', borderRadius: '50%', background: '#10b981', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                            <polyline points="22 6 13.5 14.5 8.5 9.5 2 16"></polyline>
                            <polyline points="16 6 22 6 22 12"></polyline>
                          </svg>
                        </div>
                        <p style={{margin: 0, fontSize: '14px', color: '#5f6368', marginBottom: '12px'}}>Total Expenses</p>
                        <p style={{margin: 0, fontSize: '32px', fontWeight: '500', color: '#202124', marginBottom: '8px'}}>
                          {'$' + stats.totalExpenses.toLocaleString()}
                        </p>
                        <p style={{margin: 0, fontSize: '12px', color: '#6b7280'}}>{expensesPercent}% of revenue</p>
                      </div>
                      
                      {/* Net Profit */}
                      <div style={{background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', position: 'relative'}}>
                        <div style={{position: 'absolute', top: '20px', right: '20px', width: '40px', height: '40px', borderRadius: '50%', background: '#f97316', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                          </svg>
                        </div>
                        <p style={{margin: 0, fontSize: '14px', color: '#5f6368', marginBottom: '12px'}}>Net Profit</p>
                        <p style={{margin: 0, fontSize: '32px', fontWeight: '500', color: '#202124', marginBottom: '8px'}}>
                          {'$' + stats.netProfit.toLocaleString()}
                        </p>
                        <p style={{margin: 0, fontSize: '12px', color: '#10b981'}}>{profitMargin}% margin</p>
                      </div>
                      
                      {/* Avg. Occupancy */}
                      <div style={{background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', position: 'relative'}}>
                        <div style={{position: 'absolute', top: '20px', right: '20px', width: '40px', height: '40px', borderRadius: '50%', background: '#1a73e8', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                          </svg>
                        </div>
                        <p style={{margin: 0, fontSize: '14px', color: '#5f6368', marginBottom: '12px'}}>Avg. Occupancy</p>
                        <p style={{margin: 0, fontSize: '32px', fontWeight: '500', color: '#202124', marginBottom: '8px'}}>
                          {occupancyRate}%
                        </p>
                        <p style={{margin: 0, fontSize: '12px', color: '#6b7280'}}>Last 6 months</p>
                      </div>
                    </div>
                    
                    {/* Charts Section */}
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px', marginBottom: '24px'}}>
                      {/* Revenue vs Expenses Chart */}
                      <div style={{background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
                        <h3 style={{margin: '0 0 4px', fontSize: '18px', fontWeight: '500', color: '#202124'}}>Revenue vs Expenses</h3>
                        <p style={{margin: '0 0 24px', fontSize: '14px', color: '#5f6368'}}>Monthly comparison</p>
                        <ResponsiveContainer width="100%" height={300}>
                          <BarChart data={getRevenueVsExpensesData()}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                            <XAxis dataKey="month" stroke="#6b7280" />
                            <YAxis 
                              stroke="#6b7280" 
                              tickFormatter={(value) => formatCurrency(value)}
                            />
                            <Tooltip 
                              formatter={(value, name) => [formatCurrency(value), name]}
                            />
                            <Legend wrapperStyle={{paddingTop: '20px'}} />
                            <Bar dataKey="revenue" fill="#1a73e8" name="Revenue" />
                            <Bar dataKey="expenses" fill="#f97316" name="Expenses" />
                          </BarChart>
                        </ResponsiveContainer>
                      </div>
                      
                      {/* Occupancy Trend Chart */}
                      <div style={{background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
                        <h3 style={{margin: '0 0 4px', fontSize: '18px', fontWeight: '500', color: '#202124'}}>Occupancy Trend</h3>
                        <p style={{margin: '0 0 24px', fontSize: '14px', color: '#5f6368'}}>6-month trend</p>
                        <ResponsiveContainer width="100%" height={300}>
                          <LineChart data={getOccupancyTrendData()}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                            <XAxis dataKey="month" stroke="#6b7280" />
                            <YAxis stroke="#6b7280" domain={[40, 60]} />
                            <Tooltip />
                            <Line type="monotone" dataKey="occupancy" stroke="#10b981" strokeWidth={2} dot={{ fill: '#10b981', r: 4 }} name="Occupancy %" />
                          </LineChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                    
                    {/* Bottom Section */}
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px'}}>
                      {/* Revenue by Property Pie Chart */}
                      <div style={{background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
                        <h3 style={{margin: '0 0 4px', fontSize: '18px', fontWeight: '500', color: '#202124'}}>Revenue by Property</h3>
                        <p style={{margin: '0 0 24px', fontSize: '14px', color: '#5f6368'}}>Distribution</p>
                        <ResponsiveContainer width="100%" height={250}>
                          <PieChart>
                            <Pie
                              data={revenueByPropertyData}
                              cx="50%"
                              cy="50%"
                              labelLine={false}
                              outerRadius={80}
                              fill="#8884d8"
                              dataKey="value"
                            >
                              {revenueByPropertyData.map((entry, index) => {
                                const color = pieColors[index % pieColors.length];
                                return <Cell key={`cell-${index}`} fill={color} />;
                              })}
                            </Pie>
                            <Tooltip formatter={(value) => formatCurrency(value)} />
                          </PieChart>
                        </ResponsiveContainer>
                        {/* Custom Legend */}
                        <div style={{display: 'flex', flexDirection: 'column', gap: '8px', marginTop: '16px'}}>
                          {revenueByPropertyData.map((entry, index) => {
                            const percent = totalRevenueForPie > 0 ? ((entry.value / totalRevenueForPie) * 100).toFixed(0) : 0;
                            return (
                              <div key={index} style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <div style={{width: '12px', height: '12px', borderRadius: '50%', background: pieColors[index % pieColors.length], flexShrink: 0}}></div>
                                <span style={{fontSize: '14px', color: '#202124'}}>{getShortPropertyName(entry.name)}</span>
                                <span style={{fontSize: '14px', color: '#5f6368', marginLeft: 'auto'}}>{percent}%</span>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                      
                      {/* Property Performance List */}
                      <div style={{background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)'}}>
                        <h3 style={{margin: '0 0 4px', fontSize: '18px', fontWeight: '500', color: '#202124'}}>Property Performance</h3>
                        <p style={{margin: '0 0 24px', fontSize: '14px', color: '#5f6368'}}>Key metrics by property</p>
                        <div style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                          {propertyPerformanceData.map((property, index) => {
                            // Match property to pie chart color by finding matching property name in revenue data
                            const propertyName = property.name || property.address || '';
                            const matchingPieIndex = revenueByPropertyData.findIndex(item => {
                              const itemName = item.name.toLowerCase();
                              const propName = propertyName.toLowerCase();
                              return itemName.includes(propName) || propName.includes(itemName) || 
                                     itemName === propName || 
                                     (item.name && property.address && item.name.includes(property.address)) ||
                                     (property.address && item.name && property.address.includes(item.name));
                            });
                            // Use matching index if found, otherwise use property index
                            const colorIndex = matchingPieIndex >= 0 ? matchingPieIndex : index;
                            const dotColor = pieColors[colorIndex % pieColors.length];
                            return (
                              <div key={property.id} style={{display: 'flex', alignItems: 'center', gap: '12px', paddingBottom: '16px', borderBottom: index < propertyPerformanceData.length - 1 ? '1px solid #e5e7eb' : 'none'}}>
                                <div style={{width: '12px', height: '12px', borderRadius: '50%', background: dotColor, flexShrink: 0}}></div>
                                <div style={{flex: 1}}>
                                  <p style={{margin: 0, fontSize: '14px', fontWeight: '500', color: '#202124'}}>{property.name || property.address}</p>
                                  <p style={{margin: '4px 0 0', fontSize: '12px', color: '#5f6368'}}>{property.propertyOccupied}/{property.propertyUnits} units occupied</p>
                                </div>
                                <p style={{margin: 0, fontSize: '14px', fontWeight: '500', color: '#202124'}}>{formatCurrency(property.propertyRevenue)}</p>
                              </div>
                            );
                          })}
                          {properties.length === 0 && (
                            <p style={{color: '#6b7280', fontSize: '14px', textAlign: 'center', padding: '24px'}}>No properties yet</p>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Tag Analysis Section */}
                    <div style={{background: 'white', padding: '24px', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', marginTop: '24px'}}>
                      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '24px'}}>
                        <div>
                          <h3 style={{margin: '0 0 4px', fontSize: '18px', fontWeight: '500', color: '#202124'}}>Tag Analysis</h3>
                          <p style={{margin: 0, fontSize: '14px', color: '#5f6368'}}>Track patterns across your portfolio</p>
                        </div>
                        <div style={{display: 'flex', gap: '12px', alignItems: 'center'}}>
                          <select
                            value={tagAnalysisDateRange}
                            onChange={(e) => setTagAnalysisDateRange(e.target.value)}
                            style={{
                              padding: '8px 12px',
                              border: '1px solid #dadce0',
                              borderRadius: '4px',
                              background: '#fff',
                              color: '#202124',
                              fontSize: '14px',
                              cursor: 'pointer'
                            }}
                          >
                            <option value="all">All time</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="12months">Last 12 months</option>
                          </select>
                          <button
                            className="btn-secondary"
                            onClick={() => {
                              const tagAnalysisData = getTagAnalysisData(tagAnalysisDateRange);
                              const csvData = [];
                              
                              // Header
                              csvData.push(['Record Type', 'Record Name', 'Tag', 'Date Added']);
                              
                              // Get all record tags within date range
                              const now = new Date();
                              let startDate = null;
                              if (tagAnalysisDateRange === '30') {
                                startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                              } else if (tagAnalysisDateRange === '90') {
                                startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                              } else if (tagAnalysisDateRange === '12months') {
                                startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                              }
                              
                              recordTags.forEach(rt => {
                                if (startDate) {
                                  const addedDate = new Date(rt.added_at);
                                  if (addedDate < startDate) return;
                                }
                                
                                const tag = tags.find(t => t.id === rt.tag_id);
                                if (!tag) return;
                                
                                let recordName = 'Unknown';
                                if (rt.record_type === 'tenant') {
                                  const tenant = tenants.find(t => t.id === rt.record_id);
                                  recordName = tenant ? tenant.name : 'Unknown Tenant';
                                } else if (rt.record_type === 'property') {
                                  const property = properties.find(p => p.id === rt.record_id);
                                  recordName = property ? property.address : 'Unknown Property';
                                } else if (rt.record_type === 'maintenance') {
                                  const maintenance = maintenanceRequests.find(m => m.id === rt.record_id);
                                  recordName = maintenance ? maintenance.issue : 'Unknown Request';
                                }
                                
                                csvData.push([
                                  rt.record_type.charAt(0).toUpperCase() + rt.record_type.slice(1),
                                  recordName,
                                  tag.name,
                                  new Date(rt.added_at).toLocaleDateString()
                                ]);
                              });
                              
                              const csv = Papa.unparse(csvData);
                              const blob = new Blob([csv], { type: 'text/csv' });
                              const url = window.URL.createObjectURL(blob);
                              const a = document.createElement('a');
                              a.href = url;
                              a.download = `tag_report_${tagAnalysisDateRange}_${new Date().toISOString().split('T')[0]}.csv`;
                              a.click();
                              window.URL.revokeObjectURL(url);
                            }}
                            style={{
                              padding: '8px 16px',
                              border: '1px solid #dadce0',
                              borderRadius: '4px',
                              background: '#fff',
                              color: '#202124',
                              fontSize: '14px',
                              cursor: 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '8px'
                            }}
                          >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                              <polyline points="7 10 12 15 17 10"></polyline>
                              <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Export Tag Report
                          </button>
                        </div>
                      </div>

                      {/* Tag Summary Table */}
                      <div style={{marginBottom: '24px'}}>
                        <table style={{width: '100%', borderCollapse: 'collapse'}}>
                          <thead>
                            <tr style={{background: '#f8f9fa', borderBottom: '1px solid #dadce0'}}>
                              <th style={{padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: '500', color: '#5f6368'}}>Tag</th>
                              <th style={{padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: '500', color: '#5f6368'}}>Records</th>
                              <th style={{padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: '500', color: '#5f6368'}}>Tenants</th>
                              <th style={{padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: '500', color: '#5f6368'}}>Properties</th>
                              <th style={{padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: '500', color: '#5f6368'}}>Maintenance</th>
                              <th style={{padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: '500', color: '#5f6368'}}>Total Rent Affected</th>
                            </tr>
                          </thead>
                          <tbody>
                            {getTagAnalysisData(tagAnalysisDateRange).map((tagStat, index) => {
                              const colorMap = {
                                blue: '#1a73e8',
                                green: '#10b981',
                                yellow: '#fbbf24',
                                orange: '#f97316',
                                red: '#ef4444',
                                purple: '#a855f7',
                                teal: '#14b8a6',
                                gray: '#6b7280'
                              };
                              const isExpanded = expandedTagRow === tagStat.tag.id;
                              const tagRecords = recordTags.filter(rt => rt.tag_id === tagStat.tag.id);
                              
                              return (
                                <React.Fragment key={tagStat.tag.id}>
                                  <tr
                                    style={{
                                      borderBottom: '1px solid #e5e7eb',
                                      cursor: 'pointer',
                                      background: isExpanded ? '#f8f9fa' : '#fff'
                                    }}
                                    onClick={() => setExpandedTagRow(isExpanded ? null : tagStat.tag.id)}
                                    onMouseEnter={(e) => {
                                      if (!isExpanded) e.currentTarget.style.background = '#f9fafb';
                                    }}
                                    onMouseLeave={(e) => {
                                      if (!isExpanded) e.currentTarget.style.background = '#fff';
                                    }}
                                  >
                                    <td style={{padding: '12px'}}>
                                      <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                        <div
                                          style={{
                                            width: '12px',
                                            height: '12px',
                                            borderRadius: '50%',
                                            background: colorMap[tagStat.tag.color] || colorMap.blue,
                                            flexShrink: 0
                                          }}
                                        />
                                        <span style={{fontSize: '14px', color: '#202124', fontWeight: '500'}}>{tagStat.tag.name}</span>
                                        <svg
                                          width="16"
                                          height="16"
                                          viewBox="0 0 24 24"
                                          fill="none"
                                          stroke="currentColor"
                                          strokeWidth="2"
                                          style={{
                                            marginLeft: '4px',
                                            transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)',
                                            transition: 'transform 0.2s',
                                            color: '#5f6368'
                                          }}
                                        >
                                          <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                      </div>
                                    </td>
                                    <td style={{padding: '12px', textAlign: 'right', fontSize: '14px', color: '#202124'}}>{tagStat.totalRecords}</td>
                                    <td style={{padding: '12px', textAlign: 'right', fontSize: '14px', color: '#202124'}}>{tagStat.tenants}</td>
                                    <td style={{padding: '12px', textAlign: 'right', fontSize: '14px', color: '#202124'}}>{tagStat.properties}</td>
                                    <td style={{padding: '12px', textAlign: 'right', fontSize: '14px', color: '#202124'}}>{tagStat.maintenance}</td>
                                    <td style={{padding: '12px', textAlign: 'right', fontSize: '14px', color: '#202124', fontWeight: '500'}}>
                                      {tagStat.totalRent > 0 ? formatCurrency(tagStat.totalRent) : '-'}
                                    </td>
                                  </tr>
                                  {isExpanded && (
                                    <tr>
                                      <td colSpan="6" style={{padding: '16px', background: '#f8f9fa', borderBottom: '1px solid #e5e7eb'}}>
                                        <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
                                          {tagRecords.map(rt => {
                                            let recordName = 'Unknown';
                                            let recordLink = null;
                                            
                                            if (rt.record_type === 'tenant') {
                                              const tenant = tenants.find(t => t.id === rt.record_id);
                                              if (tenant) {
                                                recordName = tenant.name;
                                                recordLink = () => {
                                                  setSelectedTenant(tenant);
                                                  setActiveTab('tenants');
                                                };
                                              }
                                            } else if (rt.record_type === 'property') {
                                              const property = properties.find(p => p.id === rt.record_id);
                                              if (property) {
                                                recordName = property.address;
                                                recordLink = () => {
                                                  setSelectedProperty(property);
                                                  setActiveTab('properties');
                                                };
                                              }
                                            } else if (rt.record_type === 'maintenance') {
                                              const maintenance = maintenanceRequests.find(m => m.id === rt.record_id);
                                              if (maintenance) {
                                                recordName = maintenance.issue;
                                                recordLink = () => {
                                                  setSelectedMaintenanceRequest(maintenance);
                                                  setActiveTab('maintenance');
                                                };
                                              }
                                            }
                                            
                                            return (
                                              <div
                                                key={rt.id}
                                                style={{
                                                  display: 'flex',
                                                  alignItems: 'center',
                                                  gap: '12px',
                                                  padding: '8px',
                                                  background: '#fff',
                                                  borderRadius: '4px',
                                                  cursor: recordLink ? 'pointer' : 'default'
                                                }}
                                                onClick={recordLink}
                                                onMouseEnter={(e) => {
                                                  if (recordLink) e.currentTarget.style.background = '#f0f0f0';
                                                }}
                                                onMouseLeave={(e) => {
                                                  if (recordLink) e.currentTarget.style.background = '#fff';
                                                }}
                                              >
                                                <span style={{
                                                  fontSize: '12px',
                                                  padding: '2px 8px',
                                                  borderRadius: '4px',
                                                  background: rt.record_type === 'tenant' ? '#e8f0fe' : rt.record_type === 'property' ? '#e6f4ea' : '#fef3c7',
                                                  color: rt.record_type === 'tenant' ? '#1a73e8' : rt.record_type === 'property' ? '#166534' : '#92400e',
                                                  fontWeight: '500',
                                                  textTransform: 'capitalize'
                                                }}>
                                                  {rt.record_type}
                                                </span>
                                                <span style={{fontSize: '14px', color: '#202124', flex: 1}}>{recordName}</span>
                                                <span style={{fontSize: '12px', color: '#5f6368'}}>
                                                  {new Date(rt.added_at).toLocaleDateString()}
                                                </span>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      </td>
                                    </tr>
                                  )}
                                </React.Fragment>
                              );
                            })}
                            {getTagAnalysisData(tagAnalysisDateRange).length === 0 && (
                              <tr>
                                <td colSpan="6" style={{padding: '40px', textAlign: 'center', color: '#5f6368'}}>
                                  No tags found for the selected date range
                                </td>
                              </tr>
                            )}
                          </tbody>
                        </table>
                      </div>

                      {/* Tag Trend Chart */}
                      <div style={{marginTop: '32px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                          <div>
                            <h4 style={{margin: '0 0 4px', fontSize: '16px', fontWeight: '500', color: '#202124'}}>Tag Trend</h4>
                            <p style={{margin: 0, fontSize: '14px', color: '#5f6368'}}>Track tag frequency over time</p>
                          </div>
                          <select
                            value={selectedTagForTrend || ''}
                            onChange={(e) => setSelectedTagForTrend(e.target.value || null)}
                            style={{
                              padding: '8px 12px',
                              border: '1px solid #dadce0',
                              borderRadius: '4px',
                              background: '#fff',
                              color: '#202124',
                              fontSize: '14px',
                              cursor: 'pointer',
                              minWidth: '200px'
                            }}
                          >
                            <option value="">Select a tag...</option>
                            {tags.map(tag => (
                              <option key={tag.id} value={tag.id}>{tag.name}</option>
                            ))}
                          </select>
                        </div>
                        {selectedTagForTrend && (() => {
                          const trendData = getTagTrendData(selectedTagForTrend, tagAnalysisDateRange);
                          return trendData.length > 0 ? (
                            <div style={{height: '300px'}}>
                              <ResponsiveContainer width="100%" height="100%">
                                <LineChart data={trendData}>
                                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                                  <XAxis dataKey="month" stroke="#5f6368" />
                                  <YAxis stroke="#5f6368" />
                                  <Tooltip />
                                  <Line type="monotone" dataKey="count" stroke="#1a73e8" strokeWidth={2} dot={{ fill: '#1a73e8', r: 4 }} />
                                </LineChart>
                              </ResponsiveContainer>
                            </div>
                          ) : (
                            <div style={{padding: '40px', textAlign: 'center', color: '#5f6368', background: '#f8f9fa', borderRadius: '8px'}}>
                              No data available for this tag in the selected date range
                            </div>
                          );
                        })()}
                        {!selectedTagForTrend && (
                          <div style={{padding: '40px', textAlign: 'center', color: '#5f6368', background: '#f8f9fa', borderRadius: '8px'}}>
                            Select a tag to view its trend
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })()}

              {/* Messages Tab */}
              {activeTab === 'messages' && (
                <div className="content-section" style={{ padding: 0, height: 'calc(100vh - 60px)', display: 'flex', flexDirection: 'column' }}>
                  <div style={{ 
                    display: 'flex', 
                    height: '100%', 
                    borderTop: '1px solid #e5e7eb',
                    overflow: 'hidden'
                  }}>
                    {/* Left Panel - Conversation List */}
                    <div style={{
                      width: isMobile ? '100%' : '350px',
                      borderRight: isMobile ? 'none' : '1px solid #e5e7eb',
                      display: 'flex',
                      flexDirection: 'column',
                      background: '#f9fafb'
                    }}>
                      {/* Header */}
                      <div style={{
                        padding: '20px',
                        borderBottom: '1px solid #e2e8f0',
                        background: 'white'
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                          <div>
                            <h1 style={{ fontSize: 28, fontWeight: 600, margin: 0, color: '#0f172a' }}>Messages</h1>
                            <p style={{ color: '#64748b', margin: '4px 0 0', fontSize: 14 }}>{conversations.length} conversation{conversations.length !== 1 ? 's' : ''}</p>
                          </div>
                          <button 
                            onClick={handleMessagesRefresh}
                            disabled={messagesRefreshing}
                            style={{
                              background: 'transparent',
                              border: '1px solid #e2e8f0',
                              padding: 8,
                              cursor: messagesRefreshing ? 'not-allowed' : 'pointer',
                              borderRadius: 6,
                              display: 'flex',
                              alignItems: 'center',
                              color: messagesRefreshing ? '#94a3b8' : '#64748b',
                              transition: 'all 0.15s',
                              opacity: messagesRefreshing ? 0.6 : 1
                            }}
                            onMouseEnter={(e) => {
                              if (!messagesRefreshing) {
                                e.currentTarget.style.borderColor = '#94a3b8';
                                e.currentTarget.style.color = '#0f172a';
                              }
                            }}
                            onMouseLeave={(e) => {
                              if (!messagesRefreshing) {
                                e.currentTarget.style.borderColor = '#e2e8f0';
                                e.currentTarget.style.color = '#64748b';
                              }
                            }}
                            title='Refresh'
                          >
                            <svg 
                              width='20' 
                              height='20' 
                              viewBox='0 0 24 24' 
                              fill='none' 
                              stroke='currentColor' 
                              strokeWidth='2'
                              style={{
                                animation: messagesRefreshing ? 'spin 1s linear infinite' : 'none'
                              }}
                            >
                              <path d='M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15'/>
                            </svg>
                          </button>
                        </div>
                      </div>

                      {/* Conversation List */}
                      <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        background: 'white'
                      }}>
                        {conversations.length === 0 ? (
                          <div style={{
                            padding: '40px 20px',
                            textAlign: 'center',
                            color: '#9ca3af'
                          }}>
                            <div style={{ fontSize: 48, marginBottom: 16 }}>ð¬</div>
                            <p>No messages yet</p>
                            <p style={{ fontSize: 12, marginTop: 8 }}>SMS conversations will appear here</p>
                          </div>
                        ) : (
                          conversations.map(conv => {
                            const isSelected = selectedConversation?.phone === conv.phone;
                            return (
                              <div
                                key={conv.phone}
                                onClick={() => {
                                  setSelectedConversation(conv);
                                }}
                                style={{
                                  padding: '16px',
                                  borderBottom: '1px solid #f3f4f6',
                                  cursor: 'pointer',
                                  background: isSelected ? '#f1f5f9' : 'white',
                                  transition: 'background 0.15s',
                                  display: 'flex',
                                  alignItems: 'flex-start',
                                  gap: 12
                                }}
                                onMouseEnter={(e) => {
                                  if (!isSelected) e.currentTarget.style.background = '#f8fafc';
                                }}
                                onMouseLeave={(e) => {
                                  if (!isSelected) e.currentTarget.style.background = 'white';
                                }}
                              >
                                <div style={{
                                  width: 44,
                                  height: 44,
                                  borderRadius: 8,
                                  background: '#f1f5f9',
                                  color: '#64748b',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  fontSize: 14,
                                  fontWeight: 600,
                                  flexShrink: 0
                                }}>
                                  {conv.tenant?.name ? conv.tenant.name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase() : (
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                      <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                  )}
                                </div>
                                <div style={{ flex: 1, minWidth: 0 }}>
                                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 4 }}>
                                    <h3 style={{
                                      fontSize: 15,
                                      fontWeight: 600,
                                      margin: 0,
                                      whiteSpace: 'nowrap',
                                      overflow: 'hidden',
                                      textOverflow: 'ellipsis',
                                      flex: 1
                                    }}>
                                      {conv.tenant?.name || conv.phone}
                                    </h3>
                                    {conv.lastMessage && (
                                      <span style={{
                                        fontSize: 12,
                                        color: '#9ca3af',
                                        whiteSpace: 'nowrap',
                                        marginLeft: 8
                                      }}>
                                        {new Date(conv.lastMessage.created_at).toLocaleDateString('en-US', {
                                          month: 'short',
                                          day: 'numeric',
                                          ...(new Date(conv.lastMessage.created_at).toDateString() !== new Date().toDateString() ? {} : {
                                            hour: 'numeric',
                                            minute: '2-digit'
                                          })
                                        })}
                                      </span>
                                    )}
                                  </div>
                                  {conv.lastMessage && (
                                    <p style={{
                                      fontSize: 13,
                                      color: '#6b7280',
                                      margin: 0,
                                      whiteSpace: 'nowrap',
                                      overflow: 'hidden',
                                      textOverflow: 'ellipsis'
                                    }}>
                                      {conv.lastMessage.message}
                                    </p>
                                  )}
                                  {conv.unreadCount > 0 && (
                                    <div style={{
                                      display: 'inline-block',
                                      marginTop: 4,
                                      padding: '2px 8px',
                                      borderRadius: 4,
                                      background: '#0f172a',
                                      color: 'white',
                                      fontSize: 11,
                                      fontWeight: 500
                                    }}>
                                      {conv.unreadCount}
                                    </div>
                                  )}
                                </div>
                              </div>
                            );
                          })
                        )}
                      </div>
                    </div>

                    {/* Right Panel - Conversation Thread */}
                    {!isMobile && (
                      <div style={{
                        flex: 1,
                        display: 'flex',
                        flexDirection: 'column',
                        background: 'white'
                      }}>
                        {selectedConversation ? (
                          <>
                            {/* Conversation Header */}
                            <div style={{
                              padding: '20px',
                              borderBottom: '1px solid #e5e7eb',
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center'
                            }}>
                              <div>
                                <h2 style={{ fontSize: '20px', fontWeight: 600, margin: 0, marginBottom: 4 }}>
                                  {selectedConversation.tenant?.name || selectedConversation.phone}
                                </h2>
                                <p style={{ fontSize: '14px', color: '#6b7280', margin: 0 }}>
                                  {selectedConversation.tenant?.phone || selectedConversation.phone}
                                </p>
                              </div>
                              {selectedConversation.tenant && (
                                <button
                                  onClick={() => {
                                    // Create maintenance request from conversation
                                    setShowAddMaintenanceModal(true);
                                    setNewMaintenanceRequest({
                                      tenantId: selectedConversation.tenant.id,
                                      tenantName: selectedConversation.tenant.name,
                                      issue: 'Maintenance Request',
                                      description: selectedConversation.messages
                                        .filter(m => m.direction === 'inbound')
                                        .map(m => m.message)
                                        .join('\n\n'),
                                      status: 'open',
                                      priority: 'medium'
                                    });
                                  }}
                                  className="btn btn-secondary"
                                  style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: 6
                                  }}
                                >
                                  ð§ Create Request
                                </button>
                              )}
                            </div>

                            {/* Messages */}
                            <div style={{
                              flex: 1,
                              overflowY: 'auto',
                              padding: '20px',
                              display: 'flex',
                              flexDirection: 'column',
                              gap: 12
                            }}>
                              {[...selectedConversation.messages]
                                .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
                                .map(msg => {
                                  const isOutbound = msg.direction === 'outbound';
                                  return (
                                    <div
                                      key={msg.id}
                                      style={{
                                        display: 'flex',
                                        justifyContent: isOutbound ? 'flex-end' : 'flex-start',
                                        width: '100%'
                                      }}
                                    >
                                      <div style={{
                                        maxWidth: '70%',
                                        padding: '12px 16px',
                                        borderRadius: 18,
                                        background: isOutbound ? '#1a73e8' : '#f3f4f6',
                                        color: isOutbound ? 'white' : '#111827',
                                        fontSize: 14,
                                        lineHeight: 1.5,
                                        wordWrap: 'break-word'
                                      }}>
                                        <p style={{ margin: 0, whiteSpace: 'pre-wrap' }}>{msg.message}</p>
                                        <span style={{
                                          fontSize: 11,
                                          opacity: 0.7,
                                          marginTop: 4,
                                          display: 'block'
                                        }}>
                                          {new Date(msg.created_at).toLocaleTimeString('en-US', {
                                            hour: 'numeric',
                                            minute: '2-digit'
                                          })}
                                        </span>
                                      </div>
                                    </div>
                                  );
                                })}
                            </div>

                            {/* Message Input */}
                            <div style={{
                              padding: '16px 20px',
                              borderTop: '1px solid #e5e7eb',
                              display: 'flex',
                              gap: 8
                            }}>
                              <input
                                type="text"
                                value={newMessage}
                                onChange={(e) => setNewMessage(e.target.value)}
                                onKeyPress={(e) => {
                                  if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    sendSms(selectedConversation.phone, newMessage);
                                  }
                                }}
                                placeholder="Type a message..."
                                style={{
                                  flex: 1,
                                  padding: '12px 16px',
                                  border: '1px solid #e5e7eb',
                                  borderRadius: 20,
                                  fontSize: 14,
                                  outline: 'none'
                                }}
                              />
                              <button
                                onClick={() => sendSms(selectedConversation.phone, newMessage)}
                                className="btn btn-primary"
                                style={{
                                  padding: '12px 24px',
                                  borderRadius: 20
                                }}
                              >
                                Send
                              </button>
                            </div>
                          </>
                        ) : (
                          <div style={{
                            flex: 1,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: '#94a3b8'
                          }}>
                            <div style={{ textAlign: 'center' }}>
                              <div style={{ 
                                width: 64, 
                                height: 64, 
                                borderRadius: 16, 
                                background: '#f1f5f9', 
                                display: 'flex', 
                                alignItems: 'center', 
                                justifyContent: 'center',
                                margin: '0 auto 16px'
                              }}>
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="1.5">
                                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                              </div>
                              <p style={{ fontSize: 14, margin: 0 }}>Select a conversation to start messaging</p>
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Schedule Tab */}
              {activeTab === 'schedule' && (
                <div style={{ padding: 24 }}>
                  {/* Header */}
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 24 }}>
                    <div>
                      <h1 style={{ fontSize: 28, fontWeight: 600, color: '#0f172a', marginBottom: 4, margin: 0 }}>Schedule</h1>
                      <p style={{ color: '#64748b', margin: '4px 0 0', fontSize: 14 }}>
                        {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                      </p>
                    </div>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <button 
                        onClick={() => setShowCalendarSync(true)}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 6,
                          padding: '8px 16px',
                          background: 'white',
                          border: '1px solid #e2e8f0',
                          borderRadius: 6,
                          fontSize: 13,
                          fontWeight: 500,
                          color: '#64748b',
                          cursor: 'pointer',
                          transition: 'all 0.15s'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.borderColor = '#94a3b8';
                          e.currentTarget.style.color = '#0f172a';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.borderColor = '#e2e8f0';
                          e.currentTarget.style.color = '#64748b';
                        }}
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        Sync Calendar
                      </button>
                      <button 
                        onClick={() => setShowAddEventModal(true)}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 6,
                          padding: '8px 16px',
                          background: '#0f172a',
                          border: 'none',
                          borderRadius: 6,
                          fontSize: 13,
                          fontWeight: 500,
                          color: 'white',
                          cursor: 'pointer',
                          transition: 'all 0.15s'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.background = '#1e293b'}
                        onMouseLeave={(e) => e.currentTarget.style.background = '#0f172a'}
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <line x1="12" y1="5" x2="12" y2="19"></line>
                          <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Event
                      </button>
                    </div>
                  </div>
                  
                  {/* Quick Stats Bar */}
                  <div style={{ 
                    display: 'flex', 
                    gap: 24, 
                    marginBottom: 24, 
                    padding: '16px 20px',
                    background: '#f8fafc',
                    borderRadius: 8,
                    border: '1px solid #e2e8f0'
                  }}>
                    {(() => {
                      const todayCount = getTodayEvents().length;
                      const thisWeekMoveIns = getUpcomingMoveIns().filter(e => {
                        const eventDate = new Date(e.date);
                        const weekFromNow = new Date();
                        weekFromNow.setDate(weekFromNow.getDate() + 7);
                        return eventDate <= weekFromNow;
                      }).length;
                      const expiringLeases = getExpiringLeases().filter(t => {
                        const daysUntil = Math.ceil((new Date(t.leaseEnd || t.lease_end) - new Date()) / (1000 * 60 * 60 * 24));
                        return daysUntil <= 30;
                      }).length;
                      const pendingMaintenance = maintenanceRequests.filter(r => {
                        const status = (r.status || 'open').toLowerCase();
                        return status === 'open' && r.scheduled_date;
                      }).length;
                      
                      return (
                        <>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                            <div style={{ 
                              width: 40, height: 40, borderRadius: 8, background: todayCount > 0 ? '#dbeafe' : '#f1f5f9',
                              display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>
                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={todayCount > 0 ? '#3b82f6' : '#64748b'} strokeWidth="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                              </svg>
                            </div>
                            <div>
                              <div style={{ fontSize: 20, fontWeight: 600, color: '#0f172a' }}>{todayCount}</div>
                              <div style={{ fontSize: 12, color: '#64748b' }}>Today</div>
                            </div>
                          </div>
                          <div style={{ width: 1, background: '#e2e8f0' }}></div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                            <div style={{ 
                              width: 40, height: 40, borderRadius: 8, background: thisWeekMoveIns > 0 ? '#dcfce7' : '#f1f5f9',
                              display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>
                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={thisWeekMoveIns > 0 ? '#16a34a' : '#64748b'} strokeWidth="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                              </svg>
                            </div>
                            <div>
                              <div style={{ fontSize: 20, fontWeight: 600, color: '#0f172a' }}>{thisWeekMoveIns}</div>
                              <div style={{ fontSize: 12, color: '#64748b' }}>Move-ins this week</div>
                            </div>
                          </div>
                          <div style={{ width: 1, background: '#e2e8f0' }}></div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                            <div style={{ 
                              width: 40, height: 40, borderRadius: 8, background: expiringLeases > 0 ? '#fef3c7' : '#f1f5f9',
                              display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>
                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={expiringLeases > 0 ? '#d97706' : '#64748b'} strokeWidth="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                              </svg>
                            </div>
                            <div>
                              <div style={{ fontSize: 20, fontWeight: 600, color: expiringLeases > 0 ? '#d97706' : '#0f172a' }}>{expiringLeases}</div>
                              <div style={{ fontSize: 12, color: '#64748b' }}>Leases expiring soon</div>
                            </div>
                          </div>
                        </>
                      );
                    })()}
                  </div>
                  
                  {/* Main Content - Timeline + Calendar */}
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 340px', gap: 24 }}>
                    
                    {/* Left - Unified Timeline */}
                    <div>
                      {/* Needs Action Section */}
                      {(() => {
                        const needsAction = [
                          ...getExpiringLeases().filter(t => {
                            const daysUntil = Math.ceil((new Date(t.leaseEnd || t.lease_end) - new Date()) / (1000 * 60 * 60 * 24));
                            return daysUntil <= 14;
                          }).map(t => ({
                            type: 'lease-action',
                            title: `Renewal needed: ${t.name}`,
                            subtitle: `Lease expires in ${Math.ceil((new Date(t.leaseEnd || t.lease_end) - new Date()) / (1000 * 60 * 60 * 24))} days`,
                            property: t.property,
                            unit: t.unit,
                            tenant: t,
                            urgent: Math.ceil((new Date(t.leaseEnd || t.lease_end) - new Date()) / (1000 * 60 * 60 * 24)) <= 7
                          })),
                          ...getTodayEvents().map(e => ({
                            type: 'today',
                            title: e.title,
                            subtitle: e.time || 'All day',
                            event: e
                          }))
                        ];
                        
                        if (needsAction.length === 0) return null;
                        
                        return (
                          <div style={{ marginBottom: 24 }}>
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: 8, 
                              marginBottom: 12 
                            }}>
                              <div style={{ 
                                width: 8, height: 8, borderRadius: '50%', 
                                background: '#ef4444',
                                animation: 'pulse 2s infinite'
                              }}></div>
                              <h3 style={{ fontSize: 13, fontWeight: 600, color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.5px', margin: 0 }}>
                                Needs Action ({needsAction.length})
                              </h3>
                            </div>
                            <div style={{ 
                              background: 'white', 
                              borderRadius: 8, 
                              border: '1px solid #e2e8f0',
                              overflow: 'hidden'
                            }}>
                              {needsAction.map((item, i) => (
                                <div 
                                  key={i}
                                  style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    padding: '14px 16px',
                                    borderBottom: i < needsAction.length - 1 ? '1px solid #f1f5f9' : 'none',
                                    borderLeft: `3px solid ${item.urgent ? '#ef4444' : '#f59e0b'}`,
                                    gap: 12,
                                    cursor: 'pointer',
                                    transition: 'background 0.15s'
                                  }}
                                  onMouseEnter={(e) => e.currentTarget.style.background = '#f8fafc'}
                                  onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                                  onClick={() => {
                                    if (item.tenant) {
                                      setSelectedTenant(item.tenant);
                                      setActiveTab('tenants');
                                    }
                                  }}
                                >
                                  <div style={{ flex: 1 }}>
                                    <div style={{ fontSize: 14, fontWeight: 500, color: '#0f172a', marginBottom: 2 }}>
                                      {item.title}
                                    </div>
                                    <div style={{ fontSize: 12, color: '#64748b' }}>
                                      {item.subtitle} {item.property && `Â· ${item.property}`}
                                    </div>
                                  </div>
                                  <div style={{ display: 'flex', gap: 6 }}>
                                    {item.tenant?.phone && (
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          window.location.href = `tel:${item.tenant.phone}`;
                                        }}
                                        style={{
                                          width: 32, height: 32, borderRadius: 6,
                                          background: '#f1f5f9', border: 'none',
                                          display: 'flex', alignItems: 'center', justifyContent: 'center',
                                          cursor: 'pointer', transition: 'all 0.15s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.background = '#e2e8f0'}
                                        onMouseLeave={(e) => e.currentTarget.style.background = '#f1f5f9'}
                                        title="Call"
                                      >
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                        </svg>
                                      </button>
                                    )}
                                    {item.tenant?.email && (
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          window.location.href = `mailto:${item.tenant.email}`;
                                        }}
                                        style={{
                                          width: 32, height: 32, borderRadius: 6,
                                          background: '#f1f5f9', border: 'none',
                                          display: 'flex', alignItems: 'center', justifyContent: 'center',
                                          cursor: 'pointer', transition: 'all 0.15s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.background = '#e2e8f0'}
                                        onMouseLeave={(e) => e.currentTarget.style.background = '#f1f5f9'}
                                        title="Email"
                                      >
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                          <polyline points="22,6 12,13 2,6"></polyline>
                                        </svg>
                                      </button>
                                    )}
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2">
                                      <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })()}
                      
                      {/* This Week Timeline */}
                      <div style={{ marginBottom: 24 }}>
                        <h3 style={{ fontSize: 13, fontWeight: 600, color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: 12, margin: '0 0 12px' }}>
                          This Week
                        </h3>
                        <div style={{ 
                          background: 'white', 
                          borderRadius: 8, 
                          border: '1px solid #e2e8f0',
                          overflow: 'hidden'
                        }}>
                          {(() => {
                            // Get next 7 days
                            const days = [];
                            for (let i = 0; i < 7; i++) {
                              const date = new Date();
                              date.setDate(date.getDate() + i);
                              const dayEvents = getAllEventsForDate(date);
                              days.push({ date, events: dayEvents });
                            }
                            
                            const hasAnyEvents = days.some(d => d.events.length > 0);
                            
                            if (!hasAnyEvents) {
                              return (
                                <div style={{ padding: 40, textAlign: 'center', color: '#94a3b8' }}>
                                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ margin: '0 auto 12px' }}>
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                  </svg>
                                  <p style={{ fontSize: 14, margin: 0 }}>No events scheduled this week</p>
                                </div>
                              );
                            }
                            
                            return days.map((day, dayIndex) => {
                              if (day.events.length === 0) return null;
                              const isToday = day.date.toDateString() === new Date().toDateString();
                              
                              return (
                                <div key={dayIndex}>
                                  {/* Day Header */}
                                  <div style={{
                                    padding: '10px 16px',
                                    background: isToday ? '#f0f9ff' : '#f8fafc',
                                    borderBottom: '1px solid #e2e8f0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: 8
                                  }}>
                                    {isToday && (
                                      <div style={{ width: 6, height: 6, borderRadius: '50%', background: '#3b82f6' }}></div>
                                    )}
                                    <span style={{ 
                                      fontSize: 12, 
                                      fontWeight: 600, 
                                      color: isToday ? '#0369a1' : '#64748b'
                                    }}>
                                      {isToday ? 'Today' : day.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                                    </span>
                                    <span style={{ fontSize: 11, color: '#94a3b8' }}>
                                      {day.events.length} event{day.events.length !== 1 ? 's' : ''}
                                    </span>
                                  </div>
                                  
                                  {/* Day Events */}
                                  {day.events.map((event, eventIndex) => (
                                    <div
                                      key={eventIndex}
                                      style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        padding: '12px 16px',
                                        borderBottom: '1px solid #f1f5f9',
                                        borderLeft: `3px solid ${
                                          event.type === 'move-in' ? '#10b981' :
                                          event.type === 'move-out' ? '#ef4444' :
                                          event.type === 'maintenance' ? '#f59e0b' :
                                          event.type === 'lease-expiration' ? '#f59e0b' : '#94a3b8'
                                        }`,
                                        gap: 12,
                                        cursor: 'pointer',
                                        transition: 'background 0.15s'
                                      }}
                                      onMouseEnter={(e) => e.currentTarget.style.background = '#fafafa'}
                                      onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                                    >
                                      <div style={{
                                        width: 36, height: 36, borderRadius: 8,
                                        background: '#f1f5f9',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        flexShrink: 0
                                      }}>
                                        {event.type === 'move-in' && (
                                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2">
                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                          </svg>
                                        )}
                                        {event.type === 'move-out' && (
                                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth="2">
                                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                            <polyline points="16 17 21 12 16 7"></polyline>
                                            <line x1="21" y1="12" x2="9" y2="12"></line>
                                          </svg>
                                        )}
                                        {event.type === 'maintenance' && (
                                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2">
                                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                                          </svg>
                                        )}
                                        {!['move-in', 'move-out', 'maintenance'].includes(event.type) && (
                                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                          </svg>
                                        )}
                                      </div>
                                      <div style={{ flex: 1, minWidth: 0 }}>
                                        <div style={{ fontSize: 14, fontWeight: 500, color: '#0f172a', marginBottom: 2 }}>
                                          {event.title}
                                        </div>
                                        <div style={{ fontSize: 12, color: '#64748b' }}>
                                          {event.time && `${event.time} Â· `}
                                          {event.property || event.location || ''}
                                        </div>
                                      </div>
                                      <span style={{
                                        fontSize: 11,
                                        padding: '3px 8px',
                                        borderRadius: 4,
                                        background: event.type === 'move-in' ? '#dcfce7' :
                                                   event.type === 'move-out' ? '#fef2f2' :
                                                   event.type === 'maintenance' ? '#fef3c7' : '#f1f5f9',
                                        color: event.type === 'move-in' ? '#16a34a' :
                                              event.type === 'move-out' ? '#dc2626' :
                                              event.type === 'maintenance' ? '#d97706' : '#64748b',
                                        fontWeight: 500,
                                        textTransform: 'capitalize'
                                      }}>
                                        {event.type?.replace('-', ' ') || 'Event'}
                                      </span>
                                    </div>
                                  ))}
                                </div>
                              );
                            });
                          })()}
                        </div>
                      </div>
                      
                      {/* Upcoming Move-Ins/Outs Combined */}
                      <div style={{ marginBottom: 24 }}>
                        <h3 style={{ fontSize: 13, fontWeight: 600, color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: 12, margin: '0 0 12px' }}>
                          Upcoming Transitions
                        </h3>
                        <div style={{ 
                          background: 'white', 
                          borderRadius: 8, 
                          border: '1px solid #e2e8f0',
                          overflow: 'hidden'
                        }}>
                          {(() => {
                            const moveIns = getUpcomingMoveIns();
                            const moveOuts = getUpcomingMoveOuts();
                            const combined = [...moveIns, ...moveOuts]
                              .sort((a, b) => new Date(a.date) - new Date(b.date))
                              .slice(0, 8);
                            
                            if (combined.length === 0) {
                              return (
                                <div style={{ padding: 40, textAlign: 'center', color: '#94a3b8' }}>
                                  <p style={{ fontSize: 14, margin: 0 }}>No upcoming move-ins or move-outs</p>
                                </div>
                              );
                            }
                            
                            return combined.map((event, i) => (
                              <div
                                key={i}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  padding: '12px 16px',
                                  borderBottom: i < combined.length - 1 ? '1px solid #f1f5f9' : 'none',
                                  borderLeft: `3px solid ${event.type === 'move-in' ? '#10b981' : '#ef4444'}`,
                                  gap: 12,
                                  cursor: 'pointer',
                                  transition: 'background 0.15s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = '#fafafa'}
                                onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                              >
                                <div style={{ flex: 1 }}>
                                  <div style={{ fontSize: 14, fontWeight: 500, color: '#0f172a', marginBottom: 2 }}>
                                    {event.title}
                                  </div>
                                  <div style={{ fontSize: 12, color: '#64748b' }}>
                                    {event.property}
                                  </div>
                                </div>
                                <div style={{ textAlign: 'right' }}>
                                  <div style={{ fontSize: 13, fontWeight: 500, color: '#0f172a' }}>
                                    {new Date(event.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                  </div>
                                  <div style={{ 
                                    fontSize: 11, 
                                    color: event.type === 'move-in' ? '#16a34a' : '#dc2626'
                                  }}>
                                    {event.type === 'move-in' ? 'Move-in' : 'Move-out'}
                                  </div>
                                </div>
                              </div>
                            ));
                          })()}
                        </div>
                      </div>
                    </div>
                    
                    {/* Right Column - Mini Calendar + Quick Add */}
                    <div>
                      {/* Mini Calendar */}
                      <div style={{ 
                        background: 'white', 
                        borderRadius: 8, 
                        border: '1px solid #e2e8f0', 
                        padding: 20, 
                        marginBottom: 20 
                      }}>
                        {/* Calendar Header */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                          <button 
                            type="button"
                            onClick={() => {
                              const newDate = new Date(calendarDate);
                              newDate.setMonth(newDate.getMonth() - 1);
                              setCalendarDate(newDate);
                            }}
                            style={{ 
                              background: 'none', 
                              border: '1px solid #e2e8f0', 
                              borderRadius: 6,
                              cursor: 'pointer', 
                              width: 28, height: 28,
                              display: 'flex', alignItems: 'center', justifyContent: 'center',
                              color: '#64748b'
                            }}
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                          </button>
                          <h3 style={{ fontSize: 14, fontWeight: 600, margin: 0, color: '#0f172a' }}>
                            {calendarDate.toLocaleString('default', { month: 'long', year: 'numeric' })}
                          </h3>
                          <button 
                            type="button"
                            onClick={() => {
                              const newDate = new Date(calendarDate);
                              newDate.setMonth(newDate.getMonth() + 1);
                              setCalendarDate(newDate);
                            }}
                            style={{ 
                              background: 'none', 
                              border: '1px solid #e2e8f0', 
                              borderRadius: 6,
                              cursor: 'pointer', 
                              width: 28, height: 28,
                              display: 'flex', alignItems: 'center', justifyContent: 'center',
                              color: '#64748b'
                            }}
                          >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                          </button>
                        </div>
                        
                        {/* Day Headers */}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', textAlign: 'center', marginBottom: 8 }}>
                          {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(day => (
                            <div key={day} style={{ fontSize: 11, fontWeight: 500, color: '#94a3b8', padding: 4 }}>
                              {day}
                            </div>
                          ))}
                        </div>
                        
                        {/* Calendar Grid */}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 2 }}>
                          {generateCalendarDays(calendarDate).map((day, i) => {
                            const isToday = day?.toDateString() === new Date().toDateString();
                            const isSelected = day?.toDateString() === selectedCalendarDate?.toDateString();
                            const dayEvents = day ? getAllEventsForDate(day) : [];
                            const hasEvents = dayEvents.length > 0;
                            
                            return (
                              <div
                                key={i}
                                onClick={() => day && setSelectedCalendarDate(day)}
                                style={{
                                  aspectRatio: '1',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  borderRadius: 6,
                                  cursor: day ? 'pointer' : 'default',
                                  background: isSelected ? '#0f172a' : isToday ? '#f1f5f9' : 'transparent',
                                  color: isSelected ? 'white' : !day ? '#d1d5db' : '#0f172a',
                                  fontWeight: isToday || isSelected ? 600 : 400,
                                  fontSize: 13,
                                  position: 'relative',
                                  transition: 'all 0.15s'
                                }}
                              >
                                {day?.getDate()}
                                {hasEvents && !isSelected && (
                                  <div style={{
                                    position: 'absolute',
                                    bottom: 3,
                                    width: 4,
                                    height: 4,
                                    borderRadius: '50%',
                                    background: '#3b82f6'
                                  }} />
                                )}
                              </div>
                            );
                          })}
                        </div>
                      </div>
                      
                      {/* Selected Day Events */}
                      {selectedCalendarDate && (
                        <div style={{ 
                          background: 'white', 
                          borderRadius: 8, 
                          border: '1px solid #e2e8f0', 
                          padding: 16, 
                          marginBottom: 20 
                        }}>
                          <div style={{ 
                            fontSize: 13, 
                            fontWeight: 600, 
                            color: '#0f172a', 
                            marginBottom: 12,
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                          }}>
                            <span>{selectedCalendarDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</span>
                          </div>
                          {getAllEventsForDate(selectedCalendarDate).length > 0 ? (
                            getAllEventsForDate(selectedCalendarDate).map((event, i) => (
                              <div key={i} style={{
                                padding: '10px 12px',
                                background: '#f8fafc',
                                borderRadius: 6,
                                marginBottom: 8,
                                borderLeft: `3px solid ${
                                  event.type === 'move-in' ? '#10b981' :
                                  event.type === 'move-out' ? '#ef4444' : '#64748b'
                                }`
                              }}>
                                <div style={{ fontSize: 13, fontWeight: 500, color: '#0f172a' }}>{event.title}</div>
                                <div style={{ fontSize: 12, color: '#64748b' }}>{event.time || event.property || ''}</div>
                              </div>
                            ))
                          ) : (
                            <p style={{ color: '#94a3b8', fontSize: 13, margin: 0 }}>No events</p>
                          )}
                          <button
                            type="button"
                            onClick={() => {
                              setNewEvent({ ...newEvent, date: selectedCalendarDate.toISOString().split('T')[0] });
                              setShowAddEventModal(true);
                            }}
                            style={{
                              width: '100%',
                              padding: '8px',
                              background: '#f8fafc',
                              border: '1px dashed #e2e8f0',
                              borderRadius: 6,
                              fontSize: 12,
                              color: '#64748b',
                              cursor: 'pointer',
                              marginTop: 8,
                              transition: 'all 0.15s'
                            }}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.borderColor = '#94a3b8';
                              e.currentTarget.style.color = '#0f172a';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.borderColor = '#e2e8f0';
                              e.currentTarget.style.color = '#64748b';
                            }}
                          >
                            + Add event
                          </button>
                        </div>
                      )}
                      
                      {/* Lease Expirations Quick List */}
                      <div style={{ 
                        background: 'white', 
                        borderRadius: 8, 
                        border: '1px solid #e2e8f0', 
                        padding: 16 
                      }}>
                        <div style={{ 
                          fontSize: 13, 
                          fontWeight: 600, 
                          color: '#0f172a', 
                          marginBottom: 12,
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center'
                        }}>
                          <span>Lease Expirations</span>
                          <span style={{ fontSize: 11, color: '#64748b', fontWeight: 400 }}>Next 90 days</span>
                        </div>
                        {getExpiringLeases().length > 0 ? (
                          getExpiringLeases().slice(0, 5).map((tenant, i) => {
                            const daysUntil = Math.ceil((new Date(tenant.leaseEnd || tenant.lease_end) - new Date()) / (1000 * 60 * 60 * 24));
                            return (
                              <div 
                                key={i}
                                onClick={() => {
                                  setSelectedTenant(tenant);
                                  setActiveTab('tenants');
                                }}
                                style={{
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center',
                                  padding: '8px 0',
                                  borderBottom: i < Math.min(getExpiringLeases().length, 5) - 1 ? '1px solid #f1f5f9' : 'none',
                                  cursor: 'pointer'
                                }}
                              >
                                <div>
                                  <div style={{ fontSize: 13, fontWeight: 500, color: '#0f172a' }}>{tenant.name}</div>
                                  <div style={{ fontSize: 11, color: '#64748b' }}>Unit {tenant.unit || 'N/A'}</div>
                                </div>
                                <span style={{ 
                                  fontSize: 12, 
                                  fontWeight: 500,
                                  color: daysUntil <= 14 ? '#dc2626' : daysUntil <= 30 ? '#d97706' : '#64748b'
                                }}>
                                  {daysUntil}d
                                </span>
                              </div>
                            );
                          })
                        ) : (
                          <p style={{ color: '#94a3b8', fontSize: 13, margin: 0 }}>No upcoming expirations</p>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {activeTab === 'settings' && (
                <div className="content-section">
                  {/* Header */}
                  <div style={{ marginBottom: '24px' }}>
                    <h1 style={{ fontSize: '32px', fontWeight: '400', color: '#202124', margin: '0 0 8px 0' }}>Settings</h1>
                    <p style={{ fontSize: '14px', color: '#5f6368', margin: 0 }}>Manage your account and application preferences</p>
                  </div>

                  {/* Tab Navigation */}
                  <div style={{ 
                    display: 'flex', 
                    gap: '32px', 
                    borderBottom: '1px solid #dadce0',
                    marginBottom: '32px'
                  }}>
                    {['profile', 'notifications', 'security', 'billing', 'company', 'tags', 'integrations'].map((tab) => (
                      <button
                        key={tab}
                        onClick={() => setSettingsTab(tab)}
                        style={{
                          background: 'none',
                          border: 'none',
                          padding: '12px 0',
                          fontSize: '14px',
                          fontWeight: '500',
                          color: settingsTab === tab ? '#1a73e8' : '#5f6368',
                          cursor: 'pointer',
                          borderBottom: settingsTab === tab ? '2px solid #1a73e8' : '2px solid transparent',
                          marginBottom: '-1px',
                          textTransform: 'capitalize'
                        }}
                      >
                        {tab === 'profile' ? 'Profile' : 
                         tab === 'notifications' ? 'Notifications' :
                         tab === 'security' ? 'Security' :
                         tab === 'billing' ? 'Billing' : 
                         tab === 'company' ? 'Company' : 
                         tab === 'tags' ? 'Tags' :
                         tab === 'integrations' ? 'Integrations' : tab}
                      </button>
                    ))}
                  </div>

                  {/* Tab Content */}
                  <div className="settings-content">
                    {/* Profile Tab */}
                    {settingsTab === 'profile' && (
                      <>
                        {/* Personal Information Section */}
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                          marginBottom: '20px'
                        }}>
                          <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 24px 0' }}>Personal Information</h3>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>First Name</label>
                              <input
                                type="text"
                                value={profileData.firstName}
                                onChange={e => setProfileData({...profileData, firstName: e.target.value})}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                                placeholder="Enter your first name"
                              />
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Last Name</label>
                              <input
                                type="text"
                                value={profileData.lastName}
                                onChange={e => setProfileData({...profileData, lastName: e.target.value})}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                                placeholder="Enter your last name"
                              />
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Email</label>
                              <input
                                type="email"
                                value={profileData.email || (user?.email || '')}
                                onChange={e => setProfileData({...profileData, email: e.target.value})}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                                placeholder="Enter your email"
                              />
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Phone</label>
                              <input
                                type="tel"
                                value={profileData.phone}
                                onChange={e => setProfileData({...profileData, phone: e.target.value})}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                                placeholder="Enter your phone number"
                              />
                            </div>
                            <button
                              className="btn-primary"
                              onClick={() => {
                                // Save profile data
                                alert('Profile saved successfully');
                              }}
                              style={{
                                background: '#1a73e8',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '4px',
                                padding: '10px 24px',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: 'pointer',
                                alignSelf: 'flex-start'
                              }}
                            >
                              Save Changes
                            </button>
                          </div>
                        </div>

                        {/* Profile Picture Section */}
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                        }}>
                          <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 24px 0' }}>Profile Picture</h3>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '24px' }}>
                            <div style={{
                              width: '80px',
                              height: '80px',
                              borderRadius: '50%',
                              background: '#1a73e8',
                              color: '#fff',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '32px',
                              fontWeight: '500'
                            }}>
                              {getInitials(user?.email || 'User')}
                            </div>
                            <div style={{ display: 'flex', gap: '12px' }}>
                              <button
                                className="btn-secondary"
                                style={{
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  padding: '8px 16px',
                                  fontSize: '14px',
                                  fontWeight: '500',
                                  cursor: 'pointer',
                                  background: '#fff'
                                }}
                              >
                                Upload New
                              </button>
                              <button
                                style={{
                                  background: 'none',
                                  border: 'none',
                                  color: '#1a73e8',
                                  fontSize: '14px',
                                  fontWeight: '500',
                                  cursor: 'pointer',
                                  padding: '8px 16px'
                                }}
                              >
                                Remove
                              </button>
                            </div>
                          </div>
                        </div>
                      </>
                    )}

                    {/* Notifications Tab */}
                    {settingsTab === 'notifications' && (
                      <>
                        {/* SMS Notifications Section */}
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                          marginBottom: '20px'
                        }}>
                          <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 8px 0' }}>SMS Notifications</h3>
                          <p style={{ fontSize: '14px', color: '#5f6368', margin: '0 0 24px 0' }}>Configure Twilio to send SMS reminders to tenants</p>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Twilio Account SID</label>
                              <input
                                type="text"
                                value={twilioSettings.accountSid}
                                onChange={e => setTwilioSettings({...twilioSettings, accountSid: e.target.value})}
                                placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                              />
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Twilio Auth Token</label>
                              <input
                                type="password"
                                value={twilioSettings.authToken}
                                onChange={e => setTwilioSettings({...twilioSettings, authToken: e.target.value})}
                                placeholder="Enter your Twilio Auth Token"
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                              />
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Twilio Phone Number</label>
                              <input
                                type="text"
                                value={twilioSettings.phoneNumber}
                                onChange={e => setTwilioSettings({...twilioSettings, phoneNumber: e.target.value})}
                                placeholder="+1234567890"
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                              />
                            </div>
                            <button
                              className="btn-primary"
                              onClick={saveTwilioSettings}
                              disabled={twilioSettingsLoading}
                              style={{
                                background: '#1a73e8',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '4px',
                                padding: '10px 24px',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: 'pointer',
                                alignSelf: 'flex-start',
                                opacity: twilioSettingsLoading ? 0.6 : 1
                              }}
                            >
                              {twilioSettingsLoading ? 'Saving...' : 'Save Settings'}
                            </button>
                          </div>

                          {/* Test SMS */}
                          <div style={{ marginTop: '32px', padding: '20px', background: '#f8f9fa', borderRadius: '8px' }}>
                            <h4 style={{ marginBottom: '16px', fontSize: '14px', fontWeight: '500', color: '#202124' }}>Test SMS</h4>
                            <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-end' }}>
                              <div style={{ flex: 1 }}>
                                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Phone Number</label>
                                <input
                                  type="tel"
                                  value={testSmsPhone}
                                  onChange={e => setTestSmsPhone(e.target.value)}
                                  placeholder="+1234567890"
                                  style={{
                                    width: '100%',
                                    padding: '10px 12px',
                                    border: '1px solid #dadce0',
                                    borderRadius: '4px',
                                    fontSize: '14px',
                                    color: '#202124'
                                  }}
                                />
                              </div>
                              <button
                                className="btn-secondary"
                                onClick={sendTestSMS}
                                disabled={testSmsSending || !testSmsPhone}
                                style={{
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  padding: '10px 24px',
                                  fontSize: '14px',
                                  fontWeight: '500',
                                  cursor: 'pointer',
                                  background: '#fff',
                                  opacity: (testSmsSending || !testSmsPhone) ? 0.6 : 1
                                }}
                              >
                                {testSmsSending ? 'Sending...' : 'Send Test SMS'}
                              </button>
                            </div>
                          </div>
                        </div>

                        {/* Email Notification Preferences */}
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                        }}>
                          <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 24px 0' }}>Email Notification Preferences</h3>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                            {[
                              { key: 'lateRentReminders', label: 'Late Rent Reminders' },
                              { key: 'newTenantAdded', label: 'New Tenant Added' },
                              { key: 'maintenanceRequests', label: 'Maintenance Requests' },
                              { key: 'paymentReceived', label: 'Payment Received' }
                            ].map(pref => (
                              <div key={pref.key} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <label style={{ fontSize: '14px', color: '#202124' }}>{pref.label}</label>
                                <label style={{ position: 'relative', display: 'inline-block', width: '44px', height: '24px' }}>
                                  <input
                                    type="checkbox"
                                    checked={emailNotifications[pref.key]}
                                    onChange={e => setEmailNotifications({...emailNotifications, [pref.key]: e.target.checked})}
                                    style={{ opacity: 0, width: 0, height: 0 }}
                                  />
                                  <span style={{
                                    position: 'absolute',
                                    cursor: 'pointer',
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    backgroundColor: emailNotifications[pref.key] ? '#1a73e8' : '#ccc',
                                    borderRadius: '24px',
                                    transition: '0.3s'
                                  }}>
                                    <span style={{
                                      position: 'absolute',
                                      content: '""',
                                      height: '18px',
                                      width: '18px',
                                      left: emailNotifications[pref.key] ? '22px' : '3px',
                                      bottom: '3px',
                                      backgroundColor: 'white',
                                      borderRadius: '50%',
                                      transition: '0.3s'
                                    }}></span>
                                  </span>
                                </label>
                              </div>
                            ))}
                          </div>
                        </div>
                      </>
                    )}

                    {/* Security Tab */}
                    {settingsTab === 'security' && (
                      <>
                        {/* Change Password Section */}
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                          marginBottom: '20px'
                        }}>
                          <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 24px 0' }}>Change Password</h3>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Current Password</label>
                              <input
                                type="password"
                                value={passwordData.currentPassword}
                                onChange={e => setPasswordData({...passwordData, currentPassword: e.target.value})}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                                placeholder="Enter current password"
                              />
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>New Password</label>
                              <input
                                type="password"
                                value={passwordData.newPassword}
                                onChange={e => setPasswordData({...passwordData, newPassword: e.target.value})}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                                placeholder="Enter new password"
                              />
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Confirm New Password</label>
                              <input
                                type="password"
                                value={passwordData.confirmPassword}
                                onChange={e => setPasswordData({...passwordData, confirmPassword: e.target.value})}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                                placeholder="Confirm new password"
                              />
                            </div>
                            <button
                              className="btn-primary"
                              onClick={() => {
                                if (passwordData.newPassword !== passwordData.confirmPassword) {
                                  alert('Passwords do not match');
                                  return;
                                }
                                alert('Password changed successfully');
                                setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
                              }}
                              style={{
                                background: '#1a73e8',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '4px',
                                padding: '10px 24px',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: 'pointer',
                                alignSelf: 'flex-start'
                              }}
                            >
                              Update Password
                            </button>
                          </div>
                        </div>

                        {/* Two-Factor Authentication Section */}
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                        }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                              <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 4px 0' }}>Two-Factor Authentication</h3>
                              <p style={{ fontSize: '14px', color: '#5f6368', margin: 0 }}>Add an extra layer of security to your account</p>
                            </div>
                            <label style={{ position: 'relative', display: 'inline-block', width: '44px', height: '24px' }}>
                              <input
                                type="checkbox"
                                checked={twoFactorEnabled}
                                onChange={e => setTwoFactorEnabled(e.target.checked)}
                                style={{ opacity: 0, width: 0, height: 0 }}
                              />
                              <span style={{
                                position: 'absolute',
                                cursor: 'pointer',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: twoFactorEnabled ? '#1a73e8' : '#ccc',
                                borderRadius: '24px',
                                transition: '0.3s'
                              }}>
                                <span style={{
                                  position: 'absolute',
                                  content: '""',
                                  height: '18px',
                                  width: '18px',
                                  left: twoFactorEnabled ? '22px' : '3px',
                                  bottom: '3px',
                                  backgroundColor: 'white',
                                  borderRadius: '50%',
                                  transition: '0.3s'
                                }}></span>
                              </span>
                            </label>
                          </div>
                        </div>
                      </>
                    )}

                    {/* Billing Tab */}
                    {settingsTab === 'billing' && (
                      <>
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                          marginBottom: '20px'
                        }}>
                          <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 24px 0' }}>Current Plan</h3>
                          <div style={{ padding: '20px', background: '#f8f9fa', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                              <span style={{ fontSize: '16px', fontWeight: '500', color: '#202124' }}>Pro Plan</span>
                              <span style={{ fontSize: '16px', fontWeight: '500', color: '#1a73e8' }}>$29/month</span>
                            </div>
                            <p style={{ fontSize: '14px', color: '#5f6368', margin: 0 }}>Includes all features and unlimited properties</p>
                          </div>
                        </div>

                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                        }}>
                          <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 24px 0' }}>Payment Method</h3>
                          <div style={{ padding: '20px', background: '#f8f9fa', borderRadius: '8px', marginBottom: '16px' }}>
                            <p style={{ fontSize: '14px', color: '#5f6368', margin: 0 }}>Stripe integration coming soon</p>
                          </div>
                          <button
                            className="btn-secondary"
                            style={{
                              border: '1px solid #dadce0',
                              borderRadius: '4px',
                              padding: '10px 24px',
                              fontSize: '14px',
                              fontWeight: '500',
                              cursor: 'pointer',
                              background: '#fff'
                            }}
                          >
                            Update Payment Method
                          </button>
                        </div>
                      </>
                    )}

                    {/* Company Tab */}
                    {settingsTab === 'company' && (
                      <>
                        {/* Company Information */}
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                          marginBottom: '20px'
                        }}>
                          <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 24px 0' }}>Company Information</h3>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Company Name</label>
                              <input
                                type="text"
                                value={companyData.name}
                                onChange={e => setCompanyData({...companyData, name: e.target.value})}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                                placeholder="Enter company name"
                              />
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Company Address</label>
                              <input
                                type="text"
                                value={companyData.address}
                                onChange={e => setCompanyData({...companyData, address: e.target.value})}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  fontSize: '14px',
                                  color: '#202124'
                                }}
                                placeholder="Enter company address"
                              />
                            </div>
                            <div>
                              <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#202124', marginBottom: '8px' }}>Company Logo</label>
                              <button
                                className="btn-secondary"
                                style={{
                                  border: '1px solid #dadce0',
                                  borderRadius: '4px',
                                  padding: '10px 24px',
                                  fontSize: '14px',
                                  fontWeight: '500',
                                  cursor: 'pointer',
                                  background: '#fff'
                                }}
                              >
                                Upload Logo
                              </button>
                            </div>
                            <button
                              className="btn-primary"
                              onClick={() => alert('Company information saved')}
                              style={{
                                background: '#1a73e8',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '4px',
                                padding: '10px 24px',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: 'pointer',
                                alignSelf: 'flex-start'
                              }}
                            >
                              Save Changes
                            </button>
                          </div>
                        </div>

                        {/* Demo Data Section - Dev Only */}
                        {user?.email === DEV_EMAIL && (
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                          marginBottom: '20px'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2">
                              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: 0 }}>Developer Tools</h3>
                            <span style={{ 
                              background: '#fef3c7', 
                              color: '#92400e', 
                              padding: '2px 8px', 
                              borderRadius: 4, 
                              fontSize: 11, 
                              fontWeight: 600 
                            }}>DEV ONLY</span>
                          </div>
                          
                          {/* Load Demo Data */}
                          <div style={{ 
                            background: '#f0fdf4', 
                            border: '1px solid #bbf7d0', 
                            borderRadius: 8, 
                            padding: 16, 
                            marginBottom: 16 
                          }}>
                            <h4 style={{ fontSize: 14, fontWeight: 600, color: '#166534', margin: '0 0 8px 0' }}>Load Demo Data</h4>
                            <p style={{ fontSize: '13px', color: '#166534', margin: '0 0 12px 0' }}>
                              Load comprehensive sample data for demos. Includes 8 properties, 35 tenants (with late payments), 20 maintenance requests, and 12 months of payment/expense history. Perfect for showcasing all features.
                            </p>
                            <button
                              onClick={loadDemoData}
                              disabled={loading}
                              style={{
                                background: '#16a34a',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '10px 20px',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: loading ? 'not-allowed' : 'pointer',
                                opacity: loading ? 0.6 : 1,
                                display: 'flex',
                                alignItems: 'center',
                                gap: 8
                              }}
                            >
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                              </svg>
                              {loading ? 'Loading...' : 'Load Demo Data'}
                            </button>
                          </div>
                          
                          {/* Clear All Data */}
                          <div style={{ 
                            background: '#fef2f2', 
                            border: '1px solid #fecaca', 
                            borderRadius: 8, 
                            padding: 16 
                          }}>
                            <h4 style={{ fontSize: 14, fontWeight: 600, color: '#991b1b', margin: '0 0 8px 0' }}>Clear All Data</h4>
                            <p style={{ fontSize: '13px', color: '#991b1b', margin: '0 0 12px 0' }}>
                              Permanently delete all properties, tenants, maintenance requests, messages, and payment history. Use for fresh starts before demos. This cannot be undone.
                            </p>
                            <button
                              onClick={clearAllData}
                              disabled={loading}
                              style={{
                                background: '#dc2626',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '10px 20px',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: loading ? 'not-allowed' : 'pointer',
                                opacity: loading ? 0.6 : 1,
                                display: 'flex',
                                alignItems: 'center',
                                gap: 8
                              }}
                            >
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                              </svg>
                              {loading ? 'Clearing...' : 'Clear All Data'}
                            </button>
                          </div>
                        </div>
                        )}

                        {/* Import/Export Section */}
                        <div className="import-section">
                      <div className="import-section-header">
                        <div className="import-section-title">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginRight: '8px' }}>
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                          </svg>
                          <h3>Import Tenants</h3>
                        </div>
                        <button 
                          className="btn-secondary"
                          onClick={() => {
                            const sampleData = [
                              ['Tenant Name', 'Phone Number', 'Email Address', 'Unit', 'Rent Amount', 'Deposit', 'Lease From', 'Lease To', 'Status'],
                              ['John Doe', '555-0101', 'john@example.com', 'Unit 1A', '1200', '1200', '2024-01-01', '2024-12-31', 'current'],
                              ['Jane Smith', '555-0102', 'jane@example.com', 'Unit 2B', '1500', '1500', '2024-02-01', '2025-01-31', 'current']
                            ];
                            const csv = Papa.unparse(sampleData);
                            const blob = new Blob([csv], { type: 'text/csv' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'tenant_import_template.csv';
                            a.click();
                            window.URL.revokeObjectURL(url);
                          }}
                        >
                          Download Sample CSV
                        </button>
                      </div>
                      <p className="section-description">Upload a CSV file to import multiple tenants at once</p>

                      {/* File Upload */}
                      {!tenantCsvFile && (
                        <div 
                          className="csv-upload-area"
                          onDragOver={(e) => {
                            e.preventDefault();
                            e.currentTarget.classList.add('drag-over');
                          }}
                          onDragLeave={(e) => {
                            e.currentTarget.classList.remove('drag-over');
                          }}
                          onDrop={(e) => {
                            e.preventDefault();
                            e.currentTarget.classList.remove('drag-over');
                            const file = e.dataTransfer.files[0];
                            if (file && file.name.endsWith('.csv')) {
                              handleTenantCsvUpload(file);
                            }
                          }}
                        >
                          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginBottom: '16px' }}>
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                          </svg>
                          <p style={{ marginBottom: '16px' }}>Drag and drop CSV file here, or click to browse</p>
                          <input
                            type="file"
                            accept=".csv"
                            onChange={(e) => {
                              const file = e.target.files[0];
                              if (file) {
                                handleTenantCsvUpload(file);
                              }
                            }}
                            style={{ display: 'none' }}
                            id="tenant-csv-input"
                          />
                          <label htmlFor="tenant-csv-input" className="btn-secondary">
                            Select CSV File
                          </label>
                        </div>
                      )}

                      {/* CSV Preview and Mapping */}
                      {tenantCsvPreview && (
                        <div className="csv-preview-section">
                          <div className="preview-header">
                            <h4>CSV Preview (First 5 rows)</h4>
                            <button 
                              className="btn-secondary btn-small"
                              onClick={() => {
                                setTenantCsvFile(null);
                                setTenantCsvData(null);
                                setTenantCsvPreview(null);
                                setTenantColumnMapping({});
                              }}
                            >
                              Clear
                            </button>
                          </div>
                          
                          {/* Column Mapping */}
                          <div className="column-mapping">
                            <h4>Column Mapping</h4>
                            <div className="mapping-grid">
                              {['name', 'phone', 'email', 'property', 'rentAmount', 'securityDeposit', 'leaseStart', 'leaseEnd', 'status'].map(field => (
                                <div key={field} className="mapping-item">
                                  <label>{field === 'rentAmount' ? 'Monthly Rent' : field === 'securityDeposit' ? 'Security Deposit' : field === 'leaseStart' ? 'Lease Start' : field === 'leaseEnd' ? 'Lease End' : field.charAt(0).toUpperCase() + field.slice(1)}</label>
                                  <select
                                    value={tenantColumnMapping[field] || ''}
                                    onChange={(e) => {
                                      setTenantColumnMapping({
                                        ...tenantColumnMapping,
                                        [field]: e.target.value
                                      });
                                    }}
                                  >
                                    <option value="">Select column...</option>
                                    {tenantCsvPreview.headers.map(header => (
                                      <option key={header} value={header}>{header}</option>
                                    ))}
                                  </select>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Preview Table */}
                          <div className="preview-table-container">
                            <table className="preview-table">
                              <thead>
                                <tr>
                                  {tenantCsvPreview.headers.map(header => (
                                    <th key={header}>{header}</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {tenantCsvPreview.rows.slice(0, 5).map((row, idx) => (
                                  <tr key={idx}>
                                    {tenantCsvPreview.headers.map(header => (
                                      <td key={header}>{row[header] || ''}</td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>

                          {/* Import Button */}
                          <div className="import-button-section">
                            <button
                              className="btn-primary"
                              onClick={handleImportTenants}
                              disabled={!Object.values(tenantColumnMapping).some(v => v) || tenantImportProgress}
                            >
                              {tenantImportProgress ? `Importing... ${tenantImportProgress.processed}/${tenantImportProgress.total}` : 'Import Tenants'}
                            </button>
                          </div>

                          {/* Progress Bar */}
                          {tenantImportProgress && (
                            <div className="import-progress">
                              <div className="progress-bar">
                                <div 
                                  className="progress-fill"
                                  style={{ width: `${(tenantImportProgress.processed / tenantImportProgress.total) * 100}%` }}
                                ></div>
                              </div>
                              <div className="progress-stats">
                                <span>Processed: {tenantImportProgress.processed}/{tenantImportProgress.total}</span>
                                <span>Success: {tenantImportProgress.success}</span>
                                <span>Errors: {tenantImportProgress.errors}</span>
                                <span>Duplicates: {tenantImportProgress.duplicates}</span>
                              </div>
                              {tenantImportProgress.complete && (
                                <div className="import-results">
                                  <p className="success-message">
                                    Import complete! {tenantImportProgress.success} tenants imported successfully.
                                    {tenantImportProgress.errors > 0 && ` ${tenantImportProgress.errors} errors.`}
                                    {tenantImportProgress.duplicates > 0 && ` ${tenantImportProgress.duplicates} duplicates skipped.`}
                                  </p>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {/* CSV Import - Properties */}
                    <div className="import-section" style={{ marginTop: '24px' }}>
                      <div className="import-section-header">
                        <div className="import-section-title">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginRight: '8px' }}>
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                          </svg>
                          <h3>Import Properties</h3>
                        </div>
                        <button 
                          className="btn-secondary"
                          onClick={() => {
                            const sampleData = [
                              ['Property Address', 'Type', 'Units', 'Owner', 'Owner Email'],
                              ['123 Main Street', 'Single Family', '1', 'John Owner', 'owner@example.com'],
                              ['456 Oak Avenue', 'Multi-Family', '4', 'Jane Owner', 'jane@example.com']
                            ];
                            const csv = Papa.unparse(sampleData);
                            const blob = new Blob([csv], { type: 'text/csv' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'property_import_template.csv';
                            a.click();
                            window.URL.revokeObjectURL(url);
                          }}
                        >
                          Download Sample CSV
                        </button>
                      </div>
                      <p className="section-description">Upload a CSV file to import multiple properties at once</p>

                      {/* File Upload */}
                      {!propertyCsvFile && (
                        <div 
                          className="csv-upload-area"
                          onDragOver={(e) => {
                            e.preventDefault();
                            e.currentTarget.classList.add('drag-over');
                          }}
                          onDragLeave={(e) => {
                            e.currentTarget.classList.remove('drag-over');
                          }}
                          onDrop={(e) => {
                            e.preventDefault();
                            e.currentTarget.classList.remove('drag-over');
                            const file = e.dataTransfer.files[0];
                            if (file && file.name.endsWith('.csv')) {
                              handlePropertyCsvUpload(file);
                            }
                          }}
                        >
                          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginBottom: '16px' }}>
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                          </svg>
                          <p style={{ marginBottom: '16px' }}>Drag and drop CSV file here, or click to browse</p>
                          <input
                            type="file"
                            accept=".csv"
                            onChange={(e) => {
                              const file = e.target.files[0];
                              if (file) {
                                handlePropertyCsvUpload(file);
                              }
                            }}
                            style={{ display: 'none' }}
                            id="property-csv-input"
                          />
                          <label htmlFor="property-csv-input" className="btn-secondary">
                            Select CSV File
                          </label>
                        </div>
                      )}

                      {/* CSV Preview and Mapping */}
                      {propertyCsvPreview && (
                        <div className="csv-preview-section">
                          <div className="preview-header">
                            <h4>CSV Preview (First 5 rows)</h4>
                            <button 
                              className="btn-secondary btn-small"
                              onClick={() => {
                                setPropertyCsvFile(null);
                                setPropertyCsvData(null);
                                setPropertyCsvPreview(null);
                                setPropertyColumnMapping({});
                              }}
                            >
                              Clear
                            </button>
                          </div>
                          
                          {/* Column Mapping */}
                          <div className="column-mapping">
                            <h4>Column Mapping</h4>
                            <div className="mapping-grid">
                              {['address', 'type', 'units', 'ownerName', 'ownerEmail'].map(field => (
                                <div key={field} className="mapping-item">
                                  <label>{field === 'ownerName' ? 'Owner Name' : field === 'ownerEmail' ? 'Owner Email' : field.charAt(0).toUpperCase() + field.slice(1)}</label>
                                  <select
                                    value={propertyColumnMapping[field] || ''}
                                    onChange={(e) => {
                                      setPropertyColumnMapping({
                                        ...propertyColumnMapping,
                                        [field]: e.target.value
                                      });
                                    }}
                                  >
                                    <option value="">Select column...</option>
                                    {propertyCsvPreview.headers.map(header => (
                                      <option key={header} value={header}>{header}</option>
                                    ))}
                                  </select>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Preview Table */}
                          <div className="preview-table-container">
                            <table className="preview-table">
                              <thead>
                                <tr>
                                  {propertyCsvPreview.headers.map(header => (
                                    <th key={header}>{header}</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {propertyCsvPreview.rows.slice(0, 5).map((row, idx) => (
                                  <tr key={idx}>
                                    {propertyCsvPreview.headers.map(header => (
                                      <td key={header}>{row[header] || ''}</td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>

                          {/* Import Button */}
                          <div className="import-button-section">
                            <button
                              className="btn-primary"
                              onClick={handleImportProperties}
                              disabled={!Object.values(propertyColumnMapping).some(v => v) || propertyImportProgress}
                            >
                              {propertyImportProgress ? `Importing... ${propertyImportProgress.processed}/${propertyImportProgress.total}` : 'Import Properties'}
                            </button>
                          </div>

                          {/* Progress Bar */}
                          {propertyImportProgress && (
                            <div className="import-progress">
                              <div className="progress-bar">
                                <div 
                                  className="progress-fill"
                                  style={{ width: `${(propertyImportProgress.processed / propertyImportProgress.total) * 100}%` }}
                                ></div>
                              </div>
                              <div className="progress-stats">
                                <span>Processed: {propertyImportProgress.processed}/{propertyImportProgress.total}</span>
                                <span>Success: {propertyImportProgress.success}</span>
                                <span>Errors: {propertyImportProgress.errors}</span>
                                <span>Duplicates: {propertyImportProgress.duplicates}</span>
                              </div>
                              {propertyImportProgress.complete && (
                                <div className="import-results">
                                  <p className="success-message">
                                    Import complete! {propertyImportProgress.success} properties imported successfully.
                                    {propertyImportProgress.errors > 0 && ` ${propertyImportProgress.errors} errors.`}
                                    {propertyImportProgress.duplicates > 0 && ` ${propertyImportProgress.duplicates} duplicates skipped.`}
                                  </p>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                      </>
                    )}

                    {/* Tags Tab */}
                    {settingsTab === 'tags' && (
                      <>
                        {/* Tags Header */}
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                          marginBottom: '20px'
                        }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                            <div>
                              <h3 style={{ fontSize: '18px', fontWeight: '500', color: '#202124', margin: '0 0 4px 0' }}>Manage Tags</h3>
                              <p style={{ fontSize: '14px', color: '#5f6368', margin: 0 }}>Create tags to track and categorize records</p>
                            </div>
                            <button
                              className="btn-primary"
                              onClick={() => setShowCreateTagModal(true)}
                              style={{
                                background: '#1a73e8',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '4px',
                                padding: '10px 24px',
                                fontSize: '14px',
                                fontWeight: '500',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}
                            >
                              + Create Tag
                            </button>
                          </div>

                          {/* Tags Grid */}
                          <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(3, 1fr)',
                            gap: '16px',
                            marginTop: '24px'
                          }}>
                            {tags.map(tag => {
                              const recordCount = getTagRecordCount(tag.id);
                              const colorMap = {
                                blue: '#1a73e8',
                                green: '#10b981',
                                yellow: '#fbbf24',
                                orange: '#f97316',
                                red: '#ef4444',
                                purple: '#a855f7',
                                teal: '#14b8a6',
                                gray: '#6b7280'
                              };
                              const tagColor = colorMap[tag.color] || colorMap.blue;

                              return (
                                <div
                                  key={tag.id}
                                  style={{
                                    background: '#f8f9fa',
                                    border: '1px solid #e5e7eb',
                                    borderRadius: '8px',
                                    padding: '16px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'space-between',
                                    gap: '12px'
                                  }}
                                >
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1, minWidth: 0 }}>
                                    <div
                                      style={{
                                        background: tagColor,
                                        color: '#fff',
                                        padding: '4px 12px',
                                        borderRadius: '16px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        whiteSpace: 'nowrap',
                                        flexShrink: 0
                                      }}
                                    >
                                      {tag.name}
                                    </div>
                                    <span style={{ fontSize: '14px', color: '#5f6368', whiteSpace: 'nowrap' }}>
                                      ({recordCount})
                                    </span>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (confirm(`Are you sure you want to delete the tag "${tag.name}"? This will remove it from all records.`)) {
                                        try {
                                          await deleteTag(tag.id);
                                        } catch (error) {
                                          // Error already handled in deleteTag
                                        }
                                      }
                                    }}
                                    style={{
                                      background: 'none',
                                      border: 'none',
                                      color: '#ef4444',
                                      cursor: 'pointer',
                                      padding: '4px',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      borderRadius: '4px',
                                      flexShrink: 0
                                    }}
                                    onMouseEnter={(e) => e.target.style.background = 'rgba(239, 68, 68, 0.1)'}
                                    onMouseLeave={(e) => e.target.style.background = 'none'}
                                    title="Delete tag"
                                    aria-label="Delete tag"
                                  >
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                      <line x1="18" y1="6" x2="6" y2="18"></line>
                                      <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                  </button>
                                </div>
                              );
                            })}
                          </div>

                          {tags.length === 0 && (
                            <div style={{ textAlign: 'center', padding: '40px', color: '#5f6368' }}>
                              <p>No tags yet. Create your first tag to get started.</p>
                            </div>
                          )}
                        </div>
                      </>
                    )}

                    {/* Integrations Tab */}
                    {settingsTab === 'integrations' && (
                      <>
                        <div style={{
                          background: '#fff',
                          border: '1px solid #dadce0',
                          borderRadius: '12px',
                          padding: '24px',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                          marginBottom: '20px'
                        }}>
                          <h2 style={{ fontSize: 20, fontWeight: 600, marginBottom: 8 }}>Integrations</h2>
                          <p style={{ color: '#6b7280', marginBottom: 24, margin: '0 0 24px' }}>Connect Propli with your favorite apps</p>
                          
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16 }}>
                            {/* Accounting */}
                            <div
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'default'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>ð°</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>QuickBooks</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Coming Soon
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Sync income, expenses, and invoices</p>
                                </div>
                              </div>
                            </div>
                            
                            <div
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'default'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>ð</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>Xero</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Coming Soon
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Accounting and bookkeeping</p>
                                </div>
                              </div>
                            </div>
                            
                            {/* Communication */}
                            <div
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'default'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>ð§</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>Gmail</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Coming Soon
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Send emails directly from Propli</p>
                                </div>
                              </div>
                            </div>
                            
                            <div
                              onClick={() => setShowTwilioSetup && setShowTwilioSetup(true)}
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.borderColor = '#1a73e8';
                                e.currentTarget.style.boxShadow = '0 2px 8px rgba(26, 115, 232, 0.1)';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.borderColor = '#e5e7eb';
                                e.currentTarget.style.boxShadow = 'none';
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>ð±</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>Twilio SMS</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Available
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Two-way text messaging with tenants</p>
                                </div>
                              </div>
                            </div>
                            
                            {/* Calendar */}
                            <div
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'default'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>ð</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>Google Calendar</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Coming Soon
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Sync events and appointments</p>
                                </div>
                              </div>
                            </div>
                            
                            <div
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'default'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>ð</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>Outlook Calendar</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Coming Soon
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Sync with Microsoft 365</p>
                                </div>
                              </div>
                            </div>
                            
                            {/* Payments */}
                            <div
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'default'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>ð³</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>Stripe</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Coming Soon
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Accept online rent payments</p>
                                </div>
                              </div>
                            </div>
                            
                            <div
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'default'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>ð¦</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>Plaid</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Coming Soon
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Bank account verification</p>
                                </div>
                              </div>
                            </div>
                            
                            {/* Automation */}
                            <div
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'default'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>â¡</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>Zapier</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Coming Soon
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Connect 5,000+ apps</p>
                                </div>
                              </div>
                            </div>
                            
                            <div
                              style={{
                                padding: 20,
                                background: 'white',
                                borderRadius: 12,
                                border: '1px solid #e5e7eb',
                                cursor: 'default'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'flex-start', gap: 16 }}>
                                <span style={{ fontSize: 32 }}>ð</span>
                                <div style={{ flex: 1 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                                    <h4 style={{ fontWeight: 600, margin: 0 }}>Webhooks</h4>
                                    <span style={{ fontSize: 11, padding: '2px 8px', background: '#f3f4f6', color: '#6b7280', borderRadius: 12 }}>
                                      Coming Soon
                                    </span>
                                  </div>
                                  <p style={{ fontSize: 14, color: '#6b7280', margin: 0 }}>Custom API integrations</p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                </div>
              )}

              {/* Old Settings sections removed - now in tabs above */}
              {false && activeTab === 'settings' && (
                <div className="content-section">
                  {/* This section is intentionally disabled - content moved to tabs */}
                  <div className="settings-content">
                    {/* CSV Import - Properties */}
                    <div className="import-section" style={{ marginTop: '24px' }}>
                      <div className="import-section-header">
                        <div className="import-section-title">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginRight: '8px' }}>
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                          </svg>
                          <h3>Import Properties</h3>
                        </div>
                        <button 
                          className="btn-secondary"
                          onClick={() => {
                            const sampleData = [
                              ['Property Address', 'Type', 'Units', 'Owner', 'Owner Email'],
                              ['123 Main Street', 'Single Family', '1', 'John Owner', 'owner@example.com'],
                              ['456 Oak Avenue', 'Multi-Family', '4', 'Jane Owner', 'jane@example.com']
                            ];
                            const csv = Papa.unparse(sampleData);
                            const blob = new Blob([csv], { type: 'text/csv' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'property_import_template.csv';
                            a.click();
                            window.URL.revokeObjectURL(url);
                          }}
                        >
                          Download Sample CSV
                        </button>
                      </div>
                      <p className="section-description">Upload a CSV file to import multiple properties at once</p>

                      {/* File Upload */}
                      {!propertyCsvFile && (
                        <div 
                          className="csv-upload-area"
                          onDragOver={(e) => {
                            e.preventDefault();
                            e.currentTarget.classList.add('drag-over');
                          }}
                          onDragLeave={(e) => {
                            e.currentTarget.classList.remove('drag-over');
                          }}
                          onDrop={(e) => {
                            e.preventDefault();
                            e.currentTarget.classList.remove('drag-over');
                            const file = e.dataTransfer.files[0];
                            if (file && file.name.endsWith('.csv')) {
                              handlePropertyCsvUpload(file);
                            }
                          }}
                        >
                          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginBottom: '16px' }}>
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                          </svg>
                          <p style={{ marginBottom: '16px' }}>Drag and drop CSV file here, or click to browse</p>
                          <input
                            type="file"
                            accept=".csv"
                            onChange={(e) => {
                              const file = e.target.files[0];
                              if (file) {
                                handlePropertyCsvUpload(file);
                              }
                            }}
                            style={{ display: 'none' }}
                            id="property-csv-input"
                          />
                          <label htmlFor="property-csv-input" className="btn-secondary">
                            Select CSV File
                          </label>
                        </div>
                      )}

                      {/* CSV Preview and Mapping */}
                      {propertyCsvPreview && (
                        <div className="csv-preview-section">
                          <div className="preview-header">
                            <h4>CSV Preview (First 5 rows)</h4>
                            <button 
                              className="btn-secondary btn-small"
                              onClick={() => {
                                setPropertyCsvFile(null);
                                setPropertyCsvData(null);
                                setPropertyCsvPreview(null);
                                setPropertyColumnMapping({});
                              }}
                            >
                              Clear
                            </button>
                          </div>
                          
                          {/* Column Mapping */}
                          <div className="column-mapping">
                            <h4>Column Mapping</h4>
                            <div className="mapping-grid">
                              {['address', 'type', 'units', 'ownerName', 'ownerEmail'].map(field => (
                                <div key={field} className="mapping-item">
                                  <label>{field === 'ownerName' ? 'Owner Name' : field === 'ownerEmail' ? 'Owner Email' : field.charAt(0).toUpperCase() + field.slice(1)}</label>
                                  <select
                                    value={propertyColumnMapping[field] || ''}
                                    onChange={(e) => {
                                      setPropertyColumnMapping({
                                        ...propertyColumnMapping,
                                        [field]: e.target.value
                                      });
                                    }}
                                  >
                                    <option value="">Select column...</option>
                                    {propertyCsvPreview.headers.map(header => (
                                      <option key={header} value={header}>{header}</option>
                                    ))}
                                  </select>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Preview Table */}
                          <div className="preview-table-container">
                            <table className="preview-table">
                              <thead>
                                <tr>
                                  {propertyCsvPreview.headers.map(header => (
                                    <th key={header}>{header}</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {propertyCsvPreview.rows.slice(0, 5).map((row, idx) => (
                                  <tr key={idx}>
                                    {propertyCsvPreview.headers.map(header => (
                                      <td key={header}>{row[header] || ''}</td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>

                          {/* Import Button */}
                          <div className="import-button-section">
                            <button
                              className="btn-primary"
                              onClick={handleImportProperties}
                              disabled={!Object.values(propertyColumnMapping).some(v => v) || propertyImportProgress}
                            >
                              {propertyImportProgress ? `Importing... ${propertyImportProgress.processed}/${propertyImportProgress.total}` : 'Import Properties'}
                            </button>
                          </div>

                          {/* Progress Bar */}
                          {propertyImportProgress && (
                            <div className="import-progress">
                              <div className="progress-bar">
                                <div 
                                  className="progress-fill"
                                  style={{ width: `${(propertyImportProgress.processed / propertyImportProgress.total) * 100}%` }}
                                ></div>
                              </div>
                              <div className="progress-stats">
                                <span>Processed: {propertyImportProgress.processed}/{propertyImportProgress.total}</span>
                                <span>Success: {propertyImportProgress.success}</span>
                                <span>Errors: {propertyImportProgress.errors}</span>
                                <span>Duplicates: {propertyImportProgress.duplicates}</span>
                              </div>
                              {propertyImportProgress.complete && (
                                <div className="import-results">
                                  <p className="success-message">
                                    Import complete! {propertyImportProgress.success} properties imported successfully.
                                    {propertyImportProgress.errors > 0 && ` ${propertyImportProgress.errors} errors.`}
                                    {propertyImportProgress.duplicates > 0 && ` ${propertyImportProgress.duplicates} duplicates skipped.`}
                                  </p>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {/* SMS Notifications Section */}
                    <div className="import-section" style={{ marginTop: '48px' }}>
                      <div className="import-section-header">
                        <div className="import-section-title">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginRight: '8px' }}>
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                          </svg>
                          <h3>SMS Notifications</h3>
                        </div>
                      </div>
                      <p className="section-description">Configure Twilio to send SMS reminders to tenants</p>

                      <div className="form-grid" style={{ marginTop: '24px' }}>
                        <div className="form-group full-width">
                          <label>Twilio Account SID</label>
                          <input
                            type="text"
                            value={twilioSettings.accountSid}
                            onChange={e => setTwilioSettings({...twilioSettings, accountSid: e.target.value})}
                            placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                          />
                        </div>
                        <div className="form-group full-width">
                          <label>Twilio Auth Token</label>
                          <input
                            type="password"
                            value={twilioSettings.authToken}
                            onChange={e => setTwilioSettings({...twilioSettings, authToken: e.target.value})}
                            placeholder="Enter your Twilio Auth Token"
                          />
                        </div>
                        <div className="form-group full-width">
                          <label>Twilio Phone Number</label>
                          <input
                            type="text"
                            value={twilioSettings.phoneNumber}
                            onChange={e => setTwilioSettings({...twilioSettings, phoneNumber: e.target.value})}
                            placeholder="+1234567890"
                          />
                        </div>
                      </div>

                      <div className="modal-actions" style={{ marginTop: '24px', justifyContent: 'flex-start' }}>
                        <button
                          className="btn-primary"
                          onClick={saveTwilioSettings}
                          disabled={twilioSettingsLoading}
                        >
                          {twilioSettingsLoading ? 'Saving...' : 'Save Settings'}
                        </button>
                      </div>

                      {/* Test SMS */}
                      <div style={{ marginTop: '32px', padding: '24px', background: '#f8f9fa', borderRadius: '8px' }}>
                        <h4 style={{ marginBottom: '16px', fontSize: '14px', fontWeight: '500', color: '#202124' }}>Test SMS</h4>
                        <div className="form-grid">
                          <div className="form-group" style={{ flex: 1 }}>
                            <label>Phone Number</label>
                            <input
                              type="tel"
                              value={testSmsPhone}
                              onChange={e => setTestSmsPhone(e.target.value)}
                              placeholder="+1234567890"
                            />
                          </div>
                          <div className="form-group" style={{ display: 'flex', alignItems: 'flex-end' }}>
                            <button
                              className="btn-secondary"
                              onClick={sendTestSMS}
                              disabled={testSmsSending || !testSmsPhone}
                            >
                              {testSmsSending ? 'Sending...' : 'Send Test SMS'}
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </>
          )}

      {(showAddModal || editingTenant) && (
        <div className="modal-overlay" onClick={() => handleModalClose('tenant-form', () => {
          setShowAddModal(false);
          setEditingTenant(null);
        })}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>{editingTenant ? 'Edit Tenant' : 'Add New Tenant'}</h2>
              <button className="close-btn" onClick={() => {
                setShowAddModal(false);
                setEditingTenant(null);
              }}>Ã</button>
            </div>
            <div className="modal-body">
              <form id="tenant-form" onSubmit={editingTenant ? handleUpdateTenant : handleAddTenant}>
                <div className="two-col">
                  <div className="form-group">
                    <RequiredLabel>Full Name</RequiredLabel>
                    <input
                      type="text"
                      className="form-input"
                      value={editingTenant ? editingTenant.name : newTenant.name}
                      onChange={e => editingTenant 
                        ? setEditingTenant({...editingTenant, name: e.target.value})
                        : setNewTenant({...newTenant, name: e.target.value})}
                      required
                    />
                  </div>
                  <div className="form-group">
                    <RequiredLabel required={false}>Phone</RequiredLabel>
                    <input
                      type="tel"
                      className="form-input"
                      value={editingTenant ? editingTenant.phone : newTenant.phone}
                      onChange={e => editingTenant 
                        ? setEditingTenant({...editingTenant, phone: e.target.value})
                        : setNewTenant({...newTenant, phone: e.target.value})}
                      placeholder="(optional)"
                    />
                  </div>
                </div>
                <div className="form-group">
                  <RequiredLabel>Email</RequiredLabel>
                  <input
                    type="email"
                    className="form-input"
                    value={editingTenant ? editingTenant.email : newTenant.email}
                    onChange={e => editingTenant 
                      ? setEditingTenant({...editingTenant, email: e.target.value})
                      : setNewTenant({...newTenant, email: e.target.value})}
                    required
                  />
                </div>
                <div className="two-col">
                  <div className="form-group">
                    <label className="form-label">Status</label>
                    <select
                      className="form-select"
                      value={editingTenant ? editingTenant.status : newTenant.status}
                      onChange={e => editingTenant 
                        ? setEditingTenant({...editingTenant, status: e.target.value})
                        : setNewTenant({...newTenant, status: e.target.value})}
                    >
                      <option value="prospect">Prospect</option>
                      <option value="current">Current Tenant</option>
                      <option value="past">Past Tenant</option>
                    </select>
                  </div>
                  <div className="form-group">
                    <label className="form-label">Payment Status</label>
                    <select
                      className="form-select"
                      value={editingTenant ? editingTenant.paymentStatus : newTenant.paymentStatus}
                      onChange={e => editingTenant 
                        ? setEditingTenant({...editingTenant, paymentStatus: e.target.value})
                        : setNewTenant({...newTenant, paymentStatus: e.target.value})}
                    >
                      <option value="n/a">N/A</option>
                      <option value="paid">Paid</option>
                      <option value="late">Late</option>
                      <option value="unpaid">Unpaid</option>
                    </select>
                  </div>
                </div>
                <div className="form-group">
                  <label className="form-label">Property / Unit</label>
                  <select
                    className="form-select"
                    value={editingTenant ? editingTenant.property : newTenant.property}
                    onChange={e => editingTenant 
                      ? setEditingTenant({...editingTenant, property: e.target.value})
                      : setNewTenant({...newTenant, property: e.target.value})}
                  >
                    <option value="">Select Property</option>
                    {properties.map(prop => (
                      <option key={prop.id} value={prop.address}>{prop.address}</option>
                    ))}
                  </select>
                </div>
                <div className="two-col">
                  <div className="form-group">
                    <RequiredLabel required={(editingTenant ? editingTenant.status : newTenant.status) === 'current'}>Monthly Rent</RequiredLabel>
                    <input
                      type="number"
                      className="form-input"
                      value={editingTenant ? editingTenant.rentAmount : newTenant.rentAmount}
                      onChange={e => editingTenant 
                        ? setEditingTenant({...editingTenant, rentAmount: e.target.value})
                        : setNewTenant({...newTenant, rentAmount: e.target.value})}
                      placeholder="0"
                      required={(editingTenant ? editingTenant.status : newTenant.status) === 'current'}
                    />
                  </div>
                  <div className="form-group">
                    <RequiredLabel required={false}>Security Deposit</RequiredLabel>
                    <input
                      type="number"
                      className="form-input"
                      value={editingTenant ? editingTenant.securityDeposit : newTenant.securityDeposit}
                      onChange={e => editingTenant 
                        ? setEditingTenant({...editingTenant, securityDeposit: e.target.value})
                        : setNewTenant({...newTenant, securityDeposit: e.target.value})}
                      placeholder="0"
                    />
                  </div>
                </div>
                <div className="two-col">
                  <div className="form-group">
                    <RequiredLabel required={(editingTenant ? editingTenant.status : newTenant.status) === 'current'}>Lease Start</RequiredLabel>
                    <input
                      type="date"
                      className="form-input"
                      value={editingTenant ? editingTenant.leaseStart : newTenant.leaseStart}
                      onChange={e => editingTenant 
                        ? setEditingTenant({...editingTenant, leaseStart: e.target.value})
                        : setNewTenant({...newTenant, leaseStart: e.target.value})}
                      required={(editingTenant ? editingTenant.status : newTenant.status) === 'current'}
                    />
                  </div>
                  <div className="form-group">
                    <RequiredLabel required={false}>Lease End</RequiredLabel>
                    <input
                      type="date"
                      className="form-input"
                      value={editingTenant ? editingTenant.leaseEnd : newTenant.leaseEnd}
                      onChange={e => editingTenant 
                        ? setEditingTenant({...editingTenant, leaseEnd: e.target.value})
                        : setNewTenant({...newTenant, leaseEnd: e.target.value})}
                    />
                  </div>
                </div>
                <div className="form-group">
                  <label className="form-label">Move-In Date</label>
                  <input
                    type="date"
                    className="form-input"
                    value={editingTenant ? editingTenant.moveInDate : newTenant.moveInDate || ''}
                    onChange={e => editingTenant 
                      ? setEditingTenant({...editingTenant, moveInDate: e.target.value})
                      : setNewTenant({...newTenant, moveInDate: e.target.value})}
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Move-In Condition Notes</label>
                  <textarea
                    className="form-textarea"
                    value={editingTenant ? editingTenant.moveInNotes : newTenant.moveInNotes || ''}
                    onChange={e => editingTenant 
                      ? setEditingTenant({...editingTenant, moveInNotes: e.target.value})
                      : setNewTenant({...newTenant, moveInNotes: e.target.value})}
                    rows="2"
                    placeholder="Describe the condition of the property at move-in..."
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Notes</label>
                  <textarea
                    className="form-textarea"
                    value={editingTenant ? editingTenant.notes : newTenant.notes}
                    onChange={e => editingTenant 
                      ? setEditingTenant({...editingTenant, notes: e.target.value})
                      : setNewTenant({...newTenant, notes: e.target.value})}
                    rows="3"
                    placeholder="Pet info, preferences, move-in notes..."
                  />
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={() => {
                    setShowAddModal(false);
                    setEditingTenant(null);
                  }}>
                    Cancel
                  </button>
                  <button type="submit" className="btn btn-primary">
                    {editingTenant ? 'Update Tenant' : 'Add Tenant'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {selectedTenant && (
        <>
          {/* Backdrop/Overlay */}
          <div 
            className="panel-overlay" 
            onClick={() => {
              setSelectedTenant(null);
              setTagsExpanded(false); // Reset tags expanded when closing panel
            }}
          />
          {/* Right-side slide-out panel */}
          <div className="tenant-detail-panel open" onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div style={{ 
              padding: '24px', 
              borderBottom: '1px solid #e5e7eb',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <h2 style={{ fontSize: '18px', fontWeight: '600', color: '#1f2937', margin: 0 }}>Tenant Details</h2>
              <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                <button 
                  onClick={() => {
                    setEditingTenant({...selectedTenant});
                    setSelectedTenant(null);
                  }}
                  style={{
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: '14px',
                    color: '#1a73e8',
                    padding: '4px 8px',
                    borderRadius: '4px',
                    transition: 'background 0.2s'
                  }}
                  onMouseEnter={(e) => e.target.style.background = '#f3f4f6'}
                  onMouseLeave={(e) => e.target.style.background = 'none'}
                >
                  Edit
                </button>
                <button 
                  className="close-btn" 
                  onClick={() => {
                    setSelectedTenant(null);
                    setTagsExpanded(false); // Reset tags expanded when closing panel
                  }}
                  style={{
                    background: 'none',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: '24px',
                    color: '#6b7280',
                    padding: '0',
                    width: '32px',
                    height: '32px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    borderRadius: '50%',
                    transition: 'background 0.2s'
                  }}
                  onMouseEnter={(e) => e.target.style.background = '#f3f4f6'}
                  onMouseLeave={(e) => e.target.style.background = 'none'}
                >
                  Ã
                </button>
              </div>
            </div>
            
            {/* Content */}
            <div style={{ padding: '24px', overflowY: 'auto', height: 'calc(100vh - 73px)' }}>
              {/* Avatar with Photo Upload */}
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '24px' }}>
                <div
                  onClick={() => document.getElementById('tenant-photo-input').click()}
                  style={{
                    width: '96px',
                    height: '96px',
                    borderRadius: '50%',
                    background: selectedTenant.photo_url 
                      ? `url(${selectedTenant.photo_url}) center/cover`
                      : getAvatarColorByName(selectedTenant.name),
                    color: '#fff',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '32px',
                    fontWeight: '600',
                    marginBottom: '16px',
                    cursor: 'pointer',
                    position: 'relative',
                    border: '3px solid white',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                  }}
                >
                  {!selectedTenant.photo_url && (
                    <span>{getInitials(selectedTenant.name)}</span>
                  )}
                  <div style={{
                    position: 'absolute',
                    bottom: 0,
                    right: 0,
                    width: '28px',
                    height: '28px',
                    borderRadius: '50%',
                    background: '#1a73e8',
                    border: '2px solid white',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                  }}>
                    <span style={{ color: 'white', fontSize: '14px' }}>ð·</span>
                  </div>
                </div>
                <input
                  id='tenant-photo-input'
                  type='file'
                  accept='image/*'
                  style={{ display: 'none' }}
                  onChange={async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                      const photoUrl = await uploadPhoto(file, 'tenant', selectedTenant.id);
                      await supabase.from('tenants').update({ photo_url: photoUrl }).eq('id', selectedTenant.id);
                      setSelectedTenant({ ...selectedTenant, photo_url: photoUrl });
                      setTenants(tenants.map(t => t.id === selectedTenant.id ? { ...t, photo_url: photoUrl } : t));
                    } catch (err) {
                      console.error('Upload failed:', err);
                      alert('Failed to upload photo');
                    }
                    e.target.value = ''; // Reset input
                  }}
                />
                
                {/* Name */}
                <h2 style={{ 
                  fontSize: '24px', 
                  fontWeight: '600', 
                  color: '#1f2937', 
                  margin: '0 0 8px 0',
                  textAlign: 'center'
                }}>
                  {selectedTenant.name}
                </h2>
                
                {/* Status Badge */}
                <span 
                  className="badge" 
                  style={{
                    ...getStatusBadge(selectedTenant.status),
                    fontSize: '12px',
                    padding: '4px 12px',
                    borderRadius: '12px'
                  }}
                >
                  {selectedTenant.status === 'current' ? 'Current' : selectedTenant.status === 'prospect' ? 'Prospect' : 'Past'}
                </span>
              </div>

              {/* Divider */}
              <div style={{ height: '1px', background: '#e5e7eb', margin: '24px 0' }}></div>

              {/* Email Section */}
              {selectedTenant.email && (
                <div style={{ marginBottom: '24px' }}>
                  <div style={{ 
                    fontSize: '12px', 
                    fontWeight: '500', 
                    color: '#6b7280', 
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px',
                    marginBottom: '8px'
                  }}>
                    Email
                  </div>
                  <div style={{ fontSize: '14px', color: '#1f2937' }}>
                    {selectedTenant.email}
                  </div>
                </div>
              )}

              {/* Phone Section */}
              {selectedTenant.phone && (
                <div style={{ marginBottom: '24px' }}>
                  <div style={{ 
                    fontSize: '12px', 
                    fontWeight: '500', 
                    color: '#6b7280', 
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px',
                    marginBottom: '8px'
                  }}>
                    Phone
                  </div>
                  <div style={{ fontSize: '14px', color: '#1f2937' }}>
                    {selectedTenant.phone}
                  </div>
                </div>
              )}

              {/* Divider */}
              <div style={{ height: '1px', background: '#e5e7eb', margin: '24px 0' }}></div>

              {/* Property Section */}
              <div style={{ marginBottom: '24px' }}>
                <div style={{ 
                  fontSize: '12px', 
                  fontWeight: '500', 
                  color: '#6b7280', 
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  marginBottom: '8px'
                }}>
                  Property
                </div>
                <div style={{ fontSize: '14px', color: '#1f2937' }}>
                  {selectedTenant.property || 'Not assigned'}
                </div>
              </div>

              {/* Monthly Rent and Balance - Two Columns */}
              {selectedTenant.rentAmount > 0 && (
                <div style={{ 
                  display: 'grid', 
                  gridTemplateColumns: '1fr 1fr', 
                  gap: '16px',
                  marginBottom: '24px'
                }}>
                  <div>
                    <div style={{ 
                      fontSize: '12px', 
                      fontWeight: '500', 
                      color: '#6b7280', 
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '8px'
                    }}>
                      Monthly Rent
                    </div>
                    <div style={{ fontSize: '14px', color: '#1f2937', fontWeight: '500' }}>
                      ${selectedTenant.rentAmount.toLocaleString()}
                    </div>
                  </div>
                  <div>
                    <div style={{ 
                      fontSize: '12px', 
                      fontWeight: '500', 
                      color: '#6b7280', 
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      marginBottom: '8px'
                    }}>
                      Balance
                    </div>
                    <div style={{ 
                      fontSize: '14px', 
                      color: selectedTenant.paymentStatus === 'paid' ? '#10b981' : '#1f2937',
                      fontWeight: '500'
                    }}>
                      {selectedTenant.paymentStatus === 'paid' ? '$0' : `$${selectedTenant.rentAmount.toLocaleString()}`}
                    </div>
                  </div>
                </div>
              )}

              {/* Lease Period */}
              {selectedTenant.leaseStart && selectedTenant.leaseEnd && (
                <div style={{ marginBottom: '24px' }}>
                  <div style={{ 
                    fontSize: '12px', 
                    fontWeight: '500', 
                    color: '#6b7280', 
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px',
                    marginBottom: '8px'
                  }}>
                    Lease Period
                  </div>
                  <div style={{ fontSize: '14px', color: '#1f2937' }}>
                    {new Date(selectedTenant.leaseStart).toLocaleDateString()} - {new Date(selectedTenant.leaseEnd).toLocaleDateString()}
                  </div>
                </div>
              )}

              {/* Divider */}
              <div style={{ height: '1px', background: '#e5e7eb', margin: '24px 0' }}></div>

              {/* Tags Section */}
              <div style={{ marginBottom: '24px' }}>
                {(() => {
                  const tenantTags = getTagsForRecord('tenant', selectedTenant.id);
                  const displayedTags = tagsExpanded ? tenantTags : tenantTags.slice(0, 3);
                  
                  return (
                    <div>
                      <div 
                        onClick={() => setTagsExpanded(!tagsExpanded)} 
                        style={{ 
                          cursor: 'pointer', 
                          display: 'flex', 
                          justifyContent: 'space-between', 
                          alignItems: 'center',
                          marginBottom: '8px'
                        }}
                      >
                        <span className="section-label">TAGS</span>
                        <span style={{ fontSize: '12px', color: '#6b7280' }}>
                          {tagsExpanded ? 'â¼' : 'â¶'} {tenantTags.length}
                        </span>
                      </div>
                      <div style={{ marginTop: '8px', display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                        {displayedTags.map(tag => {
                          const tagColor = getTagColor(tag.color);
                          return (
                            <span
                              key={tag.id}
                              style={{
                                padding: '4px 12px',
                                borderRadius: '12px',
                                fontSize: '12px',
                                fontWeight: 500,
                                background: tagColor.bg,
                                color: tagColor.text,
                                display: 'inline-flex',
                                alignItems: 'center',
                                gap: '6px'
                              }}
                            >
                              {tag.name}
                              <button
                                onClick={async (e) => {
                                  e.stopPropagation();
                                  await removeTagFromRecord(tag.id, 'tenant', selectedTenant.id);
                                  // Reload record tags
                                  try {
                                    const { data: allRecordTags } = await supabase
                                      .from('record_tags')
                                      .select('*');
                                    if (allRecordTags) {
                                      setRecordTags(allRecordTags);
                                    }
                                  } catch (error) {
                                    console.error('Error reloading record tags:', error);
                                  }
                                }}
                                style={{
                                  background: 'none',
                                  border: 'none',
                                  color: tagColor.text,
                                  cursor: 'pointer',
                                  fontSize: '16px',
                                  padding: '0',
                                  margin: '0',
                                  lineHeight: '1',
                                  opacity: 0.7
                                }}
                                title="Remove tag"
                                onMouseEnter={(e) => e.target.style.opacity = '1'}
                                onMouseLeave={(e) => e.target.style.opacity = '0.7'}
                              >
                                Ã
                              </button>
                            </span>
                          );
                        })}
                        {!tagsExpanded && tenantTags.length > 3 && (
                          <span style={{ fontSize: '12px', color: '#6b7280', alignSelf: 'center' }}>
                            +{tenantTags.length - 3} more
                          </span>
                        )}
                      </div>
                      {tagsExpanded && (
                        <div style={{ marginTop: '8px' }}>
                          <TagPicker
                            recordType="tenant"
                            recordId={selectedTenant.id}
                            onTagsChange={async () => {
                              // Reload record tags for this tenant
                              try {
                                const { data: allRecordTags } = await supabase
                                  .from('record_tags')
                                  .select('*');
                                if (allRecordTags) {
                                  setRecordTags(allRecordTags);
                                }
                              } catch (error) {
                                console.error('Error reloading record tags:', error);
                              }
                            }}
                          />
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>

              {/* Divider */}
              <div style={{ height: '1px', background: '#e5e7eb', margin: '24px 0' }}></div>

              {/* Files Section */}
              <div style={{ marginBottom: '24px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                  <span className="section-label">FILES</span>
                  <button
                    onClick={() => document.getElementById('tenant-file-input').click()}
                    className="btn-text"
                    style={{ fontSize: '12px', padding: '4px 8px' }}
                  >
                    + Add File
                  </button>
                </div>
                <input
                  id='tenant-file-input'
                  type='file'
                  multiple
                  accept='.pdf,.doc,.docx,.jpg,.png,.jpeg'
                  style={{ display: 'none' }}
                  onChange={async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;
                    
                    try {
                      for (const file of files) {
                        await uploadDocument(file, 'tenant', selectedTenant.id, 'document');
                      }
                      const updated = await loadFilesForRecord('tenant', selectedTenant.id);
                      setTenantFiles(updated);
                    } catch (err) {
                      console.error('Upload failed:', err);
                      alert('Failed to upload file(s)');
                    }
                    e.target.value = ''; // Reset input
                  }}
                />
                {tenantFiles.length === 0 ? (
                  <p style={{ color: '#9ca3af', fontSize: '14px' }}>No files uploaded</p>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {tenantFiles.map(file => (
                      <div 
                        key={file.id} 
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          padding: '10px 12px',
                          background: '#f9fafb',
                          borderRadius: '8px',
                          border: '1px solid #e5e7eb'
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', flex: 1, minWidth: 0 }}>
                          <span style={{ fontSize: '18px', flexShrink: 0 }}>ð</span>
                          <span style={{ fontSize: '14px', color: '#374151', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                            {file.file_name}
                          </span>
                          <span style={{ fontSize: '12px', color: '#9ca3af', marginLeft: '8px' }}>
                            {file.file_size ? `${(file.file_size / 1024).toFixed(1)} KB` : ''}
                          </span>
                        </div>
                        <div style={{ display: 'flex', gap: '8px', flexShrink: 0 }}>
                          <button 
                            onClick={async (e) => {
                              e.stopPropagation();
                              try {
                                const url = await getDocumentUrl(file.storage_path);
                                window.open(url, '_blank');
                              } catch (err) {
                                console.error('Error downloading file:', err);
                                alert('Failed to download file');
                              }
                            }} 
                            className="btn-text"
                            style={{ padding: '4px 8px', fontSize: '14px' }}
                            title="Download"
                          >
                            â¬ï¸
                          </button>
                          <button 
                            onClick={async (e) => {
                              e.stopPropagation();
                              if (confirm('Are you sure you want to delete this file?')) {
                                try {
                                  await deleteFile(file.id, file.storage_path);
                                  setTenantFiles(tenantFiles.filter(f => f.id !== file.id));
                                } catch (err) {
                                  console.error('Error deleting file:', err);
                                  alert('Failed to delete file');
                                }
                              }
                            }} 
                            className="btn-text"
                            style={{ padding: '4px 8px', fontSize: '14px', color: '#dc2626' }}
                            title="Delete"
                          >
                            ðï¸
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Divider */}
              <div style={{ height: '1px', background: '#e5e7eb', margin: '24px 0' }}></div>

              {/* Action Buttons */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginTop: '24px' }}>
                {selectedTenant.email && (
                  <a
                    href={`mailto:${selectedTenant.email}`}
                    className="btn-primary"
                    style={{
                      width: '100%',
                      textAlign: 'center',
                      textDecoration: 'none',
                      display: 'inline-block'
                    }}
                  >
                    Email
                  </a>
                )}
                {selectedTenant.phone && (
                  <a
                    href={`tel:${selectedTenant.phone}`}
                    className="btn-secondary"
                    style={{
                      width: '100%',
                      textAlign: 'center',
                      textDecoration: 'none',
                      display: 'inline-block'
                    }}
                  >
                    Call
                  </a>
                )}
              </div>
            </div>
          </div>
        </>
      )}

      {showPaymentRequestModal && (() => {
        const tenant = tenants.find(t => t.id === showPaymentRequestModal);
        if (!tenant) return null;
        
        return (
          <div className="modal-overlay" onClick={() => handleModalClose('payment-request-form', () => {
            setShowPaymentRequestModal(null);
            setPaymentRequest({ amount: '', dueDate: '', note: '' });
            setPaymentLinkCopied(false);
            setCreatedPaymentLink('');
          })}>
            <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '500px' }}>
              <div className="modal-header">
                <h2>Request Payment - {tenant.name}</h2>
                <button className="close-btn" onClick={() => {
                  setShowPaymentRequestModal(null);
                  setPaymentRequest({ amount: '', dueDate: '', note: '' });
                  setPaymentLinkCopied(false);
                  setCreatedPaymentLink('');
                }}>Ã</button>
              </div>
              <div className="modal-content">
                <form id="payment-request-form" onSubmit={async (e) => {
                  e.preventDefault();
                  if (!paymentRequest.amount || !paymentRequest.dueDate) {
                    alert('Please fill in amount and due date');
                    return;
                  }

                  // Create payment request in Supabase
                  const { data, error } = await supabase
                    .from('payment_requests')
                    .insert([{
                      user_id: user.id,
                      tenant_id: tenant.id,
                      amount: parseFloat(paymentRequest.amount),
                      due_date: paymentRequest.dueDate,
                      note: paymentRequest.note || null,
                      status: 'pending'
                    }])
                    .select()
                    .single();

                  if (error) {
                    console.error('Error creating payment request:', error);
                    alert('Error creating payment request. Please make sure the payment_requests table exists. Run the add-payment-requests-migration.sql file in your Supabase SQL editor.');
                    return;
                  }

                  // Generate payment link using the created record's timestamp
                  const timestamp = new Date(data.created_at).getTime();
                  const paymentLink = `${window.location.origin}/pay/${tenant.id}/${parseFloat(paymentRequest.amount)}/${timestamp}`;
                  
                  // Store the link
                  setCreatedPaymentLink(paymentLink);

                  // Copy link to clipboard
                  try {
                    await navigator.clipboard.writeText(paymentLink);
                    setPaymentLinkCopied(true);
                    setTimeout(() => {
                      setPaymentLinkCopied(false);
                      setCreatedPaymentLink('');
                    }, 10000);
                  } catch (err) {
                    const textArea = document.createElement('textarea');
                    textArea.value = paymentLink;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    setPaymentLinkCopied(true);
                    setTimeout(() => {
                      setPaymentLinkCopied(false);
                      setCreatedPaymentLink('');
                    }, 10000);
                  }
                }}>
                  <div className="form-grid">
                    <div className="form-group full-width">
                      <label>Amount</label>
                      <input
                        type="number"
                        value={paymentRequest.amount}
                        onChange={e => setPaymentRequest({...paymentRequest, amount: e.target.value})}
                        placeholder="0.00"
                        step="0.01"
                        required
                      />
                    </div>
                    <div className="form-group full-width">
                      <label>Due Date</label>
                      <input
                        type="date"
                        value={paymentRequest.dueDate}
                        onChange={e => setPaymentRequest({...paymentRequest, dueDate: e.target.value})}
                        required
                      />
                    </div>
                    <div className="form-group full-width">
                      <label>Note (Optional)</label>
                      <textarea
                        value={paymentRequest.note}
                        onChange={e => setPaymentRequest({...paymentRequest, note: e.target.value})}
                        placeholder="Add a note for the tenant..."
                        rows="3"
                      />
                    </div>
                  </div>
                  <div className="modal-actions">
                    <button 
                      type="button" 
                      className="btn-secondary" 
                      onClick={() => {
                        setShowPaymentRequestModal(null);
                        setPaymentRequest({ amount: '', dueDate: '', note: '' });
                        setPaymentLinkCopied(false);
                        setCreatedPaymentLink('');
                      }}
                    >
                      Cancel
                    </button>
                    <button type="submit" className="btn-primary">
                      {paymentLinkCopied ? 'Link Copied!' : 'Create Payment Link'}
                    </button>
                  </div>
                </form>
                {paymentLinkCopied && createdPaymentLink && (
                  <div style={{ marginTop: '24px', padding: '16px', background: '#e8f5e9', borderRadius: '8px' }}>
                    <p style={{ marginBottom: '12px', color: '#1e8e3e', fontWeight: '500' }}>
                      â Payment link created and copied to clipboard!
                    </p>
                    <div style={{ marginBottom: '12px' }}>
                      <label style={{ fontSize: '12px', color: '#5f6368', display: 'block', marginBottom: '4px' }}>
                        Payment Link:
                      </label>
                      <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                        <input
                          type="text"
                          value={createdPaymentLink}
                          readOnly
                          style={{ 
                            flex: 1, 
                            padding: '8px 12px', 
                            border: '1px solid #dadce0', 
                            borderRadius: '4px',
                            fontSize: '13px',
                            background: '#ffffff'
                          }}
                        />
                        <button
                          type="button"
                          className="btn-secondary"
                          onClick={async () => {
                            try {
                              await navigator.clipboard.writeText(createdPaymentLink);
                              alert('Link copied again!');
                            } catch (err) {
                              const textArea = document.createElement('textarea');
                              textArea.value = createdPaymentLink;
                              document.body.appendChild(textArea);
                              textArea.select();
                              document.execCommand('copy');
                              document.body.removeChild(textArea);
                              alert('Link copied again!');
                            }
                          }}
                        >
                          Copy
                        </button>
                      </div>
                    </div>
                    {tenant.email && (
                      <button
                        type="button"
                        className="btn-primary"
                        style={{ width: '100%' }}
                        onClick={() => {
                          const subject = encodeURIComponent(`Payment Request - $${parseFloat(paymentRequest.amount).toLocaleString()}`);
                          const body = encodeURIComponent(
                            `Dear ${tenant.name},\n\n` +
                            `This is a payment request for ${tenant.property || 'your property'}.\n\n` +
                            `Amount Due: $${parseFloat(paymentRequest.amount).toLocaleString()}\n` +
                            `Due Date: ${new Date(paymentRequest.dueDate).toLocaleDateString()}\n` +
                            (paymentRequest.note ? `\nNote: ${paymentRequest.note}\n` : '') +
                            `\nPlease use the following link to make your payment:\n${createdPaymentLink}\n\n` +
                            `Thank you,\nProperty Management`
                          );
                          window.location.href = `mailto:${tenant.email}?subject=${subject}&body=${body}`;
                        }}
                      >
                        Send via Email
                      </button>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      })()}

      {confirmPaymentChange && (
        <div className="modal-overlay" onClick={() => setConfirmPaymentChange(null)}>
          <div className="modal confirmation-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Confirm Payment Status Change</h2>
              <button className="close-btn" onClick={() => setConfirmPaymentChange(null)}>Ã</button>
            </div>
            <div className="confirmation-content">
              <p>Are you sure you want to mark <strong>{confirmPaymentChange.tenantName}</strong> as <strong>late</strong>?</p>
            </div>
            <div className="modal-actions">
              <button 
                type="button" 
                className="btn-secondary" 
                onClick={() => setConfirmPaymentChange(null)}
              >
                Cancel
              </button>
              <button 
                type="button" 
                className="btn-primary" 
                onClick={confirmPaymentChangeAction}
              >
                Confirm
              </button>
            </div>
          </div>
        </div>
      )}

      {confirmDelete && (
        <div className="modal-overlay" onClick={() => setConfirmDelete(null)}>
          <div className="modal confirmation-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Delete Tenant</h2>
              <button className="close-btn" onClick={() => setConfirmDelete(null)}>Ã</button>
            </div>
            <div className="confirmation-content">
              <p>Are you sure you want to delete <strong>{confirmDelete.tenantName}</strong>?</p>
              <p className="warning-text">This action cannot be undone.</p>
            </div>
            <div className="modal-actions">
              <button 
                type="button" 
                className="btn-secondary" 
                onClick={() => setConfirmDelete(null)}
              >
                Cancel
              </button>
              <button 
                type="button" 
                className="btn-danger" 
                onClick={confirmDeleteAction}
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      {showSelectTenantForPayment && (
        <div className="modal-overlay" onClick={() => handleModalClose('select-tenant-form', () => {
          setShowSelectTenantForPayment(false);
          setPaymentTenantSearch('');
        })}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '500px' }}>
            <div className="modal-header">
              <h2>Select Tenant for Payment</h2>
              <button className="close-btn" onClick={() => {
                setShowSelectTenantForPayment(false);
                setPaymentTenantSearch('');
              }}>Ã</button>
            </div>
            <div className="modal-content">
              <form id="select-tenant-form">
                <div className="form-group full-width">
                  <label>Search Tenant</label>
                  <input
                    name="search"
                    type="text"
                    placeholder="Search by name, property, or email..."
                    value={paymentTenantSearch}
                    onChange={(e) => setPaymentTenantSearch(e.target.value)}
                    className="search-bar"
                    autoFocus
                  />
                </div>
              </form>
              <div className="tenant-selection-list" style={{ maxHeight: '400px', overflowY: 'auto', marginTop: '16px' }}>
                {(() => {
                  const filteredTenants = tenants.filter(t => {
                    if (!paymentTenantSearch || !paymentTenantSearch.trim()) return true;
                    const search = paymentTenantSearch.toLowerCase();
                    return (t.name && t.name.toLowerCase().includes(search)) ||
                           (t.property && t.property.toLowerCase().includes(search)) ||
                           (t.email && t.email.toLowerCase().includes(search));
                  });
                  
                  if (filteredTenants.length === 0) {
                    return (
                      <div style={{ padding: '2rem', textAlign: 'center', color: '#5f6368' }}>
                        <p>No tenants found</p>
                      </div>
                    );
                  }
                  
                  return filteredTenants.map(tenant => (
                    <div
                      key={tenant.id}
                      className="tenant-selection-item"
                      onClick={() => {
                        setShowSelectTenantForPayment(false);
                        setPaymentTenantSearch('');
                        setShowPaymentLog(tenant.id);
                      }}
                    >
                      <div>
                        <strong style={{ display: 'block', marginBottom: '4px', fontSize: '14px', color: '#202124' }}>
                          {tenant.name || 'Unnamed'}
                        </strong>
                        <span style={{ fontSize: '13px', color: '#5f6368' }}>
                          {tenant.property || 'No property'}
                        </span>
                        {tenant.email && (
                          <span style={{ fontSize: '13px', color: '#5f6368', display: 'block', marginTop: '2px' }}>
                            {tenant.email}
                          </span>
                        )}
                      </div>
                      {tenant.status === 'current' && (
                        <span className="badge" style={getPaymentBadge(tenant.paymentStatus)}>
                          {tenant.paymentStatus === 'paid' ? 'Paid' : 'Late'}
                        </span>
                      )}
                    </div>
                  ));
                })()}
              </div>
            </div>
          </div>
        </div>
      )}

      {showPaymentLog && (
        <div className="modal-overlay" onClick={() => setShowPaymentLog(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Payment Log - {tenants.find(t => t.id === showPaymentLog)?.name}</h2>
              <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                <button
                  className="btn-secondary"
                  onClick={async (e) => {
                    e.stopPropagation();
                    await refreshData();
                  }}
                  style={{
                    padding: '6px 12px',
                    fontSize: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px'
                  }}
                  title="Refresh data"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                  </svg>
                  Refresh
                </button>
                <button className="close-btn" onClick={() => setShowPaymentLog(null)}>Ã</button>
              </div>
            </div>
            <div className="modal-content">
              <form onSubmit={(e) => handleAddPayment(showPaymentLog, e)}>
                <div className="form-group">
                  <label>Amount</label>
                  <input
                    type="number"
                    value={newPayment.amount}
                    onChange={e => setNewPayment({...newPayment, amount: e.target.value})}
                    placeholder="0.00"
                    step="0.01"
                    required
                  />
                </div>
                <div className="form-group">
                  <label>Payment Method</label>
                  <select
                    value={newPayment.method}
                    onChange={e => setNewPayment({...newPayment, method: e.target.value})}
                  >
                    <option value="cash">Cash</option>
                    <option value="check">Check</option>
                    <option value="Venmo">Venmo</option>
                    <option value="Zelle">Zelle</option>
                  </select>
                </div>
                <div className="form-group">
                  <label>Date Received</label>
                  <input
                    type="date"
                    value={newPayment.date}
                    onChange={e => setNewPayment({...newPayment, date: e.target.value})}
                    required
                  />
                </div>
                <div className="modal-actions">
                  <button type="button" className="btn-secondary" onClick={() => setShowPaymentLog(null)}>
                    Cancel
                  </button>
                  <button type="submit" className="btn-primary">
                    Add Payment
                  </button>
                </div>
              </form>
              <div className="payment-log-list" style={{ marginTop: '1.5rem' }}>
                <h4>Payment History</h4>
                {tenants.find(t => t.id === showPaymentLog)?.paymentLog?.length > 0 ? (
                  tenants.find(t => t.id === showPaymentLog).paymentLog.slice().reverse().map(payment => (
                    <div key={payment.id} className="payment-log-item">
                      <span>${payment.amount.toLocaleString()}</span>
                      <span>{payment.method}</span>
                      <span>{new Date(payment.date).toLocaleDateString()}</span>
                    </div>
                  ))
                ) : (
                  <p className="text-muted">No payments recorded</p>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {showActivityLog && (
        <div className="modal-overlay" onClick={() => setShowActivityLog(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Activity Log - {tenants.find(t => t.id === showActivityLog)?.name}</h2>
              <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                <button
                  className="btn-secondary"
                  onClick={async (e) => {
                    e.stopPropagation();
                    await refreshData();
                  }}
                  style={{
                    padding: '6px 12px',
                    fontSize: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px'
                  }}
                  title="Refresh data"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                  </svg>
                  Refresh
                </button>
                <button className="close-btn" onClick={() => setShowActivityLog(null)}>Ã</button>
              </div>
            </div>
            <div className="modal-content">
              <form onSubmit={(e) => handleAddActivity(showActivityLog, e)}>
                <div className="form-group full-width">
                  <label>Add Note</label>
                  <textarea
                    value={newActivityNote}
                    onChange={e => setNewActivityNote(e.target.value)}
                    rows="3"
                    placeholder="Enter activity note..."
                    required
                  />
                </div>
                <div className="modal-actions">
                  <button type="button" className="btn-secondary" onClick={() => setShowActivityLog(null)}>
                    Cancel
                  </button>
                  <button type="submit" className="btn-primary">
                    Add Note
                  </button>
                </div>
              </form>
              <div className="activity-log-list" style={{ marginTop: '1.5rem' }}>
                <h4>Activity History</h4>
                {tenants.find(t => t.id === showActivityLog)?.activityLog?.length > 0 ? (
                  tenants.find(t => t.id === showActivityLog).activityLog.slice().reverse().map(activity => (
                    <div key={activity.id} className="activity-log-item">
                      <p className="activity-note">{activity.note}</p>
                      <span className="activity-time">{new Date(activity.timestamp).toLocaleString()}</span>
                    </div>
                  ))
                ) : (
                  <p className="text-muted">No activity recorded</p>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {showExpenseModal && (
        <div className="modal-overlay" onClick={() => handleModalClose('expense-form', () => setShowExpenseModal(null))}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Add Expense - {properties.find(p => p.id === showExpenseModal)?.address}</h2>
              <button className="close-btn" onClick={() => setShowExpenseModal(null)}>Ã</button>
            </div>
            <div className="modal-body">
              <form id="expense-form" onSubmit={(e) => handleAddExpense(showExpenseModal, e)}>
                <div className="form-group">
                  <label className="form-label">Description</label>
                  <input
                    type="text"
                    className="form-input"
                    value={newExpense.description}
                    onChange={e => setNewExpense({...newExpense, description: e.target.value})}
                    placeholder="e.g., Plumbing repair"
                    required
                  />
                </div>
                <div className="two-col">
                  <div className="form-group">
                    <label className="form-label">Amount</label>
                    <input
                      type="number"
                      className="form-input"
                      value={newExpense.amount}
                      onChange={e => setNewExpense({...newExpense, amount: e.target.value})}
                      placeholder="0.00"
                      step="0.01"
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Category</label>
                    <select
                      className="form-select"
                      value={newExpense.category}
                      onChange={e => setNewExpense({...newExpense, category: e.target.value})}
                    >
                      <option value="repair">Repair</option>
                      <option value="maintenance">Maintenance</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
                <div className="form-group">
                  <label className="form-label">Date</label>
                  <input
                    type="date"
                    className="form-input"
                    value={newExpense.date}
                    onChange={e => setNewExpense({...newExpense, date: e.target.value})}
                    required
                  />
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={() => setShowExpenseModal(null)}>
                    Cancel
                  </button>
                  <button type="submit" className="btn btn-primary">
                    Add Expense
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {editingProperty && (
        <div className="modal-overlay" onClick={() => handleModalClose('edit-property-form', () => setEditingProperty(null))}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Edit Property</h2>
              <button className="close-btn" onClick={() => setEditingProperty(null)}>Ã</button>
            </div>
            <div className="modal-body">
              <form id="edit-property-form" onSubmit={handleUpdateProperty}>
                <div className="form-group">
                  <RequiredLabel>Address</RequiredLabel>
                  <input
                    type="text"
                    className="form-input"
                    value={editingProperty.address}
                    onChange={e => setEditingProperty({...editingProperty, address: e.target.value})}
                    placeholder="123 Main Street"
                    required
                  />
                </div>
                <div className="form-group">
                  <RequiredLabel>Property Type</RequiredLabel>
                  <select
                    className="form-select"
                    value={editingProperty.type || ''}
                    onChange={e => setEditingProperty({...editingProperty, type: e.target.value})}
                    required
                  >
                    <option value="">Select Type</option>
                    <option value="Single Family">Single Family</option>
                    <option value="Multi-Family">Multi-Family</option>
                    <option value="Apartment Complex">Apartment Complex</option>
                    <option value="Commercial">Commercial</option>
                  </select>
                </div>
                <div className="two-col">
                  <div className="form-group">
                    <RequiredLabel>Total Units</RequiredLabel>
                    <input
                      type="number"
                      className="form-input"
                      value={editingProperty.units}
                      onChange={e => setEditingProperty({...editingProperty, units: e.target.value})}
                      placeholder="0"
                      min="0"
                      required
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Occupied Units</label>
                    <input
                      type="number"
                      className="form-input"
                      value={editingProperty.occupied}
                      onChange={e => setEditingProperty({...editingProperty, occupied: e.target.value})}
                      placeholder="0"
                      min="0"
                    />
                  </div>
                </div>
                <div className="form-group">
                  <label className="form-label">Monthly Revenue</label>
                  <input
                    type="number"
                    className="form-input"
                    value={editingProperty.monthlyRevenue}
                    onChange={e => setEditingProperty({...editingProperty, monthlyRevenue: e.target.value})}
                    placeholder="0.00"
                    step="0.01"
                    min="0"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Owner</label>
                  <select
                    className="form-select"
                    value={editingProperty.ownerId || ''}
                    onChange={e => {
                      const ownerId = e.target.value || null;
                      const selectedOwnerObj = ownerId ? owners.find(o => o.id === ownerId) : null;
                      setEditingProperty({
                        ...editingProperty,
                        ownerId: ownerId,
                        ownerName: selectedOwnerObj ? selectedOwnerObj.name : '',
                        ownerEmail: selectedOwnerObj ? selectedOwnerObj.email : ''
                      });
                    }}
                  >
                    <option value="">Self-managed</option>
                    {owners.map(owner => (
                      <option key={owner.id} value={owner.id}>{owner.name}</option>
                    ))}
                  </select>
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={() => setEditingProperty(null)}>
                    Cancel
                  </button>
                  <button type="submit" className="btn btn-primary">
                    Update Property
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {showDeletePropertyConfirm && (
        <div className="modal-overlay" onClick={() => setShowDeletePropertyConfirm(null)}>
          <div className="modal confirmation-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Delete Property</h2>
              <button className="close-btn" onClick={() => setShowDeletePropertyConfirm(null)}>Ã</button>
            </div>
            <div className="confirmation-content">
              <p>Are you sure you want to delete this property?</p>
              <p className="warning-text">This action cannot be undone.</p>
            </div>
            <div className="modal-actions">
              <button 
                type="button" 
                className="btn-secondary" 
                onClick={() => setShowDeletePropertyConfirm(null)}
              >
                Cancel
              </button>
              <button 
                type="button" 
                className="btn-primary" 
                onClick={() => handleDeleteProperty(showDeletePropertyConfirm)}
                style={{ background: '#d93025', borderColor: '#d93025' }}
              >
                Delete Property
              </button>
            </div>
          </div>
        </div>
      )}

      {showAddPropertyModal && (
        <div className="modal-overlay" onClick={() => handleModalClose('property-form', () => setShowAddPropertyModal(false))}>
          <div className="modal form-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Add New Property</h2>
              <button className="close-btn" onClick={() => setShowAddPropertyModal(false)}>Ã</button>
            </div>
            <div className="modal-content">
              <form id="property-form" onSubmit={handleAddProperty}>
                <div className="form-grid">
                <div className="form-group full-width">
                  <RequiredLabel>Address</RequiredLabel>
                  <input
                    type="text"
                    value={newProperty.address}
                    onChange={e => setNewProperty({...newProperty, address: e.target.value})}
                    placeholder="123 Main Street"
                    required
                  />
                </div>
                <div className="form-group">
                  <RequiredLabel>Property Type</RequiredLabel>
                  <select
                    value={newProperty.type}
                    onChange={e => setNewProperty({...newProperty, type: e.target.value})}
                    required
                  >
                    <option value="">Select Type</option>
                    <option value="Single Family">Single Family</option>
                    <option value="Multi-Family">Multi-Family</option>
                    <option value="Apartment Complex">Apartment Complex</option>
                    <option value="Commercial">Commercial</option>
                  </select>
                </div>
                <div className="form-group">
                  <RequiredLabel>Total Units</RequiredLabel>
                  <input
                    type="number"
                    value={newProperty.units}
                    onChange={e => setNewProperty({...newProperty, units: e.target.value})}
                    placeholder="0"
                    min="0"
                    required
                  />
                </div>
                <div className="form-group">
                  <RequiredLabel required={false}>Occupied Units</RequiredLabel>
                  <input
                    type="number"
                    value={newProperty.occupied}
                    onChange={e => setNewProperty({...newProperty, occupied: e.target.value})}
                    placeholder="0"
                    min="0"
                  />
                </div>
                <div className="form-group">
                  <label>Monthly Revenue</label>
                  <input
                    type="number"
                    value={newProperty.monthlyRevenue}
                    onChange={e => setNewProperty({...newProperty, monthlyRevenue: e.target.value})}
                    placeholder="0.00"
                    step="0.01"
                    min="0"
                  />
                </div>
                <div className="form-group full-width">
                  <label>Owner</label>
                  <select
                    value={newProperty.ownerId || ''}
                    onChange={e => {
                      const ownerId = e.target.value || null;
                      const selectedOwnerObj = ownerId ? owners.find(o => o.id === ownerId) : null;
                      setNewProperty({
                        ...newProperty,
                        ownerId: ownerId,
                        ownerName: selectedOwnerObj ? selectedOwnerObj.name : '',
                        ownerEmail: selectedOwnerObj ? selectedOwnerObj.email : ''
                      });
                    }}
                  >
                    <option value="">Self-managed</option>
                    {owners.map(owner => (
                      <option key={owner.id} value={owner.id}>{owner.name}</option>
                    ))}
                  </select>
                </div>
                <div className="form-group full-width">
                  <label>Owner Name (Legacy)</label>
                  <input
                    type="text"
                    value={newProperty.ownerName}
                    onChange={e => setNewProperty({...newProperty, ownerName: e.target.value})}
                    placeholder="Property owner name (for backward compatibility)"
                  />
                </div>
                <div className="form-group full-width">
                  <label>Owner Email (Legacy)</label>
                  <input
                    type="email"
                    value={newProperty.ownerEmail}
                    onChange={e => setNewProperty({...newProperty, ownerEmail: e.target.value})}
                    placeholder="owner@example.com (for backward compatibility)"
                  />
                </div>
                <div className="form-group full-width">
                  <label>Property Photo</label>
                  <div 
                    className="photo-upload-area"
                    onDragOver={(e) => {
                      e.preventDefault();
                      e.currentTarget.classList.add('drag-over');
                    }}
                    onDragLeave={(e) => {
                      e.currentTarget.classList.remove('drag-over');
                    }}
                    onDrop={(e) => {
                      e.preventDefault();
                      e.currentTarget.classList.remove('drag-over');
                      const file = e.dataTransfer.files[0];
                      if (file && file.type.startsWith('image/')) {
                        setNewProperty({...newProperty, photo: file});
                      }
                    }}
                  >
                    {newProperty.photo ? (
                      <div className="photo-preview">
                        <img 
                          src={URL.createObjectURL(newProperty.photo)} 
                          alt="Preview"
                          className="photo-preview-img"
                        />
                        <button
                          type="button"
                          className="photo-remove-btn"
                          onClick={() => setNewProperty({...newProperty, photo: null})}
                        >
                          Ã
                        </button>
                      </div>
                    ) : (
                      <div className="photo-upload-placeholder">
                        <span>ð·</span>
                        <p>Drop photo here or click to select</p>
                      </div>
                    )}
                    <input
                      type="file"
                      accept="image/*"
                      onChange={(e) => {
                        const file = e.target.files[0];
                        if (file) {
                          setNewProperty({...newProperty, photo: file});
                        }
                      }}
                      style={{ display: 'none' }}
                      id="new-property-photo-input"
                    />
                    <label htmlFor="new-property-photo-input" className="photo-upload-label">
                      {newProperty.photo ? 'Change Photo' : 'Select Photo'}
                    </label>
                  </div>
                </div>
                </div>
                <div className="modal-actions">
                  <button type="button" className="btn-secondary" onClick={() => setShowAddPropertyModal(false)}>
                    Cancel
                  </button>
                  <button type="submit" className="btn-primary">
                    Add Property
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {showAddMaintenanceModal && (
        <div className="modal-overlay" onClick={() => handleModalClose('maintenance-form', () => setShowAddMaintenanceModal(false))}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>New Maintenance Request</h2>
              <button className="close-btn" onClick={() => setShowAddMaintenanceModal(false)}>Ã</button>
            </div>
            <div className="modal-body">
              <form id="maintenance-form" onSubmit={handleAddMaintenanceRequest}>
                <div className="form-group">
                  <RequiredLabel>Issue</RequiredLabel>
                  <input
                    type="text"
                    className="form-input"
                    value={newMaintenanceRequest.issue}
                    onChange={e => setNewMaintenanceRequest({...newMaintenanceRequest, issue: e.target.value})}
                    placeholder="e.g., Leaky faucet"
                    required
                  />
                </div>
                <div className="form-group">
                  <RequiredLabel>Property / Unit</RequiredLabel>
                  <input
                    type="text"
                    className="form-input"
                    value={newMaintenanceRequest.property}
                    onChange={e => setNewMaintenanceRequest({...newMaintenanceRequest, property: e.target.value})}
                    placeholder="e.g., 1420 Oak Street, Unit 3B"
                    required
                  />
                </div>
                <div className="two-col">
                  <div className="form-group">
                    <RequiredLabel required={false}>Tenant Name</RequiredLabel>
                    <input
                      type="text"
                      className="form-input"
                      value={newMaintenanceRequest.tenantName}
                      onChange={e => setNewMaintenanceRequest({...newMaintenanceRequest, tenantName: e.target.value})}
                      placeholder="Optional"
                    />
                  </div>
                  <div className="form-group">
                    <RequiredLabel>Priority</RequiredLabel>
                    <select
                      className="form-select"
                      value={newMaintenanceRequest.priority}
                      onChange={e => setNewMaintenanceRequest({...newMaintenanceRequest, priority: e.target.value})}
                      required
                    >
                      <option value="low">Low</option>
                      <option value="medium">Medium</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                </div>
                <div className="form-group">
                  <label className="form-label">Date</label>
                  <input
                    type="date"
                    className="form-input"
                    value={newMaintenanceRequest.date}
                    onChange={e => setNewMaintenanceRequest({...newMaintenanceRequest, date: e.target.value})}
                    required
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Description</label>
                  <textarea
                    className="form-textarea"
                    value={newMaintenanceRequest.description}
                    onChange={e => setNewMaintenanceRequest({...newMaintenanceRequest, description: e.target.value})}
                    rows="3"
                    placeholder="Detailed description of the issue..."
                  />
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={() => setShowAddMaintenanceModal(false)}>
                    Cancel
                  </button>
                  <button type="submit" className="btn btn-primary">
                    Add Request
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {showMoveOutModal && (
        <div className="modal-overlay" onClick={() => handleModalClose('moveout-form', () => setShowMoveOutModal(null))}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Record Move-Out - {tenants.find(t => t.id === showMoveOutModal)?.name}</h2>
              <button className="close-btn" onClick={() => setShowMoveOutModal(null)}>Ã</button>
            </div>
            <form id="moveout-form" onSubmit={(e) => handleMoveOut(showMoveOutModal, e)}>
              <div className="form-grid">
                <div className="form-group">
                  <label>Move-Out Date</label>
                  <input
                    type="date"
                    value={moveOutData.date}
                    onChange={e => setMoveOutData({...moveOutData, date: e.target.value})}
                    required
                  />
                </div>
                <div className="form-group full-width">
                  <label>Move-Out Condition Notes</label>
                  <textarea
                    value={moveOutData.notes}
                    onChange={e => setMoveOutData({...moveOutData, notes: e.target.value})}
                    rows="3"
                    placeholder="Describe the condition of the property at move-out..."
                  />
                </div>
                <div className="form-group full-width">
                  <label>Deposit Deductions</label>
                  {moveOutData.deductions.map((deduction, index) => (
                    <div key={index} style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem', alignItems: 'flex-end' }}>
                      <div style={{ flex: 2 }}>
                        <input
                          type="text"
                          value={deduction.description}
                          onChange={e => {
                            const newDeductions = [...moveOutData.deductions];
                            newDeductions[index].description = e.target.value;
                            setMoveOutData({...moveOutData, deductions: newDeductions});
                          }}
                          placeholder="Description (e.g., Carpet cleaning, Wall repair)"
                          style={{ width: '100%' }}
                        />
                      </div>
                      <div style={{ flex: 1 }}>
                        <input
                          type="number"
                          value={deduction.amount}
                          onChange={e => {
                            const newDeductions = [...moveOutData.deductions];
                            newDeductions[index].amount = e.target.value;
                            setMoveOutData({...moveOutData, deductions: newDeductions});
                          }}
                          placeholder="Amount"
                          step="0.01"
                          min="0"
                          style={{ width: '100%' }}
                        />
                      </div>
                      {moveOutData.deductions.length > 1 && (
                        <button
                          type="button"
                          className="btn-danger btn-small"
                          onClick={() => {
                            const newDeductions = moveOutData.deductions.filter((_, i) => i !== index);
                            setMoveOutData({...moveOutData, deductions: newDeductions});
                          }}
                        >
                          Ã
                        </button>
                      )}
                    </div>
                  ))}
                  <button
                    type="button"
                    className="btn-secondary"
                    onClick={() => setMoveOutData({...moveOutData, deductions: [...moveOutData.deductions, { description: '', amount: '' }]})}
                    style={{ marginTop: '0.5rem' }}
                  >
                    + Add Deduction
                  </button>
                </div>
                {(() => {
                  const tenant = tenants.find(t => t.id === showMoveOutModal);
                  if (!tenant) return null;
                  const totalDeductions = moveOutData.deductions
                    .filter(d => d.description && d.amount)
                    .reduce((sum, d) => sum + Number(d.amount) || 0, 0);
                  const refundAmount = Math.max(0, tenant.securityDeposit - totalDeductions);
                  return (
                    <div className="form-group full-width" style={{ padding: '1rem', background: '#f8fafc', borderRadius: '6px', marginTop: '1rem' }}>
                      <p><strong>Security Deposit:</strong> ${tenant.securityDeposit.toLocaleString()}</p>
                      <p><strong>Total Deductions:</strong> ${totalDeductions.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                      <p style={{ fontSize: '1.1rem', marginTop: '0.5rem' }}>
                        <strong>Refund Amount:</strong> ${refundAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                      </p>
                    </div>
                  );
                })()}
              </div>
              <div className="modal-actions">
                <button type="button" className="btn-secondary" onClick={() => setShowMoveOutModal(null)}>
                  Cancel
                </button>
                <button type="submit" className="btn-primary">
                  Record Move-Out
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {showReminderModal && (
        <div className="modal-overlay" onClick={() => handleModalClose('reminder-form', () => setShowReminderModal(null))}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Send Rent Reminder</h2>
              <button className="close-btn" onClick={() => setShowReminderModal(null)}>Ã</button>
            </div>
            <div className="modal-content">
              <form id="reminder-form" style={{ display: 'none' }}></form>
              <div className="reminder-email-preview">
                <div className="email-field">
                  <label><strong>To:</strong></label>
                  <span>{showReminderModal.email}</span>
                </div>
                <div className="email-field">
                  <label><strong>Subject:</strong></label>
                  <span>Rent Payment Reminder - {showReminderModal.property}</span>
                </div>
                <div className="email-field">
                  <label><strong>Body:</strong></label>
                  <div className="email-body-preview">
                    <p>Dear {showReminderModal.name},</p>
                    <p>This is a reminder that your rent payment for {showReminderModal.property} is currently overdue.</p>
                    <p><strong>Amount Due:</strong> ${showReminderModal.rentAmount.toLocaleString()}</p>
                    <p><strong>Property:</strong> {showReminderModal.property}</p>
                    <p>Please remit payment as soon as possible to avoid any additional fees.</p>
                    <p>Thank you,<br />Property Management</p>
                  </div>
                </div>
              </div>
              <div className="modal-actions">
                <button 
                  type="button" 
                  className="btn-secondary" 
                  onClick={() => setShowReminderModal(null)}
                >
                  Cancel
                </button>
                <button 
                  type="button" 
                  className="btn-primary" 
                  onClick={() => {
                    handleSendReminder(showReminderModal);
                    setShowReminderModal(null);
                  }}
                >
                  Open Email Client
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {selectedProperty && (
        <>
          <div className="panel-overlay" onClick={() => setSelectedProperty(null)}></div>
          <div className="slide-panel" onClick={e => e.stopPropagation()}>
            <div className="slide-panel-header">
              <h2>Property Details</h2>
              <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                <button 
                  className="btn-text"
                  onClick={(e) => {
                    e.stopPropagation();
                    setEditingProperty({
                      ...selectedProperty,
                      units: String(selectedProperty.units || ''),
                      occupied: String(selectedProperty.occupied || ''),
                      monthlyRevenue: String(selectedProperty.monthlyRevenue || ''),
                      photo: null
                    });
                    setSelectedProperty(null);
                  }}
                >
                  Edit
                </button>
                <button className="close-btn" onClick={() => setSelectedProperty(null)}>Ã</button>
              </div>
            </div>
            <div className="slide-panel-body">
              {/* Property Avatar/Icon with Photo Upload */}
              <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '24px' }}>
                <div 
                  onClick={() => document.getElementById('property-photo-input-detail').click()}
                  className="avatar avatar-lg"
                  style={{ 
                    background: selectedProperty.photoUrl ? 'transparent' : getAvatarColorByName(selectedProperty.address),
                    backgroundImage: selectedProperty.photoUrl ? `url(${selectedProperty.photoUrl})` : 'none',
                    backgroundSize: 'cover',
                    backgroundPosition: 'center',
                    cursor: 'pointer',
                    position: 'relative',
                    border: '3px solid white',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                  }}
                >
                  {!selectedProperty.photoUrl && (
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                      <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                  )}
                  <div style={{
                    position: 'absolute',
                    bottom: 0,
                    right: 0,
                    width: '28px',
                    height: '28px',
                    borderRadius: '50%',
                    background: '#1a73e8',
                    border: '2px solid white',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                  }}>
                    <span style={{ color: 'white', fontSize: '14px' }}>ð·</span>
                  </div>
                </div>
                <input
                  id='property-photo-input-detail'
                  type='file'
                  accept='image/*'
                  style={{ display: 'none' }}
                  onChange={async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                      await handlePropertyPhotoUpdate(selectedProperty.id, file);
                      // Reload property data
                      const { data: propertyData } = await supabase
                        .from('properties')
                        .select('*')
                        .eq('id', selectedProperty.id)
                        .single();
                      if (propertyData) {
                        setSelectedProperty(transformProperty(propertyData));
                      }
                    } catch (err) {
                      console.error('Upload failed:', err);
                      alert('Failed to upload photo');
                    }
                    e.target.value = ''; // Reset input
                  }}
                />
              </div>

              {/* Property Name */}
              <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#111827', textAlign: 'center', marginBottom: '12px' }}>
                {selectedProperty.address}
              </h2>

              {/* Status Badge */}
              <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '24px' }}>
                <span className={`badge ${(selectedProperty.units || 0) - (selectedProperty.occupied || 0) === 0 ? 'badge-late' : 'badge-current'}`}>
                  {(selectedProperty.units || 0) - (selectedProperty.occupied || 0) === 0 ? 'Full' : 'Available'}
                </span>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* ADDRESS */}
              <div style={{ marginBottom: '24px' }}>
                <span className="section-label">ADDRESS</span>
                <div className="section-value">{selectedProperty.address}</div>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* TYPE */}
              <div style={{ marginBottom: '24px' }}>
                <span className="section-label">TYPE</span>
                <div className="section-value">{selectedProperty.type || 'Not specified'}</div>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* UNITS */}
              <div style={{ marginBottom: '24px' }}>
                <span className="section-label">UNITS</span>
                <div className="section-value">
                  {selectedProperty.occupied || 0} / {selectedProperty.units || 0} occupied
                </div>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* MONTHLY REVENUE */}
              <div style={{ marginBottom: '24px' }}>
                <span className="section-label">MONTHLY REVENUE</span>
                <div className="section-value">${(selectedProperty.monthlyRevenue || 0).toLocaleString()}</div>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* TAGS */}
              <div style={{ marginBottom: '24px' }}>
                <span className="section-label">TAGS</span>
                <div style={{ marginTop: '8px' }}>
                  <TagPicker
                    recordType="property"
                    recordId={selectedProperty.id}
                    onTagsChange={async () => {
                      await refreshData();
                      const { data: propertyData } = await supabase
                        .from('properties')
                        .select('*')
                        .eq('id', selectedProperty.id)
                        .single();
                      if (propertyData) {
                        setSelectedProperty(transformProperty(propertyData));
                      }
                    }}
                  />
                </div>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* Files Section */}
              <div style={{ marginBottom: '24px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                  <span className="section-label">FILES</span>
                  <button
                    onClick={() => document.getElementById('property-file-input').click()}
                    className="btn-text"
                    style={{ fontSize: '12px', padding: '4px 8px' }}
                  >
                    + Add File
                  </button>
                </div>
                <input
                  id='property-file-input'
                  type='file'
                  multiple
                  accept='.pdf,.doc,.docx,.jpg,.png,.jpeg'
                  style={{ display: 'none' }}
                  onChange={async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;
                    
                    try {
                      for (const file of files) {
                        await uploadDocument(file, 'property', selectedProperty.id, 'document');
                      }
                      const updated = await loadFilesForRecord('property', selectedProperty.id);
                      setPropertyFiles(updated);
                    } catch (err) {
                      console.error('Upload failed:', err);
                      alert('Failed to upload file(s)');
                    }
                    e.target.value = ''; // Reset input
                  }}
                />
                {propertyFiles.length === 0 ? (
                  <p style={{ color: '#9ca3af', fontSize: '14px' }}>No files uploaded</p>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {propertyFiles.map(file => (
                      <div 
                        key={file.id} 
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          padding: '10px 12px',
                          background: '#f9fafb',
                          borderRadius: '8px',
                          border: '1px solid #e5e7eb'
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', flex: 1, minWidth: 0 }}>
                          <span style={{ fontSize: '18px', flexShrink: 0 }}>ð</span>
                          <span style={{ fontSize: '14px', color: '#374151', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                            {file.file_name}
                          </span>
                          <span style={{ fontSize: '12px', color: '#9ca3af', marginLeft: '8px' }}>
                            {file.file_size ? `${(file.file_size / 1024).toFixed(1)} KB` : ''}
                          </span>
                        </div>
                        <div style={{ display: 'flex', gap: '8px', flexShrink: 0 }}>
                          <button 
                            onClick={async (e) => {
                              e.stopPropagation();
                              try {
                                const url = await getDocumentUrl(file.storage_path);
                                window.open(url, '_blank');
                              } catch (err) {
                                console.error('Error downloading file:', err);
                                alert('Failed to download file');
                              }
                            }} 
                            className="btn-text"
                            style={{ padding: '4px 8px', fontSize: '14px' }}
                            title="Download"
                          >
                            â¬ï¸
                          </button>
                          <button 
                            onClick={async (e) => {
                              e.stopPropagation();
                              if (confirm('Are you sure you want to delete this file?')) {
                                try {
                                  await deleteFile(file.id, file.storage_path);
                                  setPropertyFiles(propertyFiles.filter(f => f.id !== file.id));
                                } catch (err) {
                                  console.error('Error deleting file:', err);
                                  alert('Failed to delete file');
                                }
                              }
                            }} 
                            className="btn-text"
                            style={{ padding: '4px 8px', fontSize: '14px', color: '#dc2626' }}
                            title="Delete"
                          >
                            ðï¸
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
            <div className="slide-panel-footer">
              <button 
                className="btn btn-primary"
                onClick={(e) => {
                  e.stopPropagation();
                  setEditingProperty({
                    ...selectedProperty,
                    units: String(selectedProperty.units || ''),
                    occupied: String(selectedProperty.occupied || ''),
                    monthlyRevenue: String(selectedProperty.monthlyRevenue || ''),
                    photo: null
                  });
                  setSelectedProperty(null);
                }}
              >
                Edit Property
              </button>
              <button 
                className="btn btn-secondary"
                onClick={(e) => {
                  e.stopPropagation();
                  setSelectedProperty(null);
                  setActiveTab('tenants');
                  setFilterStatus('all');
                  setTenantSearchQuery(selectedProperty.address);
                }}
              >
                View Tenants
              </button>
            </div>
          </div>
        </>
      )}

      {/* Maintenance Request Detail Panel */}
      {selectedMaintenanceRequest && (
        <>
          <div className="panel-overlay" onClick={() => setSelectedMaintenanceRequest(null)}></div>
          <div className="slide-panel" onClick={e => e.stopPropagation()}>
            <div className="slide-panel-header">
              <div>
                <h2>{selectedMaintenanceRequest.issue}</h2>
                <div style={{ display: 'flex', gap: '8px', marginTop: '8px' }}>
                  <span className="badge" style={getPriorityBadgeStyle(selectedMaintenanceRequest.priority)}>
                    {(selectedMaintenanceRequest.priority || 'medium').toUpperCase()}
                  </span>
                  <span className="badge" style={getMaintenanceStatusBadgeStyle(selectedMaintenanceRequest.status)}>
                    {getMaintenanceStatusDisplay(selectedMaintenanceRequest.status)}
                  </span>
                </div>
              </div>
              <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                <button className="close-btn" onClick={() => {
                  setSelectedMaintenanceRequest(null);
                  setShowStatusDropdown(false);
                  setShowVendorInput(false);
                }}>Ã</button>
              </div>
            </div>
            <div className="slide-panel-body">
              {/* PROPERTY */}
              <div style={{ marginBottom: '24px' }}>
                <span className="section-label">PROPERTY</span>
                <div className="section-value">{selectedMaintenanceRequest.property || 'Not specified'}</div>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* TENANT */}
              <div style={{ marginBottom: '24px' }}>
                <span className="section-label">TENANT</span>
                <div className="section-value">{selectedMaintenanceRequest.tenantName || 'Not specified'}</div>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* CREATED */}
              <div style={{ marginBottom: '24px' }}>
                <span className="section-label">CREATED</span>
                <div className="section-value">
                  {selectedMaintenanceRequest.date ? new Date(selectedMaintenanceRequest.date).toLocaleDateString() : 'N/A'}
                </div>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* DESCRIPTION */}
              {selectedMaintenanceRequest.description && (
                <>
                  <div style={{ marginBottom: '24px' }}>
                    <span className="section-label">DESCRIPTION</span>
                    <div className="section-value" style={{ marginTop: '8px', lineHeight: '1.5' }}>
                      {selectedMaintenanceRequest.description}
                    </div>
                  </div>
                  <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>
                </>
              )}

              {/* TAGS */}
              <div style={{ marginBottom: '24px' }}>
                <span className="section-label">TAGS</span>
                <div style={{ marginTop: '8px' }}>
                  <TagPicker
                    recordType="maintenance"
                    recordId={selectedMaintenanceRequest.id}
                    onTagsChange={async () => {
                      await refreshData();
                      const { data: maintenanceData } = await supabase
                        .from('maintenance_requests')
                        .select('*')
                        .eq('id', selectedMaintenanceRequest.id)
                        .single();
                      if (maintenanceData) {
                        setSelectedMaintenanceRequest(transformMaintenanceRequest(maintenanceData));
                      }
                    }}
                  />
                </div>
              </div>

              <div style={{ height: '1px', background: '#e5e7eb', marginBottom: '24px' }}></div>

              {/* Vendor Assignment Section */}
              <div style={{ marginTop: '20px', padding: '16px', background: '#f8fafc', borderRadius: '10px' }}>
                <h4 style={{ margin: '0 0 12px', fontSize: '14px', fontWeight: '600', color: '#374151' }}>
                  Assigned Vendor
                </h4>
                {selectedMaintenanceRequest.vendor_id ? (
                  <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{
                          width: '40px',
                          height: '40px',
                          borderRadius: '8px',
                          background: '#e2e8f0',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: '#64748b'
                        }}>
                          {(() => {
                            const vendor = vendors.find(v => v.id === selectedMaintenanceRequest.vendor_id);
                            if (vendor) {
                              const specialtyInfo = getSpecialtyInfo(vendor.specialty);
                              return specialtyInfo.icon;
                            }
                            return <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>;
                          })()}
                        </div>
                        <div>
                          <p style={{ margin: 0, fontSize: '14px', fontWeight: '500', color: '#1e293b' }}>
                            {vendors.find(v => v.id === selectedMaintenanceRequest.vendor_id)?.name || 'Unknown Vendor'}
                          </p>
                          <p style={{ margin: '2px 0 0', fontSize: '12px', color: '#64748b' }}>
                            {vendors.find(v => v.id === selectedMaintenanceRequest.vendor_id)?.company || 
                             getSpecialtyInfo(vendors.find(v => v.id === selectedMaintenanceRequest.vendor_id)?.specialty)?.label}
                          </p>
                          {selectedMaintenanceRequest.vendor_cost && (
                            <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#1a73e8', fontWeight: '500' }}>
                              Cost: ${Number(selectedMaintenanceRequest.vendor_cost).toLocaleString()}
                            </p>
                          )}
                        </div>
                      </div>
                      <button
                        onClick={() => assignVendorToMaintenance(selectedMaintenanceRequest.id, null, null)}
                        style={{
                          padding: '6px 12px',
                          background: 'white',
                          border: '1px solid #fecaca',
                          borderRadius: '6px',
                          fontSize: '12px',
                          cursor: 'pointer',
                          color: '#dc2626'
                        }}
                      >
                        Remove
                      </button>
                    </div>
                    <button
                      onClick={() => {
                        const vendor = vendors.find(v => v.id === selectedMaintenanceRequest.vendor_id);
                        if (vendor && vendor.email) {
                          const property = properties.find(p => p.id === selectedMaintenanceRequest.property_id);
                          const subject = encodeURIComponent(`Work Order: ${selectedMaintenanceRequest.title}`);
                          const body = encodeURIComponent(
`Hello ${vendor.name},

You have been assigned a new work order.

Property: ${property?.name || 'N/A'}
Issue: ${selectedMaintenanceRequest.title}
Description: ${selectedMaintenanceRequest.description || 'No description provided'}
Priority: ${selectedMaintenanceRequest.priority || 'Normal'}

Please contact us to schedule the work.

Thank you.`
                          );
                          window.open(`mailto:${vendor.email}?subject=${subject}&body=${body}`, '_blank');
                        } else {
                          alert('No email address on file for this vendor.');
                        }
                      }}
                      style={{
                        width: '100%',
                        padding: '10px',
                        background: '#1a73e8',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '13px',
                        fontWeight: '500',
                        cursor: 'pointer',
                        color: 'white',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '8px'
                      }}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                      Email Work Order to Vendor
                    </button>
                  </div>
                ) : (
                  <div>
                    <select
                      id="vendor-select"
                      defaultValue=""
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white',
                        boxSizing: 'border-box',
                        marginBottom: '12px'
                      }}
                    >
                      <option value="">Select a vendor...</option>
                      {vendors
                        .filter(v => v.status === 'active')
                        .map(v => (
                          <option key={v.id} value={v.id}>
                            {v.name} ({v.company || getSpecialtyInfo(v.specialty).label})
                          </option>
                        ))}
                    </select>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      <button
                        onClick={async () => {
                          const select = document.getElementById('vendor-select');
                          const vendorId = select?.value;
                          if (!vendorId) {
                            alert('Please select a vendor first.');
                            return;
                          }
                          const cost = prompt('Enter estimated cost (optional):');
                          await assignVendorToMaintenance(
                            selectedMaintenanceRequest.id,
                            Number(vendorId),
                            cost ? Number(cost) : null
                          );
                          
                          // Ask to send email
                          const vendor = vendors.find(v => v.id === Number(vendorId));
                          if (vendor?.email) {
                            if (confirm(`Vendor assigned. Would you like to email the work order to ${vendor.name}?`)) {
                              const property = properties.find(p => p.id === selectedMaintenanceRequest.property_id);
                              const subject = encodeURIComponent(`Work Order: ${selectedMaintenanceRequest.title}`);
                              const body = encodeURIComponent(
`Hello ${vendor.name},

You have been assigned a new work order.

Property: ${property?.name || 'N/A'}
Issue: ${selectedMaintenanceRequest.title}
Description: ${selectedMaintenanceRequest.description || 'No description provided'}
Priority: ${selectedMaintenanceRequest.priority || 'Normal'}

Please contact us to schedule the work.

Thank you.`
                              );
                              window.open(`mailto:${vendor.email}?subject=${subject}&body=${body}`, '_blank');
                            }
                          }
                        }}
                        style={{
                          flex: 1,
                          padding: '10px',
                          background: '#1a73e8',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '13px',
                          fontWeight: '500',
                          cursor: 'pointer',
                          color: 'white'
                        }}
                      >
                        Assign Vendor
                      </button>
                    </div>
                    {vendors.filter(v => v.status === 'active').length === 0 && (
                      <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#64748b' }}>
                        No active vendors. <span 
                          onClick={() => setActiveTab('vendors')} 
                          style={{ color: '#1a73e8', cursor: 'pointer' }}
                        >Add a vendor</span> first.
                      </p>
                    )}
                  </div>
                )}
              </div>

            </div>
            <div className="slide-panel-footer" style={{ position: 'relative' }}>
              <div style={{ position: 'relative' }}>
                <button 
                  className="btn btn-secondary" 
                  onClick={(e) => {
                    e.stopPropagation();
                    setShowStatusDropdown(!showStatusDropdown);
                    setShowVendorInput(false);
                  }}
                >
                  Update Status
                </button>
                {showStatusDropdown && (
                  <div 
                    style={{ 
                      position: 'absolute', 
                      bottom: '100%', 
                      left: 0, 
                      background: 'white', 
                      border: '1px solid #e5e7eb', 
                      borderRadius: 8, 
                      boxShadow: '0 4px 12px rgba(0,0,0,0.1)', 
                      padding: 8, 
                      marginBottom: 4,
                      zIndex: 1000,
                      minWidth: '150px'
                    }}
                    onClick={(e) => e.stopPropagation()}
                  >
                    {['Pending', 'In Progress', 'Completed'].map(status => (
                      <button 
                        key={status}
                        onClick={() => { 
                          updateMaintenanceStatus(selectedMaintenanceRequest.id, status); 
                          setShowStatusDropdown(false); 
                        }}
                        style={{ 
                          display: 'block', 
                          width: '100%', 
                          padding: '8px 16px', 
                          textAlign: 'left', 
                          border: 'none', 
                          background: 'none', 
                          cursor: 'pointer',
                          borderRadius: 4,
                          fontSize: 14,
                          color: '#111827'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.background = '#f3f4f6'}
                        onMouseLeave={(e) => e.currentTarget.style.background = 'none'}
                      >
                        {status}
                      </button>
                    ))}
                  </div>
                )}
              </div>
              <button 
                className="btn btn-primary" 
                onClick={(e) => {
                  e.stopPropagation();
                  setShowStatusDropdown(false);
                  setShowVendorInput(false);
                  setNewMaintenanceRequest({
                    tenantId: selectedMaintenanceRequest.tenantId || '',
                    tenantName: selectedMaintenanceRequest.tenantName || '',
                    property: selectedMaintenanceRequest.property || '',
                    issue: selectedMaintenanceRequest.issue || '',
                    priority: selectedMaintenanceRequest.priority || 'medium',
                    description: selectedMaintenanceRequest.description || '',
                    date: selectedMaintenanceRequest.date || new Date().toISOString().split('T')[0],
                    id: selectedMaintenanceRequest.id
                  });
                  setShowAddMaintenanceModal(true);
                }}
              >
                Edit
              </button>
              <button className="btn btn-danger" onClick={(e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this maintenance request?')) {
                  // TODO: Delete
                }
              }}>
                Delete
              </button>
            </div>
          </div>
        </>
      )}

      {/* Add Owner Modal */}
      {showAddOwnerModal && (
        <div className="modal-overlay" onClick={() => handleModalClose('owner-form', () => setShowAddOwnerModal(false))}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Add Owner</h2>
              <button className="close-btn" onClick={() => setShowAddOwnerModal(false)}>Ã</button>
            </div>
            <div className="modal-body">
              <form id="owner-form" onSubmit={handleAddOwner}>
                <div className="form-group">
                  <label className="form-label">Name *</label>
                  <input
                    type="text"
                    className="form-input"
                    value={newOwner.name}
                    onChange={e => setNewOwner({...newOwner, name: e.target.value})}
                    required
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Email *</label>
                  <input
                    type="email"
                    className="form-input"
                    value={newOwner.email}
                    onChange={e => setNewOwner({...newOwner, email: e.target.value})}
                    required
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Phone</label>
                  <input
                    type="tel"
                    className="form-input"
                    value={newOwner.phone}
                    onChange={e => setNewOwner({...newOwner, phone: e.target.value})}
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Management Fee %</label>
                  <input
                    type="number"
                    className="form-input"
                    value={newOwner.managementFeePercent}
                    onChange={e => setNewOwner({...newOwner, managementFeePercent: parseFloat(e.target.value) || 10})}
                    min="0"
                    max="100"
                    step="0.01"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Mailing Address</label>
                  <input
                    type="text"
                    className="form-input"
                    value={newOwner.address}
                    onChange={e => setNewOwner({...newOwner, address: e.target.value})}
                  />
                </div>
                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', fontSize: '14px', color: '#374151' }}>
                    <input
                      type="checkbox"
                      checked={newOwner.portalEnabled}
                      onChange={e => setNewOwner({...newOwner, portalEnabled: e.target.checked})}
                      style={{ cursor: 'pointer' }}
                    />
                    Enable Owner Portal
                  </label>
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={() => setShowAddOwnerModal(false)}>
                    Cancel
                  </button>
                  <button type="submit" className="btn btn-primary">
                    Save Owner
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* Edit Owner Modal */}
      {showEditOwnerModal && selectedOwner && (
        <div className="modal-overlay" onClick={() => handleModalClose('edit-owner-form', () => {
          setShowEditOwnerModal(false);
          setSelectedOwner(null);
        })}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Edit Owner</h2>
              <button className="close-btn" onClick={() => {
                setShowEditOwnerModal(false);
                setSelectedOwner(null);
              }}>Ã</button>
            </div>
            <div className="modal-body">
              <form id="edit-owner-form" onSubmit={handleUpdateOwner}>
                <div className="form-group">
                  <label className="form-label">Name *</label>
                  <input
                    type="text"
                    className="form-input"
                    value={selectedOwner.name}
                    onChange={e => setSelectedOwner({...selectedOwner, name: e.target.value})}
                    required
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Email *</label>
                  <input
                    type="email"
                    className="form-input"
                    value={selectedOwner.email}
                    onChange={e => setSelectedOwner({...selectedOwner, email: e.target.value})}
                    required
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Phone</label>
                  <input
                    type="tel"
                    className="form-input"
                    value={selectedOwner.phone}
                    onChange={e => setSelectedOwner({...selectedOwner, phone: e.target.value})}
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Management Fee %</label>
                  <input
                    type="number"
                    className="form-input"
                    value={selectedOwner.managementFeePercent}
                    onChange={e => setSelectedOwner({...selectedOwner, managementFeePercent: parseFloat(e.target.value) || 10})}
                    min="0"
                    max="100"
                    step="0.01"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Mailing Address</label>
                  <input
                    type="text"
                    className="form-input"
                    value={selectedOwner.address}
                    onChange={e => setSelectedOwner({...selectedOwner, address: e.target.value})}
                  />
                </div>
                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', fontSize: '14px', color: '#374151' }}>
                    <input
                      type="checkbox"
                      checked={selectedOwner.portalEnabled}
                      onChange={e => handleToggleOwnerPortal(selectedOwner.id, e.target.checked)}
                      style={{ cursor: 'pointer' }}
                    />
                    Enable Owner Portal
                  </label>
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={() => {
                    setShowEditOwnerModal(false);
                    setSelectedOwner(null);
                  }}>
                    Cancel
                  </button>
                  <button type="submit" className="btn btn-primary">
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* Owner Detail Modal with Portal Management */}
      {showOwnerDetailModal && selectedOwner && (
        <div className='panel-overlay' onClick={() => setShowOwnerDetailModal(false)}>
          <div className='slide-panel' onClick={e => e.stopPropagation()} style={{ width: 500 }}>
            <div className='panel-header'>
              <h2>Owner Details</h2>
              <button className='close-btn' onClick={() => setShowOwnerDetailModal(false)}>Ã</button>
            </div>
            
            <div className='panel-body' style={{ padding: 24 }}>
              {/* Owner Info */}
              <div style={{ textAlign: 'center', marginBottom: 24 }}>
                <div style={{
                  width: 80,
                  height: 80,
                  borderRadius: 16,
                  background: '#e8f0fe',
                  color: '#1a73e8',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontWeight: 700,
                  fontSize: 28,
                  margin: '0 auto 16px'
                }}>
                  {selectedOwner.name?.split(' ').map(n => n[0]).join('').slice(0, 2)}
                </div>
                <h3 style={{ fontSize: 20, fontWeight: 600, margin: '0 0 4px' }}>{selectedOwner.name}</h3>
                <p style={{ color: '#6b7280', margin: 0 }}>{selectedOwner.email}</p>
                {selectedOwner.phone && <p style={{ color: '#6b7280', margin: '4px 0 0' }}>{selectedOwner.phone}</p>}
              </div>
              
              {/* Portal Status */}
              <div style={{ background: '#f9fafb', padding: 16, borderRadius: 8, marginBottom: 24 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div>
                    <p style={{ fontWeight: 600, margin: 0 }}>Owner Portal</p>
                    <p style={{ fontSize: 13, color: '#6b7280', margin: '4px 0 0' }}>
                      {selectedOwner.portalEnabled ? 'Owner can log in to view their properties' : 'Portal access is disabled'}
                    </p>
                  </div>
                  <button
                    onClick={() => toggleOwnerPortal(selectedOwner)}
                    style={{
                      padding: '8px 16px',
                      borderRadius: 6,
                      border: 'none',
                      background: selectedOwner.portalEnabled ? '#fee2e2' : '#d1fae5',
                      color: selectedOwner.portalEnabled ? '#991b1b' : '#065f46',
                      cursor: 'pointer',
                      fontWeight: 500
                    }}
                  >
                    {selectedOwner.portalEnabled ? 'Disable' : 'Enable'}
                  </button>
                </div>
                
                {selectedOwner.portalEnabled && (
                  <div style={{ marginTop: 12, padding: 12, background: 'white', borderRadius: 6 }}>
                    <p style={{ fontSize: 12, color: '#6b7280', margin: '0 0 4px' }}>Portal Login URL</p>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <input
                        type='text'
                        readOnly
                        value={`${window.location.origin}/owner-portal`}
                        style={{ flex: 1, padding: 8, border: '1px solid #e5e7eb', borderRadius: 4, fontSize: 13 }}
                      />
                      <button
                        onClick={() => {
                          navigator.clipboard.writeText(`${window.location.origin}/owner-portal`);
                          showToast('Link copied!', 'success');
                        }}
                        className='btn-secondary'
                        style={{ fontSize: 13 }}
                      >
                        Copy
                      </button>
                    </div>
                  </div>
                )}
              </div>
              
              {/* Assigned Properties */}
              <div style={{ marginBottom: 24 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                  <p style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', margin: 0 }}>Assigned Properties</p>
                  <span
                    onClick={() => setShowAssignPropertyModal(true)}
                    style={{ 
                      color: '#1a73e8', 
                      cursor: 'pointer', 
                      fontSize: 14,
                      fontWeight: 500
                    }}
                  >
                    + Assign Property
                  </span>
                </div>
                
                {getOwnerPropertiesById(selectedOwner.id).length > 0 ? (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                    {getOwnerPropertiesById(selectedOwner.id).map(prop => (
                      <div
                        key={prop.id}
                        style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          padding: 12,
                          background: '#f9fafb',
                          borderRadius: 8
                        }}
                      >
                        <div>
                          <p style={{ fontWeight: 500, margin: 0 }}>{prop.name || prop.address}</p>
                          <p style={{ fontSize: 13, color: '#6b7280', margin: '2px 0 0' }}>
                            {prop.type || 'Property'} â¢ {prop.units || 1} units
                          </p>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                          <span style={{ fontSize: 14, fontWeight: 600, color: '#1a73e8' }}>
                            {prop.ownership_percentage || 100}%
                          </span>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              unassignProperty(selectedOwner.id, prop.id);
                            }}
                            style={{
                              background: 'none',
                              border: 'none',
                              color: '#dc2626',
                              cursor: 'pointer',
                              fontSize: 18,
                              padding: '4px 8px',
                              borderRadius: 4,
                              lineHeight: 1
                            }}
                            onMouseEnter={(e) => e.target.style.background = '#fee2e2'}
                            onMouseLeave={(e) => e.target.style.background = 'none'}
                          >
                            Ã
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p style={{ color: '#9ca3af', fontSize: 14 }}>No properties assigned to this owner</p>
                )}
              </div>
              
              {/* Financial Summary */}
              <div style={{ marginBottom: 24 }}>
                <p style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 12 }}>Financial Summary</p>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                  <div style={{ background: '#f0fdf4', padding: 16, borderRadius: 8 }}>
                    <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Total Monthly Revenue</p>
                    <p style={{ fontSize: 24, fontWeight: 700, color: '#10b981', margin: '4px 0 0' }}>
                      ${getOwnerRevenue(selectedOwner.id).toLocaleString()}
                    </p>
                  </div>
                  <div style={{ background: '#fef3c7', padding: 16, borderRadius: 8 }}>
                    <p style={{ fontSize: 12, color: '#6b7280', margin: 0 }}>Management Fee ({selectedOwner.managementFeePercent || 10}%)</p>
                    <p style={{ fontSize: 24, fontWeight: 700, color: '#f59e0b', margin: '4px 0 0' }}>
                      ${Math.round(getOwnerRevenue(selectedOwner.id) * (selectedOwner.managementFeePercent || 10) / 100).toLocaleString()}
                    </p>
                  </div>
                </div>
              </div>
              
              {/* Recent Distributions */}
              <div>
                <p style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 12 }}>Recent Distributions</p>
                {getOwnerDistributionsById(selectedOwner.id).length > 0 ? (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                    {getOwnerDistributionsById(selectedOwner.id).slice(0, 5).map(dist => (
                      <div
                        key={dist.id}
                        style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          padding: 12,
                          background: '#f9fafb',
                          borderRadius: 8
                        }}
                      >
                        <div>
                          <p style={{ fontWeight: 500, margin: 0 }}>
                            {new Date(dist.period_start).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
                          </p>
                          <p style={{ fontSize: 12, color: '#6b7280', margin: '2px 0 0' }}>
                            {dist.status === 'paid' ? `Paid ${new Date(dist.payment_date).toLocaleDateString()}` : 'Pending'}
                          </p>
                        </div>
                        <span style={{
                          fontWeight: 600,
                          color: dist.status === 'paid' ? '#10b981' : '#f59e0b'
                        }}>
                          ${parseFloat(dist.amount).toLocaleString()}
                        </span>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p style={{ color: '#9ca3af', fontSize: 14 }}>No distributions yet</p>
                )}
              </div>
            </div>
            
            <div className='panel-footer' style={{ padding: 16, borderTop: '1px solid #e5e7eb', display: 'flex', gap: 12 }}>
              <button className='btn-secondary' onClick={() => setShowOwnerDetailModal(false)} style={{ flex: 1 }}>Close</button>
              <button className='btn-primary' onClick={() => openOwnerStatement(selectedOwner)} style={{ flex: 1 }}>
                Generate Statement
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Assign Property Modal */}
      {showAssignPropertyModal && selectedOwner && (
        <div className='modal-overlay' onClick={() => handleModalClose('assign-property-form', () => setShowAssignPropertyModal(false))} style={{ zIndex: 1100 }}>
          <div className='modal' onClick={e => e.stopPropagation()} style={{ maxWidth: 450 }}>
            <div className='modal-header'>
              <h2>Assign Property to {selectedOwner.name}</h2>
              <button className='close-btn' onClick={() => setShowAssignPropertyModal(false)}>Ã</button>
            </div>
            <div className='modal-body'>
              <form id="assign-property-form">
                <div className='form-group'>
                  <label className='form-label'>Select Property</label>
                  <select
                    name="property_id"
                    className='form-select'
                    value={assignPropertyId}
                    onChange={(e) => setAssignPropertyId(e.target.value)}
                    style={{ width: '100%', padding: '10px 12px', border: '1px solid #dadce0', borderRadius: 4, fontSize: 14 }}
                  >
                    <option value=''>Choose a property...</option>
                    {properties
                      .filter(p => !getOwnerPropertiesById(selectedOwner.id).find(op => op.id === p.id))
                      .map(p => (
                        <option key={p.id} value={p.id}>{p.name || p.address}</option>
                      ))
                    }
                  </select>
                </div>
                
                <div className='form-group' style={{ marginTop: 16 }}>
                  <label className='form-label'>Ownership Percentage</label>
                  <input
                    name="ownership_pct"
                    type='number'
                    className='form-input'
                    placeholder='100'
                    min='1'
                    max='100'
                    value={assignOwnershipPct}
                    onChange={(e) => setAssignOwnershipPct(e.target.value)}
                    style={{ width: '100%', padding: '10px 12px', border: '1px solid #dadce0', borderRadius: 4, fontSize: 14 }}
                  />
                  <p style={{ fontSize: 12, color: '#6b7280', marginTop: 4 }}>
                    Enter the percentage this owner owns (e.g., 50 for 50%)
                  </p>
                </div>
              </form>
            </div>
            <div className='modal-footer' style={{ padding: 16, borderTop: '1px solid #e5e7eb', display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className='btn-secondary' onClick={() => setShowAssignPropertyModal(false)}>Cancel</button>
              <button className='btn-primary' onClick={assignPropertyToOwner}>Assign Property</button>
            </div>
          </div>
        </div>
      )}

      {/* Owner Statement Modal */}
      {showOwnerStatementModal && selectedOwner && (
        <div className='modal-overlay' onClick={() => handleModalClose('owner-statement-form', () => setShowOwnerStatementModal(false))}>
          <div className='modal' onClick={e => e.stopPropagation()} style={{ maxWidth: 700 }}>
            <div className='modal-header'>
              <h2>Owner Statement</h2>
              <button className='close-btn' onClick={() => setShowOwnerStatementModal(false)}>Ã</button>
            </div>
            <div className='modal-body'>
              <form id="owner-statement-form">
                {/* Period Selection */}
                <div style={{ display: 'flex', gap: 16, marginBottom: 24 }}>
                  <div className='form-group' style={{ flex: 1 }}>
                    <label className='form-label'>Period Start</label>
                    <input
                      name="period_start"
                      type='date'
                      className='form-input'
                      value={statementPeriod.start}
                      onChange={(e) => setStatementPeriod({ ...statementPeriod, start: e.target.value })}
                      style={{ width: '100%', padding: '10px 12px', border: '1px solid #dadce0', borderRadius: 4, fontSize: 14 }}
                    />
                  </div>
                  <div className='form-group' style={{ flex: 1 }}>
                    <label className='form-label'>Period End</label>
                    <input
                      name="period_end"
                      type='date'
                      className='form-input'
                      value={statementPeriod.end}
                      onChange={(e) => setStatementPeriod({ ...statementPeriod, end: e.target.value })}
                      style={{ width: '100%', padding: '10px 12px', border: '1px solid #dadce0', borderRadius: 4, fontSize: 14 }}
                    />
                  </div>
                </div>
              </form>
              
              {/* Statement Preview */}
              <div style={{ background: '#f9fafb', padding: 24, borderRadius: 8 }}>
                <div style={{ textAlign: 'center', marginBottom: 24 }}>
                  <h3 style={{ fontSize: 18, fontWeight: 700, marginBottom: 4 }}>Owner Statement</h3>
                  <p style={{ color: '#6b7280', margin: 0 }}>
                    {new Date(statementPeriod.start).toLocaleDateString()} - {new Date(statementPeriod.end).toLocaleDateString()}
                  </p>
                </div>
                
                <div style={{ marginBottom: 20 }}>
                  <p style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Owner</p>
                  <p style={{ fontWeight: 600, margin: 0 }}>{selectedOwner.name}</p>
                </div>
                
                {/* Income Section */}
                <div style={{ marginBottom: 20 }}>
                  <p style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 8 }}>Income</p>
                  <table style={{ width: '100%', fontSize: 14 }}>
                    <tbody>
                      {getOwnerPropertiesById(selectedOwner.id).map(prop => {
                        // Find all current tenants in this property
                        const propTenants = tenants.filter(t => {
                          const matchesProperty = t.property_id === prop.id || 
                                                  (t.property && prop.address && t.property.includes(prop.address)) ||
                                                  (t.property && prop.name && t.property.includes(prop.name));
                          const isCurrent = (t.status === 'Current' || t.status === 'current' || t.status === 'Late' || t.status === 'late');
                          return matchesProperty && isCurrent;
                        });
                        
                        // Sum their rent (check both rentAmount and rent fields)
                        const propIncome = propTenants.reduce((sum, t) => {
                          const rent = parseFloat(t.rentAmount || t.rent || 0);
                          return sum + rent;
                        }, 0);
                        
                        // Apply ownership percentage
                        const ownerShare = Math.round(propIncome * ((prop.ownership_percentage || 100) / 100));
                        
                        return (
                          <tr key={prop.id}>
                            <td style={{ padding: '8px 0' }}>{prop.name || prop.address} ({prop.ownership_percentage || 100}%)</td>
                            <td style={{ padding: '8px 0', textAlign: 'right' }}>${ownerShare.toLocaleString()}</td>
                          </tr>
                        );
                      })}
                      <tr style={{ fontWeight: 600, borderTop: '1px solid #e5e7eb' }}>
                        <td style={{ padding: '12px 0' }}>Total Income</td>
                        <td style={{ padding: '12px 0', textAlign: 'right', color: '#10b981' }}>
                          ${getOwnerRevenue(selectedOwner.id).toLocaleString()}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                {/* Deductions Section */}
                <div style={{ marginBottom: 20 }}>
                  <p style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 8 }}>Deductions</p>
                  <table style={{ width: '100%', fontSize: 14 }}>
                    <tbody>
                      <tr>
                        <td style={{ padding: '8px 0' }}>Management Fee ({selectedOwner.managementFeePercent || 10}%)</td>
                        <td style={{ padding: '8px 0', textAlign: 'right', color: '#dc2626' }}>
                          -${Math.round(getOwnerRevenue(selectedOwner.id) * (selectedOwner.managementFeePercent || 10) / 100).toLocaleString()}
                        </td>
                      </tr>
                      <tr style={{ fontWeight: 600, borderTop: '1px solid #e5e7eb' }}>
                        <td style={{ padding: '12px 0' }}>Total Deductions</td>
                        <td style={{ padding: '12px 0', textAlign: 'right', color: '#dc2626' }}>
                          -${Math.round(getOwnerRevenue(selectedOwner.id) * (selectedOwner.managementFeePercent || 10) / 100).toLocaleString()}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                {/* Net Distribution */}
                <div style={{ background: '#d1fae5', padding: 16, borderRadius: 8, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{ fontWeight: 600, fontSize: 16 }}>Net Distribution</span>
                  <span style={{ fontWeight: 700, fontSize: 24, color: '#065f46' }}>
                    ${getPendingDistribution(selectedOwner.id).toLocaleString()}
                  </span>
                </div>
              </div>
            </div>
            <div className='modal-footer' style={{ padding: 16, borderTop: '1px solid #e5e7eb', display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className='btn-secondary' onClick={() => setShowOwnerStatementModal(false)}>Close</button>
              <button className='btn-secondary'>ð Download PDF</button>
              <button className='btn-primary' onClick={() => recordDistribution(selectedOwner)}>
                ð° Record Distribution
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Create Tag Modal */}
      {showCreateTagModal && (
        <div className="modal-overlay" onClick={() => handleModalClose('create-tag-form', () => {
          setShowCreateTagModal(false);
          setNewTag({ name: '', color: 'blue' });
        })}>
          <div className="modal form-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>Create Tag</h2>
              <button className="close-btn" onClick={() => {
                setShowCreateTagModal(false);
                setNewTag({ name: '', color: 'blue' });
              }}>Ã</button>
            </div>
            <div className="modal-content">
              <form id="create-tag-form" onSubmit={async (e) => {
                e.preventDefault();
                const tagData = await createTag(newTag.name, newTag.color);
                if (tagData) {
                  setShowCreateTagModal(false);
                  setNewTag({ name: '', color: 'blue' });
                }
                // If tagData is null, error was already logged in createTag
              }}>
                <div className="form-group full-width">
                  <label>Tag name</label>
                  <input
                    type="text"
                    value={newTag.name}
                    onChange={(e) => {
                      // Auto-convert spaces to underscores and lowercase
                      const value = e.target.value.toLowerCase().replace(/\s+/g, '_');
                      setNewTag({ ...newTag, name: value });
                    }}
                    placeholder="e.g., late_payment"
                    required
                    pattern="[a-z0-9_]+"
                    title="Tag name must be lowercase letters, numbers, and underscores only"
                    style={{
                      width: '100%',
                      padding: '10px 12px',
                      border: '1px solid #dadce0',
                      borderRadius: '4px',
                      fontSize: '14px',
                      color: '#202124'
                    }}
                  />
                  <p style={{ fontSize: '12px', color: '#5f6368', margin: '4px 0 0 0' }}>
                    Use lowercase letters, numbers, and underscores only. Spaces will be converted to underscores.
                  </p>
                </div>

                <div className="form-group full-width">
                  <label>Color</label>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', marginTop: '8px' }}>
                    {[
                      { name: 'blue', hex: '#1a73e8' },
                      { name: 'green', hex: '#10b981' },
                      { name: 'yellow', hex: '#fbbf24' },
                      { name: 'orange', hex: '#f97316' },
                      { name: 'red', hex: '#ef4444' },
                      { name: 'purple', hex: '#a855f7' },
                      { name: 'teal', hex: '#14b8a6' },
                      { name: 'gray', hex: '#6b7280' }
                    ].map(color => (
                      <button
                        key={color.name}
                        type="button"
                        onClick={() => setNewTag({ ...newTag, color: color.name })}
                        style={{
                          width: '100%',
                          height: '48px',
                          background: newTag.color === color.name ? color.hex : '#f8f9fa',
                          border: newTag.color === color.name ? `3px solid ${color.hex}` : '2px solid #e5e7eb',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          if (newTag.color !== color.name) {
                            e.currentTarget.style.borderColor = color.hex;
                            e.currentTarget.style.background = color.hex + '20';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (newTag.color !== color.name) {
                            e.currentTarget.style.borderColor = '#e5e7eb';
                            e.currentTarget.style.background = '#f8f9fa';
                          }
                        }}
                        title={color.name.charAt(0).toUpperCase() + color.name.slice(1)}
                      >
                        {newTag.color === color.name && (
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg>
                        )}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Tag Preview */}
                <div className="form-group full-width" style={{ marginTop: '16px', padding: '16px', background: '#f8f9fa', borderRadius: '8px' }}>
                  <label style={{ fontSize: '12px', color: '#5f6368', marginBottom: '8px', display: 'block' }}>Preview</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    {newTag.name ? (
                      <>
                        <div
                          style={{
                            background: (() => {
                              const colorMap = {
                                blue: '#1a73e8',
                                green: '#10b981',
                                yellow: '#fbbf24',
                                orange: '#f97316',
                                red: '#ef4444',
                                purple: '#a855f7',
                                teal: '#14b8a6',
                                gray: '#6b7280'
                              };
                              return colorMap[newTag.color] || colorMap.blue;
                            })(),
                            color: '#fff',
                            padding: '6px 16px',
                            borderRadius: '16px',
                            fontSize: '14px',
                            fontWeight: '500',
                            display: 'inline-block'
                          }}
                        >
                          {newTag.name}
                        </div>
                        <span style={{ fontSize: '12px', color: '#5f6368' }}>(0)</span>
                      </>
                    ) : (
                      <span style={{ fontSize: '14px', color: '#9aa0a6', fontStyle: 'italic' }}>Enter a tag name to see preview</span>
                    )}
                  </div>
                </div>

                <div className="modal-actions" style={{ marginTop: '24px' }}>
                  <button
                    type="button"
                    className="btn-secondary"
                    onClick={() => {
                      setShowCreateTagModal(false);
                      setNewTag({ name: '', color: 'blue' });
                    }}
                  >
                    Cancel
                  </button>
                  <button type="submit" className="btn-primary">
                    Create Tag
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* Quick Tag Menu */}
      {quickTagMenu.recordType && quickTagMenu.recordId && (
        <>
          <div
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              zIndex: 999
            }}
            onClick={() => setQuickTagMenu({ recordType: null, recordId: null, x: 0, y: 0 })}
          />
          <div
            style={{
              position: 'fixed',
              top: quickTagMenu.y,
              left: quickTagMenu.x,
              background: '#ffffff',
              border: '1px solid #e5e7eb',
              borderRadius: '8px',
              boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
              zIndex: 1000,
              minWidth: '200px',
              maxWidth: '300px',
              padding: '8px 0',
              transform: 'translateY(-100%)'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div style={{ padding: '8px 16px', fontSize: '12px', fontWeight: '600', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: '1px solid #e5e7eb', marginBottom: '4px' }}>
              Quick Tag
            </div>
            {getMostRecentTags().length > 0 ? (
              <>
                {getMostRecentTags().map(tag => {
                  const existingTags = getTagsForRecord(quickTagMenu.recordType, quickTagMenu.recordId);
                  const isApplied = existingTags.some(t => t.id === tag.id);
                  const colorMap = {
                    blue: '#1a73e8',
                    green: '#10b981',
                    yellow: '#fbbf24',
                    orange: '#f97316',
                    red: '#ef4444',
                    purple: '#a855f7',
                    teal: '#14b8a6',
                    gray: '#6b7280'
                  };
                  return (
                    <div
                      key={tag.id}
                      onClick={async () => {
                        if (isApplied) {
                          await removeTagFromRecord(tag.id, quickTagMenu.recordType, quickTagMenu.recordId);
                        } else {
                          await addTagToRecord(tag.id, quickTagMenu.recordType, quickTagMenu.recordId);
                        }
                        setQuickTagMenu({ recordType: null, recordId: null, x: 0, y: 0 });
                        await refreshData();
                      }}
                      style={{
                        padding: '8px 16px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        fontSize: '14px',
                        color: '#1f2937',
                        transition: 'background 0.2s'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.background = '#f9fafb';
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.background = '#ffffff';
                      }}
                    >
                      <div
                        style={{
                          width: '12px',
                          height: '12px',
                          borderRadius: '50%',
                          background: colorMap[tag.color] || colorMap.blue,
                          flexShrink: 0
                        }}
                      />
                      <span style={{ flex: 1 }}>{tag.name}</span>
                      {isApplied && (
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1a73e8" strokeWidth="2">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      )}
                    </div>
                  );
                })}
                <div style={{ borderTop: '1px solid #e5e7eb', marginTop: '4px', paddingTop: '4px' }}>
                  <div
                    onClick={() => {
                      // Open the detail modal to show full tag picker
                      if (quickTagMenu.recordType === 'tenant') {
                        const tenant = tenants.find(t => t.id === quickTagMenu.recordId);
                        if (tenant) {
                          setSelectedTenant(tenant);
                          loadFilesForRecord('tenant', tenant.id).then(files => {
                            setTenantFiles(files);
                          });
                        }
                      } else if (quickTagMenu.recordType === 'property') {
                        const property = properties.find(p => p.id === quickTagMenu.recordId);
                        if (property) {
                          setSelectedProperty(property);
                          loadFilesForRecord('property', property.id).then(files => {
                            setPropertyFiles(files);
                          });
                        }
                      } else if (quickTagMenu.recordType === 'maintenance') {
                        const request = maintenanceRequests.find(r => r.id === quickTagMenu.recordId);
                        if (request) setSelectedMaintenanceRequest(request);
                      }
                      setQuickTagMenu({ recordType: null, recordId: null, x: 0, y: 0 });
                    }}
                    style={{
                      padding: '8px 16px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      color: '#1a73e8',
                      fontWeight: '500',
                      transition: 'background 0.2s'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.background = '#f9fafb';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.background = '#ffffff';
                    }}
                  >
                    More...
                  </div>
                </div>
              </>
            ) : (
              <div style={{ padding: '8px 16px', fontSize: '14px', color: '#6b7280', textAlign: 'center' }}>
                No tags available
              </div>
            )}
          </div>
        </>
      )}

      {/* Onboarding Wizard */}
      {showOnboardingWizard && (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'white',
          zIndex: 2000,
          overflow: 'auto'
        }}>
          <div style={{ maxWidth: 800, margin: '0 auto', padding: '40px 24px' }}>
            {/* Step Indicator */}
            {(() => {
              const steps = [
                { num: 1, title: 'Property' },
                { num: 2, title: 'Tenant' },
                { num: 3, title: 'Lease' },
                { num: 4, title: 'Documents' },
                { num: 5, title: 'Move-In' },
                { num: 6, title: 'Review' }
              ];

              return (
                <div style={{ display: 'flex', justifyContent: 'center', gap: 8, marginBottom: 32, flexWrap: 'wrap' }}>
                  {steps.map((step, i) => (
                    <div key={step.num} style={{ display: 'flex', alignItems: 'center' }}>
                      <div style={{
                        width: 32,
                        height: 32,
                        borderRadius: '50%',
                        background: onboardingStep >= step.num ? '#1a73e8' : '#e5e7eb',
                        color: onboardingStep >= step.num ? 'white' : '#6b7280',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontWeight: 600,
                        fontSize: 14,
                        flexShrink: 0
                      }}>
                        {onboardingStep > step.num ? 'â' : step.num}
                      </div>
                      <span style={{ marginLeft: 8, fontSize: 14, color: onboardingStep >= step.num ? '#1f2937' : '#9ca3af', whiteSpace: 'nowrap' }}>
                        {step.title}
                      </span>
                      {i < steps.length - 1 && (
                        <div style={{ width: 40, height: 2, background: onboardingStep > step.num ? '#1a73e8' : '#e5e7eb', marginLeft: 8 }} />
                      )}
                    </div>
                  ))}
                </div>
              );
            })()}

            {/* Step Content */}
            <div style={{ minHeight: '400px' }}>
              {/* Step 1 - Select Property */}
              {onboardingStep === 1 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Select Property & Unit</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Choose where the tenant will live</p>
                  
                  {/* Property Dropdown */}
                  <div className='form-group'>
                    <RequiredLabel>Property</RequiredLabel>
                    <select
                      className='form-select'
                      value={onboardingData.property?.id || ''}
                      onChange={(e) => {
                        const selectedProperty = properties.find(p => String(p.id) === e.target.value);
                        setOnboardingData({
                          ...onboardingData,
                          property: selectedProperty || null,
                          unit: '' // Reset unit when property changes
                        });
                      }}
                      style={{ padding: '12px', fontSize: 15 }}
                    >
                      <option value=''>Select a property...</option>
                      {properties.map(property => {
                        const availableUnits = (property.units || property.total_units || 1) - (property.occupied || property.occupied_units || 0);
                        const propertyType = property.type || property.property_type || 'Single-family';
                        return (
                          <option key={property.id} value={property.id}>
                            {property.address} ({propertyType}) - {availableUnits} available
                          </option>
                        );
                      })}
                    </select>
                  </div>
                  
                  {/* Conditional Unit Selection */}
                  {onboardingData.property && (
                    <div className='form-group' style={{ marginTop: 20 }}>
                      {/* Check if multi-unit property */}
                      {((onboardingData.property.units || onboardingData.property.total_units || 0) > 1 || 
                        ['Multi-Family', 'Multi-family', 'Townhouse', 'Duplex', 'Apartment Complex'].includes(onboardingData.property.type || onboardingData.property.property_type)) ? (
                        <>
                          <RequiredLabel>Select Unit</RequiredLabel>
                          <select
                            className='form-select'
                            value={onboardingData.unit}
                            onChange={(e) => setOnboardingData({ ...onboardingData, unit: e.target.value })}
                            style={{ padding: '12px', fontSize: 15 }}
                          >
                            <option value=''>Select an available unit...</option>
                            {getAvailableUnits(onboardingData.property).map(unit => (
                              <option key={unit} value={unit}>
                                Unit {unit}
                              </option>
                            ))}
                          </select>
                          <p style={{ fontSize: 13, color: '#6b7280', marginTop: 8 }}>
                            {getAvailableUnits(onboardingData.property).length} unit(s) available
                          </p>
                        </>
                      ) : (
                        <>
                          {/* Single-family - auto-assign */}
                          <div style={{ 
                            padding: 16, 
                            background: '#f0fdf4', 
                            borderRadius: 8,
                            border: '1px solid #bbf7d0'
                          }}>
                            <p style={{ color: '#166534', margin: 0 }}>
                              â Single-family property selected. Unit will be assigned automatically.
                            </p>
                          </div>
                        </>
                      )}
                    </div>
                  )}
                  
                  {/* Property Preview Card */}
                  {onboardingData.property && (
                    <div style={{ 
                      marginTop: 24, 
                      padding: 16, 
                      background: '#f9fafb', 
                      borderRadius: 8,
                      border: '1px solid #e5e7eb'
                    }}>
                      <h4 style={{ fontSize: 14, fontWeight: 600, marginBottom: 8 }}>Selected Property</h4>
                      <p style={{ margin: 0, fontWeight: 500 }}>{onboardingData.property.address}</p>
                      <p style={{ margin: '4px 0 0', fontSize: 14, color: '#6b7280' }}>
                        {onboardingData.property.type || onboardingData.property.property_type || 'Single-family'} â¢ 
                        ${(onboardingData.property.monthlyRevenue || 0).toLocaleString()}/mo
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* Step 2 - Tenant Info */}
              {onboardingStep === 2 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Tenant Information</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Enter new tenant details or select existing prospect</p>
                  
                  {/* Toggle between new and existing */}
                  <div style={{ display: 'flex', gap: 12, marginBottom: 24 }}>
                    <button
                      type="button"
                      onClick={() => setOnboardingData({ ...onboardingData, tenant: { ...onboardingData.tenant, isExisting: false } })}
                      className={onboardingData.tenant.isExisting ? 'btn btn-secondary' : 'btn btn-primary'}
                    >
                      New Tenant
                    </button>
                    <button
                      type="button"
                      onClick={() => setOnboardingData({ ...onboardingData, tenant: { ...onboardingData.tenant, isExisting: true } })}
                      className={onboardingData.tenant.isExisting ? 'btn btn-primary' : 'btn btn-secondary'}
                    >
                      Existing Prospect
                    </button>
                  </div>
                  
                  {onboardingData.tenant.isExisting ? (
                    <div className='form-group'>
                      <RequiredLabel>Select Prospect</RequiredLabel>
                      <select
                        className='form-select'
                        value={onboardingData.tenant.existingId || ''}
                        onChange={(e) => {
                          const selectedId = e.target.value;
                          const prospect = tenants.find(t => String(t.id) === selectedId && t.status === 'prospect');
                          
                          if (prospect) {
                            setOnboardingData({
                              ...onboardingData,
                              tenant: {
                                ...onboardingData.tenant,
                                isExisting: true,
                                existingId: selectedId,
                                name: prospect.name || '',
                                email: prospect.email || '',
                                phone: prospect.phone || ''
                              }
                            });
                          } else if (!selectedId) {
                            // Clear selection
                            setOnboardingData({
                              ...onboardingData,
                              tenant: {
                                ...onboardingData.tenant,
                                existingId: null,
                                name: '',
                                email: '',
                                phone: ''
                              }
                            });
                          }
                        }}
                      >
                        <option value=''>Select a prospect...</option>
                        {tenants.filter(t => t.status === 'prospect').map(t => (
                          <option key={t.id} value={t.id}>{t.name} - {t.email || t.phone || 'No contact'}</option>
                        ))}
                      </select>
                    </div>
                  ) : (
                    <div className='two-col'>
                      <div className='form-group'>
                        <RequiredLabel>Full Name</RequiredLabel>
                        <input
                          type='text'
                          className='form-input'
                          value={onboardingData.tenant.name}
                          onChange={(e) => setOnboardingData({
                            ...onboardingData,
                            tenant: { ...onboardingData.tenant, name: e.target.value }
                          })}
                          placeholder='Enter tenant name'
                        />
                      </div>
                      <div className='form-group'>
                        <RequiredLabel required={false}>Phone</RequiredLabel>
                        <input
                          type='tel'
                          className='form-input'
                          value={onboardingData.tenant.phone}
                          onChange={(e) => setOnboardingData({
                            ...onboardingData,
                            tenant: { ...onboardingData.tenant, phone: e.target.value }
                          })}
                          placeholder='(optional)'
                        />
                      </div>
                      <div className='form-group' style={{ gridColumn: 'span 2' }}>
                        <RequiredLabel>Email</RequiredLabel>
                        <input
                          type='email'
                          className='form-input'
                          value={onboardingData.tenant.email}
                          onChange={(e) => setOnboardingData({
                            ...onboardingData,
                            tenant: { ...onboardingData.tenant, email: e.target.value }
                          })}
                          placeholder='tenant@email.com'
                        />
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Step 3 - Lease Details */}
              {onboardingStep === 3 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Lease Details</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Set the terms of the lease agreement</p>
                  
                  <div style={{ marginBottom: 24 }}>
                    <label className='form-label'>Lease Type</label>
                    <div style={{ display: 'flex', gap: 12 }}>
                      <button
                        type="button"
                        onClick={() => setOnboardingData({ ...onboardingData, lease: { ...onboardingData.lease, leaseType: 'fixed' } })}
                        className={onboardingData.lease.leaseType === 'fixed' ? 'btn btn-primary' : 'btn btn-secondary'}
                      >
                        Fixed Term
                      </button>
                      <button
                        type="button"
                        onClick={() => setOnboardingData({ ...onboardingData, lease: { ...onboardingData.lease, leaseType: 'month-to-month' } })}
                        className={onboardingData.lease.leaseType === 'month-to-month' ? 'btn btn-primary' : 'btn btn-secondary'}
                      >
                        Month-to-Month
                      </button>
                    </div>
                  </div>
                  
                  <div className='two-col'>
                    <div className='form-group'>
                      <RequiredLabel>Monthly Rent</RequiredLabel>
                      <input
                        type='number'
                        className='form-input'
                        placeholder='0.00'
                        step='0.01'
                        value={onboardingData.lease.monthlyRent}
                        onChange={(e) => setOnboardingData({
                          ...onboardingData,
                          lease: { ...onboardingData.lease, monthlyRent: e.target.value }
                        })}
                        required
                      />
                    </div>
                    <div className='form-group'>
                      <RequiredLabel required={false}>Security Deposit</RequiredLabel>
                      <input
                        type='number'
                        className='form-input'
                        placeholder='0.00'
                        step='0.01'
                        value={onboardingData.lease.securityDeposit}
                        onChange={(e) => setOnboardingData({
                          ...onboardingData,
                          lease: { ...onboardingData.lease, securityDeposit: e.target.value }
                        })}
                      />
                    </div>
                    <div className='form-group'>
                      <RequiredLabel>Lease Start Date</RequiredLabel>
                      <input
                        type='date'
                        className='form-input'
                        value={onboardingData.lease.startDate}
                        onChange={(e) => setOnboardingData({
                          ...onboardingData,
                          lease: { ...onboardingData.lease, startDate: e.target.value }
                        })}
                        required
                      />
                    </div>
                    <div className='form-group'>
                      <RequiredLabel required={onboardingData.lease.leaseType === 'fixed'}>Lease End Date</RequiredLabel>
                      <input
                        type='date'
                        className='form-input'
                        value={onboardingData.lease.endDate}
                        onChange={(e) => setOnboardingData({
                          ...onboardingData,
                          lease: { ...onboardingData.lease, endDate: e.target.value }
                        })}
                        disabled={onboardingData.lease.leaseType === 'month-to-month'}
                        required={onboardingData.lease.leaseType === 'fixed'}
                      />
                    </div>
                  </div>
                </div>
              )}

              {/* Step 4 - Documents */}
              {onboardingStep === 4 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Upload Documents</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Add lease agreement and other required documents</p>
                  
                  <div style={{ border: '2px dashed #e5e7eb', borderRadius: 12, padding: 32, textAlign: 'center' }}>
                    <input
                      type='file'
                      id='onboarding-docs'
                      multiple
                      accept='.pdf,.doc,.docx,.jpg,.png'
                      style={{ display: 'none' }}
                      onChange={(e) => {
                        const files = Array.from(e.target.files);
                        setOnboardingData({
                          ...onboardingData,
                          documents: [...onboardingData.documents, ...files]
                        });
                        e.target.value = ''; // Reset input
                      }}
                    />
                    <div style={{ fontSize: 48, marginBottom: 16 }}>ð</div>
                    <p style={{ marginBottom: 16, color: '#6b7280' }}>Drag and drop files here, or</p>
                    <button 
                      type="button"
                      onClick={() => document.getElementById('onboarding-docs').click()} 
                      className='btn btn-primary'
                    >
                      Browse Files
                    </button>
                  </div>
                  
                  {onboardingData.documents.length > 0 && (
                    <div style={{ marginTop: 24 }}>
                      <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 12 }}>Uploaded Documents</h3>
                      {onboardingData.documents.map((doc, i) => (
                        <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', background: '#f9fafb', borderRadius: 8, marginBottom: 8 }}>
                          <span style={{ fontSize: 14 }}>ð {doc.name}</span>
                          <button 
                            type="button"
                            onClick={() => {
                              setOnboardingData({
                                ...onboardingData,
                                documents: onboardingData.documents.filter((_, idx) => idx !== i)
                              });
                            }} 
                            style={{ color: '#dc2626', background: 'none', border: 'none', cursor: 'pointer', fontSize: 14, padding: '4px 8px' }}
                          >
                            Remove
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Step 5 - Move-In */}
              {onboardingStep === 5 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Schedule Move-In</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Set the move-in date and add any notes</p>
                  
                  <div className='form-group'>
                    <RequiredLabel>Move-In Date</RequiredLabel>
                    <input
                      type='date'
                      className='form-input'
                      value={onboardingData.moveInDate}
                      onChange={(e) => setOnboardingData({ ...onboardingData, moveInDate: e.target.value })}
                      required
                    />
                  </div>
                  
                  <div className='form-group'>
                    <label className='form-label'>Move-In Condition Notes</label>
                    <textarea
                      className='form-textarea'
                      rows={4}
                      placeholder='Document the condition of the unit at move-in...'
                      value={onboardingData.moveInNotes}
                      onChange={(e) => setOnboardingData({ ...onboardingData, moveInNotes: e.target.value })}
                    />
                  </div>
                  
                  <div style={{ background: '#fef3c7', padding: 16, borderRadius: 8, marginTop: 24 }}>
                    <h4 style={{ fontWeight: 600, marginBottom: 8 }}>ð Move-In Checklist</h4>
                    <ul style={{ margin: 0, paddingLeft: 20, color: '#78350f' }}>
                      <li>Take photos of unit condition</li>
                      <li>Test all appliances</li>
                      <li>Check smoke detectors</li>
                      <li>Provide keys and access codes</li>
                      <li>Review lease terms with tenant</li>
                      <li>Collect first month rent and deposit</li>
                    </ul>
                  </div>
                </div>
              )}

              {/* Step 6 - Review & Complete */}
              {onboardingStep === 6 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Review & Complete</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Confirm all details before onboarding the tenant</p>
                  
                  <div style={{ background: '#f9fafb', padding: 24, borderRadius: 12 }}>
                    <div style={{ marginBottom: 20 }}>
                      <h4 style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Property</h4>
                      <p style={{ fontWeight: 600 }}>{onboardingData.property?.address || 'Not selected'}, {onboardingData.unit ? `Unit ${onboardingData.unit}` : 'No unit specified'}</p>
                    </div>
                    
                    <div style={{ marginBottom: 20 }}>
                      <h4 style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Tenant</h4>
                      <p style={{ fontWeight: 600 }}>{onboardingData.tenant.name || 'Not specified'}</p>
                      {(onboardingData.tenant.email || onboardingData.tenant.phone) && (
                        <p style={{ fontSize: 14, color: '#6b7280' }}>
                          {onboardingData.tenant.email || ''} {onboardingData.tenant.email && onboardingData.tenant.phone ? 'â¢' : ''} {onboardingData.tenant.phone || ''}
                        </p>
                      )}
                    </div>
                    
                    <div style={{ marginBottom: 20 }}>
                      <h4 style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Lease Terms</h4>
                      <p><strong>Rent:</strong> ${parseFloat(onboardingData.lease.monthlyRent || 0).toLocaleString()}/month</p>
                      <p><strong>Deposit:</strong> ${parseFloat(onboardingData.lease.securityDeposit || 0).toLocaleString()}</p>
                      <p><strong>Period:</strong> {onboardingData.lease.startDate || 'Not set'} to {onboardingData.lease.endDate || (onboardingData.lease.leaseType === 'month-to-month' ? 'Month-to-Month' : 'Not set')}</p>
                    </div>
                    
                    <div style={{ marginBottom: 20 }}>
                      <h4 style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Move-In</h4>
                      <p>{onboardingData.moveInDate || 'Not scheduled'}</p>
                    </div>
                    
                    <div>
                      <h4 style={{ fontSize: 12, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Documents</h4>
                      <p>{onboardingData.documents.length} file(s) uploaded</p>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Footer Navigation */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 32, paddingTop: 24, borderTop: '1px solid #e5e7eb' }}>
              <button
                type="button"
                onClick={() => onboardingStep === 1 ? setShowOnboardingWizard(false) : setOnboardingStep(onboardingStep - 1)}
                className='btn btn-secondary'
              >
                {onboardingStep === 1 ? 'Cancel' : 'Back'}
              </button>
              
              <button
                type="button"
                onClick={validateAndContinue}
                className='btn btn-primary'
              >
                {onboardingStep === 6 ? 'Complete Onboarding' : 'Continue'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Offboarding Wizard */}
      {showOffboardingWizard && (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'white',
          zIndex: 2000,
          overflow: 'auto'
        }}>
          <div style={{ maxWidth: 800, margin: '0 auto', padding: '40px 24px' }}>
            {/* Step Indicator */}
            {(() => {
              const offboardingSteps = [
                { num: 1, title: 'Select Tenant' },
                { num: 2, title: 'Move-Out Date' },
                { num: 3, title: 'Inspection' },
                { num: 4, title: 'Deposit' },
                { num: 5, title: 'Statement' },
                { num: 6, title: 'Complete' }
              ];
              
              return (
                <div style={{ display: 'flex', justifyContent: 'center', gap: 8, marginBottom: 32 }}>
                  {offboardingSteps.map((step, i) => (
                    <div key={step.num} style={{ display: 'flex', alignItems: 'center' }}>
                      <div style={{ width: 32, height: 32, borderRadius: '50%', background: offboardingStep >= step.num ? '#ef4444' : '#e5e7eb', color: offboardingStep >= step.num ? 'white' : '#6b7280', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 600, fontSize: 14 }}>
                        {offboardingStep > step.num ? 'â' : step.num}
                      </div>
                      <span style={{ marginLeft: 8, fontSize: 14, color: offboardingStep >= step.num ? '#1f2937' : '#9ca3af' }}>
                        {step.title}
                      </span>
                      {i < offboardingSteps.length - 1 && (
                        <div style={{ width: 40, height: 2, background: offboardingStep > step.num ? '#ef4444' : '#e5e7eb', marginLeft: 8 }} />
                      )}
                    </div>
                  ))}
                </div>
              );
            })()}

            {/* Step Content */}
            <div style={{ minHeight: '400px' }}>
              {/* Step 1 - Select Tenant */}
              {offboardingStep === 1 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Select Tenant to Move Out</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Choose which tenant is moving out</p>
                  
                  <div className='form-group'>
                    <RequiredLabel>Tenant</RequiredLabel>
                    <select
                      className='form-select'
                      value={offboardingData.tenant?.id || ''}
                      onChange={(e) => {
                        const selected = tenants.find(t => String(t.id) === e.target.value && (t.status === 'current' || t.status === 'Current'));
                        if (selected) {
                          const property = properties.find(p => p.id === selected.property_id || p.address === selected.property);
                          setOffboardingData({
                            ...offboardingData,
                            tenant: {
                              ...selected,
                              property_name: property?.name || property?.address || selected.property || 'Unknown',
                              security_deposit: selected.securityDeposit || selected.security_deposit || 0,
                              rent: selected.rentAmount || selected.rent || 0,
                              lease_end: selected.leaseEnd || selected.lease_end || null,
                              unit: selected.unit || ''
                            }
                          });
                        }
                      }}
                    >
                      <option value=''>Select a current tenant...</option>
                      {tenants.filter(t => t.status === 'current' || t.status === 'Current').map(t => {
                        const property = properties.find(p => p.id === t.property_id || p.address === t.property);
                        return (
                          <option key={t.id} value={t.id}>
                            {t.name} - {property?.name || property?.address || t.property || 'Unknown'}, Unit {t.unit || 'N/A'}
                          </option>
                        );
                      })}
                    </select>
                  </div>
                  
                  {offboardingData.tenant && (
                    <div style={{ background: '#fef2f2', padding: 16, borderRadius: 8, marginTop: 16, border: '1px solid #fecaca' }}>
                      <h4 style={{ fontWeight: 600, marginBottom: 12, color: '#991b1b' }}>Tenant Selected for Move-Out</h4>
                      <p style={{ margin: 0, fontWeight: 500 }}>{offboardingData.tenant.name}</p>
                      <p style={{ margin: '4px 0', fontSize: 14, color: '#6b7280' }}>{offboardingData.tenant.email}</p>
                      <p style={{ margin: '4px 0', fontSize: 14, color: '#6b7280' }}>
                        {offboardingData.tenant.property_name}, Unit {offboardingData.tenant.unit}
                      </p>
                      <div style={{ display: 'flex', gap: 24, marginTop: 12 }}>
                        <div>
                          <span style={{ fontSize: 12, color: '#6b7280' }}>Monthly Rent</span>
                          <p style={{ margin: 0, fontWeight: 600 }}>${offboardingData.tenant.rent || 0}</p>
                        </div>
                        <div>
                          <span style={{ fontSize: 12, color: '#6b7280' }}>Security Deposit</span>
                          <p style={{ margin: 0, fontWeight: 600 }}>${offboardingData.tenant.security_deposit || 0}</p>
                        </div>
                        <div>
                          <span style={{ fontSize: 12, color: '#6b7280' }}>Lease End</span>
                          <p style={{ margin: 0, fontWeight: 600 }}>{offboardingData.tenant.lease_end || 'Month-to-month'}</p>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Step 2 - Move-Out Date & Reason */}
              {offboardingStep === 2 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Set Move-Out Date</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>When is the tenant moving out?</p>
                  
                  <div className='two-col'>
                    <div className='form-group'>
                      <RequiredLabel>Move-Out Date</RequiredLabel>
                      <input
                        type='date'
                        className='form-input'
                        value={offboardingData.moveOutDate}
                        onChange={(e) => setOffboardingData({ ...offboardingData, moveOutDate: e.target.value })}
                        required
                      />
                    </div>
                    
                    <div className='form-group'>
                      <label className='form-label'>Reason for Moving</label>
                      <select
                        className='form-select'
                        value={offboardingData.reason}
                        onChange={(e) => setOffboardingData({ ...offboardingData, reason: e.target.value })}
                      >
                        <option value=''>Select reason...</option>
                        <option value='lease-end'>Lease ended - not renewing</option>
                        <option value='relocation'>Job relocation</option>
                        <option value='purchase'>Purchased a home</option>
                        <option value='upgrade'>Moving to larger space</option>
                        <option value='downgrade'>Moving to smaller space</option>
                        <option value='eviction'>Eviction</option>
                        <option value='mutual'>Mutual agreement - early termination</option>
                        <option value='other'>Other</option>
                      </select>
                    </div>
                  </div>
                  
                  <div className='form-group'>
                    <label className='form-label'>Forwarding Address (for deposit refund)</label>
                    <textarea
                      className='form-textarea'
                      rows={2}
                      placeholder='Enter the address where the deposit check should be mailed...'
                      value={offboardingData.forwardingAddress}
                      onChange={(e) => setOffboardingData({ ...offboardingData, forwardingAddress: e.target.value })}
                    />
                  </div>
                  
                  {offboardingData.moveOutDate && (
                    <div style={{ background: '#fef7e0', padding: 16, borderRadius: 8, marginTop: 16 }}>
                      <p style={{ margin: 0, fontSize: 14 }}>
                        <strong>Note:</strong> You have until {new Date(new Date(offboardingData.moveOutDate).getTime() + 21 * 24 * 60 * 60 * 1000).toLocaleDateString()} (21 days) to return the security deposit with an itemized statement.
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* Step 3 - Move-Out Inspection */}
              {offboardingStep === 3 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Move-Out Inspection</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Document the condition of the unit</p>
                  
                  <div style={{ background: '#f9fafb', padding: 20, borderRadius: 8, marginBottom: 24 }}>
                    <h4 style={{ fontWeight: 600, marginBottom: 16 }}>Inspection Checklist</h4>
                    
                    {[
                      { key: 'wallsClean', label: 'Walls are clean, no holes or major marks' },
                      { key: 'floorsClean', label: 'Floors are clean, no stains or damage' },
                      { key: 'appliancesWorking', label: 'All appliances are working' },
                      { key: 'plumbingWorking', label: 'Plumbing fixtures working, no leaks' },
                      { key: 'keysReturned', label: 'All keys and access devices returned' },
                      { key: 'smokeDetectorsWorking', label: 'Smoke detectors working' },
                      { key: 'noMissingItems', label: 'No missing fixtures or items' }
                    ].map(item => (
                      <div key={item.key} style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
                        <input
                          type='checkbox'
                          id={item.key}
                          checked={offboardingData.inspectionChecklist[item.key]}
                          onChange={(e) => setOffboardingData({
                            ...offboardingData,
                            inspectionChecklist: {
                              ...offboardingData.inspectionChecklist,
                              [item.key]: e.target.checked
                            }
                          })}
                          style={{ width: 20, height: 20 }}
                        />
                        <label htmlFor={item.key} style={{ fontSize: 14, cursor: 'pointer' }}>{item.label}</label>
                      </div>
                    ))}
                  </div>
                  
                  <div className='form-group'>
                    <label className='form-label'>Inspection Notes & Damages Found</label>
                    <textarea
                      className='form-textarea'
                      rows={4}
                      placeholder='Document any damage, excessive wear, cleaning needed, or issues found...'
                      value={offboardingData.inspectionNotes}
                      onChange={(e) => setOffboardingData({ ...offboardingData, inspectionNotes: e.target.value })}
                    />
                  </div>
                  
                  <div className='form-group'>
                    <label className='form-label'>Inspection Photos</label>
                    <div style={{ border: '2px dashed #d1d5db', borderRadius: 8, padding: 24, textAlign: 'center' }}>
                      <input
                        type='file'
                        id='inspection-photos'
                        multiple
                        accept='image/*'
                        style={{ display: 'none' }}
                        onChange={(e) => {
                          const files = Array.from(e.target.files);
                          setOffboardingData({
                            ...offboardingData,
                            inspectionPhotos: [...offboardingData.inspectionPhotos, ...files]
                          });
                          e.target.value = '';
                        }}
                      />
                      <div style={{ fontSize: 32, marginBottom: 8 }}>ð·</div>
                      <p style={{ marginBottom: 12, color: '#6b7280' }}>Take photos of any damage or issues</p>
                      <button type="button" onClick={() => document.getElementById('inspection-photos').click()} className='btn btn-secondary'>
                        Upload Photos
                      </button>
                    </div>
                    
                    {offboardingData.inspectionPhotos.length > 0 && (
                      <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', marginTop: 16 }}>
                        {offboardingData.inspectionPhotos.map((photo, i) => (
                          <div key={i} style={{ position: 'relative' }}>
                            <img
                              src={URL.createObjectURL(photo)}
                              alt={`Inspection ${i + 1}`}
                              style={{ width: 100, height: 100, objectFit: 'cover', borderRadius: 8 }}
                            />
                            <button
                              type="button"
                              onClick={() => setOffboardingData({
                                ...offboardingData,
                                inspectionPhotos: offboardingData.inspectionPhotos.filter((_, idx) => idx !== i)
                              })}
                              style={{
                                position: 'absolute',
                                top: -8,
                                right: -8,
                                width: 24,
                                height: 24,
                                borderRadius: '50%',
                                background: '#dc2626',
                                color: 'white',
                                border: 'none',
                                cursor: 'pointer',
                                fontSize: 14
                              }}
                            >Ã</button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Step 4 - Deposit Calculation */}
              {offboardingStep === 4 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Calculate Deposit Return</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Add any deductions from the security deposit</p>
                  
                  <div style={{ background: '#f0fdf4', padding: 16, borderRadius: 8, marginBottom: 24 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span style={{ fontWeight: 500 }}>Security Deposit Held</span>
                      <span style={{ fontSize: 24, fontWeight: 700, color: '#059669' }}>
                        ${offboardingData.tenant?.security_deposit || 0}
                      </span>
                    </div>
                  </div>
                  
                  <h4 style={{ fontWeight: 600, marginBottom: 12 }}>Deductions</h4>
                  <p style={{ fontSize: 14, color: '#6b7280', marginBottom: 16 }}>
                    Add itemized deductions for damages, cleaning, or unpaid rent
                  </p>
                  
                  {offboardingData.depositDeductions.map((deduction, i) => (
                    <div key={i} style={{ display: 'flex', gap: 12, marginBottom: 12, alignItems: 'flex-start' }}>
                      <div style={{ flex: 2 }}>
                        <input
                          type='text'
                          className='form-input'
                          placeholder='Description (e.g., Wall repair, Carpet cleaning)'
                          value={deduction.description || ''}
                          onChange={(e) => {
                            const updated = [...offboardingData.depositDeductions];
                            updated[i] = { ...updated[i], description: e.target.value };
                            setOffboardingData({ ...offboardingData, depositDeductions: updated });
                          }}
                        />
                      </div>
                      <div style={{ width: 120 }}>
                        <input
                          type='number'
                          className='form-input'
                          placeholder='Amount'
                          value={deduction.amount || ''}
                          onChange={(e) => {
                            const updated = [...offboardingData.depositDeductions];
                            updated[i] = { ...updated[i], amount: parseFloat(e.target.value) || 0 };
                            setOffboardingData({ ...offboardingData, depositDeductions: updated });
                          }}
                        />
                      </div>
                      <button
                        type="button"
                        onClick={() => setOffboardingData({
                          ...offboardingData,
                          depositDeductions: offboardingData.depositDeductions.filter((_, idx) => idx !== i)
                        })}
                        style={{ padding: 8, background: 'none', border: 'none', color: '#dc2626', cursor: 'pointer', fontSize: 18 }}
                      >ðï¸</button>
                    </div>
                  ))}
                  
                  <button
                    type="button"
                    onClick={() => setOffboardingData({
                      ...offboardingData,
                      depositDeductions: [...offboardingData.depositDeductions, { description: '', amount: 0 }]
                    })}
                    className='btn btn-secondary'
                    style={{ marginBottom: 24 }}
                  >
                    + Add Deduction
                  </button>
                  
                  <div style={{ background: '#f9fafb', padding: 20, borderRadius: 8, border: '1px solid #e5e7eb' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>
                      <span>Security Deposit</span>
                      <span>${offboardingData.tenant?.security_deposit || 0}</span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12, color: '#dc2626' }}>
                      <span>Total Deductions</span>
                      <span>-${offboardingData.depositDeductions.reduce((sum, d) => sum + (d.amount || 0), 0)}</span>
                    </div>
                    <hr style={{ border: 'none', borderTop: '2px solid #1f2937', margin: '12px 0' }} />
                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 20, fontWeight: 700 }}>
                      <span>Refund Due</span>
                      <span style={{ color: '#059669' }}>
                        ${Math.max(0, (offboardingData.tenant?.security_deposit || 0) - offboardingData.depositDeductions.reduce((sum, d) => sum + (d.amount || 0), 0))}
                      </span>
                    </div>
                  </div>
                </div>
              )}

              {/* Step 5 - Final Statement Preview */}
              {offboardingStep === 5 && (
                <div>
                  <h2 style={{ fontSize: 24, fontWeight: 600, marginBottom: 8 }}>Final Move-Out Statement</h2>
                  <p style={{ color: '#6b7280', marginBottom: 24 }}>Review before completing</p>
                  
                  <div style={{ background: 'white', padding: 32, borderRadius: 12, border: '1px solid #e5e7eb', boxShadow: '0 4px 12px rgba(0,0,0,0.05)' }}>
                    <div style={{ textAlign: 'center', marginBottom: 24 }}>
                      <h3 style={{ fontSize: 20, fontWeight: 700, marginBottom: 4 }}>Security Deposit Statement</h3>
                      <p style={{ color: '#6b7280', fontSize: 14 }}>Generated {new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 24, marginBottom: 24 }}>
                      <div>
                        <p style={{ fontSize: 11, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Tenant</p>
                        <p style={{ fontWeight: 600, margin: 0 }}>{offboardingData.tenant?.name}</p>
                        <p style={{ fontSize: 14, color: '#6b7280', margin: '4px 0 0' }}>{offboardingData.tenant?.email}</p>
                      </div>
                      <div>
                        <p style={{ fontSize: 11, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Property</p>
                        <p style={{ fontWeight: 600, margin: 0 }}>{offboardingData.tenant?.property_name}</p>
                        <p style={{ fontSize: 14, color: '#6b7280', margin: '4px 0 0' }}>Unit {offboardingData.tenant?.unit}</p>
                      </div>
                      <div>
                        <p style={{ fontSize: 11, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Move-Out Date</p>
                        <p style={{ fontWeight: 600, margin: 0 }}>{offboardingData.moveOutDate}</p>
                      </div>
                      <div>
                        <p style={{ fontSize: 11, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Reason</p>
                        <p style={{ fontWeight: 600, margin: 0 }}>{offboardingData.reason || 'Not specified'}</p>
                      </div>
                    </div>
                    
                    <hr style={{ border: 'none', borderTop: '1px solid #e5e7eb', margin: '24px 0' }} />
                    
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                      <tbody>
                        <tr>
                          <td style={{ padding: '8px 0' }}>Security Deposit Held</td>
                          <td style={{ padding: '8px 0', textAlign: 'right' }}>${offboardingData.tenant?.security_deposit || 0}</td>
                        </tr>
                        {offboardingData.depositDeductions.map((d, i) => (
                          <tr key={i} style={{ color: '#dc2626' }}>
                            <td style={{ padding: '8px 0' }}>{d.description || 'Deduction'}</td>
                            <td style={{ padding: '8px 0', textAlign: 'right' }}>-${d.amount || 0}</td>
                          </tr>
                        ))}
                      </tbody>
                      <tfoot>
                        <tr style={{ fontWeight: 700, fontSize: 18 }}>
                          <td style={{ padding: '16px 0', borderTop: '2px solid #1f2937' }}>Amount Due to Tenant</td>
                          <td style={{ padding: '16px 0', borderTop: '2px solid #1f2937', textAlign: 'right', color: '#059669' }}>
                            ${Math.max(0, (offboardingData.tenant?.security_deposit || 0) - offboardingData.depositDeductions.reduce((sum, d) => sum + (d.amount || 0), 0))}
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                    
                    {offboardingData.forwardingAddress && (
                      <div style={{ marginTop: 24, padding: 16, background: '#f9fafb', borderRadius: 8 }}>
                        <p style={{ fontSize: 11, color: '#6b7280', textTransform: 'uppercase', marginBottom: 4 }}>Mail Refund To</p>
                        <p style={{ margin: 0 }}>{offboardingData.forwardingAddress}</p>
                      </div>
                    )}
                  </div>
                  
                  <div style={{ marginTop: 24, display: 'flex', gap: 12 }}>
                    <button type="button" className='btn btn-secondary' style={{ flex: 1 }}>
                      ð Download PDF
                    </button>
                    <button type="button" className='btn btn-secondary' style={{ flex: 1 }}>
                      âï¸ Email to Tenant
                    </button>
                  </div>
                </div>
              )}

              {/* Step 6 - Complete */}
              {offboardingStep === 6 && (
                <div style={{ textAlign: 'center', padding: '40px 0' }}>
                  <div style={{ 
                    width: 80, 
                    height: 80, 
                    borderRadius: '50%', 
                    background: '#d1fae5', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center',
                    margin: '0 auto 24px',
                    fontSize: 40
                  }}>
                    â
                  </div>
                  
                  <h2 style={{ fontSize: 28, fontWeight: 700, marginBottom: 8 }}>Move-Out Complete</h2>
                  <p style={{ color: '#6b7280', marginBottom: 32, maxWidth: 400, margin: '0 auto 32px' }}>
                    {offboardingData.tenant?.name} has been successfully moved out. The unit is now marked as available.
                  </p>
                  
                  <div style={{ background: '#f9fafb', padding: 24, borderRadius: 12, textAlign: 'left', maxWidth: 500, margin: '0 auto' }}>
                    <h4 style={{ fontWeight: 600, marginBottom: 16 }}>Summary</h4>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                      <div>
                        <p style={{ fontSize: 12, color: '#6b7280', marginBottom: 2 }}>Tenant</p>
                        <p style={{ fontWeight: 500, margin: 0 }}>{offboardingData.tenant?.name}</p>
                      </div>
                      <div>
                        <p style={{ fontSize: 12, color: '#6b7280', marginBottom: 2 }}>Move-Out Date</p>
                        <p style={{ fontWeight: 500, margin: 0 }}>{offboardingData.moveOutDate}</p>
                      </div>
                      <div>
                        <p style={{ fontSize: 12, color: '#6b7280', marginBottom: 2 }}>Refund Amount</p>
                        <p style={{ fontWeight: 500, margin: 0, color: '#059669' }}>
                          ${Math.max(0, (offboardingData.tenant?.security_deposit || 0) - offboardingData.depositDeductions.reduce((sum, d) => sum + (d.amount || 0), 0))}
                        </p>
                      </div>
                      <div>
                        <p style={{ fontSize: 12, color: '#6b7280', marginBottom: 2 }}>Unit Status</p>
                        <p style={{ fontWeight: 500, margin: 0, color: '#059669' }}>Available</p>
                      </div>
                    </div>
                    
                    <hr style={{ border: 'none', borderTop: '1px solid #e5e7eb', margin: '20px 0' }} />
                    
                    <h4 style={{ fontWeight: 600, marginBottom: 12 }}>Next Steps</h4>
                    <ul style={{ margin: 0, paddingLeft: 20, fontSize: 14, color: '#4b5563' }}>
                      <li>Mail deposit refund check within 21 days</li>
                      <li>Schedule unit turnover (cleaning, repairs)</li>
                      <li>Update property listing as available</li>
                      <li>Begin marketing for new tenant</li>
                    </ul>
                  </div>
                </div>
              )}
            </div>

            {/* Footer Navigation */}
            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 32, paddingTop: 24, borderTop: '1px solid #e5e7eb' }}>
              <button
                type="button"
                onClick={() => {
                  if (offboardingStep === 1) {
                    setShowOffboardingWizard(false);
                  } else if (offboardingStep === 6) {
                    setShowOffboardingWizard(false);
                    setOffboardingStep(1);
                    setOffboardingData({
                      tenant: null,
                      moveOutDate: '',
                      reason: '',
                      forwardingAddress: '',
                      inspectionChecklist: {
                        wallsClean: false,
                        floorsClean: false,
                        appliancesWorking: false,
                        plumbingWorking: false,
                        keysReturned: false,
                        smokeDetectorsWorking: false,
                        noMissingItems: false
                      },
                      inspectionNotes: '',
                      inspectionPhotos: [],
                      depositDeductions: [],
                      finalStatement: null
                    });
                  } else {
                    setOffboardingStep(offboardingStep - 1);
                  }
                }}
                className='btn btn-secondary'
              >
                {offboardingStep === 1 ? 'Cancel' : offboardingStep === 6 ? 'Close' : 'Back'}
              </button>
              
              <button
                type="button"
                onClick={validateAndContinueOffboarding}
                className='btn btn-primary'
                disabled={offboardingStep === 6}
              >
                {offboardingStep === 5 ? 'Complete Offboarding' : offboardingStep === 6 ? 'Done' : 'Continue'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add/Edit Vendor Modal */}
      {(showAddVendorModal || showEditVendorModal) && (
        <div 
          onClick={() => handleModalClose('vendor-form', () => {
            setShowAddVendorModal(false);
            setShowEditVendorModal(null);
          })}
          style={{ 
            position: 'fixed', 
            inset: 0, 
            background: 'rgba(0,0,0,0.5)', 
            zIndex: 1000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
          }}
        >
          <div 
            onClick={e => e.stopPropagation()}
            style={{
              background: 'white',
              borderRadius: '16px',
              width: '90%',
              maxWidth: '560px',
              maxHeight: '90vh',
              overflow: 'auto'
            }}
          >
            <div style={{ 
              padding: '20px 24px', 
              borderBottom: '1px solid #e2e8f0',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#1e293b' }}>
                {showEditVendorModal ? 'Edit Vendor' : 'Add New Vendor'}
              </h2>
              <button
                onClick={() => {
                  setShowAddVendorModal(false);
                  setShowEditVendorModal(null);
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '20px',
                  cursor: 'pointer',
                  color: '#64748b'
                }}
              >
                Ã
              </button>
            </div>
            
            <form
              id="vendor-form"
              onSubmit={async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const vendorData = {
                  name: formData.get('name'),
                  company: formData.get('company') || null,
                  phone: formData.get('phone') || null,
                  email: formData.get('email') || null,
                  specialty: formData.get('specialty'),
                  hourly_rate: formData.get('hourly_rate') ? Number(formData.get('hourly_rate')) : null,
                  flat_rate: formData.get('flat_rate') ? Number(formData.get('flat_rate')) : null,
                  notes: formData.get('notes') || null,
                  rating: formData.get('rating') ? Number(formData.get('rating')) : null,
                  insurance_expiry: formData.get('insurance_expiry') || null,
                  license_number: formData.get('license_number') || null,
                  is_preferred: formData.get('is_preferred') === 'on',
                  status: formData.get('status') || 'active'
                };
                
                if (showEditVendorModal) {
                  await updateVendor(showEditVendorModal.id, vendorData);
                } else {
                  await addVendor(vendorData);
                }
                setShowAddVendorModal(false);
                setShowEditVendorModal(null);
              }}
              style={{ padding: '24px' }}
            >
              <div style={{ display: 'grid', gap: '20px' }}>
                {/* Name */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Contact Name *
                  </label>
                  <input
                    name="name"
                    required
                    defaultValue={showEditVendorModal?.name || ''}
                    placeholder="John Smith"
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      boxSizing: 'border-box'
                    }}
                  />
                </div>

                {/* Company */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Company Name
                  </label>
                  <input
                    name="company"
                    defaultValue={showEditVendorModal?.company || ''}
                    placeholder="ABC Plumbing LLC"
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      boxSizing: 'border-box'
                    }}
                  />
                </div>

                {/* Phone & Email */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Phone
                    </label>
                    <input
                      name="phone"
                      type="tel"
                      defaultValue={showEditVendorModal?.phone || ''}
                      placeholder="(555) 123-4567"
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Email
                    </label>
                    <input
                      name="email"
                      type="email"
                      defaultValue={showEditVendorModal?.email || ''}
                      placeholder="john@abcplumbing.com"
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>
                </div>

                {/* Specialty */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Specialty *
                  </label>
                  <select
                    name="specialty"
                    required
                    defaultValue={showEditVendorModal?.specialty || ''}
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      background: 'white',
                      boxSizing: 'border-box'
                    }}
                  >
                    <option value="">Select specialty...</option>
                    {vendorSpecialties.map(s => (
                      <option key={s.value} value={s.value}>{s.label}</option>
                    ))}
                  </select>
                </div>

                {/* Rates */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Hourly Rate
                    </label>
                    <input
                      name="hourly_rate"
                      type="number"
                      step="0.01"
                      defaultValue={showEditVendorModal?.hourly_rate || ''}
                      placeholder="75.00"
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Flat Rate
                    </label>
                    <input
                      name="flat_rate"
                      type="number"
                      step="0.01"
                      defaultValue={showEditVendorModal?.flat_rate || ''}
                      placeholder="150.00"
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>
                </div>

                {/* License & Insurance */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      License Number
                    </label>
                    <input
                      name="license_number"
                      defaultValue={showEditVendorModal?.license_number || ''}
                      placeholder="LIC-12345"
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Insurance Expiry
                    </label>
                    <input
                      name="insurance_expiry"
                      type="date"
                      defaultValue={showEditVendorModal?.insurance_expiry || ''}
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>
                </div>

                {/* Rating */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Rating
                  </label>
                  <select
                    name="rating"
                    defaultValue={showEditVendorModal?.rating || ''}
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      background: 'white',
                      boxSizing: 'border-box'
                    }}
                  >
                    <option value="">No rating</option>
                    <option value="5">âââââ Excellent</option>
                    <option value="4">âââââ Good</option>
                    <option value="3">âââââ Average</option>
                    <option value="2">âââââ Below Average</option>
                    <option value="1">âââââ Poor</option>
                  </select>
                </div>

                {/* Status & Preferred */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Status
                    </label>
                    <select
                      name="status"
                      defaultValue={showEditVendorModal?.status || 'active'}
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white',
                        boxSizing: 'border-box'
                      }}
                    >
                      <option value="active">Active</option>
                      <option value="inactive">Inactive</option>
                    </select>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', paddingTop: '28px' }}>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                      <input
                        name="is_preferred"
                        type="checkbox"
                        defaultChecked={showEditVendorModal?.is_preferred || false}
                        style={{ width: '18px', height: '18px' }}
                      />
                      <span style={{ fontSize: '14px', color: '#374151' }}>Mark as Preferred Vendor</span>
                    </label>
                  </div>
                </div>

                {/* Notes */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Notes
                  </label>
                  <textarea
                    name="notes"
                    defaultValue={showEditVendorModal?.notes || ''}
                    placeholder="Additional notes about this vendor..."
                    rows={3}
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      resize: 'vertical',
                      boxSizing: 'border-box'
                    }}
                  />
                </div>
              </div>

              {/* Actions */}
              <div style={{ 
                display: 'flex', 
                justifyContent: 'flex-end', 
                gap: '12px', 
                marginTop: '24px',
                paddingTop: '20px',
                borderTop: '1px solid #e2e8f0'
              }}>
                <button
                  type="button"
                  onClick={() => {
                    setShowAddVendorModal(false);
                    setShowEditVendorModal(null);
                  }}
                  style={{
                    padding: '10px 20px',
                    background: 'white',
                    border: '1px solid #e2e8f0',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    color: '#64748b'
                  }}
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  style={{
                    padding: '10px 20px',
                    background: '#1a73e8',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    color: 'white'
                  }}
                >
                  {showEditVendorModal ? 'Save Changes' : 'Add Vendor'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Vendor Detail Panel */}
      {showVendorDetail && (
        <div 
          onClick={() => setShowVendorDetail(null)}
          style={{ 
            position: 'fixed', 
            inset: 0, 
            background: 'rgba(0,0,0,0.5)', 
            zIndex: 1000 
          }}
        >
          <div 
            onClick={e => e.stopPropagation()}
            style={{
              position: 'fixed',
              top: 0,
              right: 0,
              width: '600px',
              maxWidth: '100%',
              height: '100vh',
              background: 'white',
              boxShadow: '-4px 0 20px rgba(0,0,0,0.1)',
              overflow: 'auto'
            }}
          >
            {(() => {
              const vendor = showVendorDetail;
              const stats = getVendorStats(vendor.id);
              const specialtyInfo = getSpecialtyInfo(vendor.specialty);
              const vendorJobs = maintenanceRequests.filter(m => m.vendor_id === vendor.id);
              
              return (
                <>
                  {/* Header */}
                  <div style={{ 
                    padding: '24px', 
                    borderBottom: '1px solid #e2e8f0',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'flex-start'
                  }}>
                    <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                      <div style={{
                        width: '64px',
                        height: '64px',
                        borderRadius: '12px',
                        background: '#f1f5f9',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: '#64748b'
                      }}>
                        <div style={{ transform: 'scale(1.5)' }}>{specialtyInfo.icon}</div>
                      </div>
                      <div>
                        <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: '#1e293b' }}>
                          {vendor.name}
                        </h2>
                        {vendor.company && (
                          <p style={{ margin: '4px 0 0', color: '#64748b' }}>{vendor.company}</p>
                        )}
                        <p style={{ margin: '4px 0 0', fontSize: '14px', color: '#1a73e8', fontWeight: '500' }}>
                          {specialtyInfo.label}
                        </p>
                      </div>
                    </div>
                    <button
                      onClick={() => setShowVendorDetail(null)}
                      style={{
                        background: 'none',
                        border: 'none',
                        fontSize: '24px',
                        cursor: 'pointer',
                        color: '#64748b'
                      }}
                    >
                      Ã
                    </button>
                  </div>

                  {/* Content */}
                  <div style={{ padding: '24px' }}>
                    {/* Quick Actions */}
                    <div style={{ display: 'flex', gap: '8px', marginBottom: '24px' }}>
                      <button
                        onClick={() => {
                          setShowEditVendorModal(vendor);
                          setShowVendorDetail(null);
                        }}
                        style={{
                          flex: 1,
                          padding: '10px',
                          background: 'white',
                          border: '1px solid #e2e8f0',
                          borderRadius: '8px',
                          fontSize: '13px',
                          fontWeight: '500',
                          cursor: 'pointer',
                          color: '#374151'
                        }}
                      >
                        Edit Vendor
                      </button>
                      <button
                        onClick={() => setShowAddPaymentModal(vendor)}
                        style={{
                          flex: 1,
                          padding: '10px',
                          background: '#1a73e8',
                          border: 'none',
                          borderRadius: '8px',
                          fontSize: '13px',
                          fontWeight: '500',
                          cursor: 'pointer',
                          color: 'white'
                        }}
                      >
                        Record Payment
                      </button>
                      {vendor.phone && (
                        <a
                          href={`tel:${vendor.phone}`}
                          style={{
                            padding: '10px 16px',
                            background: '#f1f5f9',
                            border: 'none',
                            borderRadius: '8px',
                            fontSize: '13px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            color: '#374151',
                            textDecoration: 'none',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                        >
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                          Call
                        </a>
                      )}
                    </div>

                    {/* Stats Cards */}
                    <div style={{ 
                      display: 'grid', 
                      gridTemplateColumns: 'repeat(2, 1fr)', 
                      gap: '12px',
                      marginBottom: '24px'
                    }}>
                      <div style={{
                        padding: '16px',
                        background: '#f8fafc',
                        borderRadius: '10px'
                      }}>
                        <p style={{ margin: 0, fontSize: '12px', color: '#64748b' }}>Total Jobs</p>
                        <p style={{ margin: '4px 0 0', fontSize: '24px', fontWeight: '600', color: '#1e293b' }}>
                          {stats.totalJobs}
                        </p>
                        <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>
                          {stats.completedJobs} completed, {stats.openJobs} open
                        </p>
                      </div>
                      <div style={{
                        padding: '16px',
                        background: '#f8fafc',
                        borderRadius: '10px'
                      }}>
                        <p style={{ margin: 0, fontSize: '12px', color: '#64748b' }}>Total Paid</p>
                        <p style={{ margin: '4px 0 0', fontSize: '24px', fontWeight: '600', color: '#1e293b' }}>
                          ${stats.totalPaid.toLocaleString()}
                        </p>
                        {stats.pendingPayments > 0 && (
                          <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#dc2626' }}>
                            ${stats.pendingPayments.toLocaleString()} pending
                          </p>
                        )}
                      </div>
                    </div>

                    {/* Contact Info */}
                    <div style={{ 
                      padding: '16px', 
                      background: '#f8fafc', 
                      borderRadius: '10px',
                      marginBottom: '24px'
                    }}>
                      <h4 style={{ margin: '0 0 12px', fontSize: '14px', fontWeight: '600', color: '#374151' }}>
                        Contact Information
                      </h4>
                      <div style={{ display: 'grid', gap: '8px' }}>
                        {vendor.phone && (
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ color: '#64748b', fontSize: '13px' }}>Phone</span>
                            <span style={{ color: '#1e293b', fontSize: '13px' }}>{vendor.phone}</span>
                          </div>
                        )}
                        {vendor.email && (
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ color: '#64748b', fontSize: '13px' }}>Email</span>
                            <a href={`mailto:${vendor.email}`} style={{ color: '#1a73e8', fontSize: '13px' }}>
                              {vendor.email}
                            </a>
                          </div>
                        )}
                        {vendor.license_number && (
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ color: '#64748b', fontSize: '13px' }}>License</span>
                            <span style={{ color: '#1e293b', fontSize: '13px' }}>{vendor.license_number}</span>
                          </div>
                        )}
                        {vendor.insurance_expiry && (
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ color: '#64748b', fontSize: '13px' }}>Insurance Expires</span>
                            <span style={{ 
                              color: new Date(vendor.insurance_expiry) < new Date() ? '#dc2626' : '#1e293b', 
                              fontSize: '13px' 
                            }}>
                              {new Date(vendor.insurance_expiry).toLocaleDateString()}
                            </span>
                          </div>
                        )}
                        {(vendor.hourly_rate || vendor.flat_rate) && (
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span style={{ color: '#64748b', fontSize: '13px' }}>Rate</span>
                            <span style={{ color: '#1e293b', fontSize: '13px' }}>
                              {vendor.hourly_rate && `$${vendor.hourly_rate}/hr`}
                              {vendor.hourly_rate && vendor.flat_rate && ' | '}
                              {vendor.flat_rate && `$${vendor.flat_rate} flat`}
                            </span>
                          </div>
                        )}
                        {vendor.rating && (
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ color: '#64748b', fontSize: '13px' }}>Rating</span>
                            {renderStars(vendor.rating)}
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Notes */}
                    {vendor.notes && (
                      <div style={{ marginBottom: '24px' }}>
                        <h4 style={{ margin: '0 0 8px', fontSize: '14px', fontWeight: '600', color: '#374151' }}>
                          Notes
                        </h4>
                        <p style={{ margin: 0, fontSize: '14px', color: '#64748b', lineHeight: '1.5' }}>
                          {vendor.notes}
                        </p>
                      </div>
                    )}

                    {/* Assigned Jobs */}
                    <div style={{ marginBottom: '24px' }}>
                      <h4 style={{ margin: '0 0 12px', fontSize: '14px', fontWeight: '600', color: '#374151' }}>
                        Assigned Jobs ({vendorJobs.length})
                      </h4>
                      {vendorJobs.length === 0 ? (
                        <p style={{ color: '#64748b', fontSize: '14px' }}>No jobs assigned yet</p>
                      ) : (
                        <div style={{ display: 'grid', gap: '8px' }}>
                          {vendorJobs.slice(0, 5).map(job => (
                            <div key={job.id} style={{
                              padding: '12px',
                              background: '#f8fafc',
                              borderRadius: '8px',
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center'
                            }}>
                              <div>
                                <p style={{ margin: 0, fontSize: '14px', fontWeight: '500', color: '#1e293b' }}>
                                  {job.title}
                                </p>
                                <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>
                                  {properties.find(p => p.id === job.property_id)?.name || 'Unknown property'}
                                </p>
                              </div>
                              <span style={{
                                padding: '4px 8px',
                                background: job.status === 'completed' ? '#dcfce7' : job.status === 'in_progress' ? '#dbeafe' : '#fef3c7',
                                color: job.status === 'completed' ? '#166534' : job.status === 'in_progress' ? '#1e40af' : '#92400e',
                                borderRadius: '6px',
                                fontSize: '11px',
                                fontWeight: '500'
                              }}>
                                {job.status}
                              </span>
                            </div>
                          ))}
                          {vendorJobs.length > 5 && (
                            <p style={{ margin: '8px 0 0', fontSize: '13px', color: '#64748b', textAlign: 'center' }}>
                              +{vendorJobs.length - 5} more jobs
                            </p>
                          )}
                        </div>
                      )}
                    </div>

                    {/* Payment History */}
                    <div style={{ marginBottom: '24px' }}>
                      <h4 style={{ margin: '0 0 12px', fontSize: '14px', fontWeight: '600', color: '#374151' }}>
                        Payment History ({stats.payments.length})
                      </h4>
                      {stats.payments.length === 0 ? (
                        <p style={{ color: '#64748b', fontSize: '14px' }}>No payments recorded</p>
                      ) : (
                        <div style={{ display: 'grid', gap: '8px' }}>
                          {stats.payments.slice(0, 10).map(payment => (
                            <div key={payment.id} style={{
                              padding: '12px',
                              background: '#f8fafc',
                              borderRadius: '8px',
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center'
                            }}>
                              <div>
                                <p style={{ margin: 0, fontSize: '14px', fontWeight: '500', color: '#1e293b' }}>
                                  ${Number(payment.amount).toLocaleString()}
                                </p>
                                <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>
                                  {payment.description || 'No description'} | {new Date(payment.payment_date).toLocaleDateString()}
                                </p>
                              </div>
                              <span style={{
                                padding: '4px 8px',
                                background: payment.status === 'paid' ? '#dcfce7' : payment.status === 'pending' ? '#fef3c7' : '#fee2e2',
                                color: payment.status === 'paid' ? '#166534' : payment.status === 'pending' ? '#92400e' : '#dc2626',
                                borderRadius: '6px',
                                fontSize: '11px',
                                fontWeight: '500'
                              }}>
                                {payment.status}
                              </span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    {/* Delete Button */}
                    <div style={{ marginTop: '32px', paddingTop: '20px', borderTop: '1px solid #e2e8f0' }}>
                      <button
                        onClick={async () => {
                          if (confirm(`Delete ${vendor.name}? This cannot be undone.`)) {
                            await deleteVendor(vendor.id);
                            setShowVendorDetail(null);
                          }
                        }}
                        style={{
                          width: '100%',
                          padding: '10px',
                          background: 'white',
                          border: '1px solid #fecaca',
                          borderRadius: '8px',
                          fontSize: '14px',
                          fontWeight: '500',
                          cursor: 'pointer',
                          color: '#dc2626'
                        }}
                      >
                        Delete Vendor
                      </button>
                    </div>
                  </div>
                </>
              );
            })()}
          </div>
        </div>
      )}

      {/* Add Vendor Payment Modal */}
      {showAddPaymentModal && (
        <div 
          onClick={() => handleModalClose('payment-form', () => setShowAddPaymentModal(null))}
          style={{ 
            position: 'fixed', 
            inset: 0, 
            background: 'rgba(0,0,0,0.5)', 
            zIndex: 1001,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
          }}
        >
          <div 
            onClick={e => e.stopPropagation()}
            style={{
              background: 'white',
              borderRadius: '16px',
              width: '90%',
              maxWidth: '480px',
              maxHeight: '90vh',
              overflow: 'auto'
            }}
          >
            <div style={{ 
              padding: '20px 24px', 
              borderBottom: '1px solid #e2e8f0',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600', color: '#1e293b' }}>
                Record Payment
              </h2>
              <button
                onClick={() => setShowAddPaymentModal(null)}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '20px',
                  cursor: 'pointer',
                  color: '#64748b'
                }}
              >
                Ã
              </button>
            </div>
            
            <form
              id="payment-form"
              onSubmit={async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const paymentData = {
                  vendor_id: showAddPaymentModal.id,
                  amount: Number(formData.get('amount')),
                  description: formData.get('description') || null,
                  payment_date: formData.get('payment_date'),
                  payment_method: formData.get('payment_method'),
                  check_number: formData.get('check_number') || null,
                  invoice_number: formData.get('invoice_number') || null,
                  property_id: formData.get('property_id') ? Number(formData.get('property_id')) : null,
                  maintenance_request_id: formData.get('maintenance_request_id') ? Number(formData.get('maintenance_request_id')) : null,
                  status: formData.get('status')
                };
                
                await addVendorPayment(paymentData);
                setShowAddPaymentModal(null);
              }}
              style={{ padding: '24px' }}
            >
              <div style={{ display: 'grid', gap: '20px' }}>
                {/* Vendor (read-only) */}
                <div style={{
                  padding: '12px',
                  background: '#f8fafc',
                  borderRadius: '8px'
                }}>
                  <p style={{ margin: 0, fontSize: '12px', color: '#64748b' }}>Vendor</p>
                  <p style={{ margin: '4px 0 0', fontSize: '14px', fontWeight: '500', color: '#1e293b' }}>
                    {showAddPaymentModal.name} {showAddPaymentModal.company && `(${showAddPaymentModal.company})`}
                  </p>
                </div>

                {/* Amount */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Amount *
                  </label>
                  <input
                    name="amount"
                    type="number"
                    step="0.01"
                    required
                    placeholder="0.00"
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      boxSizing: 'border-box'
                    }}
                  />
                </div>

                {/* Description */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Description
                  </label>
                  <input
                    name="description"
                    placeholder="Service call, repairs, etc."
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      boxSizing: 'border-box'
                    }}
                  />
                </div>

                {/* Date & Method */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Payment Date *
                    </label>
                    <input
                      name="payment_date"
                      type="date"
                      required
                      defaultValue={new Date().toISOString().split('T')[0]}
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Payment Method
                    </label>
                    <select
                      name="payment_method"
                      defaultValue="check"
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        background: 'white',
                        boxSizing: 'border-box'
                      }}
                    >
                      {paymentMethods.map(m => (
                        <option key={m.value} value={m.value}>{m.label}</option>
                      ))}
                    </select>
                  </div>
                </div>

                {/* Check & Invoice Numbers */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Check Number
                    </label>
                    <input
                      name="check_number"
                      placeholder="1234"
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                      Invoice Number
                    </label>
                    <input
                      name="invoice_number"
                      placeholder="INV-001"
                      style={{
                        width: '100%',
                        padding: '10px 14px',
                        border: '1px solid #e2e8f0',
                        borderRadius: '8px',
                        fontSize: '14px',
                        boxSizing: 'border-box'
                      }}
                    />
                  </div>
                </div>

                {/* Property */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Property (optional)
                  </label>
                  <select
                    name="property_id"
                    defaultValue=""
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      background: 'white',
                      boxSizing: 'border-box'
                    }}
                  >
                    <option value="">Select property...</option>
                    {properties.map(p => (
                      <option key={p.id} value={p.id}>{p.name}</option>
                    ))}
                  </select>
                </div>

                {/* Maintenance Request */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Related Maintenance Request (optional)
                  </label>
                  <select
                    name="maintenance_request_id"
                    defaultValue=""
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      background: 'white',
                      boxSizing: 'border-box'
                    }}
                  >
                    <option value="">Select maintenance request...</option>
                    {maintenanceRequests
                      .filter(m => m.vendor_id === showAddPaymentModal.id)
                      .map(m => (
                        <option key={m.id} value={m.id}>{m.issue || m.title}</option>
                      ))}
                  </select>
                </div>

                {/* Status */}
                <div>
                  <label style={{ display: 'block', marginBottom: '6px', fontSize: '14px', fontWeight: '500', color: '#374151' }}>
                    Status
                  </label>
                  <select
                    name="status"
                    defaultValue="paid"
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '1px solid #e2e8f0',
                      borderRadius: '8px',
                      fontSize: '14px',
                      background: 'white',
                      boxSizing: 'border-box'
                    }}
                  >
                    <option value="paid">Paid</option>
                    <option value="pending">Pending</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                </div>
              </div>

              {/* Actions */}
              <div style={{ 
                display: 'flex', 
                justifyContent: 'flex-end', 
                gap: '12px', 
                marginTop: '24px',
                paddingTop: '20px',
                borderTop: '1px solid #e2e8f0'
              }}>
                <button
                  type="button"
                  onClick={() => setShowAddPaymentModal(null)}
                  style={{
                    padding: '10px 20px',
                    background: 'white',
                    border: '1px solid #e2e8f0',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    color: '#64748b'
                  }}
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  style={{
                    padding: '10px 20px',
                    background: '#1a73e8',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    color: 'white'
                  }}
                >
                  Record Payment
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Help & Support Modal */}
      {showHelpSupport && (
        <div 
          onClick={() => setShowHelpSupport(false)}
          style={{ 
            position: 'fixed', 
            inset: 0, 
            background: 'rgba(0,0,0,0.5)', 
            zIndex: 1000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
          }}
        >
          <div 
            onClick={e => e.stopPropagation()}
            style={{
              background: 'white',
              borderRadius: '16px',
              width: '90%',
              maxWidth: '900px',
              maxHeight: '90vh',
              overflow: 'hidden',
              display: 'flex',
              flexDirection: 'column'
            }}
          >
            {/* Header */}
            <div style={{ 
              padding: '24px', 
              borderBottom: '1px solid #e2e8f0',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <div>
                <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: '#1e293b' }}>
                  Help & Support
                </h2>
                <p style={{ margin: '4px 0 0', fontSize: '14px', color: '#64748b' }}>
                  Find answers or get in touch with our team
                </p>
              </div>
              <button
                onClick={() => setShowHelpSupport(false)}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '24px',
                  cursor: 'pointer',
                  color: '#64748b'
                }}
              >
                Ã
              </button>
            </div>
            
            {/* Content */}
            <div style={{ flex: 1, overflow: 'auto', padding: '24px' }}>
              {/* Search */}
              <div style={{ marginBottom: '24px' }}>
                <input
                  type="text"
                  placeholder="Search for help..."
                  value={helpSearchQuery}
                  onChange={(e) => setHelpSearchQuery(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '14px 16px',
                    border: '1px solid #e2e8f0',
                    borderRadius: '10px',
                    fontSize: '15px',
                    boxSizing: 'border-box'
                  }}
                />
              </div>
              
              {/* Quick Actions */}
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(3, 1fr)', 
                gap: '16px',
                marginBottom: '32px'
              }}>
                <a
                  href="mailto:support@propli.app?subject=Support Request"
                  style={{
                    padding: '20px',
                    background: '#f8fafc',
                    borderRadius: '12px',
                    textDecoration: 'none',
                    textAlign: 'center',
                    border: '1px solid #e2e8f0',
                    transition: 'border-color 0.15s'
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.borderColor = '#1a73e8'}
                  onMouseLeave={(e) => e.currentTarget.style.borderColor = '#e2e8f0'}
                >
                  <div style={{
                    width: '48px',
                    height: '48px',
                    margin: '0 auto 12px',
                    background: '#dbeafe',
                    borderRadius: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: '#1a73e8'
                  }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                  </div>
                  <p style={{ margin: 0, fontSize: '14px', fontWeight: '600', color: '#1e293b' }}>Email Support</p>
                  <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>Get help within 24 hours</p>
                </a>
                
                <a
                  href="tel:+12065551234"
                  style={{
                    padding: '20px',
                    background: '#f8fafc',
                    borderRadius: '12px',
                    textDecoration: 'none',
                    textAlign: 'center',
                    border: '1px solid #e2e8f0',
                    transition: 'border-color 0.15s'
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.borderColor = '#1a73e8'}
                  onMouseLeave={(e) => e.currentTarget.style.borderColor = '#e2e8f0'}
                >
                  <div style={{
                    width: '48px',
                    height: '48px',
                    margin: '0 auto 12px',
                    background: '#dcfce7',
                    borderRadius: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: '#16a34a'
                  }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                  </div>
                  <p style={{ margin: 0, fontSize: '14px', fontWeight: '600', color: '#1e293b' }}>Call Us</p>
                  <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>Mon-Fri, 9am-5pm PST</p>
                </a>
                
                <button
                  onClick={() => {
                    // Open live chat or chatbot
                    alert('Live chat coming soon! For now, please email support@propli.app');
                  }}
                  style={{
                    padding: '20px',
                    background: '#f8fafc',
                    borderRadius: '12px',
                    textAlign: 'center',
                    border: '1px solid #e2e8f0',
                    cursor: 'pointer',
                    transition: 'border-color 0.15s'
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.borderColor = '#1a73e8'}
                  onMouseLeave={(e) => e.currentTarget.style.borderColor = '#e2e8f0'}
                >
                  <div style={{
                    width: '48px',
                    height: '48px',
                    margin: '0 auto 12px',
                    background: '#fef3c7',
                    borderRadius: '12px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: '#d97706'
                  }}>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                  </div>
                  <p style={{ margin: 0, fontSize: '14px', fontWeight: '600', color: '#1e293b' }}>Live Chat</p>
                  <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>Coming soon</p>
                </button>
              </div>
              
              {/* Category Filters */}
              <div style={{ display: 'flex', gap: '8px', marginBottom: '20px', flexWrap: 'wrap' }}>
                {[
                  { id: 'all', label: 'All Topics' },
                  { id: 'getting-started', label: 'Getting Started' },
                  { id: 'tenants', label: 'Tenants' },
                  { id: 'properties', label: 'Properties' },
                  { id: 'maintenance', label: 'Maintenance' },
                  { id: 'payments', label: 'Payments & Fees' },
                  { id: 'vendors', label: 'Vendors' },
                  { id: 'account', label: 'Account' }
                ].map(cat => (
                  <button
                    key={cat.id}
                    onClick={() => setHelpCategory(cat.id)}
                    style={{
                      padding: '8px 16px',
                      background: helpCategory === cat.id ? '#1a73e8' : 'white',
                      color: helpCategory === cat.id ? 'white' : '#64748b',
                      border: '1px solid',
                      borderColor: helpCategory === cat.id ? '#1a73e8' : '#e2e8f0',
                      borderRadius: '20px',
                      fontSize: '13px',
                      fontWeight: '500',
                      cursor: 'pointer'
                    }}
                  >
                    {cat.label}
                  </button>
                ))}
              </div>
              
              {/* FAQ Items */}
              <div style={{ display: 'grid', gap: '12px' }}>
                {[
                  { category: 'getting-started', q: 'How do I add my first property?', a: 'Go to the Properties tab and click "Add Property". Fill in the property details including name, address, and unit information. You can add photos and set up units after the property is created.' },
                  { category: 'getting-started', q: 'How do I import existing tenant data?', a: 'Currently, tenants need to be added manually through the Tenants tab. Bulk import via CSV is coming soon. Contact support if you have a large dataset to migrate.' },
                  { category: 'tenants', q: 'How do I send a rent reminder to a tenant?', a: 'Open the tenant\'s profile and click "Send Reminder" or go to the Messages tab to send a custom SMS. You can also enable automatic reminders in Settings.' },
                  { category: 'tenants', q: 'How do I handle a tenant move-out?', a: 'Update the tenant\'s status to "Past" and set their lease end date. This will update occupancy numbers and move them to the Past Tenants view.' },
                  { category: 'properties', q: 'Can I manage multiple properties?', a: 'Yes! Propli supports unlimited properties. Each property can have multiple units, and you can view portfolio-wide analytics on the Dashboard.' },
                  { category: 'maintenance', q: 'How do I assign a vendor to a maintenance request?', a: 'Open the maintenance request and use the "Assigned Vendor" dropdown to select a vendor. You can then email the work order directly to the vendor.' },
                  { category: 'maintenance', q: 'Can tenants submit maintenance requests?', a: 'Yes, tenants can text maintenance requests to your Propli number. The system automatically creates a ticket when keywords like "broken", "leak", or "repair" are detected.' },
                  { category: 'payments', q: 'How do late fees work?', a: 'Configure late fees per property in the Late Fees tab. Set the fee amount (flat or percentage), grace period, and the system will automatically apply fees when rent is overdue.' },
                  { category: 'payments', q: 'Can I waive a late fee?', a: 'Yes, open the Late Fees tab, find the fee, and click "Waive". You\'ll be asked to provide a reason which is recorded for your records.' },
                  { category: 'vendors', q: 'How do I track vendor payments?', a: 'Go to the Vendors tab, select a vendor, and click "Record Payment". You can link payments to specific properties and maintenance requests.' },
                  { category: 'vendors', q: 'Can I mark a vendor as preferred?', a: 'Yes, when adding or editing a vendor, check the "Mark as Preferred Vendor" option. Preferred vendors are highlighted in the directory.' },
                  { category: 'account', q: 'How do I change my password?', a: 'Go to Settings > Account and click "Change Password". You\'ll receive an email with a password reset link.' },
                  { category: 'account', q: 'Can I add other users to my account?', a: 'Team member functionality is coming soon. Currently, Propli supports single-user accounts. Contact support for multi-user needs.' }
                ]
                  .filter(faq => {
                    if (helpCategory !== 'all' && faq.category !== helpCategory) return false;
                    if (helpSearchQuery) {
                      const query = helpSearchQuery.toLowerCase();
                      return faq.q.toLowerCase().includes(query) || faq.a.toLowerCase().includes(query);
                    }
                    return true;
                  })
                  .map((faq, i) => (
                    <details
                      key={i}
                      style={{
                        background: '#f8fafc',
                        borderRadius: '10px',
                        border: '1px solid #e2e8f0'
                      }}
                    >
                      <summary style={{
                        padding: '16px 20px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: '500',
                        color: '#1e293b',
                        listStyle: 'none',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                      }}>
                        {faq.q}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                      </summary>
                      <div style={{
                        padding: '0 20px 16px',
                        fontSize: '14px',
                        color: '#64748b',
                        lineHeight: '1.6'
                      }}>
                        {faq.a}
                      </div>
                    </details>
                  ))}
              </div>
              
              {/* Still Need Help */}
              <div style={{
                marginTop: '32px',
                padding: '24px',
                background: 'linear-gradient(135deg, #1a73e8 0%, #1e40af 100%)',
                borderRadius: '12px',
                textAlign: 'center',
                color: 'white'
              }}>
                <h3 style={{ margin: '0 0 8px', fontSize: '18px', fontWeight: '600' }}>
                  Still need help?
                </h3>
                <p style={{ margin: '0 0 16px', fontSize: '14px', opacity: 0.9 }}>
                  Our support team is here to help you succeed with Propli.
                </p>
                <a
                  href="mailto:support@propli.app?subject=Support Request"
                  style={{
                    display: 'inline-block',
                    padding: '12px 24px',
                    background: 'white',
                    color: '#1a73e8',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    textDecoration: 'none'
                  }}
                >
                  Contact Support
                </a>
              </div>
            </div>
          </div>
        </div>
      )}
      </main>
      </div>
    </div>
  );
}

export default App;
